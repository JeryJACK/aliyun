<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ç®¡ç† - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="./public/js/config.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        success: '#00B42A',
                    },
                }
            }
        }
    </script>

    <style>
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(22, 93, 255, 0.15);
        }
        .table-row:hover {
            background-color: #f8fafc;
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.drag-over {
            border-color: #165DFF;
            background-color: rgba(22, 93, 255, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-database text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">æ•°æ®ç®¡ç†ä¸­å¿ƒ</h1>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ“ä½œ -->
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">æ¬¢è¿ï¼Œ<span id="username" class="font-medium">ç®¡ç†å‘˜</span></span>
                <a href="index.html" class="text-gray-600 hover:text-primary transition-colors px-3 py-2 rounded-md">
                    <i class="fa fa-home mr-1"></i>è¿”å›é¦–é¡µ
                </a>
                <button id="logoutBtn" class="text-gray-600 hover:text-danger transition-colors px-3 py-2 rounded-md">
                    <i class="fa fa-sign-out mr-1"></i>é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container mx-auto px-4 py-6">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium">æ€»è®°å½•æ•°</p>
                        <h3 class="text-2xl font-bold text-primary mt-1" id="totalRecords">-</h3>
                    </div>
                    <div class="p-3 bg-primary/10 rounded-lg">
                        <i class="fa fa-database text-primary text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium">è®¡åˆ’IDæ•°</p>
                        <h3 class="text-2xl font-bold text-secondary mt-1" id="totalPlans">-</h3>
                    </div>
                    <div class="p-3 bg-secondary/10 rounded-lg">
                        <i class="fa fa-list-alt text-secondary text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium">å¤±è´¥è®°å½•æ•°</p>
                        <h3 class="text-2xl font-bold text-danger mt-1" id="totalFailures">-</h3>
                    </div>
                    <div class="p-3 bg-danger/10 rounded-lg">
                        <i class="fa fa-exclamation-circle text-danger text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 font-medium">æ•°æ®èŒƒå›´</p>
                        <h3 class="text-sm font-bold text-success mt-1" id="dataRange">-</h3>
                    </div>
                    <div class="p-3 bg-success/10 rounded-lg">
                        <i class="fa fa-calendar text-success text-xl"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ•°æ®å¯¼å…¥åŒºåŸŸ -->
        <section class="bg-white rounded-lg p-6 card-shadow mb-8">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-upload text-primary mr-2"></i>æ•°æ®å¯¼å…¥
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div>
                    <h3 class="text-md font-medium mb-3">Excel æ–‡ä»¶ä¸Šä¼ </h3>
                    <div id="dropArea" class="drag-area border rounded-lg p-8 text-center cursor-pointer">
                        <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-2">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <p class="text-sm text-gray-500">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
                        <p class="text-xs text-blue-500 mt-1">
                            <i class="fa fa-info-circle mr-1"></i>
                            å¤§æ–‡ä»¶ï¼ˆ>4MBï¼‰å°†è‡ªåŠ¨é‡‡ç”¨å®¢æˆ·ç«¯åˆ†æ‰¹å¤„ç†
                        </p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" />
                    </div>
                    
                    <div id="fileInfo" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fa fa-file-excel-o text-success"></i>
                                <span id="fileName" class="text-sm font-medium"></span>
                            </div>
                            <button id="removeFile" class="text-gray-400 hover:text-danger">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å¯¼å…¥è®¾ç½® -->
                <div>
                    <h3 class="text-md font-medium mb-3">å¯¼å…¥è®¾ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ•°æ®å¤„ç†æ¨¡å¼</label>
                            <select id="importMode" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="append">è¿½åŠ æ–°æ•°æ®ï¼ˆæ¨èï¼‰</option>
                                <option value="replace">æ¸…ç©ºå¹¶æ›¿æ¢æ‰€æœ‰æ•°æ®</option>
                                <option value="update">æ›´æ–°å·²å­˜åœ¨çš„æ•°æ®</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="validateData" checked class="rounded">
                                <span class="text-sm text-gray-700">æ•°æ®æ ¼å¼éªŒè¯</span>
                            </label>
                        </div>

                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="batchProcess" checked class="rounded">
                                <span class="text-sm text-gray-700">æ‰¹é‡å¤„ç†ï¼ˆåˆ†ç‰‡ä¸Šä¼ ï¼‰</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯¼å…¥æŒ‰é’®å’Œè¿›åº¦ -->
            <div class="mt-6">
                <button id="importBtn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-upload mr-2"></i>å¼€å§‹å¯¼å…¥
                </button>
                
                <div id="importProgress" class="mt-4 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600">å¯¼å…¥è¿›åº¦</span>
                        <span id="progressText" class="text-sm text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div id="importResult" class="mt-4 p-3 rounded-lg hidden">
                    <div class="flex items-center">
                        <i id="resultIcon" class="mr-2"></i>
                        <span id="resultText"></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
        <section class="bg-white rounded-lg p-6 card-shadow mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-table text-primary mr-2"></i>æ•°æ®ç®¡ç†
                </h2>
                
                <div class="flex items-center space-x-2">
                    <button id="refreshData" class="px-3 py-2 text-gray-600 hover:text-primary transition-colors">
                        <i class="fa fa-refresh mr-1"></i>åˆ·æ–°
                    </button>
                    <button id="exportData" class="px-3 py-2 text-gray-600 hover:text-success transition-colors">
                        <i class="fa fa-download mr-1"></i>å¯¼å‡º
                    </button>
                    <button id="clearAllData" class="px-3 py-2 text-gray-600 hover:text-danger transition-colors">
                        <i class="fa fa-trash mr-1"></i>æ¸…ç©ºæ•°æ®
                    </button>
                </div>
            </div>

            <!-- æœç´¢å’Œè¿‡æ»¤ -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                <div>
                    <input 
                        type="text" 
                        id="searchPlanId" 
                        placeholder="æœç´¢è®¡åˆ’ID" 
                        class="w-full p-2 border border-gray-300 rounded-md"
                    />
                </div>
                <div>
                    <input 
                        type="text" 
                        id="searchCustomer" 
                        placeholder="æœç´¢å®¢æˆ·" 
                        class="w-full p-2 border border-gray-300 rounded-md"
                    />
                </div>
                <div>
                    <input 
                        type="text" 
                        id="searchSatellite" 
                        placeholder="æœç´¢å«æ˜Ÿ" 
                        class="w-full p-2 border border-gray-300 rounded-md"
                    />
                </div>
                <div>
                    <input 
                        type="text" 
                        id="searchStation" 
                        placeholder="æœç´¢æµ‹ç«™" 
                        class="w-full p-2 border border-gray-300 rounded-md"
                    />
                </div>
                <div>
                    <input 
                        type="date" 
                        id="filterStartDate" 
                        class="w-full p-2 border border-gray-300 rounded-md"
                        title="å¼€å§‹æ—¥æœŸ"
                    />
                </div>
                <div>
                    <input 
                        type="date" 
                        id="filterEndDate" 
                        class="w-full p-2 border border-gray-300 rounded-md"
                        title="ç»“æŸæ—¥æœŸ"
                    />
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <select id="filterTaskType" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">å…¨éƒ¨ä»»åŠ¡ç±»å‹</option>
                    </select>
                </div>
                <div>
                    <select id="filterTaskResult" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">å…¨éƒ¨ç»“æœçŠ¶æ€</option>
                        <option value="æ­£å¸¸">æ­£å¸¸</option>
                        <option value="å› è®¾å¤‡æ•…éšœå¤±è´¥">å› è®¾å¤‡æ•…éšœå¤±è´¥</option>
                        <option value="å› æ“ä½œå¤±è¯¯å¤±è´¥">å› æ“ä½œå¤±è¯¯å¤±è´¥</option>
                        <option value="æœªè·Ÿè¸ª">æœªè·Ÿè¸ª</option>
                        <option value="å› å«æ˜Ÿæ–¹åŸå› å¤±è´¥">å› å«æ˜Ÿæ–¹åŸå› å¤±è´¥</option>
                        <option value="ä»»åŠ¡æˆåŠŸæ•°æ®å¤„ç†å¤±è¯¯">ä»»åŠ¡æˆåŠŸæ•°æ®å¤„ç†å¤±è¯¯</option>
                    </select>
                </div>
            </div>

            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="selectAll" class="rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®¡åˆ’ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¼€å§‹æ—¶é—´</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä»»åŠ¡ç»“æœçŠ¶æ€</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="bg-white divide-y divide-gray-200">
                        <!-- æ•°æ®è¡Œå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="flex items-center justify-between mt-6">
                <div class="text-sm text-gray-700">
                    æ˜¾ç¤º <span id="pageStart">0</span> åˆ° <span id="pageEnd">0</span> å…± <span id="totalCount">0</span> æ¡è®°å½•
                </div>
                <div class="flex items-center space-x-2">
                    <button id="prevPage" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <span id="currentPage" class="px-3 py-2 text-sm">1</span>
                    <button id="nextPage" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </section>
    </main>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div id="editModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ç¼–è¾‘è®°å½•</h3>
                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è®¡åˆ’ID</label>
                    <input type="text" id="editPlanId" class="w-full p-2 border border-gray-300 rounded-md" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¼€å§‹æ—¶é—´</label>
                    <input type="datetime-local" id="editStartTime" class="w-full p-2 border border-gray-300 rounded-md" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç»“æœçŠ¶æ€</label>
                    <select id="editTaskResult" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="æ­£å¸¸">æ­£å¸¸</option>
                        <option value="å› è®¾å¤‡æ•…éšœå¤±è´¥">å› è®¾å¤‡æ•…éšœå¤±è´¥</option>
                        <option value="å› æ“ä½œå¤±è¯¯å¤±è´¥">å› æ“ä½œå¤±è¯¯å¤±è´¥</option>
                        <option value="æœªè·Ÿè¸ª">æœªè·Ÿè¸ª</option>
                        <option value="å› å«æ˜Ÿæ–¹åŸå› å¤±è´¥">å› å«æ˜Ÿæ–¹åŸå› å¤±è´¥</option>
                        <option value="ä»»åŠ¡æˆåŠŸæ•°æ®å¤„ç†å¤±è¯¯">ä»»åŠ¡æˆåŠŸæ•°æ®å¤„ç†å¤±è¯¯</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="cancelEdit" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        class AdminApp {
            constructor() {
                this.token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                this.currentPage = 1;
                this.pageSize = 20;
                this.filters = {};
                
                this.init();
            }

            async init() {
                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                if (!this.token) {
                    console.log('âŒ æœªæ‰¾åˆ°tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    // GitHub Pagesç¯å¢ƒä¸‹è·³è¿‡éªŒè¯ï¼ˆå› ä¸ºæ²¡æœ‰ç»Ÿä¸€çš„verifyç«¯ç‚¹ï¼‰
                    if (CONFIG.isGitHubPages) {
                        console.log('ğŸŒ GitHub Pagesç¯å¢ƒï¼Œè·³è¿‡tokenéªŒè¯');
                        // å°è¯•ä»userInfoè·å–ç”¨æˆ·å
                        const userInfo = JSON.parse(localStorage.getItem('userInfo') || sessionStorage.getItem('userInfo') || '{}');
                        document.getElementById('username').textContent = userInfo.username || 'ç®¡ç†å‘˜';
                    } else {
                        // æœ¬åœ°å¼€å‘ç¯å¢ƒæ‰è¿›è¡ŒéªŒè¯
                        await this.verifyAuth();
                    }

                    this.bindEvents();
                    await this.loadStats();
                    await this.loadData();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.logout();
                }
            }

            async verifyAuth() {
                try {
                    console.log('ğŸ” å¼€å§‹éªŒè¯token...');
                    console.log('Token:', this.token);
                    console.log('API URL:', `${CONFIG.API_BASE_URL}/verify`);

                    const response = await fetch(`${CONFIG.API_BASE_URL}/verify`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    console.log('éªŒè¯å“åº”çŠ¶æ€:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('éªŒè¯å¤±è´¥:', errorText);
                        throw new Error(`è®¤è¯å¤±è´¥ (${response.status}): ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('éªŒè¯æˆåŠŸ:', result);

                    if (result.success && result.data) {
                        document.getElementById('username').textContent = result.data.username || 'ç®¡ç†å‘˜';
                    } else {
                        throw new Error('éªŒè¯å“åº”æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (error) {
                    console.error('âŒ verifyAuth å¤±è´¥:', error);
                    throw error;
                }
            }

            bindEvents() {
                // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
                const dropArea = document.getElementById('dropArea');
                const fileInput = document.getElementById('fileInput');
                
                dropArea.addEventListener('click', () => fileInput.click());
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('drag-over');
                });
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('drag-over');
                });
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFileSelect(files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });

                // å¯¼å…¥æŒ‰é’®
                document.getElementById('importBtn').addEventListener('click', () => this.importData());

                // æ•°æ®ç®¡ç†æŒ‰é’®
                document.getElementById('refreshData').addEventListener('click', () => this.loadData());
                document.getElementById('exportData').addEventListener('click', () => this.exportData());
                document.getElementById('clearAllData').addEventListener('click', () => this.clearAllData());

                // æœç´¢å’Œè¿‡æ»¤
                ['searchPlanId', 'filterStartDate', 'filterEndDate', 'filterTaskResult'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.applyFilters());
                });

                // åˆ†é¡µ
                document.getElementById('prevPage').addEventListener('click', () => this.prevPage());
                document.getElementById('nextPage').addEventListener('click', () => this.nextPage());

                // ç¼–è¾‘æ¨¡æ€æ¡†
                document.getElementById('closeEditModal').addEventListener('click', () => this.closeEditModal());
                document.getElementById('cancelEdit').addEventListener('click', () => this.closeEditModal());
                document.getElementById('editForm').addEventListener('submit', (e) => this.saveEdit(e));

                // ç™»å‡º
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            }

            handleFileSelect(file) {
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    this.showMessage('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰', 'error');
                    return;
                }

                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileInfo').classList.remove('hidden');
                this.selectedFile = file;

                document.getElementById('removeFile').addEventListener('click', () => {
                    document.getElementById('fileInfo').classList.add('hidden');
                    this.selectedFile = null;
                });
            }

            async importData() {
                if (!this.selectedFile) {
                    this.showMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }

                // è°ƒè¯•ä¿¡æ¯
                console.log('é€‰ä¸­çš„æ–‡ä»¶:', this.selectedFile);
                console.log('æ–‡ä»¶å:', this.selectedFile.name);
                console.log('æ–‡ä»¶å¤§å°:', this.selectedFile.size);
                console.log('æ–‡ä»¶ç±»å‹:', this.selectedFile.type);

                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œå¦‚æœè¶…è¿‡4MBåˆ™ä½¿ç”¨å®¢æˆ·ç«¯å¤„ç†
                if (this.selectedFile.size > 4 * 1024 * 1024) {
                    return await this.importLargeFile();
                }

                const formData = new FormData();
                formData.append('file', this.selectedFile);
                formData.append('mode', document.getElementById('importMode').value);
                formData.append('validate', document.getElementById('validateData').checked);
                formData.append('batch', document.getElementById('batchProcess').checked);

                // è°ƒè¯•FormDataå†…å®¹
                console.log('FormDataå†…å®¹:');
                for (let [key, value] of formData.entries()) {
                    console.log(key, ':', value);
                }

                try {
                    this.showImportProgress(true);

                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const importUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.import
                        : `${CONFIG.API_BASE_URL}/import`;

                    console.log('ğŸ“¤ å¯¼å…¥æ•°æ®ï¼ŒURL:', importUrl);

                    const response = await fetch(importUrl, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.token}` },
                        body: formData
                    });

                    // å…ˆæ£€æŸ¥å“åº”çŠ¶æ€
                    console.log('Response status:', response.status);
                    console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                    // è·å–å“åº”æ–‡æœ¬ç”¨äºè°ƒè¯•
                    const responseText = await response.text();
                    console.log('Raw response:', responseText);

                    // å°è¯•è§£æJSON
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('JSONè§£æå¤±è´¥:', parseError);
                        throw new Error(`æœåŠ¡å™¨è¿”å›éJSONæ ¼å¼å“åº” (çŠ¶æ€: ${response.status}): ${responseText.substring(0, 100)}...`);
                    }

                    if (response.ok && result.success) {
                        const importedCount = result.data?.imported || 0;
                        this.showImportResult('success', `æˆåŠŸå¯¼å…¥ ${importedCount} æ¡è®°å½•`);
                        await this.loadStats();
                        await this.loadData();
                    } else {
                        throw new Error(result.error || `å¯¼å…¥å¤±è´¥ (çŠ¶æ€: ${response.status})`);
                    }

                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    this.showImportResult('error', 'å¯¼å…¥å¤±è´¥: ' + error.message);
                } finally {
                    this.showImportProgress(false);
                }
            }

            showImportProgress(show) {
                const progress = document.getElementById('importProgress');
                if (show) {
                    progress.classList.remove('hidden');
                    // æ¨¡æ‹Ÿè¿›åº¦æ¡åŠ¨ç”»
                    let percent = 0;
                    const interval = setInterval(() => {
                        percent += Math.random() * 20;
                        if (percent >= 100) {
                            clearInterval(interval);
                            percent = 100;
                        }
                        document.getElementById('progressBar').style.width = percent + '%';
                        document.getElementById('progressText').textContent = Math.round(percent) + '%';
                    }, 200);
                } else {
                    progress.classList.add('hidden');
                }
            }

            showImportResult(type, message) {
                const result = document.getElementById('importResult');
                const icon = document.getElementById('resultIcon');
                const text = document.getElementById('resultText');

                result.className = `mt-4 p-3 rounded-lg ${type === 'success' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`;
                icon.className = `fa ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2`;
                text.textContent = message;

                result.classList.remove('hidden');
                setTimeout(() => result.classList.add('hidden'), 5000);
            }

            async importLargeFile() {
                try {
                    this.showImportProgress(true);
                    this.showImportResult('info', 'æ­£åœ¨å¤„ç†å¤§æ–‡ä»¶ï¼Œè¯·ç¨å€™...');

                    // å®¢æˆ·ç«¯è¯»å–Excelæ–‡ä»¶
                    const fileBuffer = await this.readFileAsArrayBuffer(this.selectedFile);
                    const workbook = XLSX.read(fileBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                    if (data.length === 0) {
                        throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                    }

                    console.log(`å®¢æˆ·ç«¯è§£æå®Œæˆï¼Œå…±${data.length}æ¡è®°å½•`);
                    
                    // åˆ†æ‰¹å¤„ç†æ•°æ®
                    const batchSize = 100;
                    let totalImported = 0;
                    
                    for (let i = 0; i < data.length; i += batchSize) {
                        const batch = data.slice(i, i + batchSize);
                        const progress = Math.round(((i + batch.length) / data.length) * 100);
                        
                        // æ›´æ–°è¿›åº¦
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressText').textContent = `${progress}% (${i + batch.length}/${data.length})`;
                        
                        try {
                            const imported = await this.uploadBatch(batch, i === 0 ? document.getElementById('importMode').value : 'append');
                            totalImported += imported;
                        } catch (error) {
                            console.warn(`æ‰¹æ¬¡ ${Math.floor(i/batchSize) + 1} å¤„ç†å¤±è´¥:`, error);
                        }
                        
                        // çŸ­æš‚å»¶è¿Ÿé¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    this.showImportResult('success', `æˆåŠŸå¯¼å…¥ ${totalImported} æ¡è®°å½•ï¼ˆå…±å¤„ç† ${data.length} æ¡ï¼‰`);
                    await this.loadStats();
                    await this.loadData();

                } catch (error) {
                    console.error('å¤§æ–‡ä»¶å¯¼å…¥å¤±è´¥:', error);
                    this.showImportResult('error', 'å¤§æ–‡ä»¶å¯¼å…¥å¤±è´¥: ' + error.message);
                } finally {
                    this.showImportProgress(false);
                }
            }

            async readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    reader.readAsArrayBuffer(file);
                });
            }

            async uploadBatch(batchData, mode) {
                // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                const importUrl = CONFIG.isGitHubPages
                    ? CONFIG.API_ENDPOINTS.import
                    : `${CONFIG.API_BASE_URL}/import-batch`;

                const response = await fetch(importUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`
                    },
                    body: JSON.stringify({
                        data: batchData,
                        mode: mode,
                        validate: document.getElementById('validateData').checked
                    })
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'æ‰¹æ¬¡ä¸Šä¼ å¤±è´¥');
                }

                return result.data?.imported || 0;
            }

            async loadStats() {
                try {
                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const statsUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.stats
                        : `${CONFIG.API_BASE_URL}/stats`;

                    console.log('ğŸ“Š åŠ è½½ç»Ÿè®¡æ•°æ®ï¼ŒURL:', statsUrl);

                    const response = await fetch(statsUrl, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const stats = result.data;
                        document.getElementById('totalRecords').textContent = stats.total_records || 0;
                        document.getElementById('totalPlans').textContent = stats.total_plans || 0;
                        document.getElementById('totalFailures').textContent = stats.total_failures || 0;

                        if (stats.earliest_time && stats.latest_time) {
                            const start = new Date(stats.earliest_time).toLocaleDateString();
                            const end = new Date(stats.latest_time).toLocaleDateString();
                            document.getElementById('dataRange').textContent = `${start} - ${end}`;
                        } else {
                            document.getElementById('dataRange').textContent = 'æš‚æ— æ•°æ®';
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                }
            }

            async loadData() {
                try {
                    const params = new URLSearchParams({
                        page: this.currentPage,
                        limit: this.pageSize,
                        ...this.filters
                    });

                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const recordsUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.records
                        : `${CONFIG.API_BASE_URL}/records`;

                    console.log('ğŸ“‹ åŠ è½½æ•°æ®è®°å½•ï¼ŒURL:', recordsUrl);

                    const response = await fetch(`${recordsUrl}?${params}`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.renderTable(result.data.records);
                        this.updatePagination(result.data);
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                }
            }

            renderTable(records) {
                const tbody = document.getElementById('dataTable');
                tbody.innerHTML = '';

                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.className = 'table-row';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="row-checkbox rounded" data-id="${record.id}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${record.plan_id}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(record.start_time).toLocaleString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${this.getStatusColor(record.task_result)}">
                                ${record.task_result || 'æœªçŸ¥'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="app.editRecord(${record.id})" class="text-primary hover:text-primary/70">
                                <i class="fa fa-edit mr-1"></i>ç¼–è¾‘
                            </button>
                            <button onclick="app.deleteRecord(${record.id})" class="text-danger hover:text-danger/70">
                                <i class="fa fa-trash mr-1"></i>åˆ é™¤
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            getStatusColor(status) {
                if (status === 'æ­£å¸¸') return 'bg-success/10 text-success';
                if (status && status.includes('å¤±è´¥')) return 'bg-danger/10 text-danger';
                if (status === 'æœªè·Ÿè¸ª') return 'bg-warning/10 text-warning';
                return 'bg-gray/10 text-gray-600';
            }

            updatePagination(data) {
                document.getElementById('totalCount').textContent = data.total;
                document.getElementById('pageStart').textContent = ((data.page - 1) * data.limit) + 1;
                document.getElementById('pageEnd').textContent = Math.min(data.page * data.limit, data.total);
                document.getElementById('currentPage').textContent = data.page;

                document.getElementById('prevPage').disabled = data.page <= 1;
                document.getElementById('nextPage').disabled = data.page >= data.totalPages;
            }

            applyFilters() {
                this.filters = {
                    planId: document.getElementById('searchPlanId').value,
                    startDate: document.getElementById('filterStartDate').value,
                    endDate: document.getElementById('filterEndDate').value,
                    taskResult: document.getElementById('filterTaskResult').value
                };
                this.currentPage = 1;
                this.loadData();
            }

            prevPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadData();
                }
            }

            nextPage() {
                this.currentPage++;
                this.loadData();
            }

            async editRecord(id) {
                try {
                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const recordsUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.records
                        : `${CONFIG.API_BASE_URL}/records`;

                    const response = await fetch(`${recordsUrl}/${id}`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const record = result.data;
                        document.getElementById('editId').value = record.id;
                        document.getElementById('editPlanId').value = record.plan_id;
                        document.getElementById('editStartTime').value = new Date(record.start_time).toISOString().slice(0, 16);
                        document.getElementById('editTaskResult').value = record.task_result;
                        
                        document.getElementById('editModal').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('è·å–è®°å½•è¯¦æƒ…å¤±è´¥:', error);
                }
            }

            async deleteRecord(id) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    return;
                }

                try {
                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const recordsUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.records
                        : `${CONFIG.API_BASE_URL}/records`;

                    const response = await fetch(`${recordsUrl}/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.showMessage('è®°å½•åˆ é™¤æˆåŠŸ', 'success');
                        await this.loadStats();
                        await this.loadData();
                    }
                } catch (error) {
                    console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
                    this.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            }

            async saveEdit(e) {
                e.preventDefault();

                const id = document.getElementById('editId').value;
                const data = {
                    plan_id: document.getElementById('editPlanId').value,
                    start_time: document.getElementById('editStartTime').value,
                    task_result: document.getElementById('editTaskResult').value
                };

                try {
                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const recordsUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.records
                        : `${CONFIG.API_BASE_URL}/records`;

                    const response = await fetch(`${recordsUrl}/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.closeEditModal();
                        this.showMessage('è®°å½•æ›´æ–°æˆåŠŸ', 'success');
                        await this.loadData();
                    }
                } catch (error) {
                    console.error('æ›´æ–°è®°å½•å¤±è´¥:', error);
                    this.showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                }
            }

            closeEditModal() {
                document.getElementById('editModal').classList.add('hidden');
            }

            async exportData() {
                try {
                    const params = new URLSearchParams(this.filters);

                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const exportUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.export || `${CONFIG.API_ENDPOINTS.stats}/export`
                        : `${CONFIG.API_BASE_URL}/export`;

                    console.log('ğŸ“¥ å¯¼å‡ºæ•°æ®ï¼ŒURL:', exportUrl);

                    const response = await fetch(`${exportUrl}?${params}`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `satellite-data-${new Date().toISOString().slice(0, 10)}.xlsx`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    }
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    this.showMessage('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                }
            }

            async clearAllData() {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    return;
                }

                if (!prompt('è¯·è¾“å…¥ "ç¡®è®¤æ¸…ç©º" æ¥ç¡®è®¤æ­¤æ“ä½œï¼š') === 'ç¡®è®¤æ¸…ç©º') {
                    return;
                }

                try {
                    // GitHub Pagesç¯å¢ƒä½¿ç”¨API_ENDPOINTSï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨API_BASE_URL
                    const clearUrl = CONFIG.isGitHubPages
                        ? CONFIG.API_ENDPOINTS.clear || `${CONFIG.API_ENDPOINTS.stats}/clear`
                        : `${CONFIG.API_BASE_URL}/clear`;

                    console.log('ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®ï¼ŒURL:', clearUrl);

                    const response = await fetch(clearUrl, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.showMessage('æ•°æ®æ¸…ç©ºæˆåŠŸ', 'success');
                        await this.loadStats();
                        await this.loadData();
                    }
                } catch (error) {
                    console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                    this.showMessage('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
                }
            }

            showMessage(message, type) {
                // ç®€å•çš„æ¶ˆæ¯æç¤ºå®ç°
                const div = document.createElement('div');
                div.className = `fixed top-4 right-4 p-3 rounded-lg z-50 ${
                    type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'
                }`;
                div.textContent = message;
                document.body.appendChild(div);
                
                setTimeout(() => {
                    document.body.removeChild(div);
                }, 3000);
            }

            logout() {
                localStorage.removeItem('authToken');
                sessionStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                sessionStorage.removeItem('userInfo');
                window.location.href = 'login.html';
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new AdminApp();
        });
    </script>
</body>
</html>
