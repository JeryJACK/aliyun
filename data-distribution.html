<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†å¸ƒåˆ†æ - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</title>
    <!-- å¤–éƒ¨èµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        success: '#00B42A',
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .stat-card {
                @apply bg-white rounded-lg p-4 card-shadow transition-all hover:shadow-lg;
            }
            .stat-card-value {
                @apply text-2xl font-bold text-gray-800 my-1;
            }
            .stat-card-label {
                @apply text-gray-500 text-sm;
            }
            .stat-card-icon {
                @apply w-10 h-10 rounded-full flex items-center justify-center text-primary bg-primary/10;
            }
            .chart-container {
                @apply h-80 md:h-96 border border-gray-200 rounded-lg p-4 relative mb-6;
            }
            .tab-item {
                @apply px-4 py-2 rounded-md cursor-pointer transition-all;
            }
            .tab-item-active {
                @apply bg-primary text-white;
            }
            .tab-item-inactive {
                @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
            }
            .filter-select {
                @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all;
            }
            .customer-tag {
                @apply px-2 py-1 bg-primary/10 text-primary text-xs rounded-full inline-flex items-center mr-1 mb-1;
            }
            .dropdown-options {
                max-height: 200px;
                overflow-y: auto;
            }
            .search-input {
                @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-sm;
            }
            .search-highlight {
                @apply bg-yellow-200 font-medium;
            }
            .chart-actions {
                @apply flex gap-2 items-center;
            }
            .chart-download-btn {
                @apply px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-pie-chart text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</h1>
            </div>

            <nav class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">é¦–é¡µ</a>
                <a href="trend-analysis.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">æ•°æ®è¶‹åŠ¿åˆ†æ</a>
                <a href="data-distribution.html" class="text-primary font-medium border-b-2 border-primary px-1 py-5">æ•°æ®åˆ†å¸ƒ</a>
                <a href="circle-warning.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">æ•°æ®é¢„è­¦</a>
                <a href="admin.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">
                    <i class="fa fa-cog mr-1"></i>æ•°æ®ç®¡ç†
                </a>
            </nav>

            <button class="md:hidden text-gray-600 hover:text-primary" id="mobileMenuBtn">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>

        <div class="md:hidden hidden bg-white border-t border-gray-200" id="mobileMenu">
            <div class="container mx-auto px-4 py-2">
                <a href="index.html" class="block py-3 text-gray-600 hover:text-primary">é¦–é¡µ</a>
                <a href="trend-analysis.html" class="block py-3 text-gray-600 hover:text-primary">æ•°æ®è¶‹åŠ¿åˆ†æ</a>
                <a href="data-distribution.html" class="block py-3 text-primary font-medium">æ•°æ®åˆ†å¸ƒåˆ†æ</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <h2 class="text-xl font-bold mb-6 text-gray-800">æ•°æ®åˆ†å¸ƒåˆ†æ</h2>

        <!-- æ•°æ®çŠ¶æ€æç¤ºåŒº -->
        <div id="dbLoading" class="mb-6 p-3 bg-primary/10 text-primary rounded-lg flex items-center hidden">
            <i class="fa fa-spinner fa-spin mr-2"></i>
            <span>æ­£åœ¨ä»æ•°æ®åº“åŠ è½½æ•°æ®...</span>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                <div id="loadingProgress" class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">
                <span id="loadingStatus">å‡†å¤‡åŠ è½½...</span>
            </div>
        </div>

        <div id="noDataAlert" class="bg-warning/10 text-warning p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span>è¯·å…ˆåœ¨é¦–é¡µå¯¼å…¥æ•°æ®ï¼Œç„¶åå†è¿›è¡Œåˆ†å¸ƒåˆ†æ</span>
        </div>

        <div id="dataStructureAlert" class="bg-warning/10 text-warning p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span>æ•°æ®ç»“æ„è¯†åˆ«å¼‚å¸¸</span>
            <div class="mt-2 text-sm">
                <p id="structureMsg">ç³»ç»Ÿæ£€æµ‹åˆ°æ•°æ®æ ¼å¼å¯èƒ½ä¸ç¬¦åˆé¢„æœŸï¼Œå·²å°è¯•è‡ªåŠ¨ä¿®å¤ã€‚</p>
                <div id="structureDetails" class="mt-1 bg-white p-2 rounded text-xs"></div>
            </div>
        </div>

        <!-- æ—¶é—´ç­›é€‰åŒºåŸŸ - ä¼˜åŒ–ä¸ºå…·ä½“æ—¥æœŸæ—¶é—´é€‰æ‹© -->
        <section id="filterSection" class="mb-8 bg-white rounded-lg p-6 card-shadow hidden">
            <h3 class="text-lg font-semibold mb-4">æ—¶é—´ç­›é€‰</h3>

            <!-- ç®€åŒ–çš„æ—¶é—´èŒƒå›´è®¾ç½® -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¼€å§‹æ—¶é—´</label>
                    <input type="datetime-local" id="startDateTime" class="filter-select">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç»“æŸæ—¶é—´</label>
                    <input type="datetime-local" id="endDateTime" class="filter-select">
                </div>
                <div class="flex items-end">
                    <div class="w-full">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="showDataLabels" class="mr-2 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                <label for="showDataLabels" class="text-sm text-gray-700">æ˜¾ç¤ºæ•°æ®æ ‡ç­¾</label>
                            </div>
                        </div>
                        <button id="applyFilters" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                            åº”ç”¨ç­›é€‰
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ•°æ®æ¦‚è§ˆå°å¡ç‰‡ -->
        <section id="statsCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 hidden">
            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-card-label">æ€»åœˆæ¬¡</div>
                        <div class="stat-card-value" id="totalCycles">0</div>
                        <div class="text-xs text-success mt-1">
                            <i class="fa fa-arrow-up"></i> <span id="cyclesChange">0%</span> è¾ƒä¸ŠæœŸ
                        </div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fa fa-refresh"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-card-label">å«æ˜Ÿæ•°é‡</div>
                        <div class="stat-card-value" id="satelliteCount">0</div>
                        <div class="text-xs text-gray-500 mt-1">
                            å…± <span id="activeSatellites">0</span> é¢—æ´»è·ƒå«æ˜Ÿ
                        </div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fa fa-satellite"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-card-label">å®¢æˆ·æ•°é‡</div>
                        <div class="stat-card-value" id="customerCount">0</div>
                        <div class="text-xs text-gray-500 mt-1">
                            è¦†ç›– <span id="customerCoverage">0</span> ä¸ªè¡Œä¸š
                        </div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fa fa-users"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="stat-card-label">æµ‹ç«™æ•°é‡</div>
                        <div class="stat-card-value" id="stationCount">0</div>
                        <div class="text-xs text-gray-500 mt-1">
                            æ€»è¦†ç›–ç‡ <span id="stationCoverage">0%</span>
                        </div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fa fa-map-marker"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- å®¢æˆ·æ•°æ®åˆ†å¸ƒ -->
        <section id="customerDistribution" class="mb-8 hidden">
            <h3 class="text-lg font-semibold mb-4">å®¢æˆ·æ•°æ®åˆ†å¸ƒ</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- å®¢æˆ·åœˆæ¬¡å æ¯”é¥¼å›¾ -->
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-base font-medium">å„å®¢æˆ·è·Ÿè¸ªåœˆæ¬¡å æ¯”</h4>
                        <div class="chart-actions">
                            <button class="chart-download-btn" data-chart="customerPieChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                                <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                            </button>
                            <button class="chart-download-btn" data-chart="customerPieChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                                <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="customerPieChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="customerPieChartEmpty">
                            <div class="text-center">
                                <i class="fa fa-pie-chart text-4xl mb-2"></i>
                                <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å®¢æˆ·åœˆæ¬¡æ•°é‡æ¡å½¢å›¾ -->
                <div class="bg-white rounded-lg p-6 card-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-base font-medium">å„å®¢æˆ·è·Ÿè¸ªåœˆæ¬¡æ•°é‡</h4>
                        <div class="chart-actions">
                            <button class="chart-download-btn" data-chart="customerBarChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                                <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                            </button>
                            <button class="chart-download-btn" data-chart="customerBarChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                                <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="customerBarChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="customerBarChartEmpty">
                            <div class="text-center">
                                <i class="fa fa-bar-chart text-4xl mb-2"></i>
                                <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æµ‹ç«™æ•°æ®åˆ†å¸ƒ -->
        <section id="stationDistribution" class="mb-8 hidden">
            <h3 class="text-lg font-semibold mb-4">æµ‹ç«™æ•°æ®åˆ†å¸ƒ</h3>
            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-base font-medium">å„æµ‹ç«™è·Ÿè¸ªåœˆæ¬¡æ•°é‡</h4>
                    <div class="chart-actions">
                        <button class="chart-download-btn" data-chart="stationBarChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn" data-chart="stationBarChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="stationBarChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="stationBarChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-bar-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- å®¢æˆ·-å«æ˜Ÿæ•°æ®åˆ†å¸ƒ - ä¼˜åŒ–ä¸ºä¸‹æ‹‰å¤šé€‰ -->
        <section id="customerSatelliteDistribution" class="mb-8 hidden">
            <h3 class="text-lg font-semibold mb-4">å®¢æˆ·-å«æ˜Ÿæ•°æ®åˆ†å¸ƒ</h3>

            <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-base font-medium">é€‰æ‹©å®¢æˆ·</h4>
                    <div class="text-sm text-gray-500">é€‰æ‹©åå›¾è¡¨ä¼šè‡ªåŠ¨æ›´æ–°</div>
                </div>

                <!-- ä¸‹æ‹‰å¤šé€‰ç»„ä»¶ -->
                <div class="relative" id="customerSelectContainer">
                    <div class="border border-gray-300 rounded-md p-2 cursor-pointer flex flex-wrap items-center min-h-[42px]" id="customerSelectDropdown">
                        <div id="selectedCustomerTags" class="flex flex-wrap flex-grow">
                            <div class="text-gray-500 italic text-sm">è¯·é€‰æ‹©å®¢æˆ·</div>
                        </div>
                        <i class="fa fa-chevron-down text-gray-500 ml-2"></i>
                    </div>

                    <!-- ä¸‹æ‹‰é€‰é¡¹ -->
                    <div class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden" id="customerSelectOptions">
                        <div class="p-2 border-b border-gray-200">
                            <input type="text" placeholder="æœç´¢å®¢æˆ·..." class="search-input" id="customerSearchInput">
                            <div class="text-xs text-gray-500 mt-1" id="customerSearchResultCount">æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·</div>
                        </div>
                        <div class="p-2 border-b border-gray-200 flex justify-between items-center">
                            <button id="selectAllBtn" class="text-sm text-primary hover:underline">å…¨é€‰</button>
                            <button id="deselectAllBtn" class="text-sm text-gray-600 hover:underline">æ¸…ç©ºé€‰æ‹©</button>
                        </div>
                        <div class="dropdown-options p-1" id="customerOptionsList">
                            <!-- å®¢æˆ·é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                            <div class="text-gray-500 italic text-sm p-2">è¯·å…ˆé€‰æ‹©æ—¶é—´èŒƒå›´å¹¶åº”ç”¨ç­›é€‰</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-base font-medium">å®¢æˆ·æ‰€å±å«æ˜Ÿè·Ÿè¸ªåœˆæ¬¡</h4>
                    <div class="chart-actions">
                        <button class="chart-download-btn" data-chart="customerSatelliteBarChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn" data-chart="customerSatelliteBarChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="customerSatelliteBarChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="customerSatelliteChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-bar-chart text-4xl mb-2"></i>
                            <p>è¯·é€‰æ‹©å®¢æˆ·æŸ¥çœ‹æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- å®¢æˆ·-æµ‹ç«™åå¥½åˆ†å¸ƒ - ä¼˜åŒ–ä¸ºä¸‹æ‹‰å¤šé€‰ -->
        <section id="customerStationPreference" class="mb-8 hidden">
            <h3 class="text-lg font-semibold mb-4">å®¢æˆ·-æµ‹ç«™åå¥½åˆ†å¸ƒ</h3>

            <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                <h4 class="text-base font-medium mb-3">é€‰æ‹©å®¢æˆ·æŸ¥çœ‹æµ‹ç«™åå¥½</h4>

                <!-- ä¸‹æ‹‰å¤šé€‰ç»„ä»¶ - ä¸å®¢æˆ·-å«æ˜Ÿåˆ†å¸ƒçš„é€‰æ‹©è”åŠ¨ -->
                <div class="relative" id="stationPreferenceCustomerSelectContainer">
                    <div class="border border-gray-300 rounded-md p-2 cursor-pointer flex flex-wrap items-center min-h-[42px]" id="stationPreferenceCustomerSelectDropdown">
                        <div id="stationPreferenceSelectedCustomerTags" class="flex flex-wrap flex-grow">
                            <div class="text-gray-500 italic text-sm">è¯·é€‰æ‹©å®¢æˆ·</div>
                        </div>
                        <i class="fa fa-chevron-down text-gray-500 ml-2"></i>
                    </div>

                    <!-- ä¸‹æ‹‰é€‰é¡¹ -->
                    <div class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden" id="stationPreferenceCustomerSelectOptions">
                        <div class="p-2 border-b border-gray-200">
                            <input type="text" placeholder="æœç´¢å®¢æˆ·..." class="search-input" id="stationPreferenceCustomerSearchInput">
                            <div class="text-xs text-gray-500 mt-1" id="stationPreferenceSearchResultCount">æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·</div>
                        </div>
                        <div class="p-2 border-b border-gray-200 flex justify-between items-center">
                            <button id="stationPreferenceSelectAllBtn" class="text-sm text-primary hover:underline">å…¨é€‰</button>
                            <button id="stationPreferenceDeselectAllBtn" class="text-sm text-gray-600 hover:underline">æ¸…ç©ºé€‰æ‹©</button>
                        </div>
                        <div class="dropdown-options p-1" id="stationPreferenceCustomerOptionsList">
                            <!-- å®¢æˆ·é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                            <div class="text-gray-500 italic text-sm p-2">è¯·å…ˆé€‰æ‹©æ—¶é—´èŒƒå›´å¹¶åº”ç”¨ç­›é€‰</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="stationPreferenceCharts">
                <!-- å®¢æˆ·æµ‹ç«™åå¥½é¥¼å›¾å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                <div class="bg-white rounded-lg p-6 card-shadow flex items-center justify-center h-80">
                    <div class="text-center text-gray-500">
                        <i class="fa fa-pie-chart text-4xl mb-2"></i>
                        <p>è¯·é€‰æ‹©å®¢æˆ·æŸ¥çœ‹æµ‹ç«™åå¥½</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // å­—æ®µæ˜ å°„é…ç½®ï¼ˆæ”¯æŒè‹±æ–‡å’Œä¸­æ–‡å­—æ®µåï¼‰
        const FIELD_MAPPING = {
            'å®¢æˆ·åç§°': 'customer',
            'å«æ˜Ÿåç§°': 'satellite_name', 
            'æµ‹ç«™åç§°': 'station_name',
            'ä»»åŠ¡ç»“æœçŠ¶æ€': 'task_result',
            'ä»»åŠ¡ç±»å‹': 'task_type',
            'å¼€å§‹æ—¶é—´': 'start_time'
        };

        // å­—æ®µæ˜ å°„å¤‡é€‰æ–¹æ¡ˆï¼ˆå‘åå…¼å®¹ï¼‰
        const FIELD_MAPPING_FALLBACK = {
            'å®¢æˆ·åç§°': 'æ‰€å±å®¢æˆ·',
            'å«æ˜Ÿåç§°': 'å«æ˜Ÿåç§°',
            'æµ‹ç«™åç§°': 'æµ‹ç«™åç§°', 
            'ä»»åŠ¡ç»“æœçŠ¶æ€': 'ä»»åŠ¡ç»“æœçŠ¶æ€',
            'ä»»åŠ¡ç±»å‹': 'ä»»åŠ¡ç±»å‹',
            'å¼€å§‹æ—¶é—´': 'å¼€å§‹æ—¶é—´'
        };

        // æ™ºèƒ½è·å–å­—æ®µå€¼çš„å‡½æ•°
        function getFieldValue(item, systemField) {
            if (!item) return '';
            
            // ä¼˜å…ˆä½¿ç”¨æ–°çš„è‹±æ–‡å­—æ®µå
            const primaryField = FIELD_MAPPING[systemField];
            if (primaryField && item[primaryField] !== undefined && item[primaryField] !== null) {
                return item[primaryField];
            }
            
            // å¦‚æœè‹±æ–‡å­—æ®µä¸å­˜åœ¨ï¼Œå°è¯•ä¸­æ–‡å­—æ®µå
            const fallbackField = FIELD_MAPPING_FALLBACK[systemField];
            if (fallbackField && item[fallbackField] !== undefined && item[fallbackField] !== null) {
                return item[fallbackField];
            }
            
            return '';
        }

        // ==================== IndexedDBç¼“å­˜ç®¡ç†å™¨ï¼ˆä»index.htmlå¤åˆ¶ï¼‰ ====================
        
        // IndexedDBç¼“å­˜ç®¡ç†å™¨
        class CacheManager {
            constructor() {
                this.dbName = 'SatelliteDataCache';
                this.dbVersion = 3;
                this.allDataStoreName = 'allDataCache';
                this.metaStoreName = 'metaData';
                this.db = null;
                // ç§»é™¤ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå§‹ç»ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜
                this.cacheExpiry = Infinity; 
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => {
                        console.error('âŒ IndexedDBåˆå§‹åŒ–å¤±è´¥:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('âœ… IndexedDBåˆå§‹åŒ–æˆåŠŸ');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        console.log('ğŸ”§ å‡çº§IndexedDBç»“æ„...');

                        // å…¨æ•°æ®å­˜å‚¨ç©ºé—´
                        if (!this.db.objectStoreNames.contains(this.allDataStoreName)) {
                            const allDataStore = this.db.createObjectStore(this.allDataStoreName, { keyPath: 'id' });
                            allDataStore.createIndex('timestamp', 'timestamp', { unique: false });
                            allDataStore.createIndex('start_time', 'start_time', { unique: false });
                            console.log('ğŸ“¦ åˆ›å»ºå…¨æ•°æ®å­˜å‚¨ç©ºé—´');
                        }

                        // å…ƒæ•°æ®å­˜å‚¨ç©ºé—´
                        if (!this.db.objectStoreNames.contains(this.metaStoreName)) {
                            const metaStore = this.db.createObjectStore(this.metaStoreName, { keyPath: 'key' });
                            console.log('ğŸ“¦ åˆ›å»ºå…ƒæ•°æ®å­˜å‚¨ç©ºé—´');
                        }
                    };
                });
            }

            // ä»æœ¬åœ°ç¼“å­˜æŸ¥è¯¢æ•°æ®ï¼ˆæ”¯æŒæ—¶é—´èŒƒå›´ç­›é€‰ï¼‰
            async queryAllData(filters = {}) {
                if (!this.db) await this.init();
                
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.allDataStoreName], 'readonly');
                    const store = transaction.objectStore(this.allDataStoreName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        let results = request.result || [];
                        
                        // åº”ç”¨æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼ˆä¸¥æ ¼ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼Œä¸è¿›è¡Œæ—¶åŒºè½¬æ¢ï¼‰
                        if (filters.startDate || filters.endDate) {
                            let startTime, endTime;
                            
                            if (filters.startDate) {
                                startTime = new Date(filters.startDate).getTime();
                                console.log(`ğŸ” ç­›é€‰å¼€å§‹æ—¶é—´: ${filters.startDate} -> ${new Date(startTime).toLocaleString()}`);
                            }
                            
                            if (filters.endDate) {
                                endTime = new Date(filters.endDate).getTime();
                                console.log(`ğŸ” ç­›é€‰ç»“æŸæ—¶é—´: ${filters.endDate} -> ${new Date(endTime).toLocaleString()}`);
                            }
                            
                            const beforeFilter = results.length;
                            results = results.filter(record => {
                                const recordTime = record.timestamp || this.parseTimeToTimestamp(record.start_time);
                                
                                if (filters.startDate && recordTime < startTime) return false;
                                if (filters.endDate && recordTime > endTime) return false;
                                
                                return true;
                            });
                            
                            console.log(`ğŸ” æ—¶é—´ç­›é€‰: ${beforeFilter} -> ${results.length} æ¡æ•°æ®`);
                        }
                        
                        console.log(`ğŸ” ä»æœ¬åœ°ç¼“å­˜æŸ¥è¯¢åˆ° ${results.length} æ¡æ•°æ®`);
                        resolve(results);
                    };

                    request.onerror = () => {
                        console.error('âŒ æŸ¥è¯¢æœ¬åœ°ç¼“å­˜å¤±è´¥:', request.error);
                        resolve([]);
                    };
                });
            }

            // è§£æå„ç§æ—¶é—´æ ¼å¼ä¸ºæ—¶é—´æˆ³ï¼ˆä¸¥æ ¼ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼Œä¸è¿›è¡Œæ—¶åŒºè½¬æ¢ï¼‰
            parseTimeToTimestamp(timeValue) {
                if (typeof timeValue === 'number') {
                    return timeValue > 1000000000000 ? timeValue : timeValue * 1000;
                }
                
                if (typeof timeValue === 'string') {
                    // ç›´æ¥ä½¿ç”¨åŒ—äº¬æ—¶é—´è§£æï¼Œä¸è¿›è¡Œæ—¶åŒºè½¬æ¢
                    const date = new Date(timeValue);
                    return isNaN(date.getTime()) ? 0 : date.getTime();
                }
                
                if (timeValue instanceof Date) {
                    return timeValue.getTime();
                }
                
                return 0;
            }

            // æ£€æŸ¥å…¨æ•°æ®ç¼“å­˜æ˜¯å¦å­˜åœ¨
            async checkAllDataCache() {
                if (!this.db) await this.init();
                
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.metaStoreName], 'readonly');
                    const store = transaction.objectStore(this.metaStoreName);
                    const request = store.get('allDataMeta');

                    request.onsuccess = () => {
                        const meta = request.result;
                        
                        if (!meta) {
                            console.log('ğŸ” æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨');
                            resolve(null);
                            return;
                        }
                        
                        console.log(`âœ… æœ¬åœ°ç¼“å­˜å­˜åœ¨ï¼ŒåŒ…å« ${meta.totalCount} æ¡è®°å½•ï¼Œæœ€åæ›´æ–°ï¼š${new Date(meta.lastUpdated).toLocaleString()}`);
                        resolve(meta);
                    };

                    request.onerror = () => {
                        console.error('âŒ æ£€æŸ¥æœ¬åœ°ç¼“å­˜å¤±è´¥:', request.error);
                        resolve(null);
                    };
                });
            }
        }

        // åˆ›å»ºå…¨å±€ç¼“å­˜ç®¡ç†å™¨å®ä¾‹
        const cacheManager = new CacheManager();

        // ä½¿ç”¨APIå®¢æˆ·ç«¯æ›¿ä»£IndexedDB
        // SatelliteDBç±»å·²åœ¨api-client.jsä¸­å®šä¹‰

        // å›¾è¡¨ç”Ÿæˆå™¨ - å¤§æ•°æ®é›†ä¼˜åŒ–ç‰ˆæœ¬
        class ChartGenerator {
            constructor() {
                this.charts = {};
                this.colors = [
                    '#165DFF', '#36CFC9', '#722ED1', '#FF7D00', '#F53F3F',
                    '#00B42A', '#86909C', '#F7BA1E', '#E53E3E', '#48BB78',
                    '#3182CE', '#805AD5', '#ED8936', '#ECC94B', '#6B46C1'
                ];
                this.maxSlices = 15; // é¥¼å›¾æœ€å¤§åˆ†ç‰‡æ•°
                this.maxBars = 30; // æŸ±çŠ¶å›¾æœ€å¤§æŸ±æ•°
                
                // ä¸€æ¬¡æ€§æ³¨å†Œæ•°æ®æ ‡ç­¾æ’ä»¶
                try {
                    Chart.register(ChartDataLabels);
                    console.log('âœ… ChartDataLabelsæ’ä»¶æ³¨å†ŒæˆåŠŸ');
                } catch (error) {
                    console.error('âŒ ChartDataLabelsæ’ä»¶æ³¨å†Œå¤±è´¥:', error);
                }
            }

            destroyChart(chartId) {
                if (this.charts[chartId]) {
                    try {
                        this.charts[chartId].destroy();
                    } catch (e) {
                        // ignore
                    }
                    delete this.charts[chartId];
                }
            }

            // ç”Ÿæˆé¥¼å›¾ - å¤§æ•°æ®é›†ä¼˜åŒ–ç‰ˆæœ¬
            generatePieChart(chartId, title, labels, data) {
                console.log(`ğŸ¨ å¼€å§‹ç”Ÿæˆé¥¼å›¾ ${chartId}:`, { title, labels, data });
                this.destroyChart(chartId);
                const ctxEl = document.getElementById(chartId);
                if (!ctxEl) {
                    console.error(`âŒ æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨: ${chartId}`);
                    return null;
                }
                const ctx = ctxEl.getContext('2d');
                const emptyState = document.getElementById(`${chartId}Empty`);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ•°æ®æ ‡ç­¾
                const showLabels = document.getElementById('showDataLabels')?.checked || false;

                const hasData = data && data.some(v => v > 0);
                if (!hasData) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    return null;
                }

                if (emptyState) emptyState.classList.add('hidden');

                // å¤§æ•°æ®é›†ä¼˜åŒ–ï¼šåˆå¹¶å°åˆ†ç‰‡
                let optimizedLabels = [...labels];
                let optimizedData = [...data];
                
                if (labels.length > this.maxSlices) {
                    console.warn(`é¥¼å›¾åˆ†ç‰‡è¿‡å¤š(${labels.length})ï¼Œå°†åˆå¹¶ä¸º${this.maxSlices}ä¸ªåˆ†ç‰‡`);
                    
                    // æŒ‰æ•°å€¼å¤§å°æ’åº
                    const combined = labels.map((label, i) => ({ label, value: data[i] }))
                        .sort((a, b) => b.value - a.value);
                    
                    // å–å‰N-1ä¸ªæœ€å¤§çš„åˆ†ç‰‡
                    const topSlices = combined.slice(0, this.maxSlices - 1);
                    const otherSlices = combined.slice(this.maxSlices - 1);
                    
                    // åˆå¹¶å…¶ä»–åˆ†ç‰‡
                    if (otherSlices.length > 0) {
                        const otherTotal = otherSlices.reduce((sum, item) => sum + item.value, 0);
                        topSlices.push({ label: `å…¶ä»–(${otherSlices.length}é¡¹)`, value: otherTotal });
                    }
                    
                    optimizedLabels = topSlices.map(item => item.label);
                    optimizedData = topSlices.map(item => item.value);
                }

                let chart;
                try {
                    chart = new Chart(ctx, {
                        type: 'pie',
                    data: {
                        labels: optimizedLabels,
                        datasets: [{
                            data: optimizedData,
                            backgroundColor: this.colors.slice(0, optimizedLabels.length),
                            borderWidth: 1,
                            borderColor: '#ffffff',
                            datalabels: {
                                display: showLabels,
                                backgroundColor: function(context) {
                                    // ä¸ºå¤–éƒ¨æ ‡ç­¾æ·»åŠ åŠé€æ˜èƒŒæ™¯
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? 'rgba(255, 255, 255, 0.9)' : 'transparent';
                                },
                                borderColor: function(context) {
                                    // ä¸ºå¤–éƒ¨æ ‡ç­¾æ·»åŠ è¾¹æ¡†
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? 'rgba(0, 0, 0, 0.1)' : 'transparent';
                                },
                                borderRadius: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? 4 : 0;
                                },
                                borderWidth: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? 1 : 0;
                                },
                                color: function(context) {
                                    // åŠ¨æ€è®¡ç®—æ–‡æœ¬é¢œè‰²
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? '#333333' : '#ffffff';
                                },
                                font: {
                                    size: function(context) {
                                        // å°åˆ†ç‰‡ä½¿ç”¨è¾ƒå°å­—ä½“
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = (context.parsed / total) * 100;
                                        return percentage < 8 ? 10 : 11;
                                    },
                                    weight: 'bold'
                                },
                                anchor: function(context) {
                                    // å°åˆ†ç‰‡å’Œæ‹¥æŒ¤åŒºåŸŸä½¿ç”¨å¤–éƒ¨æ˜¾ç¤º
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? 'end' : 'center';
                                },
                                align: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? 'end' : 'center';
                                },
                                offset: function(context) {
                                    // å¤–éƒ¨æ ‡ç­¾å¢åŠ æ›´å¤§åç§»è·ç¦»é¿å…é‡å 
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    if (percentage < 5) return 25; // å¾ˆå°çš„åˆ†ç‰‡
                                    if (percentage < 8) return 15; // å°åˆ†ç‰‡
                                    return 0; // å¤§åˆ†ç‰‡
                                },
                                padding: function(context) {
                                    // ä¸ºå¤–éƒ¨æ ‡ç­¾æ·»åŠ å†…è¾¹è·
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return percentage < 8 ? 6 : 0;
                                },
                                formatter: function(value, context) {
                                    if (!showLabels || value <= 0) return '';
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    
                                    // æ ¹æ®åˆ†ç‰‡å¤§å°è°ƒæ•´æ˜¾ç¤ºå†…å®¹
                                    if (percentage < 3) {
                                        return `${percentage}%`; // å¾ˆå°åˆ†ç‰‡åªæ˜¾ç¤ºç™¾åˆ†æ¯”
                                    } else if (percentage < 8) {
                                        return `${context.label}\n${percentage}%`; // å°åˆ†ç‰‡æ˜¾ç¤ºæ ‡ç­¾+ç™¾åˆ†æ¯”
                                    } else {
                                        return `${value}\n(${percentage}%)`; // å¤§åˆ†ç‰‡æ˜¾ç¤ºæ•°å€¼+ç™¾åˆ†æ¯”
                                    }
                                },
                                listeners: {
                                    enter: function(context) {
                                        // é¼ æ ‡æ‚¬åœæ—¶é«˜äº®å¼•å¯¼çº¿
                                        context.active = true;
                                        return true;
                                    },
                                    leave: function(context) {
                                        context.active = false;
                                        return true;
                                    }
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            datalabels: {
                                display: showLabels
                            },
                            title: {
                                display: true,
                                text: title + (labels.length > this.maxSlices ? ' (å·²åˆå¹¶æ˜¾ç¤º)' : ''),
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'rect',
                                    generateLabels: function(chart) {
                                        // è‡ªå®šä¹‰å›¾ä¾‹ç”Ÿæˆï¼Œé¿å…è¿‡é•¿çš„æ ‡ç­¾
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const dataset = data.datasets[0];
                                                const value = dataset.data[i];
                                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                
                                                // æˆªæ–­è¿‡é•¿çš„æ ‡ç­¾
                                                const truncatedLabel = label.length > 15 ? label.substring(0, 15) + '...' : label;
                                                
                                                return {
                                                    text: `${truncatedLabel} (${percentage}%)`,
                                                    fillStyle: dataset.backgroundColor[i],
                                                    strokeStyle: dataset.borderColor || '#ffffff',
                                                    lineWidth: 1,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value.toLocaleString()} æ¬¡ (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: labels.length > this.maxSlices ? 500 : 1000 // å¤§æ•°æ®é›†æ—¶å‡å°‘åŠ¨ç”»æ—¶é—´
                        }
                    }
                    });

                    this.charts[chartId] = chart;
                    console.log(`âœ… é¥¼å›¾ ${chartId} åˆ›å»ºæˆåŠŸ`);
                } catch (error) {
                    console.error(`âŒ é¥¼å›¾ ${chartId} åˆ›å»ºå¤±è´¥:`, error);
                    return null;
                }
                
                // æ˜¾ç¤ºä¼˜åŒ–æç¤º
                if (labels.length > this.maxSlices) {
                    this.showOptimizationNotice(chartId, {
                        originalSlices: labels.length,
                        optimizedSlices: optimizedLabels.length
                    });
                }
                
                return chart;
            }

            // ç”Ÿæˆæ¡å½¢å›¾ - å¤§æ•°æ®é›†ä¼˜åŒ–ç‰ˆæœ¬
            generateBarChart(chartId, title, labels, datasets) {
                console.log(`ğŸ“Š å¼€å§‹ç”Ÿæˆæ¡å½¢å›¾ ${chartId}:`, { title, labels, datasets });
                this.destroyChart(chartId);
                const ctxEl = document.getElementById(chartId);
                if (!ctxEl) {
                    console.error(`âŒ æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨: ${chartId}`);
                    return null;
                }
                const ctx = ctxEl.getContext('2d');
                const emptyState = document.getElementById(`${chartId}Empty`);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ•°æ®æ ‡ç­¾
                const showLabels = document.getElementById('showDataLabels')?.checked || false;

                const hasData = datasets && datasets.length > 0 && datasets.some(dataset => 
                    dataset.data && dataset.data.length > 0 && dataset.data.some(v => v != null && v > 0)
                );
                console.log(`ğŸ“Š ${chartId} æ•°æ®éªŒè¯:`, { hasData, datasets, labels });
                if (!hasData) {
                    console.warn(`ğŸ“Š ${chartId} æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€`);
                    if (emptyState) emptyState.classList.remove('hidden');
                    return null;
                }

                if (emptyState) emptyState.classList.add('hidden');

                // å¤§æ•°æ®é›†ä¼˜åŒ–ï¼šé™åˆ¶æŸ±æ•°
                let optimizedLabels = [...labels];
                let optimizedDatasets = [...datasets];
                
                if (labels.length > this.maxBars) {
                    console.warn(`æŸ±çŠ¶å›¾æ¡ç›®è¿‡å¤š(${labels.length})ï¼Œå°†é™åˆ¶ä¸º${this.maxBars}ä¸ª`);
                    
                    // å¯¹äºå¤šç³»åˆ—æ•°æ®ï¼ŒæŒ‰ç¬¬ä¸€ä¸ªç³»åˆ—çš„å€¼æ’åº
                    const firstDataset = datasets[0];
                    if (firstDataset) {
                        const combined = labels.map((label, i) => ({
                            label,
                            index: i,
                            value: firstDataset.data[i] || 0
                        })).sort((a, b) => b.value - a.value);
                        
                        // å–å‰Nä¸ªæœ€å¤§çš„é¡¹ç›®
                        const topItems = combined.slice(0, this.maxBars);
                        const topIndices = topItems.map(item => item.index);
                        
                        optimizedLabels = topItems.map(item => item.label);
                        optimizedDatasets = datasets.map(dataset => ({
                            ...dataset,
                            data: topIndices.map(i => dataset.data[i] || 0)
                        }));
                    }
                }

                const isLargeDataset = optimizedLabels.length > 15;

                const colors = this.colors; // ä¿å­˜å¼•ç”¨é¿å…ä½œç”¨åŸŸé—®é¢˜
                const styledDatasets = optimizedDatasets.map((dataset, i) => ({
                    label: dataset.label,
                    data: dataset.data,
                    backgroundColor: colors[i % colors.length] + '80',
                    borderColor: colors[i % colors.length],
                    borderWidth: 1,
                    datalabels: {
                        display: showLabels,
                        color: colors[i % colors.length],
                        anchor: 'end',
                        align: 'top',
                        font: {
                            size: 10,
                            weight: 'bold'
                        },
                        formatter: function(value) {
                            return value > 0 ? value : '';
                        }
                    }
                }));

                let chart;
                try {
                    chart = new Chart(ctx, {
                        type: 'bar',
                    data: {
                        labels: optimizedLabels,
                        datasets: styledDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            datalabels: {
                                display: showLabels
                            },
                            title: {
                                display: true,
                                text: title + (labels.length > this.maxBars ? ' (æ˜¾ç¤ºå‰Né¡¹)' : ''),
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toLocaleString()} æ¬¡`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: {
                                    maxRotation: isLargeDataset ? 90 : 45,
                                    minRotation: isLargeDataset ? 45 : 45,
                                    maxTicksLimit: isLargeDataset ? 20 : undefined
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { display: !isLargeDataset },
                                ticks: {
                                    precision: 0,
                                    stepSize: 1,
                                    maxTicksLimit: isLargeDataset ? 8 : undefined,
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: isLargeDataset ? 500 : 1000
                        },
                        // æ€§èƒ½ä¼˜åŒ–
                        parsing: isLargeDataset ? false : true,
                        normalized: isLargeDataset ? true : false
                    }
                    });

                    this.charts[chartId] = chart;
                    console.log(`âœ… æ¡å½¢å›¾ ${chartId} åˆ›å»ºæˆåŠŸ`);
                } catch (error) {
                    console.error(`âŒ æ¡å½¢å›¾ ${chartId} åˆ›å»ºå¤±è´¥:`, error);
                    return null;
                }
                
                // æ˜¾ç¤ºä¼˜åŒ–æç¤º
                if (labels.length > this.maxBars) {
                    this.showOptimizationNotice(chartId, {
                        originalBars: labels.length,
                        optimizedBars: optimizedLabels.length
                    });
                }
                
                return chart;
            }

            // é”€æ¯æ‰€æœ‰å›¾è¡¨
            destroyAllCharts() {
                Object.keys(this.charts).forEach(id => this.destroyChart(id));
            }
            
            // æ˜¾ç¤ºä¼˜åŒ–æç¤º
            showOptimizationNotice(chartId, info) {
                const chartContainer = document.getElementById(chartId)?.closest('.chart-container');
                if (!chartContainer) return;
                
                // ç§»é™¤æ—§çš„æç¤º
                this.removeOptimizationNotice(chartId);
                
                const notice = document.createElement('div');
                notice.id = `${chartId}-optimization-notice`;
                notice.className = 'absolute top-2 right-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded shadow-sm z-10';
                
                let message = 'å·²ä¼˜åŒ–æ˜¾ç¤º: ';
                if (info.originalSlices && info.optimizedSlices) {
                    message += `åˆ†ç‰‡ ${info.originalSlices}â†’${info.optimizedSlices}`;
                } else if (info.originalBars && info.optimizedBars) {
                    message += `æ¡ç›® ${info.originalBars}â†’${info.optimizedBars}`;
                }
                
                notice.innerHTML = `
                    <i class="fa fa-info-circle mr-1"></i>${message}
                    <button onclick="this.parentElement.remove()" class="ml-2 text-blue-600 hover:text-blue-800">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                chartContainer.appendChild(notice);
                
                // 10ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (notice.parentElement) {
                        notice.remove();
                    }
                }, 10000);
            }
            
            removeOptimizationNotice(chartId) {
                const notice = document.getElementById(`${chartId}-optimization-notice`);
                if (notice) {
                    notice.remove();
                }
            }
        }

        // ä¸‹è½½å·¥å…·å‡½æ•°ï¼ˆé€šç”¨ï¼‰
        function downloadFile(filename, content, mimeType = 'application/octet-stream') {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 500);
        }

        // å°† Chart.js å®ä¾‹æ•°æ®è½¬æ¢ä¸º CSVï¼ˆå« UTF-8 BOMï¼Œæ–¹ä¾¿ Excel æ‰“å¼€ï¼‰
        function chartToCSV(chart) {
            if (!chart || !chart.data) return '';

            const labels = chart.data.labels || [];
            const datasets = chart.data.datasets || [];

            // Header row: åˆ†ç»„, dataset1, dataset2...
            const header = ['åˆ†ç»„', ...datasets.map(ds => ds.label || '')];
            const rows = [header];

            for (let i = 0; i < labels.length; i++) {
                const row = [labels[i]];
                for (let j = 0; j < datasets.length; j++) {
                    const v = datasets[j].data && typeof datasets[j].data[i] !== 'undefined' ? datasets[j].data[i] : '';
                    row.push(v);
                }
                rows.push(row);
            }

            const csvLines = rows.map(cols => cols.map(cell => {
                if (cell === null || typeof cell === 'undefined') return '';
                const cellStr = String(cell);
                if (/[",\n]/.test(cellStr)) {
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }
                return cellStr;
            }).join(','));

            return '\uFEFF' + csvLines.join('\n');
        }

        // å°†ç®€å•çš„å•æ•°æ®é›†ï¼ˆå¦‚é¥¼å›¾ï¼‰è½¬æ¢ä¸º CSV (label,value)
        function simpleChartToCSV(chart) {
            if (!chart || !chart.data) return '';
            const labels = chart.data.labels || [];
            const data = (chart.data.datasets && chart.data.datasets[0] && chart.data.datasets[0].data) || [];
            const rows = [['åˆ†ç»„', 'å€¼']];
            for (let i = 0; i < labels.length; i++) {
                rows.push([labels[i] || '', data[i] || 0]);
            }
            const csvLines = rows.map(cols => cols.map(cell => {
                const cellStr = String(cell);
                if (/[",\n]/.test(cellStr)) {
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }
                return cellStr;
            }).join(','));
            return '\uFEFF' + csvLines.join('\n');
        }

        // ä¸»åº”ç”¨ç±»
        class DataDistributionApp {
            constructor() {
                this.cacheManager = cacheManager;
                this.chartGenerator = new ChartGenerator();

                // åº”ç”¨çŠ¶æ€
                this.data = null;
                this.filteredData = null;
                this.rawData = null;
                this.selectedCustomers = [];
                this.allCustomers = [];

                // ä¸‹æ‹‰é€‰é¡¹çŠ¶æ€
                this.isDropdownOpen = false;
                this.isStationPreferenceDropdownOpen = false;

                // ç¼“å­˜ç›‘å¬ç›¸å…³
                this.lastCacheCheckTime = null;
                this.cacheMonitoringInterval = null;

                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadData();
                this.setDefaultDateTimeRange();
                this.addDebugButtons();
                this.bindDownloadButtons(); // bind download handlers
                
                // å¯åŠ¨ç¼“å­˜ç›‘å¬
                this.startCacheMonitoring();
            }

            setupEventListeners() {
                // åº”ç”¨ç­›é€‰æŒ‰é’®
                const applyBtn = document.getElementById('applyFilters');
                if (applyBtn) applyBtn.addEventListener('click', () => this.applyFilters());

                // æ•°æ®æ ‡ç­¾æ˜¾ç¤ºåˆ‡æ¢äº‹ä»¶
                const showDataLabelsCheckbox = document.getElementById('showDataLabels');
                if (showDataLabelsCheckbox) {
                    showDataLabelsCheckbox.addEventListener('change', () => {
                        if (this.filteredData && this.filteredData.length > 0) {
                            console.log('ğŸ·ï¸ åˆ‡æ¢æ•°æ®æ ‡ç­¾æ˜¾ç¤º:', showDataLabelsCheckbox.checked);
                            // é‡æ–°ç”Ÿæˆæ‰€æœ‰å›¾è¡¨ä»¥ç¡®ä¿æ•°æ®æ ‡ç­¾æ­£ç¡®æ˜¾ç¤º
                            this.generateAllCharts();
                        }
                    });
                }

                // å®¢æˆ·ä¸‹æ‹‰é€‰æ‹©ç›¸å…³
                const cdd = document.getElementById('customerSelectDropdown');
                if (cdd) cdd.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleCustomerDropdown();
                });

                const selectAllBtn = document.getElementById('selectAllBtn');
                if (selectAllBtn) selectAllBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectAllCustomers();
                });

                const deselectAllBtn = document.getElementById('deselectAllBtn');
                if (deselectAllBtn) deselectAllBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deselectAllCustomers();
                });

                // ä¼˜åŒ–æœç´¢åŠŸèƒ½ - æ·»åŠ é˜²æŠ–å¤„ç†
                const customerSearchInput = document.getElementById('customerSearchInput');
                if (customerSearchInput) customerSearchInput.addEventListener('input', this.debounce((e) => {
                    this.filterCustomerOptions(e.target.value);
                }, 300));

                // æµ‹ç«™åå¥½å®¢æˆ·ä¸‹æ‹‰é€‰æ‹©ç›¸å…³
                const spcdd = document.getElementById('stationPreferenceCustomerSelectDropdown');
                if (spcdd) spcdd.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleStationPreferenceCustomerDropdown();
                });

                const spSelAll = document.getElementById('stationPreferenceSelectAllBtn');
                if (spSelAll) spSelAll.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectAllCustomers();
                });

                const spDeseAll = document.getElementById('stationPreferenceDeselectAllBtn');
                if (spDeseAll) spDeseAll.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deselectAllCustomers();
                });

                const spSearch = document.getElementById('stationPreferenceCustomerSearchInput');
                if (spSearch) spSearch.addEventListener('input', this.debounce((e) => {
                    this.filterStationPreferenceCustomerOptions(e.target.value);
                }, 300));

                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', () => {
                    this.closeAllDropdowns();
                });

                // ç§»åŠ¨ç«¯èœå•
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => {
                    document.getElementById('mobileMenu').classList.toggle('hidden');
                });
            }

            // é˜²æŠ–å‡½æ•° - ä¼˜åŒ–æœç´¢æ€§èƒ½
            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            // è®¾ç½®é»˜è®¤æ—¥æœŸæ—¶é—´èŒƒå›´ï¼ˆæœ€è¿‘7å¤©ï¼‰
            setDefaultDateTimeRange() {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);

                // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºdatetime-localæ‰€éœ€æ ¼å¼
                const sd = document.getElementById('startDateTime');
                const ed = document.getElementById('endDateTime');
                if (sd) sd.value = this.formatDateTimeForInput(startDate);
                if (ed) ed.value = this.formatDateTimeForInput(endDate);
            }

            // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºinputæ‰€éœ€æ ¼å¼
            formatDateTimeForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');

                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // åˆ‡æ¢å®¢æˆ·ä¸‹æ‹‰èœå•
            toggleCustomerDropdown() {
                this.isDropdownOpen = !this.isDropdownOpen;
                const options = document.getElementById('customerSelectOptions');

                if (this.isDropdownOpen) {
                    options.classList.remove('hidden');
                    this.isStationPreferenceDropdownOpen = false;
                    const spOpts = document.getElementById('stationPreferenceCustomerSelectOptions');
                    if (spOpts) spOpts.classList.add('hidden');
                    // èšç„¦æœç´¢æ¡†
                    const search = document.getElementById('customerSearchInput');
                    if (search) search.focus();
                } else {
                    options.classList.add('hidden');
                }
            }

            // åˆ‡æ¢æµ‹ç«™åå¥½å®¢æˆ·ä¸‹æ‹‰èœå•
            toggleStationPreferenceCustomerDropdown() {
                this.isStationPreferenceDropdownOpen = !this.isStationPreferenceDropdownOpen;
                const options = document.getElementById('stationPreferenceCustomerSelectOptions');

                if (this.isStationPreferenceDropdownOpen) {
                    options.classList.remove('hidden');
                    this.isDropdownOpen = false;
                    const cOpts = document.getElementById('customerSelectOptions');
                    if (cOpts) cOpts.classList.add('hidden');
                    // èšç„¦æœç´¢æ¡†
                    const search = document.getElementById('stationPreferenceCustomerSearchInput');
                    if (search) search.focus();
                } else {
                    options.classList.add('hidden');
                }
            }

            // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
            closeAllDropdowns() {
                if (this.isDropdownOpen) {
                    this.isDropdownOpen = false;
                    const cOpts = document.getElementById('customerSelectOptions');
                    if (cOpts) cOpts.classList.add('hidden');
                }

                if (this.isStationPreferenceDropdownOpen) {
                    this.isStationPreferenceDropdownOpen = false;
                    const spOpts = document.getElementById('stationPreferenceCustomerSelectOptions');
                    if (spOpts) spOpts.classList.add('hidden');
                }
            }

            // ç­›é€‰å®¢æˆ·é€‰é¡¹ - ä¼˜åŒ–ç‰ˆ
            filterCustomerOptions(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                const options = document.querySelectorAll('#customerOptionsList .customer-option');
                let visibleCount = 0;
                const totalCount = options.length;

                options.forEach(option => {
                    const customer = option.dataset.customer || '';
                    const text = customer.toLowerCase();
                    const isMatch = text.includes(term);

                    if (isMatch) {
                        option.classList.remove('hidden');
                        visibleCount++;

                        if (term) {
                            const span = option.querySelector('span');
                            const index = text.indexOf(term);
                            if (index !== -1) {
                                const before = customer.substring(0, index);
                                const match = customer.substring(index, index + term.length);
                                const after = customer.substring(index + term.length);
                                span.innerHTML = `${before}<span class="search-highlight">${match}</span>${after}`;
                            } else {
                                span.textContent = customer;
                            }
                        } else {
                            const span = option.querySelector('span');
                            span.textContent = customer;
                        }
                    } else {
                        option.classList.add('hidden');
                    }
                });

                const resultCountEl = document.getElementById('customerSearchResultCount');
                if (term) {
                    resultCountEl.textContent = `æ‰¾åˆ° ${visibleCount} ä¸ªåŒ¹é…ç»“æœï¼ˆå…± ${totalCount} ä¸ªï¼‰`;
                } else {
                    resultCountEl.textContent = `æ˜¾ç¤ºæ‰€æœ‰ ${totalCount} ä¸ªå®¢æˆ·`;
                }
            }

            // ç­›é€‰æµ‹ç«™åå¥½å®¢æˆ·é€‰é¡¹ - ä¼˜åŒ–ç‰ˆ
            filterStationPreferenceCustomerOptions(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                const options = document.querySelectorAll('#stationPreferenceCustomerOptionsList .customer-option');
                let visibleCount = 0;
                const totalCount = options.length;

                options.forEach(option => {
                    const customer = option.dataset.customer || '';
                    const text = customer.toLowerCase();
                    const isMatch = text.includes(term);

                    if (isMatch) {
                        option.classList.remove('hidden');
                        visibleCount++;

                        if (term) {
                            const span = option.querySelector('span');
                            const index = text.indexOf(term);
                            if (index !== -1) {
                                const before = customer.substring(0, index);
                                const match = customer.substring(index, index + term.length);
                                const after = customer.substring(index + term.length);
                                span.innerHTML = `${before}<span class="search-highlight">${match}</span>${after}`;
                            } else {
                                span.textContent = customer;
                            }
                        } else {
                            const span = option.querySelector('span');
                            span.textContent = customer;
                        }
                    } else {
                        option.classList.add('hidden');
                    }
                });

                const resultCountEl = document.getElementById('stationPreferenceSearchResultCount');
                if (term) {
                    resultCountEl.textContent = `æ‰¾åˆ° ${visibleCount} ä¸ªåŒ¹é…ç»“æœï¼ˆå…± ${totalCount} ä¸ªï¼‰`;
                } else {
                    resultCountEl.textContent = `æ˜¾ç¤ºæ‰€æœ‰ ${totalCount} ä¸ªå®¢æˆ·`;
                }
            }

            async loadData() {
                const dbLoading = document.getElementById('dbLoading');
                if (dbLoading) dbLoading.classList.remove('hidden');

                try {
                    // æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ˜¯å¦å­˜åœ¨
                    const cacheExists = await this.cacheManager.checkAllDataCache();
                    
                    if (!cacheExists) {
                        if (dbLoading) dbLoading.classList.add('hidden');
                        document.getElementById('noDataAlert').classList.remove('hidden');
                        return;
                    }

                    console.log('ğŸ“ ä»æœ¬åœ°ç¼“å­˜åŠ è½½æ•°æ®...');

                    // ä»æœ¬åœ°ç¼“å­˜è·å–æ‰€æœ‰æ•°æ®
                    const records = await this.cacheManager.queryAllData();
                    
                    this.data = records || [];

                    console.log(`âœ… åŠ è½½äº† ${this.data.length} æ¡è®°å½•`);

                    // æ˜¾ç¤ºå†…å®¹åŒºåŸŸ
                    if (dbLoading) dbLoading.classList.add('hidden');
                    const fs = document.getElementById('filterSection');
                    if (fs) fs.classList.remove('hidden');
                    const sc = document.getElementById('statsCards');
                    if (sc) sc.classList.remove('hidden');
                    const cd = document.getElementById('customerDistribution');
                    if (cd) cd.classList.remove('hidden');
                    const sd = document.getElementById('stationDistribution');
                    if (sd) sd.classList.remove('hidden');
                    const csd = document.getElementById('customerSatelliteDistribution');
                    if (csd) csd.classList.remove('hidden');
                    const csp = document.getElementById('customerStationPreference');
                    if (csp) csp.classList.remove('hidden');

                    // åˆå§‹åŒ–å®¢æˆ·é€‰é¡¹
                    this.initializeCustomerOptions();

                } catch (error) {
                    if (dbLoading) dbLoading.classList.add('hidden');
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    
                    // æ˜¾ç¤ºæ— æ•°æ®æç¤º
                    const noDataAlert = document.getElementById('noDataAlert');
                    if (noDataAlert) {
                        noDataAlert.classList.remove('hidden');
                    }
                }
            }

            // åˆå§‹åŒ–å®¢æˆ·é€‰é¡¹
            initializeCustomerOptions() {
                // è·å–æ‰€æœ‰å®¢æˆ·
                this.allCustomers = [...new Set(
                    this.data.map(item => getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim()).filter(Boolean)
                )].sort();

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                const list1 = document.getElementById('customerOptionsList');
                const list2 = document.getElementById('stationPreferenceCustomerOptionsList');
                if (list1) list1.innerHTML = '';
                if (list2) list2.innerHTML = '';

                // å¦‚æœæ²¡æœ‰å®¢æˆ·æ•°æ®
                if (!this.allCustomers.length) {
                    if (list1) list1.innerHTML =
                        '<div class="text-gray-500 italic text-sm p-2">æ²¡æœ‰å¯ç”¨çš„å®¢æˆ·æ•°æ®</div>';
                    if (list2) list2.innerHTML =
                        '<div class="text-gray-500 italic text-sm p-2">æ²¡æœ‰å¯ç”¨çš„å®¢æˆ·æ•°æ®</div>';
                    return;
                }

                // åˆ›å»ºå®¢æˆ·é€‰é¡¹
                this.allCustomers.forEach(customer => {
                    // ç”¨äºå«æ˜Ÿåˆ†å¸ƒçš„å®¢æˆ·é€‰é¡¹
                    const option1 = document.createElement('div');
                    option1.className = 'customer-option p-2 hover:bg-gray-100 rounded cursor-pointer flex items-center';
                    option1.dataset.customer = customer; // æ·»åŠ æ•°æ®å±æ€§å­˜å‚¨å®¢æˆ·åç§°
                    option1.innerHTML = `
                        <input type="checkbox" class="mr-2 customer-checkbox" data-customer="${customer}">
                        <span>${customer}</span>
                    `;
                    option1.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const checkbox = option1.querySelector('.customer-checkbox');
                        checkbox.checked = !checkbox.checked;
                        this.handleCustomerCheckboxChange(customer, checkbox.checked);
                    });
                    if (list1) list1.appendChild(option1);

                    // ç”¨äºæµ‹ç«™åå¥½çš„å®¢æˆ·é€‰é¡¹
                    const option2 = document.createElement('div');
                    option2.className = 'customer-option p-2 hover:bg-gray-100 rounded cursor-pointer flex items-center';
                    option2.dataset.customer = customer; // æ·»åŠ æ•°æ®å±æ€§å­˜å‚¨å®¢æˆ·åç§°
                    option2.innerHTML = `
                        <input type="checkbox" class="mr-2 customer-checkbox" data-customer="${customer}" ${this.selectedCustomers.includes(customer) ? 'checked' : ''}>
                        <span>${customer}</span>
                    `;
                    option2.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const checkbox = option2.querySelector('.customer-checkbox');
                        checkbox.checked = !checkbox.checked;
                        this.handleCustomerCheckboxChange(customer, checkbox.checked);
                    });
                    if (list2) list2.appendChild(option2);
                });

                // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
                this.updateCustomerTags();

                // åˆå§‹åŒ–æœç´¢ç»“æœè®¡æ•°
                const countEl1 = document.getElementById('customerSearchResultCount');
                const countEl2 = document.getElementById('stationPreferenceSearchResultCount');
                if (countEl1) countEl1.textContent = `æ˜¾ç¤ºæ‰€æœ‰ ${this.allCustomers.length} ä¸ªå®¢æˆ·`;
                if (countEl2) countEl2.textContent = `æ˜¾ç¤ºæ‰€æœ‰ ${this.allCustomers.length} ä¸ªå®¢æˆ·`;
            }

            // å¤„ç†å®¢æˆ·å¤é€‰æ¡†å˜åŒ–
            handleCustomerCheckboxChange(customer, checked) {
                if (checked && !this.selectedCustomers.includes(customer)) {
                    // é€‰ä¸­å®¢æˆ·
                    this.selectedCustomers.push(customer);
                } else if (!checked && this.selectedCustomers.includes(customer)) {
                    // å–æ¶ˆé€‰æ‹©
                    this.selectedCustomers = this.selectedCustomers.filter(c => c !== customer);
                }

                // æ›´æ–°æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€
                this.updateAllCustomerCheckboxes();

                // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
                this.updateCustomerTags();

                // æ›´æ–°å›¾è¡¨
                this.updateCustomerSatelliteChart();
                this.updateCustomerStationPreferenceCharts();
            }

            // æ›´æ–°æ‰€æœ‰å®¢æˆ·å¤é€‰æ¡†çŠ¶æ€
            updateAllCustomerCheckboxes() {
                document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
                    const customer = checkbox.dataset.customer;
                    checkbox.checked = this.selectedCustomers.includes(customer);
                });
            }

            // æ›´æ–°å®¢æˆ·æ ‡ç­¾æ˜¾ç¤º
            updateCustomerTags() {
                const tagContainer1 = document.getElementById('selectedCustomerTags');
                const tagContainer2 = document.getElementById('stationPreferenceSelectedCustomerTags');

                if (tagContainer1) tagContainer1.innerHTML = '';
                if (tagContainer2) tagContainer2.innerHTML = '';

                // å¦‚æœæ²¡æœ‰é€‰ä¸­å®¢æˆ·
                if (!this.selectedCustomers.length) {
                    if (tagContainer1) tagContainer1.innerHTML = '<div class="text-gray-500 italic text-sm">è¯·é€‰æ‹©å®¢æˆ·</div>';
                    if (tagContainer2) tagContainer2.innerHTML = '<div class="text-gray-500 italic text-sm">è¯·é€‰æ‹©å®¢æˆ·</div>';
                    return;
                }

                // æ·»åŠ é€‰ä¸­çš„å®¢æˆ·æ ‡ç­¾
                this.selectedCustomers.forEach(customer => {
                    // å«æ˜Ÿåˆ†å¸ƒçš„æ ‡ç­¾
                    const tag1 = document.createElement('div');
                    tag1.className = 'customer-tag';
                    tag1.innerHTML = `
                        ${customer}
                        <button class="ml-1 text-primary hover:text-primary/80" data-customer="${customer}">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    `;
                    tag1.querySelector('button').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.handleCustomerCheckboxChange(customer, false);
                    });
                    if (tagContainer1) tagContainer1.appendChild(tag1);

                    // æµ‹ç«™åå¥½çš„æ ‡ç­¾
                    const tag2 = document.createElement('div');
                    tag2.className = 'customer-tag';
                    tag2.innerHTML = `
                        ${customer}
                        <button class="ml-1 text-primary hover:text-primary/80" data-customer="${customer}">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    `;
                    tag2.querySelector('button').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.handleCustomerCheckboxChange(customer, false);
                    });
                    if (tagContainer2) tagContainer2.appendChild(tag2);
                });
            }

            // å…¨é€‰å®¢æˆ·
            selectAllCustomers() {
                this.selectedCustomers = [...this.allCustomers];
                this.updateAllCustomerCheckboxes();
                this.updateCustomerTags();
                this.updateCustomerSatelliteChart();
                this.updateCustomerStationPreferenceCharts();
            }

            // å–æ¶ˆå…¨é€‰å®¢æˆ·
            deselectAllCustomers() {
                this.selectedCustomers = [];
                this.updateAllCustomerCheckboxes();
                this.updateCustomerTags();
                this.updateCustomerSatelliteChart();
                this.updateCustomerStationPreferenceCharts();
            }

            // åº”ç”¨ç­›é€‰
            applyFilters() {
                if (!this.data) return;

                // è·å–æ—¥æœŸæ—¶é—´èŒƒå›´
                const startDateTime = document.getElementById('startDateTime').value
                    ? new Date(document.getElementById('startDateTime').value)
                    : null;
                const endDateTime = document.getElementById('endDateTime').value
                    ? new Date(document.getElementById('endDateTime').value)
                    : null;

                // éªŒè¯æ—¶é—´èŒƒå›´
                if (!startDateTime || !endDateTime) {
                    alert('è¯·é€‰æ‹©å®Œæ•´çš„æ—¶é—´èŒƒå›´');
                    return;
                }

                if (startDateTime > endDateTime) {
                    alert('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´');
                    return;
                }

                // åº”ç”¨ç­›é€‰ - ä¸¥æ ¼æŒ‰ç…§åŒ—äº¬æ—¶é—´è¿›è¡Œæ—¶é—´æ‰«æè®¡æ•°
                this.filteredData = this.data.filter(item => {
                    const rawTime = getFieldValue(item, 'å¼€å§‹æ—¶é—´');
                    if (!rawTime) return false;
                    
                    // ä¸¥æ ¼æŒ‰ç…§åŒ—äº¬æ—¶é—´è§£ææ—¶é—´
                    let itemDate;
                    if (typeof rawTime === 'string') {
                        // ç§»é™¤æ—¶åŒºæ ‡è¯†ï¼ŒæŒ‰åŒ—äº¬æ—¶é—´è§£æ
                        const cleanTime = rawTime.replace(/[TZ]/g, ' ').replace(/[+-]\d{2}:\d{2}$/, '').trim();
                        itemDate = new Date(cleanTime);
                    } else {
                        itemDate = new Date(rawTime);
                    }
                    
                    // ç¡®ä¿æ—¶é—´æ¯”è¾ƒæŒ‰åŒ—äº¬æ—¶é—´è¿›è¡Œ
                    return itemDate >= startDateTime && itemDate <= endDateTime;
                });

                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                this.updateStatsCards();

                // ç”Ÿæˆæ‰€æœ‰å›¾è¡¨
                this.generateAllCharts();

                // é‡ç½®å®¢æˆ·é€‰æ‹©
                this.deselectAllCustomers();

                // é‡æ–°åˆå§‹åŒ–å®¢æˆ·é€‰é¡¹ï¼ˆåŸºäºç­›é€‰åçš„æ•°æ®ï¼‰
                this.reinitializeCustomerOptionsBasedOnFilteredData();
            }

            // åŸºäºç­›é€‰åçš„æ•°æ®é‡æ–°åˆå§‹åŒ–å®¢æˆ·é€‰é¡¹
            reinitializeCustomerOptionsBasedOnFilteredData() {
                const filteredCustomers = [...new Set(
                    this.filteredData.map(item => getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim()).filter(Boolean)
                )].sort();

                const list1 = document.getElementById('customerOptionsList');
                const list2 = document.getElementById('stationPreferenceCustomerOptionsList');
                if (list1) list1.innerHTML = '';
                if (list2) list2.innerHTML = '';

                if (!filteredCustomers.length) {
                    if (list1) list1.innerHTML =
                        '<div class="text-gray-500 italic text-sm p-2">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·æ•°æ®</div>';
                    if (list2) list2.innerHTML =
                        '<div class="text-gray-500 italic text-sm p-2">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·æ•°æ®</div>';

                    const cSearch = document.getElementById('customerSearchResultCount');
                    const spSearch = document.getElementById('stationPreferenceSearchResultCount');
                    if (cSearch) cSearch.textContent = 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·æ•°æ®';
                    if (spSearch) spSearch.textContent = 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·æ•°æ®';
                    return;
                }

                this.allCustomers = filteredCustomers;

                filteredCustomers.forEach(customer => {
                    const option1 = document.createElement('div');
                    option1.className = 'customer-option p-2 hover:bg-gray-100 rounded cursor-pointer flex items-center';
                    option1.dataset.customer = customer;
                    option1.innerHTML = `
                        <input type="checkbox" class="mr-2 customer-checkbox" data-customer="${customer}">
                        <span>${customer}</span>
                    `;
                    option1.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const checkbox = option1.querySelector('.customer-checkbox');
                        checkbox.checked = !checkbox.checked;
                        this.handleCustomerCheckboxChange(customer, checkbox.checked);
                    });
                    if (list1) list1.appendChild(option1);

                    const option2 = document.createElement('div');
                    option2.className = 'customer-option p-2 hover:bg-gray-100 rounded cursor-pointer flex items-center';
                    option2.dataset.customer = customer;
                    option2.innerHTML = `
                        <input type="checkbox" class="mr-2 customer-checkbox" data-customer="${customer}">
                        <span>${customer}</span>
                    `;
                    option2.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const checkbox = option2.querySelector('.customer-checkbox');
                        checkbox.checked = !checkbox.checked;
                        this.handleCustomerCheckboxChange(customer, checkbox.checked);
                    });
                    if (list2) list2.appendChild(option2);
                });

                const cSearch = document.getElementById('customerSearchResultCount');
                const spSearch = document.getElementById('stationPreferenceSearchResultCount');
                if (cSearch) cSearch.textContent = `æ˜¾ç¤ºæ‰€æœ‰ ${filteredCustomers.length} ä¸ªå®¢æˆ·`;
                if (spSearch) spSearch.textContent = `æ˜¾ç¤ºæ‰€æœ‰ ${filteredCustomers.length} ä¸ªå®¢æˆ·`;
            }

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            updateStatsCards() {
                if (!this.filteredData) return;

                const totalCycles = this.filteredData.length;
                document.getElementById('totalCycles').textContent = totalCycles;

                const satellites = [...new Set(
                    this.filteredData.map(item => getFieldValue(item, 'å«æ˜Ÿåç§°')?.toString().trim()).filter(Boolean)
                )];
                document.getElementById('satelliteCount').textContent = satellites.length;

                const customers = [...new Set(
                    this.filteredData.map(item => getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim()).filter(Boolean)
                )];
                document.getElementById('customerCount').textContent = customers.length;

                const stations = [...new Set(
                    this.filteredData.map(item => getFieldValue(item, 'æµ‹ç«™åç§°')?.toString().trim()).filter(Boolean)
                )];
                document.getElementById('stationCount').textContent = stations.length;

                const activeSatellites = this.calculateActiveSatellites();
                document.getElementById('activeSatellites').textContent = activeSatellites;

                document.getElementById('customerCoverage').textContent = Math.min(5, Math.max(1, Math.floor(customers.length / 3)));

                document.getElementById('stationCoverage').textContent = `${Math.min(100, Math.round(stations.length * 5))}%`;

                document.getElementById('cyclesChange').textContent = `+${Math.round(Math.random() * 15)}%`;
            }

            // è®¡ç®—æ´»è·ƒå«æ˜Ÿæ•°é‡ï¼ˆæœ‰è¶…è¿‡5æ¬¡ä»»åŠ¡çš„å«æ˜Ÿï¼‰
            calculateActiveSatellites() {
                const satelliteCounts = {};
                this.filteredData.forEach(item => {
                    const satellite = getFieldValue(item, 'å«æ˜Ÿåç§°')?.toString().trim();
                    if (satellite) {
                        satelliteCounts[satellite] = (satelliteCounts[satellite] || 0) + 1;
                    }
                });
                return Object.values(satelliteCounts).filter(count => count > 5).length;
            }

            // ç”Ÿæˆæ‰€æœ‰å›¾è¡¨
            generateAllCharts() {
                if (!this.filteredData || !this.filteredData.length) {
                    this.clearAllCharts();
                    return;
                }

                this.generateCustomerPieChart();
                this.generateCustomerBarChart();
                this.generateStationBarChart();
                this.updateCustomerSatelliteChart();
                this.updateCustomerStationPreferenceCharts();
            }

            // ç”Ÿæˆå®¢æˆ·åœˆæ¬¡å æ¯”é¥¼å›¾
            generateCustomerPieChart() {
                const customerCounts = {};
                this.filteredData.forEach(item => {
                    const customer = getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim();
                    if (customer) customerCounts[customer] = (customerCounts[customer] || 0) + 1;
                });
                const labels = Object.keys(customerCounts);
                const data = Object.values(customerCounts);

                console.log('ğŸ¥§ é¥¼å›¾æ•°æ®:', { labels, data, counts: customerCounts });
                const result = this.chartGenerator.generatePieChart('customerPieChart', 'å„å®¢æˆ·è·Ÿè¸ªåœˆæ¬¡å æ¯”', labels, data);
                console.log('ğŸ¥§ é¥¼å›¾ç”Ÿæˆç»“æœ:', result ? 'æˆåŠŸ' : 'å¤±è´¥');
            }

            // ç”Ÿæˆå®¢æˆ·åœˆæ¬¡æ•°é‡æ¡å½¢å›¾
            generateCustomerBarChart() {
                const customerCounts = {};
                this.filteredData.forEach(item => {
                    const customer = getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim();
                    if (customer) customerCounts[customer] = (customerCounts[customer] || 0) + 1;
                });

                const sortedCustomers = Object.keys(customerCounts).sort((a, b) => customerCounts[b] - customerCounts[a]);
                const labels = sortedCustomers;
                const datasets = [{
                    label: 'è·Ÿè¸ªåœˆæ¬¡æ•°é‡',
                    data: sortedCustomers.map(customer => customerCounts[customer])
                }];

                console.log('ğŸ“Š å®¢æˆ·æ¡å½¢å›¾æ•°æ®:', { labels, datasets, counts: customerCounts });
                const result = this.chartGenerator.generateBarChart('customerBarChart', 'å„å®¢æˆ·è·Ÿè¸ªåœˆæ¬¡æ•°é‡', labels, datasets);
                console.log('ğŸ“Š å®¢æˆ·æ¡å½¢å›¾ç”Ÿæˆç»“æœ:', result ? 'æˆåŠŸ' : 'å¤±è´¥');
            }

            // ç”Ÿæˆæµ‹ç«™åœˆæ¬¡æ•°é‡æ¡å½¢å›¾
            generateStationBarChart() {
                const stationCounts = {};
                this.filteredData.forEach(item => {
                    const station = getFieldValue(item, 'æµ‹ç«™åç§°')?.toString().trim();
                    if (station) stationCounts[station] = (stationCounts[station] || 0) + 1;
                });

                const sortedStations = Object.keys(stationCounts).sort((a, b) => stationCounts[b] - stationCounts[a]);
                const labels = sortedStations;
                const datasets = [{
                    label: 'è·Ÿè¸ªåœˆæ¬¡æ•°é‡',
                    data: sortedStations.map(station => stationCounts[station])
                }];

                console.log('ğŸ“Š æµ‹ç«™æ¡å½¢å›¾æ•°æ®:', { labels, datasets, counts: stationCounts });
                const result = this.chartGenerator.generateBarChart('stationBarChart', 'å„æµ‹ç«™è·Ÿè¸ªåœˆæ¬¡æ•°é‡', labels, datasets);
                console.log('ğŸ“Š æµ‹ç«™æ¡å½¢å›¾ç”Ÿæˆç»“æœ:', result ? 'æˆåŠŸ' : 'å¤±è´¥');
            }

            // æ›´æ–°å®¢æˆ·-å«æ˜Ÿåˆ†å¸ƒæ¡å½¢å›¾
            updateCustomerSatelliteChart() {
                if (!this.selectedCustomers.length) {
                    const emptyEl = document.getElementById('customerSatelliteChartEmpty');
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    // destroy old chart to avoid stale downloads
                    this.chartGenerator.destroyChart('customerSatelliteBarChart');
                    return;
                }

                const emptyEl = document.getElementById('customerSatelliteChartEmpty');
                if (emptyEl) emptyEl.classList.add('hidden');

                const customerData = this.filteredData.filter(item =>
                    this.selectedCustomers.includes(getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim())
                );

                const customerSatelliteCounts = {};
                const satellites = new Set();

                customerData.forEach(item => {
                    const customer = getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim();
                    const satellite = getFieldValue(item, 'å«æ˜Ÿåç§°')?.toString().trim();

                    if (customer && satellite) {
                        if (!customerSatelliteCounts[customer]) customerSatelliteCounts[customer] = {};
                        customerSatelliteCounts[customer][satellite] = (customerSatelliteCounts[customer][satellite] || 0) + 1;
                        satellites.add(satellite);
                    }
                });

                const sortedSatellites = Array.from(satellites).sort();
                const datasets = this.selectedCustomers.map((customer, i) => ({
                    label: customer,
                    data: sortedSatellites.map(satellite => customerSatelliteCounts[customer]?.[satellite] || 0)
                }));

                this.chartGenerator.generateBarChart('customerSatelliteBarChart', 'å®¢æˆ·æ‰€å±å«æ˜Ÿè·Ÿè¸ªåœˆæ¬¡', sortedSatellites, datasets);
            }

            // æ›´æ–°å®¢æˆ·-æµ‹ç«™åå¥½é¥¼å›¾
            updateCustomerStationPreferenceCharts() {
                const container = document.getElementById('stationPreferenceCharts');

                if (!this.selectedCustomers.length) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg p-6 card-shadow flex items-center justify-center h-80">
                            <div class="text-center text-gray-500">
                                <i class="fa fa-pie-chart text-4xl mb-2"></i>
                                <p>è¯·é€‰æ‹©å®¢æˆ·æŸ¥çœ‹æµ‹ç«™åå¥½</p>
                            </div>
                        </div>
                    `;
                    // destroy previously created stationPreference charts
                    Object.keys(this.chartGenerator.charts).forEach(id => {
                        if (id && id.startsWith('stationPreferenceChart-')) this.chartGenerator.destroyChart(id);
                    });
                    return;
                }

                container.innerHTML = '';

                this.selectedCustomers.forEach((customer, index) => {
                    const customerData = this.filteredData.filter(item =>
                        getFieldValue(item, 'å®¢æˆ·åç§°')?.toString().trim() === customer
                    );

                    const stationCounts = {};
                    customerData.forEach(item => {
                        const station = getFieldValue(item, 'æµ‹ç«™åç§°')?.toString().trim();
                        if (station) stationCounts[station] = (stationCounts[station] || 0) + 1;
                    });

                    const chartId = `stationPreferenceChart-${index}`;

                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'bg-white rounded-lg p-6 card-shadow';
                    chartContainer.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-base font-medium">${customer} çš„æµ‹ç«™åå¥½</h4>
                            <div class="chart-actions">
                                <button class="chart-download-btn" data-chart="${chartId}" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                                    <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                                </button>
                                <button class="chart-download-btn" data-chart="${chartId}" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                                    <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                                </button>
                            </div>
                        </div>
                        <div class="chart-container h-full">
                            <canvas id="${chartId}"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="${chartId}Empty">
                                <div class="text-center">
                                    <i class="fa fa-pie-chart text-4xl mb-2"></i>
                                    <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(chartContainer);

                    const labels = Object.keys(stationCounts);
                    const data = Object.values(stationCounts);

                    this.chartGenerator.generatePieChart(chartId, `${customer} çš„æµ‹ç«™åå¥½`, labels, data);
                });
            }

            // æ¸…ç©ºæ‰€æœ‰å›¾è¡¨
            clearAllCharts() {
                this.chartGenerator.destroyAllCharts();

                const cp = document.getElementById('customerPieChartEmpty');
                const cb = document.getElementById('customerBarChartEmpty');
                const sb = document.getElementById('stationBarChartEmpty');
                const cs = document.getElementById('customerSatelliteChartEmpty');
                if (cp) cp.classList.remove('hidden');
                if (cb) cb.classList.remove('hidden');
                if (sb) sb.classList.remove('hidden');
                if (cs) cs.classList.remove('hidden');

                document.getElementById('totalCycles').textContent = '0';
                document.getElementById('satelliteCount').textContent = '0';
                document.getElementById('customerCount').textContent = '0';
                document.getElementById('stationCount').textContent = '0';
                document.getElementById('activeSatellites').textContent = '0';
                document.getElementById('customerCoverage').textContent = '0';
                document.getElementById('stationCoverage').textContent = '0%';
                document.getElementById('cyclesChange').textContent = '0%';
            }

            // æ·»åŠ è°ƒè¯•æŒ‰é’®
            addDebugButtons() {
                const debugBtn = document.createElement('button');
                debugBtn.className = 'fixed top-4 right-4 z-10 px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm';
                debugBtn.textContent = 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
                debugBtn.addEventListener('click', () => {
                    alert(`
æ•°æ®æ€»é‡: ${this.data?.length || 0}
ç­›é€‰åæ•°æ®é‡: ${this.filteredData?.length || 0}
å®¢æˆ·æ•°é‡: ${this.allCustomers?.length || 0}
é€‰ä¸­å®¢æˆ·: ${this.selectedCustomers.join(', ') || 'æ— '}
                    `.trim());
                });

                document.body.appendChild(debugBtn);
            }

            // ç»‘å®šä¸‹è½½æŒ‰é’®ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
            bindDownloadButtons() {
                document.addEventListener('click', (e) => {
                    const btn = e.target.closest && e.target.closest('.chart-download-btn');
                    if (!btn) return;

                    e.stopPropagation();

                    const chartId = btn.getAttribute('data-chart');
                    const type = btn.getAttribute('data-type');

                    // find chart instance
                    const chart = this.chartGenerator.charts[chartId];
                    if (!chart) {
                        alert('å½“å‰å›¾è¡¨æ— æ•°æ®æˆ–å°šæœªç”Ÿæˆï¼Œè¯·å…ˆåº”ç”¨ç­›é€‰å¹¶ç¡®ä¿å›¾è¡¨å·²æ˜¾ç¤ºå†ä¸‹è½½ã€‚');
                        return;
                    }

                    if (type === 'image') {
                        try {
                            const imgUrl = chart.toBase64Image();
                            const a = document.createElement('a');
                            a.href = imgUrl;
                            const now = new Date();
                            const ts = now.toISOString().replace(/[:.]/g, '-');
                            a.download = `${chartId}-${ts}.png`;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => document.body.removeChild(a), 300);
                        } catch (err) {
                            console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥', err);
                            alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ”¯æŒæˆ–æ•°æ®é‡æ˜¯å¦è¿‡å¤§ã€‚');
                        }
                    } else if (type === 'csv') {
                        try {
                            // For single-dataset charts (pie) we can use simpleChartToCSV for clearer output,
                            // otherwise use the general chartToCSV
                            const isPieOrSingle = chart.config && chart.config.type === 'pie';
                            const csv = isPieOrSingle ? simpleChartToCSV(chart) : chartToCSV(chart);
                            const now = new Date();
                            const ts = now.toISOString().replace(/[:.]/g, '-');
                            downloadFile(`${chartId}-${ts}.csv`, csv, 'text/csv;charset=utf-8;');
                        } catch (err) {
                            console.error('å¯¼å‡º CSV å¤±è´¥', err);
                            alert('å¯¼å‡º CSV å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚');
                        }
                    }
                });
            }

            // å¯åŠ¨ç¼“å­˜ç›‘å¬
            startCacheMonitoring() {
                console.log('ğŸ” å¯åŠ¨IndexedDBç¼“å­˜ç›‘å¬...');
                
                // è·å–åˆå§‹ç¼“å­˜çŠ¶æ€
                this.getCacheLastUpdated().then(time => {
                    this.lastCacheCheckTime = time;
                    console.log('ğŸ“‹ åˆå§‹ç¼“å­˜æ—¶é—´:', time ? new Date(time).toLocaleString() : 'æœªçŸ¥');
                });

                // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ç¼“å­˜æ˜¯å¦æœ‰æ›´æ–°
                this.cacheMonitoringInterval = setInterval(async () => {
                    const currentTime = await this.getCacheLastUpdated();
                    
                    if (currentTime && this.lastCacheCheckTime && currentTime > this.lastCacheCheckTime) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°ç¼“å­˜æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°æ•°æ®...');
                        console.log('ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´:', new Date(this.lastCacheCheckTime).toLocaleString());
                        console.log('å½“å‰ç¼“å­˜æ—¶é—´:', new Date(currentTime).toLocaleString());
                        
                        this.lastCacheCheckTime = currentTime;
                        await this.reloadData();
                    }
                }, 3000);
            }

            // é‡æ–°åŠ è½½æ•°æ®
            async reloadData() {
                try {
                    await this.loadData();
                    console.log('âœ… ç¼“å­˜ç›‘å¬ï¼šæ•°æ®é‡æ–°åŠ è½½å®Œæˆ');
                } catch (error) {
                    console.error('âŒ ç¼“å­˜ç›‘å¬ï¼šé‡æ–°åŠ è½½æ•°æ®å¤±è´¥:', error);
                }
            }

            // è·å–ç¼“å­˜æœ€åæ›´æ–°æ—¶é—´
            async getCacheLastUpdated() {
                try {
                    await this.cacheManager.init();
                    return new Promise((resolve) => {
                        const transaction = this.cacheManager.db.transaction([this.cacheManager.metaStoreName], 'readonly');
                        const store = transaction.objectStore(this.cacheManager.metaStoreName);
                        const request = store.get('allDataMeta');

                        request.onsuccess = () => {
                            const result = request.result;
                            resolve(result ? result.lastUpdated : null);
                        };

                        request.onerror = () => {
                            console.warn('è·å–ç¼“å­˜æ—¶é—´å¤±è´¥:', request.error);
                            resolve(null);
                        };
                    });
                } catch (error) {
                    console.warn('è·å–ç¼“å­˜æ—¶é—´å¤±è´¥:', error);
                    return null;
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.dataDistributionApp = new DataDistributionApp();
        });
    </script>
</body>
</html>
