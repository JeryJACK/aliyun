class WebSocketSyncManager{constructor(e){this.cacheManager=e,this.ws=null,this.wsUrl=this.getWebSocketUrl(),this.reconnectInterval=5e3,this.reconnectTimer=null,this.isConnected=!1,this.isReconnecting=!1,this.heartbeatInterval=null,this.missedHeartbeats=0,this.maxMissedHeartbeats=3,this.onSyncUpdate=null,this.onConnectionChange=null,this.initVisibilityListener()}initVisibilityListener(){document.addEventListener("visibilitychange",()=>{document.hidden?(this.savePageLeaveTime(),console.log("ğŸ‘‹ é¡µé¢éšè—ï¼Œä¿å­˜ç¦»å¼€æ—¶é—´æˆ³")):(console.log("ğŸ‘€ é¡µé¢å¯è§ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥åŒæ­¥"),this.checkAndPerformCatchup())}),window.addEventListener("beforeunload",()=>{this.savePageLeaveTime()}),window.addEventListener("pagehide",()=>{this.savePageLeaveTime()})}savePageLeaveTime(){try{const e=Date.now();localStorage.setItem("satellitePageLeaveTime",e.toString()),console.log(`ğŸ’¾ ä¿å­˜é¡µé¢ç¦»å¼€æ—¶é—´: ${new Date(e).toLocaleString()}`)}catch(e){console.error("âŒ ä¿å­˜é¡µé¢ç¦»å¼€æ—¶é—´å¤±è´¥:",e)}}async checkAndPerformCatchup(){try{const e=localStorage.getItem("satellitePageLeaveTime");if(!e)return console.log("â„¹ï¸ æ— é¡µé¢ç¦»å¼€æ—¶é—´è®°å½•"),{hasNewData:!1,count:0};const t=parseInt(e),a=Date.now()-t;if(a>3e4){console.log(`ğŸ”„ é¡µé¢ç¦»å¼€ ${Math.round(a/1e3)} ç§’ï¼Œè§¦å‘è¡¥åŒæ­¥`);return await this.performCatchupSync()||{hasNewData:!1,count:0}}return console.log(`â„¹ï¸ é¡µé¢ç¦»å¼€æ—¶é—´çŸ­ (${Math.round(a/1e3)}ç§’)ï¼Œæ— éœ€è¡¥åŒæ­¥`),{hasNewData:!1,count:0}}catch(e){return console.error("âŒ æ£€æŸ¥è¡¥åŒæ­¥å¤±è´¥:",e),{hasNewData:!1,count:0}}}getWebSocketUrl(){return CONFIG.isDevelopment?"ws://localhost:3000/ws":"function"==typeof window.getWebSocketUrl?window.getWebSocketUrl():CONFIG.isGitHubPages&&CONFIG.API_ENDPOINTS.websocket?CONFIG.API_ENDPOINTS.websocket:null}connect(){if(this.wsUrl)if(!this.ws||this.ws.readyState!==WebSocket.CONNECTING&&this.ws.readyState!==WebSocket.OPEN)try{console.log(`ğŸ”— æ­£åœ¨è¿æ¥ WebSocket: ${this.wsUrl}`),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>this.handleOpen(),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onclose=e=>this.handleClose(e),this.ws.onerror=e=>this.handleError(e)}catch(e){console.error("âŒ WebSocket è¿æ¥å¤±è´¥:",e),this.scheduleReconnect()}else console.log("ğŸ”— WebSocket å·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥");else console.warn("âš ï¸ WebSocket URL æœªé…ç½®ï¼Œè·³è¿‡å®æ—¶åŒæ­¥")}async handleOpen(){console.log("âœ… WebSocket è¿æ¥æˆåŠŸ"),this.isConnected=!0,this.isReconnecting=!1,this.missedHeartbeats=0,this.onConnectionChange&&this.onConnectionChange(!0),this.startHeartbeat(),await this.checkAndPerformCatchup()}async handleMessage(e){try{const t=JSON.parse(e.data);switch(console.log("ğŸ“¨ æ”¶åˆ° WebSocket æ¶ˆæ¯:",t),t.type){case"welcome":console.log("ğŸ’¡ WebSocket è¿æ¥æˆåŠŸï¼Œåç»­æ•°æ®æ›´æ–°å°†é€šè¿‡å®æ—¶æ¨é€è·å–");break;case"heartbeat":this.missedHeartbeats=0;break;case"data_change":await this.handleDataChange(t.data);break;case"batch_update":await this.handleBatchUpdate(t.data);break;default:console.warn("âš ï¸ æœªçŸ¥æ¶ˆæ¯ç±»å‹:",t.type)}}catch(e){console.error("âŒ å¤„ç† WebSocket æ¶ˆæ¯å¤±è´¥:",e)}}async handleDataChange(e){const{operation:t,record:a}=e;try{const e=t.toLowerCase();switch(e){case"insert":case"update":await this.cacheManager.updateRecord(a),console.log(`ğŸ”„ å®æ—¶åŒæ­¥ï¼š${"insert"===e?"æ–°å¢":"æ›´æ–°"} è®°å½• ID: ${a.id}`);break;case"delete":await this.cacheManager.deleteRecord(a.id),console.log(`ğŸ”„ å®æ—¶åŒæ­¥ï¼šåˆ é™¤è®°å½• ID: ${a.id}`);break;default:console.warn("âš ï¸ æœªçŸ¥æ“ä½œç±»å‹:",t)}this.onSyncUpdate&&this.onSyncUpdate({operation:e,record:a})}catch(e){console.error("âŒ å¤„ç†æ•°æ®å˜æ›´å¤±è´¥:",e)}}async handleBatchUpdate(e){const{records:t}=e;try{const e=await this.cacheManager.batchUpdateRecords(t);console.log(`ğŸ”„ æ‰¹é‡å®æ—¶åŒæ­¥ï¼šæ›´æ–° ${e} æ¡è®°å½•`),this.onSyncUpdate&&this.onSyncUpdate({operation:"batch_update",count:e})}catch(e){console.error("âŒ æ‰¹é‡æ›´æ–°å¤±è´¥:",e)}}handleClose(e){console.log(`ğŸ”Œ WebSocket è¿æ¥å…³é—­ (code: ${e.code}, reason: ${e.reason})`),this.isConnected=!1,this.stopHeartbeat(),this.onConnectionChange&&this.onConnectionChange(!1),e.wasClean||this.isReconnecting||this.scheduleReconnect()}handleError(e){console.error("âŒ WebSocket é”™è¯¯:",e)}scheduleReconnect(){this.isReconnecting||(this.isReconnecting=!0,console.log(`ğŸ”„ å°†åœ¨ ${this.reconnectInterval/1e3} ç§’åé‡è¿...`),this.reconnectTimer=setTimeout(()=>{console.log("ğŸ”„ å°è¯•é‡æ–°è¿æ¥ WebSocket..."),this.connect()},this.reconnectInterval))}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){if(this.missedHeartbeats++,this.missedHeartbeats>=this.maxMissedHeartbeats)return console.warn("âš ï¸ å¿ƒè·³è¶…æ—¶ï¼Œå…³é—­è¿æ¥å¹¶é‡è¿"),void this.ws.close();this.send({type:"heartbeat",timestamp:Date.now()})}},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}async performCatchupSync(){try{const e=await this.cacheManager.getLastSyncTime();console.log(`ğŸ”„ å¼€å§‹æ–­çº¿è¡¥åŒæ­¥ï¼Œæœ€ååŒæ­¥æ—¶é—´: ${new Date(e).toLocaleString()}`);const t=CONFIG.isGitHubPages?CONFIG.API_ENDPOINTS.catchup||`${CONFIG.API_ENDPOINTS.records}/changes`:`${CONFIG.API_BASE_URL}/satellite/changes`,a=await fetch(`${t}?since=${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!a.ok)return console.warn(`âš ï¸ è¡¥åŒæ­¥è¯·æ±‚å¤±è´¥ (${a.status}): ${a.statusText}`),console.warn("ğŸ’¡ æç¤ºï¼šè¡¥åŒæ­¥åŠŸèƒ½å¯é€‰ï¼Œä¸å½±å“é¡µé¢æ­£å¸¸ä½¿ç”¨"),{hasNewData:!1,count:0};const s=await a.json();if(s.success&&s.data&&s.data.changes){const e=s.data.changes;return e.length>0?(console.log(`ğŸ“¦ æ”¶åˆ° ${e.length} æ¡è¡¥åŒæ­¥å˜æ›´`),await this.cacheManager.batchUpdateRecords(e),{hasNewData:!0,count:e.length}):(console.log("âœ… æ— éœ€è¡¥åŒæ­¥ï¼Œæ•°æ®å·²æ˜¯æœ€æ–°"),{hasNewData:!1,count:0})}return{hasNewData:!1,count:0}}catch(e){return console.error("âŒ æ–­çº¿è¡¥åŒæ­¥å¤±è´¥:",e),{hasNewData:!1,count:0}}}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn("âš ï¸ WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯")}disconnect(){console.log("ğŸ”Œ ä¸»åŠ¨æ–­å¼€ WebSocket è¿æ¥"),this.isReconnecting=!1,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.stopHeartbeat(),this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1,this.onConnectionChange&&this.onConnectionChange(!1)}}const cacheManager=new CacheManager,dataPreloader=new DataPreloader,wsSyncManager=new WebSocketSyncManager(cacheManager);async function fetchDataFromAPI(e={}){try{console.log("ğŸ“ ä»æœ¬åœ°ç¼“å­˜è·å–æ•°æ®:",e);const t={};e.start_date&&(t.startDate=e.start_date),e.end_date&&(t.endDate=e.end_date);const a=await cacheManager.queryAllData(t);return{success:!0,data:{records:a,count:a.length}}}catch(e){return console.error("âŒ ä»æœ¬åœ°ç¼“å­˜è·å–æ•°æ®å¤±è´¥:",e),showError("ä»æœ¬åœ°ç¼“å­˜è·å–æ•°æ®å¤±è´¥: "+e.message),{success:!1,data:{records:[],count:0}}}}async function fetchStatsFromAPI(e={}){try{const t=new URLSearchParams(e).toString(),a=getApiUrl("stats"),s=await fetch(`${a}?${t}`,{method:"GET",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const n=await s.json();if(!n.success)throw new Error(n.error||"è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥");return n.data}catch(e){return console.error("è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:",e),showError("è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: "+e.message),null}}