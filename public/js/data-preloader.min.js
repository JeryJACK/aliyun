class DataPreloader{constructor(){this.isPreloading=!1,this.preloadProgress=0}async autoPreloadAllData(t=!1){try{console.log("ğŸš€ é¡µé¢åŠ è½½ï¼šå¼€å§‹æ™ºèƒ½é¢„è½½æ•°æ®..."),this.isPreloading=!0,this.updatePreloadStatus("æ­£åœ¨æ£€æŸ¥æœ¬åœ°ç¼“å­˜...","loading");const e=await cacheManager.checkAllDataCache(),a=e?Date.now()-e.lastUpdated:1/0;if(t)console.log("ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ¨¡å¼ï¼Œè·³è¿‡ç¼“å­˜æ£€æŸ¥...");else if(a<6e4)return console.log(`âœ… ä½¿ç”¨IndexedDBç¼“å­˜ï¼ˆ${Math.round(a/1e3)}ç§’å‰æ›´æ–°ï¼‰`),this.updatePreloadStatus(`âœ… ä»æœ¬åœ°ç¼“å­˜åŠ è½½ ${e.totalCount} æ¡æ•°æ®ï¼ˆç§’é€ŸåŠ è½½ï¼‰`,"success"),this.isPreloading=!1,setTimeout(()=>this.backgroundUpdate(),5e3),{success:!0,totalCount:e.totalCount};console.log("ğŸ“¡ ç¼“å­˜è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¹¶è¡Œåˆ†ç‰‡åŠ è½½å…¨é‡æ•°æ®..."),this.updatePreloadStatus("æ­£åœ¨å¹¶è¡Œè·å–æ•°æ®...","loading");const o=await this.parallelShardedLoad((t,e,a)=>{this.updatePreloadStatus(`æ­£åœ¨åŠ è½½æ•°æ®... ${e.toLocaleString()}/${a.toLocaleString()} (${t}%)`,"loading")});return this.updatePreloadStatus(`âœ… æˆåŠŸåŠ è½½å…¨é‡æ•°æ®ï¼ˆ${o.totalCount.toLocaleString()} æ¡ï¼‰`,"success"),this.isPreloading=!1,console.log("ğŸ¯ å…¨é‡æ•°æ®å·²ç¼“å­˜ï¼Œæ”¯æŒè·¨é¡µé¢å®Œæ•´å…±äº«"),{success:!0,totalCount:o.totalCount}}catch(t){console.error("âŒ æ•°æ®é¢„è½½å¤±è´¥:",t),this.updatePreloadStatus("âŒ æœ€è¿‘æ•°æ®åŠ è½½å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ...","warning");try{const t=await this.fallbackLoadAll();return this.isPreloading=!1,t}catch(t){throw console.error("âŒ é™çº§æ–¹æ¡ˆä¹Ÿå¤±è´¥:",t),this.updatePreloadStatus(`âŒ æ•°æ®é¢„è½½å¤±è´¥: ${t.message}`,"error"),this.isPreloading=!1,t}}}async parallelShardedLoad(t){const e=performance.now();console.log("ğŸš€ å¯åŠ¨æµæ°´çº¿å¹¶è¡ŒåŠ è½½ï¼ˆè¾¹ä¸‹è¾¹å­˜ï¼‰...");try{const a=new Date,o=new Date;o.setFullYear(o.getFullYear()-2);const n=this.generateQuarterlyShards(o,a);console.log(`ğŸ“Š ç”Ÿæˆ ${n.length} ä¸ªå­£åº¦åˆ†ç‰‡ï¼ˆæµæ°´çº¿å¹¶è¡Œï¼‰`);const r=4;let s=0,l=0;await cacheManager.clearAllData();for(let e=0;e<n.length;e+=r){const a=n.slice(e,e+r);console.log(`ğŸ“¥ æµæ°´çº¿æ‰¹æ¬¡ ${Math.floor(e/r)+1}: å¹¶è¡Œä¸‹è½½+å­˜å‚¨ ${a.length} ä¸ªåˆ†ç‰‡`);const o=a.map(async(e,a)=>{try{const a=performance.now(),o=await this.fetchShardData(e),r=performance.now()-a;if(o&&o.length>0){console.log(`  âœ“ ä¸‹è½½ ${e.label}: ${o.length.toLocaleString()} æ¡ (${r.toFixed(0)}ms)`);const a=performance.now();await cacheManager.storeBatch(o,{});const c=performance.now()-a;console.log(`  ğŸ’¾ å­˜å‚¨ ${e.label}: ${o.length.toLocaleString()} æ¡ (${c.toFixed(0)}ms)`),s+=o.length,l++;const i=Math.round(l/n.length*100);return t&&t(i,s,s),o.length}return 0}catch(t){return console.error(`âŒ åˆ†ç‰‡ ${e.label} æµæ°´çº¿å¤±è´¥:`,t),0}});await Promise.all(o),await new Promise(t=>setTimeout(t,0))}console.log("ğŸ“Š ä¿å­˜å…ƒæ•°æ®å’Œç´¢å¼•..."),await cacheManager.saveMetadataAndShardIndex(s,{});const c=performance.now()-e;return console.log(`âœ… æµæ°´çº¿å¹¶è¡ŒåŠ è½½å®Œæˆ: ${s.toLocaleString()} æ¡ (${(c/1e3).toFixed(1)}ç§’, ${(s/(c/1e3)).toFixed(0)} æ¡/ç§’)`),console.log("âš¡ æ€§èƒ½æå‡ï¼šä¸‹è½½å’Œå­˜å‚¨å®Œå…¨å¹¶è¡Œï¼Œæ— ç­‰å¾…æ—¶é—´"),{success:!0,totalCount:s}}catch(t){throw console.error("âŒ æµæ°´çº¿å¹¶è¡ŒåŠ è½½å¤±è´¥:",t),t}}generateQuarterlyShards(t,e){const a=[],o=new Date(t);for(;o<e;){const t=new Date(o),n=new Date(o);n.setMonth(n.getMonth()+3),n>e&&n.setTime(e.getTime()),a.push({start:t.toISOString(),end:n.toISOString(),label:`${t.getFullYear()}Q${Math.floor(t.getMonth()/3)+1}`}),o.setMonth(o.getMonth()+3)}return a}async fetchShardData(t){try{const e=getApiUrl("records")+`?startDate=${t.start}&endDate=${t.end}&no_limit=true`,a=await fetch(e,{method:"GET",headers:{Accept:"application/json","Accept-Encoding":"gzip, deflate, br"}});if(!a.ok)return console.warn(`âš ï¸ åˆ†ç‰‡ ${t.label} è¯·æ±‚å¤±è´¥: ${a.status}`),[];const o=await a.json();return o.success&&o.data.records?(console.log(`âœ“ åˆ†ç‰‡ ${t.label}: ${o.data.records.length.toLocaleString()} æ¡`),o.data.records):[]}catch(e){return console.error(`âŒ åˆ†ç‰‡ ${t.label} åŠ è½½å¤±è´¥:`,e),[]}}async loadHistoricalData(){try{console.log("ğŸ”„ åå°ä»»åŠ¡ï¼šå¼€å§‹åŠ è½½å†å²æ•°æ®...");const t=await cacheManager.getMetadataFast();if(!t||!t.minDate)return void console.log("âš ï¸ æ— æ³•è·å–å…ƒæ•°æ®ï¼Œè·³è¿‡å†å²æ•°æ®åŠ è½½");const e=t.minDate,a=new Date;if(a.setFullYear(a.getFullYear()-2),e<=a)return void console.log("âœ… å†å²æ•°æ®å·²å®Œæ•´ï¼Œæ— éœ€åŠ è½½");console.log(`ğŸ“¡ åŠ è½½å†å²æ•°æ®: ${a.toLocaleDateString()} ~ ${e.toLocaleDateString()}`);const o=getApiUrl("records")+`?startDate=${a.toISOString()}&endDate=${e.toISOString()}&no_limit=true`,n=await fetch(o,{headers:{Accept:"application/json","Accept-Encoding":"gzip, deflate, br"}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(r.success&&r.data.records&&r.data.records.length>0){const t=r.data.records;console.log(`âœ… è·å– ${t.length} æ¡å†å²æ•°æ®`),await cacheManager.appendData(t),console.log("âœ… å†å²æ•°æ®å·²è¿½åŠ åˆ°ç¼“å­˜"),window.sharedDataManager&&window.sharedDataManager.notifyDataUpdate("insert",t)}else console.log("â„¹ï¸ æ— æ›´å¤šå†å²æ•°æ®")}catch(t){console.error("âš ï¸ åå°åŠ è½½å†å²æ•°æ®å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",t)}}async fallbackLoadAll(){console.log("ğŸ”„ ä½¿ç”¨é™çº§æ–¹æ¡ˆï¼šåŠ è½½å…¨é‡æ•°æ®..."),this.updatePreloadStatus("æ­£åœ¨ä»æ•°æ®åº“è·å–å…¨éƒ¨æ•°æ®...","loading");const t=await this.fetchAllDataFromAPI();if(t&&t.length>0){console.log(`ğŸ“¥ æˆåŠŸè·å– ${t.length.toLocaleString()} æ¡æ•°æ®`),this.updatePreloadStatus(`æ­£åœ¨ç¼“å­˜ ${t.length.toLocaleString()} æ¡æ•°æ®...`,"loading");const e=await cacheManager.storeAllDataWithPrecompute(t,(t,e,a)=>{this.updatePreloadStatus(`æ­£åœ¨ç¼“å­˜æ•°æ®... ${e.toLocaleString()}/${a.toLocaleString()} (${t}%)`,"loading")},!0);return this.updatePreloadStatus(`âœ… æˆåŠŸåŠ è½½ ${e.toLocaleString()} æ¡æ•°æ®ï¼ˆé¢„è®¡ç®—åœ¨åå°æ‰§è¡Œï¼‰`,"success"),{success:!0,totalCount:e}}throw new Error("æ— æ³•è·å–æ•°æ®")}async backgroundUpdate(){try{console.log("ğŸ”„ åå°é™é»˜æ›´æ–°ç¼“å­˜...");const t=await this.fetchAllDataFromAPI();t&&t.length>0&&(await cacheManager.storeAllDataWithPrecompute(t,null,!0),console.log(`âœ… åå°ç¼“å­˜æ›´æ–°å®Œæˆï¼Œæ›´æ–°äº† ${t.length} æ¡æ•°æ®ï¼ˆé¢„è®¡ç®—åœ¨åå°æ‰§è¡Œï¼‰`))}catch(t){console.warn("âš ï¸ åå°ç¼“å­˜æ›´æ–°å¤±è´¥:",t)}}async fetchAllDataFromAPI(){try{console.log("ğŸ“¡ å¼€å§‹ä»APIä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®ï¼ˆæ— æ¡æ•°é™åˆ¶ï¼‰...");const t={order_by:"start_time",sort:"ASC",no_limit:!0,fetch_all:!0};console.log("ğŸ” APIè°ƒç”¨å‚æ•°:",t);const e=await this.fetchSinglePageFromAPI(t);return e&&e.length>0?(console.log(`âœ… æˆåŠŸä¸€æ¬¡æ€§è·å– ${e.length} æ¡è®°å½•`),e):(console.log("âš ï¸ æœªè·å–åˆ°ä»»ä½•æ•°æ®"),[])}catch(t){return console.error("âŒ è·å–å…¨æ•°æ®å¤±è´¥:",t),console.log("ğŸ”„ ä¸€æ¬¡æ€§è·å–å¤±è´¥ï¼Œå›é€€åˆ°åˆ†é¡µè·å–æ¨¡å¼..."),await this.fetchAllDataWithPagination()}}async fetchAllDataWithPagination(){try{console.log("ğŸ“¡ ä½¿ç”¨åˆ†é¡µæ¨¡å¼è·å–æ‰€æœ‰æ•°æ®...");let t=[],e=0;const a=1e4;let o=!0,n=1,r=0;const s=5;for(;o;){console.log(`ğŸ“„ [é¡µé¢ ${n}] è·å–æ•°æ® (offset: ${e}, å·²ç´¯è®¡: ${t.length} æ¡)...`);const l={offset:e,limit:a,order_by:"start_time",sort:"ASC"},c=await this.fetchSinglePageFromAPI(l);c&&c.length>0?(t.push(...c),console.log(`âœ… [é¡µé¢ ${n}] è·å– ${c.length} æ¡ï¼Œç´¯è®¡: ${t.length} æ¡`),r=0,e+=a,n++):(r++,r>=s?(o=!1,console.log(`ğŸ æ•°æ®è·å–å®Œæˆï¼Œæ€»è®¡: ${t.length} æ¡è®°å½•`)):(e+=a,n++)),await new Promise(t=>setTimeout(t,10))}return t}catch(t){throw console.error("âŒ åˆ†é¡µè·å–æ•°æ®å¤±è´¥:",t),t}}async fetchSinglePageFromAPI(t){try{const e={};for(const[a,o]of Object.entries(t))null!=o&&""!==o&&(e[a]=o);const a=new URLSearchParams(e).toString(),o=getApiUrl("records"),n=await fetch(`${o}?${a}`,{method:"GET",mode:"cors",credentials:"omit",headers:{Accept:"application/json","Accept-Encoding":"gzip, deflate, br","Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(!r.success)throw new Error(r.error||"è·å–æ•°æ®å¤±è´¥");return r.data.records||[]}catch(t){throw console.error("âŒ å•é¡µAPIè°ƒç”¨å¤±è´¥:",t),t}}updatePreloadStatus(t,e="info"){const a=document.getElementById("dbLoading"),o=document.getElementById("dbLoadingText"),n=document.getElementById("dbLoadingProgressBar");if(a)switch(o&&(o.textContent=t),n&&n.classList.add("hidden"),a.className="mb-6 p-3 rounded-lg",e){case"loading":a.classList.add("bg-primary/10","text-primary"),a.classList.remove("hidden");break;case"success":a.classList.add("bg-success/10","text-success"),setTimeout(()=>a.classList.add("hidden"),3e3);break;case"warning":a.classList.add("bg-warning/10","text-warning");break;case"error":a.classList.add("bg-danger/10","text-danger");break;default:a.classList.add("bg-primary/10","text-primary")}}}