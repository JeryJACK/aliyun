document.addEventListener("DOMContentLoaded",async()=>{try{console.log("🌟 页面加载完成，开始渐进式初始化...");const e=performance.now(),a=document.getElementById("skeleton-progress-percent"),t=document.getElementById("skeleton-progress");a&&(a.textContent="0%"),t&&(t.textContent="正在初始化..."),a&&(a.textContent="5%"),t&&(t.textContent="正在检查本地缓存...");let o={hasNewData:!1,count:0};o.hasNewData&&(console.log(`✅ 补同步已更新 ${o.count} 条数据到IndexedDB`),await cacheManager.clearDataStoreBucketsCache()),await dataPreloader.autoPreloadAllData(),window.app=new SatelliteApp;const n=performance.now()-e;console.log(`✅ 应用初始化完成，耗时 ${n.toFixed(0)}ms`);const c=()=>{console.log("🔌 延迟启动 WebSocket 实时同步..."),wsSyncManager.checkAndPerformCatchup().then(e=>{o=e,o.hasNewData&&(console.log(`✅ 后台补同步完成: ${o.count} 条数据`),cacheManager.clearDataStoreBucketsCache()),wsSyncManager.connect()})};"requestIdleCallback"in window?requestIdleCallback(c,{timeout:2e3}):setTimeout(c,500),wsSyncManager.onSyncUpdate=e=>{const{operation:a,record:t,count:o}=e;if("catchup_sync"===a)return console.log(`✅ WebSocket补同步完成: ${o} 条变更`),void(o>0&&window.app&&(console.log("🔄 增量更新UI..."),showInfo(`已同步 ${o} 条新数据`),cacheManager.clearDataStoreBucketsCache(),window.app.chart&&(window.app.refreshChartIfNeeded(),console.log("📊 图表已增量刷新")),window.app.updateCacheStatus()));console.log(`📡 WebSocket 推送: ${a}`,t?.id||t?.plan_id),window.app&&window.app.data&&window.app.handleRealtimeUpdate(a,t),void 0!==window.sharedDataManager&&window.sharedDataManager.notifyDataUpdate({operation:a,record:t})},void 0!==window.sharedDataManager&&(window.sharedDataManager.onDataUpdate=(e,a)=>{console.log(`📡 收到跨页面广播: ${e}`,a?.id||a?.plan_id),window.app&&window.app.data&&window.app.handleRealtimeUpdate(e,a)},window.sharedDataManager.onDataRequest=async(e,a)=>{if(console.log(`📨 收到来自 ${a} 的数据请求: ${e}`),window.app&&(!window.app.data||0===window.app.data.length)){console.log("⚡ this.data 为空，快速加载数据以响应请求...");try{const a=performance.now(),t=await cacheManager.getAllDataFast();window.app.data=t;const o=performance.now()-a;console.log(`✅ 数据加载完成: ${t.length.toLocaleString()} 条 (${o.toFixed(0)}ms)`),window.sharedDataManager.data=t,window.sharedDataManager.broadcast({type:"data_response",requestId:e,data:t,metadata:window.sharedDataManager.metadata,timestamp:Date.now()}),console.log(`✅ 已响应数据请求 ${e}: ${t.length} 条记录（按需加载）`)}catch(e){console.error("❌ 按需加载数据失败:",e)}}},console.log("✅ SharedDataManager 跨页面同步已配置")),wsSyncManager.onConnectionChange=e=>{const a=e?"已连接":"未连接";console.log(`🔌 WebSocket 状态: ${a}`),function(e){let a=document.getElementById("ws-connection-indicator");a||(a=document.createElement("div"),a.id="ws-connection-indicator",a.style.cssText="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    width: 12px;\n                    height: 12px;\n                    border-radius: 50%;\n                    z-index: 9999;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                    transition: all 0.3s ease;\n                ",a.title="WebSocket 连接状态",document.body.appendChild(a));e?(a.style.backgroundColor="#10b981",a.title="WebSocket 已连接 - 实时同步开启"):(a.style.backgroundColor="#ef4444",a.title="WebSocket 未连接 - 正在重连...")}(e)},console.log("✅ WebSocket 实时同步已配置")}catch(e){console.error("❌ 应用初始化失败:",e),window.app=new SatelliteApp}const e=document.getElementById("instructionsToggle"),a=document.getElementById("instructionsContent"),t=document.getElementById("instructionsIcon");let o=!1,n=null;function c(){o?(a.style.maxHeight="0px",t.classList.remove("fa-chevron-up"),t.classList.add("fa-chevron-down"),t.style.transform="rotate(0deg)"):(a.style.maxHeight=a.scrollHeight+"px",t.classList.remove("fa-chevron-down"),t.classList.add("fa-chevron-up"),t.style.transform="rotate(0deg)"),o=!o}a.style.maxHeight=a.scrollHeight+"px",t.classList.remove("fa-chevron-down"),t.classList.add("fa-chevron-up"),o=!0,e.addEventListener("click",()=>{c(),n&&clearTimeout(n),n=setTimeout(()=>{o&&(c(),console.log("⏱️ 系统说明自动折叠（点击1秒后）"))},1e3)}),window.collapseInstructions=()=>{o&&(c(),console.log("📋 系统说明已折叠（数据加载完成标志）"))}});