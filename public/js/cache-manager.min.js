class CacheManager{constructor(){this.dbName="SatelliteDataCache",this.dbVersion=4,this.allDataStoreName="allDataCache",this.metaStoreName="metaData",this.shardIndexStoreName="shardIndex",this.dataStoreCacheStoreName="dataStoreCache",this.db=null,this.cacheExpiry=1/0}getMonthKey(t){const e=new Date(t);return`${e.getFullYear()}_${String(e.getMonth()+1).padStart(2,"0")}`}getShardStoreName(t){return`monthData_${t}`}getRecentMonthKeys(t=3){const e=[],a=new Date;for(let o=0;o<t;o++){const t=new Date(a.getFullYear(),a.getMonth()-o,1);e.push(this.getMonthKey(t))}return e}groupDataByMonth(t){const e={};for(const a of t){const t=a.start_time||a["ÂºÄÂßãÊó∂Èó¥"];if(!t)continue;const o=this.getMonthKey(t);e[o]||(e[o]=[]),e[o].push(a)}return e}async init(){return new Promise((t,e)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>{console.error("‚ùå IndexedDBÂàùÂßãÂåñÂ§±Ë¥•:",a.error),e(a.error)},a.onsuccess=()=>{this.db=a.result,console.log("‚úÖ IndexedDBÂàùÂßãÂåñÊàêÂäü"),t(this.db)},a.onupgradeneeded=t=>{this.db=t.target.result;const e=t.oldVersion;if(console.log(`üîß ÂçáÁ∫ßIndexedDBÁªìÊûÑ v${e} -> v${this.dbVersion}...`),this.db.objectStoreNames.contains(this.allDataStoreName)){if(e<4){const e=t.target.transaction.objectStore(this.allDataStoreName);e.indexNames.contains("month_key")||(e.createIndex("month_key","month_key",{unique:!1}),console.log("üì¶ Ê∑ªÂä†month_keyÁ¥¢ÂºïÂà∞Áé∞ÊúâÊï∞ÊçÆ"))}}else{const t=this.db.createObjectStore(this.allDataStoreName,{keyPath:"id"});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("start_time","start_time",{unique:!1}),t.createIndex("month_key","month_key",{unique:!1}),console.log("üì¶ ÂàõÂª∫ÂÖ®Êï∞ÊçÆÂ≠òÂÇ®Á©∫Èó¥")}if(!this.db.objectStoreNames.contains(this.metaStoreName)){this.db.createObjectStore(this.metaStoreName,{keyPath:"key"});console.log("üì¶ ÂàõÂª∫ÂÖÉÊï∞ÊçÆÂ≠òÂÇ®Á©∫Èó¥")}if(e<4&&!this.db.objectStoreNames.contains(this.shardIndexStoreName)){this.db.createObjectStore(this.shardIndexStoreName,{keyPath:"monthKey"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("üì¶ ÂàõÂª∫ÂàÜÁâáÁ¥¢ÂºïÂ≠òÂÇ®Á©∫Èó¥")}if(e<4&&!this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)){const t=this.db.createObjectStore(this.dataStoreCacheStoreName,{keyPath:"key"});t.createIndex("groupType","groupType",{unique:!1}),t.createIndex("timestamp","timestamp",{unique:!1}),console.log("üì¶ ÂàõÂª∫DataStoreÁºìÂ≠òÂ≠òÂÇ®Á©∫Èó¥")}}})}async storeAllData(t,e){this.db||await this.init();const a=performance.now();console.log(`üíæ ÂºÄÂßãÊâπÈáèÂ≠òÂÇ® ${t.length.toLocaleString()} Êù°Êï∞ÊçÆ...`);try{await this.clearAllData();const o=this.sortDataByTime(t),r=1e4,n=Math.ceil(o.length/r);let s=0;const i={};for(let t=0;t<n;t++){const a=t*r,c=Math.min(a+r,o.length),l=o.slice(a,c);await this.storeBatch(l,i),s+=l.length;const m=Math.round(s/o.length*100);console.log(`üì¶ ÊâπÊ¨° ${t+1}/${n}: Â∑≤Â≠òÂÇ® ${s.toLocaleString()}/${o.length.toLocaleString()} (${m}%)`),e&&e(m,s,o.length),await new Promise(t=>setTimeout(t,0))}await this.saveMetadataAndShardIndex(o.length,i);const c=performance.now()-a;return console.log(`‚úÖ ÊâπÈáèÂ≠òÂÇ®ÂÆåÊàê: ${s.toLocaleString()} Êù° (${c.toFixed(0)}ms, ${(s/(c/1e3)).toFixed(0)} Êù°/Áßí)`),s}catch(t){throw console.error("‚ùå ÊâπÈáèÂ≠òÂÇ®Â§±Ë¥•:",t),t}}async storeBatch(t,e){return new Promise((a,o)=>{const r=this.db.transaction([this.allDataStoreName],"readwrite"),n=r.objectStore(this.allDataStoreName);for(const a of t){const t={id:a.plan_id||a["ËÆ°ÂàíID"]||a.id||`record_${Date.now()}_${Math.random()}`,start_time:a.start_time||a["ÂºÄÂßãÊó∂Èó¥"],task_result:a.task_result||a["‰ªªÂä°ÁªìÊûúÁä∂ÊÄÅ"],task_type:a.task_type||a["‰ªªÂä°Á±ªÂûã"],customer:a.customer||a["ÊâÄÂ±ûÂÆ¢Êà∑"],satellite_name:a.satellite_name||a["Âç´ÊòüÂêçÁß∞"],station_name:a.station_name||a["ÊµãÁ´ôÂêçÁß∞"],station_id:a.station_id||a["ÊµãÁ´ôID"],...a};t.start_time&&(t.timestamp=this.parseTimeToTimestamp(t.start_time),t.month_key=this.getMonthKey(t.start_time),e[t.month_key]||(e[t.month_key]=0),e[t.month_key]++),n.put(t)}r.oncomplete=()=>a(),r.onerror=()=>o(r.error)})}async clearAllData(){return new Promise((t,e)=>{const a=[this.allDataStoreName];this.db.objectStoreNames.contains(this.shardIndexStoreName)&&a.push(this.shardIndexStoreName);const o=this.db.transaction(a,"readwrite");o.objectStore(this.allDataStoreName).clear(),a.includes(this.shardIndexStoreName)&&o.objectStore(this.shardIndexStoreName).clear(),o.oncomplete=()=>{console.log("üßπ Â∑≤Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ"),t()},o.onerror=()=>e(o.error)})}async getTimeRangeQuick(){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction([this.allDataStoreName],"readonly"),o=a.objectStore(this.allDataStoreName).index("start_time"),r={};o.openCursor(null,"next").onsuccess=t=>{const e=t.target.result;e&&(r.minDate=new Date(e.value.timestamp))};o.openCursor(null,"prev").onsuccess=t=>{const e=t.target.result;e&&(r.maxDate=new Date(e.value.timestamp))},a.oncomplete=()=>t(r),a.onerror=()=>e(a.error)})}async saveMetadataAndShardIndex(t,e,a=null,o=null){return new Promise(async(r,n)=>{if(!a||!o)try{const t=await this.getTimeRangeQuick();a=t.minDate,o=t.maxDate}catch(t){console.warn("‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÊó∂Èó¥ËåÉÂõ¥:",t)}const s=[this.metaStoreName];this.db.objectStoreNames.contains(this.shardIndexStoreName)&&s.push(this.shardIndexStoreName);const i=this.db.transaction(s,"readwrite");if(i.objectStore(this.metaStoreName).put({key:"allDataMeta",totalCount:t,lastUpdated:Date.now(),dataVersion:1,sortedByTime:!0,minDate:a,maxDate:o,minTimestamp:a?a.getTime():null,maxTimestamp:o?o.getTime():null}),s.includes(this.shardIndexStoreName)){const t=i.objectStore(this.shardIndexStoreName);for(const[a,o]of Object.entries(e))t.put({monthKey:a,count:o,timestamp:Date.now()});console.log(`üìä Â∑≤ÂàõÂª∫ ${Object.keys(e).length} ‰∏™Êúà‰ªΩÂàÜÁâáÁ¥¢Âºï`)}i.oncomplete=()=>r(),i.onerror=()=>n(i.error)})}sortDataByTime(t){return t&&Array.isArray(t)?t.sort((t,e)=>{const a=t.start_time||t["ÂºÄÂßãÊó∂Èó¥"]||t.timestamp,o=e.start_time||e["ÂºÄÂßãÊó∂Èó¥"]||e.timestamp;if(!a||!o)return 0;return this.parseTimeToTimestamp(a)-this.parseTimeToTimestamp(o)}):[]}parseTimeToTimestamp(t){if("number"==typeof t)return t>1e12?t:1e3*t;if("string"==typeof t){const e=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim(),a=this.parseLocalTime(e);return isNaN(a.getTime())?0:a.getTime()}return t instanceof Date?t.getTime():0}parseLocalDateToTimestamp(t,e=0,a=0,o=0,r=0){if(!t)return 0;try{const n=t.split("-");if(3===n.length){const t=parseInt(n[0]),s=parseInt(n[1])-1,i=parseInt(n[2]);return new Date(t,s,i,e,a,o,r).getTime()}}catch(e){console.warn("Ëß£ÊûêÊó•ÊúüÂ§±Ë¥•:",t,e)}return 0}parseLocalTime(t){if(!t)return new Date(NaN);try{const e=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);if(e){const[,a,o,r,n=0,s=0,i=0]=e,c=new Date(parseInt(a),parseInt(o)-1,parseInt(r),parseInt(n),parseInt(s),parseInt(i));return console.log(`üîß CacheManagerËß£Êûê: ${t} -> ${c.toLocaleString()}`),c}const a=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/);if(a){const[,e,o,r,n,s,i]=a,c=new Date(parseInt(e),parseInt(o)-1,parseInt(r),parseInt(n),parseInt(s),parseInt(i));return console.log(`üîß CacheManagerËß£ÊûêISO: ${t} -> ${c.toLocaleString()}`),c}console.warn("CacheManagerÊó∂Èó¥Ëß£Êûê‰ΩøÁî®ÈªòËÆ§0ÁÇπÊó∂Èó¥:",t);const o=t.split(" ")[0].split("-").map(Number);if(o.length>=3){const e=new Date(o[0],o[1]-1,o[2],0,0,0);return console.log(`üîß CacheManagerÂõûÈÄÄËß£Êûê: ${t} -> ${e.toLocaleString()}`),e}return new Date(NaN)}catch(e){return console.error("CacheManagerÊó∂Èó¥Ëß£ÊûêÈîôËØØ:",t,e),new Date(NaN)}}async queryAllData(t={}){return this.db||await this.init(),new Promise(e=>{const a=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).getAll();a.onsuccess=()=>{let o=a.result||[];if(t.startDate||t.endDate){let e,a;t.startDate&&(e=this.parseLocalDateToTimestamp(t.startDate,0,0,0),console.log(`üîç Á≠õÈÄâÂºÄÂßãÊó∂Èó¥: ${t.startDate} -> ${new Date(e).toLocaleString()}`)),t.endDate&&(a=this.parseLocalDateToTimestamp(t.endDate,23,59,59,999),console.log(`üîç Á≠õÈÄâÁªìÊùüÊó∂Èó¥: ${t.endDate} -> ${new Date(a).toLocaleString()}`));const r=o.length;o=o.filter(o=>{const r=o.timestamp||this.parseTimeToTimestamp(o.start_time);return!(t.startDate&&r<e)&&!(t.endDate&&r>a)}),console.log(`üîç Êó∂Èó¥Á≠õÈÄâ: ${r} -> ${o.length} Êù°Êï∞ÊçÆ`)}console.log(`üîç ‰ªéÊú¨Âú∞ÁºìÂ≠òÊü•ËØ¢Âà∞ ${o.length} Êù°Êï∞ÊçÆ`),e(o)},a.onerror=()=>{console.error("‚ùå Êü•ËØ¢Êú¨Âú∞ÁºìÂ≠òÂ§±Ë¥•:",a.error),e([])}})}async getMetadataFast(){this.db||await this.init();const t=performance.now();return new Promise(e=>{const a=this.db.transaction([this.metaStoreName],"readonly"),o=a.objectStore(this.metaStoreName),r={},n=o.get("allDataMeta");n.onsuccess=()=>{const t=n.result;t&&(r.totalCount=t.totalCount,r.actualCount=t.totalCount,r.lastUpdated=t.lastUpdated,r.lastSyncTime=t.lastSyncTime,r.minDate=t.minDate,r.maxDate=t.maxDate,r.minTimestamp=t.minTimestamp,r.maxTimestamp=t.maxTimestamp)},a.oncomplete=()=>{const a=performance.now()-t;console.log(`‚ö° ÂÖÉÊï∞ÊçÆÂø´ÈÄüÊü•ËØ¢ÂÆåÊàê (${a.toFixed(1)}ms):`,{"ÊÄªÊï∞":r.actualCount,"Êó∂Èó¥ËåÉÂõ¥":`${r.minDate?.toLocaleDateString()} - ${r.maxDate?.toLocaleDateString()}`}),e(r)},a.onerror=()=>{console.error("‚ùå ÂÖÉÊï∞ÊçÆÊü•ËØ¢Â§±Ë¥•"),e(null)}})}async queryRecentMonthsFromShards(t=3,e,a=5e3){this.db||await this.init();const o=performance.now(),r=this.getRecentMonthKeys(t);return console.log(`üîç Êü•ËØ¢ÊúÄËøë${t}‰∏™ÊúàÂàÜÁâáÊï∞ÊçÆ: ${r.join(", ")}`),new Promise(async(n,s)=>{try{const s=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName);if(!s.indexNames.contains("month_key"))return console.warn("‚ö†Ô∏è month_keyÁ¥¢Âºï‰∏çÂ≠òÂú®ÔºåÈôçÁ∫ßÂà∞start_timeÊü•ËØ¢"),this.queryRecentData(t,e,a);const i=s.index("month_key"),c=[],l=r.map(t=>new Promise((e,a)=>{const o=IDBKeyRange.only(t),r=i.getAll(o);r.onsuccess=a=>{const o=a.target.result;console.log(`  ‚úì ${t}: ${o.length} Êù°`),e(o)},r.onerror=()=>{console.error(`  ‚úó ${t}: Êü•ËØ¢Â§±Ë¥•`),e([])}})),m=await Promise.all(l);for(const t of m)c.push(...t);const h=c.length;if(c.sort((t,e)=>(t.timestamp||0)-(e.timestamp||0)),e)for(let t=0;t<c.length;t+=a){const o=c.slice(t,t+a);e(o,Math.min(t+a,h))}const d=performance.now()-o;console.log(`‚úÖ ÂàÜÁâáÊü•ËØ¢ÂÆåÊàê: ${h.toLocaleString()} Êù° (${d.toFixed(0)}ms, ${(h/(d/1e3)).toFixed(0)} Êù°/Áßí)`),n(h)}catch(t){console.error("‚ùå ÂàÜÁâáÊü•ËØ¢Â§±Ë¥•:",t),s(t)}})}async queryDateRangeFromShards(t,e,a,o=5e3){this.db||await this.init();const r=performance.now(),n=[],s=new Date(t);s.setDate(1);const i=new Date(e);for(i.setDate(1);s<=i;){const t=this.getMonthKey(s);n.push(t),s.setMonth(s.getMonth()+1)}return console.log(`üîç Êü•ËØ¢Êó•ÊúüËåÉÂõ¥ ${t.toLocaleDateString()} - ${e.toLocaleDateString()}`),console.log(`   ÈúÄË¶ÅÊü•ËØ¢ÁöÑÊúà‰ªΩ: ${n.join(", ")}`),new Promise(async(s,i)=>{try{const c=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName);if(!c.indexNames.contains("month_key")){console.warn("‚ö†Ô∏è month_keyÁ¥¢Âºï‰∏çÂ≠òÂú®ÔºåÈôçÁ∫ßÂà∞start_timeÊü•ËØ¢");const r=c.index("start_time"),n=IDBKeyRange.bound(t,e),l=r.getAll(n);return l.onsuccess=t=>{const e=t.target.result;if(a)for(let t=0;t<e.length;t+=o){const r=e.slice(t,t+o);a(r,Math.min(t+o,e.length))}s(e.length)},void(l.onerror=()=>i(l.error))}const l=c.index("month_key");let m=0;for(const r of n.reverse()){const n=IDBKeyRange.only(r),s=await new Promise((a,o)=>{const s=l.getAll(n);s.onsuccess=o=>{const n=o.target.result.filter(a=>{const o=new Date(a.start_time||a["ÂºÄÂßãÊó∂Èó¥"]);return o>=t&&o<=e});console.log(`  ‚úì ${r}: ${n.length} Êù°ÔºàËøáÊª§ÂêéÔºâ`),a(n)},s.onerror=()=>{console.error(`  ‚úó ${r}: Êü•ËØ¢Â§±Ë¥•`),a([])}});if(s.length>0&&a)for(let t=0;t<s.length;t+=o){const e=s.slice(t,t+o);m+=e.length,a(e,m)}}const h=performance.now()-r;console.log(`‚úÖ Êó•ÊúüËåÉÂõ¥Êü•ËØ¢ÂÆåÊàê: ${m.toLocaleString()} Êù° (${h.toFixed(0)}ms)`),s(m)}catch(t){console.error("‚ùå Êó•ÊúüËåÉÂõ¥Êü•ËØ¢Â§±Ë¥•:",t),i(t)}})}async queryRecentData(t=1,e,a=5e3){this.db||await this.init();const o=performance.now(),r=new Date;return r.setMonth(r.getMonth()-t),console.log(`üîç Êü•ËØ¢ÊúÄËøë${t}‰∏™ÊúàÊï∞ÊçÆ (‰ªé ${r.toISOString()})`),new Promise((n,s)=>{const i=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).index("start_time"),c=IDBKeyRange.lowerBound(r),l=i.getAll(c);l.onsuccess=r=>{const s=r.target.result,i=s.length;if(e)for(let t=0;t<s.length;t+=a){const o=s.slice(t,t+a);e(o,Math.min(t+a,i))}const c=performance.now()-o;console.log(`‚úÖ ÊúÄËøë${t}‰∏™ÊúàÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê: ${i.toLocaleString()} Êù° (${c.toFixed(0)}ms, ${(i/(c/1e3)).toFixed(0)} Êù°/Áßí)`),n(i)},l.onerror=()=>{console.error("‚ùå Êü•ËØ¢ÊúÄËøëÊï∞ÊçÆÂ§±Ë¥•:",l.error),s(l.error)}})}async getAllDataFast(){this.db||await this.init();const t=performance.now();return new Promise((e,a)=>{const o=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).getAll();o.onsuccess=a=>{const o=a.target.result,r=performance.now()-t;console.log(`‚úÖ ‰∏ÄÊ¨°ÊÄßÂä†ËΩΩÂÆåÊàê: ${o.length.toLocaleString()} Êù° (${r.toFixed(0)}ms)`),e(o)},o.onerror=()=>{console.error("‚ùå Âä†ËΩΩÂ§±Ë¥•:",o.error),a(o.error)}})}async queryAllDataFast(t,e=5e3){this.db||await this.init();const a=performance.now();return new Promise((o,r)=>{const n=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).getAll();n.onsuccess=r=>{const n=r.target.result,s=n.length;if(t)for(let a=0;a<n.length;a+=e){const o=n.slice(a,a+e);t(o,Math.min(a+e,s))}const i=performance.now()-a;console.log(`‚úÖ Âø´ÈÄüÂä†ËΩΩÂÆåÊàê: ${s.toLocaleString()} Êù° (${i.toFixed(0)}ms, ${(s/(i/1e3)).toFixed(0)} Êù°/Áßí)`),o(s)},n.onerror=()=>{console.error("‚ùå Âø´ÈÄüÂä†ËΩΩÂ§±Ë¥•:",n.error),r(n.error)}})}async queryAllDataProgressive(t,e=5e3){this.db||await this.init();const a=performance.now();let o=0;return new Promise((r,n)=>{const s=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).openCursor();let i=[];s.onsuccess=n=>{const s=n.target.result;if(s)i.push(s.value),o++,i.length>=e&&(t&&t(i,o),i=[]),s.continue();else{i.length>0&&t&&t(i,o);const e=performance.now()-a;console.log(`‚úÖ Ê∏êËøõÂºèÂä†ËΩΩÂÆåÊàê: ${o.toLocaleString()} Êù° (${e.toFixed(0)}ms, ${(o/(e/1e3)).toFixed(0)} Êù°/Áßí)`),r(o)}},s.onerror=()=>{console.error("‚ùå Ê∏êËøõÂºèÂä†ËΩΩÂ§±Ë¥•:",s.error),n(s.error)}})}async checkAllDataCache(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.metaStoreName],"readonly").objectStore(this.metaStoreName).get("allDataMeta");e.onsuccess=()=>{const a=e.result;if(!a)return console.log("üîç Êú¨Âú∞ÁºìÂ≠ò‰∏çÂ≠òÂú®"),void t(null);console.log(`‚úÖ Êú¨Âú∞ÁºìÂ≠òÂ≠òÂú®ÔºåÂåÖÂê´ ${a.totalCount} Êù°ËÆ∞ÂΩïÔºåÊúÄÂêéÊõ¥Êñ∞Ôºö${new Date(a.lastUpdated).toLocaleString()}`),t(a)},e.onerror=()=>{console.error("‚ùå Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÂ§±Ë¥•:",e.error),t(null)}})}async clearAllDataCache(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),a=e.objectStore(this.allDataStoreName),o=e.objectStore(this.metaStoreName);a.clear(),o.delete("allDataMeta"),e.oncomplete=()=>{console.log("üßπ Êú¨Âú∞ÁºìÂ≠òÂ∑≤Ê∏ÖÁ©∫"),t()},e.onerror=()=>{console.error("‚ùå Ê∏ÖÁ©∫Êú¨Âú∞ÁºìÂ≠òÂ§±Ë¥•:",e.error),t()}})}async updateRecord(t){return this.db||await this.init(),new Promise((e,a)=>{const o=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),r=o.objectStore(this.allDataStoreName),n=o.objectStore(this.metaStoreName);t.timestamp||(t.timestamp=new Date(t.start_time).getTime());const s=r.put(t);s.onsuccess=()=>{const a=n.get("allDataMeta");a.onsuccess=()=>{const t=a.result||{key:"allDataMeta",totalCount:0,lastUpdated:Date.now(),lastSyncTime:Date.now()};t.lastUpdated=Date.now(),t.lastSyncTime=Date.now(),n.put(t)},console.log(`‚úÖ Â¢ûÈáèÊõ¥Êñ∞ËÆ∞ÂΩï ID: ${t.id}`),e(t)},s.onerror=()=>{console.error("‚ùå Â¢ûÈáèÊõ¥Êñ∞Â§±Ë¥•:",s.error),a(s.error)}})}async batchUpdateRecords(t){return this.db||await this.init(),t&&0!==t.length?new Promise((e,a)=>{const o=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),r=o.objectStore(this.allDataStoreName);o.objectStore(this.metaStoreName);let n=0;t.forEach(t=>{t.timestamp||(t.timestamp=new Date(t.start_time).getTime());r.put(t).onsuccess=()=>n++}),o.oncomplete=()=>{const a=this.db.transaction([this.metaStoreName],"readwrite").objectStore(this.metaStoreName),o=a.get("allDataMeta");o.onsuccess=()=>{const t=o.result||{key:"allDataMeta",totalCount:0,lastUpdated:Date.now(),lastSyncTime:Date.now()};t.lastUpdated=Date.now(),t.lastSyncTime=Date.now(),a.put(t)},console.log(`‚úÖ ÊâπÈáèÂ¢ûÈáèÊõ¥Êñ∞ÂÆåÊàê: ${n}/${t.length} Êù°ËÆ∞ÂΩï`),e(n)},o.onerror=()=>{console.error("‚ùå ÊâπÈáèÂ¢ûÈáèÊõ¥Êñ∞Â§±Ë¥•:",o.error),a(o.error)}}):0}async appendData(t){return this.db||await this.init(),t&&0!==t.length?new Promise((e,a)=>{const o=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),r=o.objectStore(this.allDataStoreName);o.objectStore(this.metaStoreName);let n=0;for(const e of t){const t={id:e.plan_id||e["ËÆ°ÂàíID"]||e.id||`record_${Date.now()}_${n}`,start_time:e.start_time||e["ÂºÄÂßãÊó∂Èó¥"],task_result:e.task_result||e["‰ªªÂä°ÁªìÊûúÁä∂ÊÄÅ"],task_type:e.task_type||e["‰ªªÂä°Á±ªÂûã"],customer:e.customer||e["ÊâÄÂ±ûÂÆ¢Êà∑"],satellite_name:e.satellite_name||e["Âç´ÊòüÂêçÁß∞"],station_name:e.station_name||e["ÊµãÁ´ôÂêçÁß∞"],station_id:e.station_id||e["ÊµãÁ´ôID"],...e};t.start_time&&(t.timestamp=this.parseTimeToTimestamp(t.start_time));r.put(t).onsuccess=()=>n++}o.oncomplete=()=>{const a=this.db.transaction([this.metaStoreName],"readwrite").objectStore(this.metaStoreName),o=a.get("allDataMeta");o.onsuccess=()=>{const t=o.result||{key:"allDataMeta",totalCount:0,lastUpdated:Date.now()};t.totalCount=(t.totalCount||0)+n,t.lastUpdated=Date.now(),a.put(t)},console.log(`‚úÖ ËøΩÂä†Êï∞ÊçÆÂÆåÊàê: ${n}/${t.length} Êù°ËÆ∞ÂΩï`),e(n)},o.onerror=()=>{console.error("‚ùå ËøΩÂä†Êï∞ÊçÆÂ§±Ë¥•:",o.error),a(o.error)}}):0}async deleteRecord(t){return this.db||await this.init(),new Promise((e,a)=>{const o=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),r=o.objectStore(this.allDataStoreName),n=o.objectStore(this.metaStoreName),s=r.delete(t);s.onsuccess=()=>{const a=n.get("allDataMeta");a.onsuccess=()=>{const t=a.result;t&&(t.lastUpdated=Date.now(),t.lastSyncTime=Date.now(),n.put(t))},console.log(`‚úÖ Âà†Èô§ËÆ∞ÂΩï ID: ${t}`),e(t)},s.onerror=()=>{console.error("‚ùå Âà†Èô§ËÆ∞ÂΩïÂ§±Ë¥•:",s.error),a(s.error)}})}async getLastSyncTime(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.metaStoreName],"readonly").objectStore(this.metaStoreName).get("allDataMeta");e.onsuccess=()=>{const a=e.result;t(a?.lastSyncTime||0)},e.onerror=()=>t(0)})}async saveDataStoreBuckets(t,e,a){return this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)?new Promise((o,r)=>{const n=this.db.transaction([this.dataStoreCacheStoreName],"readwrite").objectStore(this.dataStoreCacheStoreName),s=Array.from(e.entries()),i={key:`datastore_${t}`,groupType:t,buckets:s,recordCount:a,timestamp:Date.now()},c=n.put(i);c.onsuccess=()=>{console.log(`‚úÖ DataStoreÊ°∂ÁºìÂ≠òÂ∑≤‰øùÂ≠ò (${t}): ${s.length} ‰∏™Ê°∂, ${a} Êù°ËÆ∞ÂΩï`),o(!0)},c.onerror=()=>{console.error("‚ùå DataStoreÊ°∂ÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:",c.error),r(c.error)}}):(console.warn("‚ö†Ô∏è DataStoreÁºìÂ≠òÂäüËÉΩÊú™ÂêØÁî®ÔºàÈúÄË¶Åv4Êï∞ÊçÆÂ∫ìÔºâ"),!1)}async loadDataStoreBuckets(t,e=null){return this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)?new Promise((a,o)=>{const r=this.db.transaction([this.dataStoreCacheStoreName],"readonly").objectStore(this.dataStoreCacheStoreName).get(`datastore_${t}`);r.onsuccess=()=>{const o=r.result;if(!o)return console.log(`‚ö†Ô∏è DataStoreÊ°∂ÁºìÂ≠ò‰∏çÂ≠òÂú® (${t})`),void a(null);if(e&&o.timestamp<e)return console.warn(`‚ö†Ô∏è DataStoreÊ°∂ÁºìÂ≠òÂ∑≤ËøáÊúü (${t}): ÁºìÂ≠òÊó∂Èó¥ ${new Date(o.timestamp).toLocaleString()} < Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥ ${new Date(e).toLocaleString()}`),void a(null);const n=Date.now()-o.timestamp;if(n>864e5)return console.log(`‚ö†Ô∏è DataStoreÊ°∂ÁºìÂ≠òÂ∑≤ËøáÊúü (${t}): ${Math.round(n/36e5)}Â∞èÊó∂Ââç`),void a(null);console.log(`‚úÖ DataStoreÊ°∂ÁºìÂ≠òÂëΩ‰∏≠ (${t}): ${o.buckets.length} ‰∏™Ê°∂, ${o.recordCount} Êù°ËÆ∞ÂΩï`),a(o)},r.onerror=()=>{console.error("‚ùå DataStoreÊ°∂ÁºìÂ≠òÂä†ËΩΩÂ§±Ë¥•:",r.error),a(null)}}):null}async clearDataStoreBucketsCache(){if(this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName))return new Promise((t,e)=>{const a=this.db.transaction([this.dataStoreCacheStoreName],"readwrite").objectStore(this.dataStoreCacheStoreName).clear();a.onsuccess=()=>{console.log("‚úÖ DataStoreÊ°∂ÁºìÂ≠òÂ∑≤Ê∏ÖÁ©∫"),t()},a.onerror=()=>{console.error("‚ùå DataStoreÊ°∂ÁºìÂ≠òÊ∏ÖÁ©∫Â§±Ë¥•:",a.error),e(a.error)}})}}