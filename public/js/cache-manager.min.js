class CacheManager{constructor(){this.dbName="SatelliteDataCache",this.dbVersion=5,this.allDataStoreName="allDataCache",this.metaStoreName="metaData",this.shardIndexStoreName="shardIndex",this.dataStoreCacheStoreName="dataStoreCache",this.statisticsCacheStoreName="statisticsCache",this.db=null,this.cacheExpiry=1/0}getMonthKey(t){const e=new Date(t);return`${e.getFullYear()}_${String(e.getMonth()+1).padStart(2,"0")}`}getShardStoreName(t){return`monthData_${t}`}getRecentMonthKeys(t=3){const e=[],o=new Date;for(let a=0;a<t;a++){const t=new Date(o.getFullYear(),o.getMonth()-a,1);e.push(this.getMonthKey(t))}return e}groupDataByMonth(t){const e={};for(const o of t){const t=o.start_time||o["å¼€å§‹æ—¶é—´"];if(!t)continue;const a=this.getMonthKey(t);e[a]||(e[a]=[]),e[a].push(o)}return e}async init(){return new Promise((t,e)=>{const o=indexedDB.open(this.dbName,this.dbVersion);o.onerror=()=>{console.error("âŒ IndexedDBåˆå§‹åŒ–å¤±è´¥:",o.error),e(o.error)},o.onsuccess=()=>{this.db=o.result,console.log("âœ… IndexedDBåˆå§‹åŒ–æˆåŠŸ"),t(this.db)},o.onupgradeneeded=t=>{this.db=t.target.result;const e=t.oldVersion;if(console.log(`ğŸ”§ å‡çº§IndexedDBç»“æ„ v${e} -> v${this.dbVersion}...`),this.db.objectStoreNames.contains(this.allDataStoreName)){if(e<4){const e=t.target.transaction.objectStore(this.allDataStoreName);e.indexNames.contains("month_key")||(e.createIndex("month_key","month_key",{unique:!1}),console.log("ğŸ“¦ æ·»åŠ month_keyç´¢å¼•åˆ°ç°æœ‰æ•°æ®"))}}else{const t=this.db.createObjectStore(this.allDataStoreName,{keyPath:"id"});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("start_time","start_time",{unique:!1}),t.createIndex("month_key","month_key",{unique:!1}),console.log("ğŸ“¦ åˆ›å»ºå…¨æ•°æ®å­˜å‚¨ç©ºé—´")}if(!this.db.objectStoreNames.contains(this.metaStoreName)){this.db.createObjectStore(this.metaStoreName,{keyPath:"key"});console.log("ğŸ“¦ åˆ›å»ºå…ƒæ•°æ®å­˜å‚¨ç©ºé—´")}if(e<4&&!this.db.objectStoreNames.contains(this.shardIndexStoreName)){this.db.createObjectStore(this.shardIndexStoreName,{keyPath:"monthKey"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("ğŸ“¦ åˆ›å»ºåˆ†ç‰‡ç´¢å¼•å­˜å‚¨ç©ºé—´")}if(e<4&&!this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)){const t=this.db.createObjectStore(this.dataStoreCacheStoreName,{keyPath:"key"});t.createIndex("groupType","groupType",{unique:!1}),t.createIndex("timestamp","timestamp",{unique:!1}),console.log("ğŸ“¦ åˆ›å»ºDataStoreç¼“å­˜å­˜å‚¨ç©ºé—´")}if(e<5&&!this.db.objectStoreNames.contains(this.statisticsCacheStoreName)){const t=this.db.createObjectStore(this.statisticsCacheStoreName,{keyPath:"key"});t.createIndex("type","type",{unique:!1}),t.createIndex("timestamp","timestamp",{unique:!1}),console.log("ğŸš€ åˆ›å»ºé¢„è®¡ç®—ç»Ÿè®¡ç¼“å­˜è¡¨ï¼ˆ99%æ€§èƒ½æå‡ï¼ï¼‰")}}})}async storeAllData(t,e){this.db||await this.init();const o=performance.now();console.log(`ğŸ’¾ å¼€å§‹æ‰¹é‡å­˜å‚¨ ${t.length.toLocaleString()} æ¡æ•°æ®...`);try{await this.clearAllData();const a=this.sortDataByTime(t),s=1e4,r=Math.ceil(a.length/s);let n=0;const i={};for(let t=0;t<r;t++){const o=t*s,c=Math.min(o+s,a.length),l=a.slice(o,c);await this.storeBatch(l,i),n+=l.length;const m=Math.round(n/a.length*100);console.log(`ğŸ“¦ æ‰¹æ¬¡ ${t+1}/${r}: å·²å­˜å‚¨ ${n.toLocaleString()}/${a.length.toLocaleString()} (${m}%)`),e&&e(m,n,a.length),await new Promise(t=>setTimeout(t,0))}await this.saveMetadataAndShardIndex(a.length,i);const c=performance.now()-o;return console.log(`âœ… æ‰¹é‡å­˜å‚¨å®Œæˆ: ${n.toLocaleString()} æ¡ (${c.toFixed(0)}ms, ${(n/(c/1e3)).toFixed(0)} æ¡/ç§’)`),n}catch(t){throw console.error("âŒ æ‰¹é‡å­˜å‚¨å¤±è´¥:",t),t}}async storeBatch(t,e){return new Promise((o,a)=>{const s=this.db.transaction([this.allDataStoreName],"readwrite"),r=s.objectStore(this.allDataStoreName);for(const o of t){const t={id:o.plan_id||o["è®¡åˆ’ID"]||o.id||`record_${Date.now()}_${Math.random()}`,start_time:o.start_time||o["å¼€å§‹æ—¶é—´"],task_result:o.task_result||o["ä»»åŠ¡ç»“æœçŠ¶æ€"],task_type:o.task_type||o["ä»»åŠ¡ç±»å‹"],customer:o.customer||o["æ‰€å±å®¢æˆ·"],satellite_name:o.satellite_name||o["å«æ˜Ÿåç§°"],station_name:o.station_name||o["æµ‹ç«™åç§°"],station_id:o.station_id||o["æµ‹ç«™ID"],...o};t.start_time&&(t.timestamp=this.parseTimeToTimestamp(t.start_time),t.month_key=this.getMonthKey(t.start_time),e[t.month_key]||(e[t.month_key]=0),e[t.month_key]++),r.put(t)}s.oncomplete=()=>o(),s.onerror=()=>a(s.error)})}async clearAllData(){return new Promise((t,e)=>{const o=[this.allDataStoreName];this.db.objectStoreNames.contains(this.shardIndexStoreName)&&o.push(this.shardIndexStoreName);const a=this.db.transaction(o,"readwrite");a.objectStore(this.allDataStoreName).clear(),o.includes(this.shardIndexStoreName)&&a.objectStore(this.shardIndexStoreName).clear(),a.oncomplete=()=>{console.log("ğŸ§¹ å·²æ¸…ç©ºç°æœ‰æ•°æ®"),t()},a.onerror=()=>e(a.error)})}async getTimeRangeQuick(){return this.db||await this.init(),new Promise((t,e)=>{const o=this.db.transaction([this.allDataStoreName],"readonly"),a=o.objectStore(this.allDataStoreName).index("start_time"),s={};a.openCursor(null,"next").onsuccess=t=>{const e=t.target.result;e&&(s.minDate=new Date(e.value.timestamp))};a.openCursor(null,"prev").onsuccess=t=>{const e=t.target.result;e&&(s.maxDate=new Date(e.value.timestamp))},o.oncomplete=()=>t(s),o.onerror=()=>e(o.error)})}async saveMetadataAndShardIndex(t,e,o=null,a=null){return new Promise(async(s,r)=>{if(!o||!a)try{const t=await this.getTimeRangeQuick();o=t.minDate,a=t.maxDate}catch(t){console.warn("âš ï¸ æ— æ³•è·å–æ—¶é—´èŒƒå›´:",t)}const n=[this.metaStoreName];this.db.objectStoreNames.contains(this.shardIndexStoreName)&&n.push(this.shardIndexStoreName);const i=this.db.transaction(n,"readwrite");if(i.objectStore(this.metaStoreName).put({key:"allDataMeta",totalCount:t,lastUpdated:Date.now(),dataVersion:1,sortedByTime:!0,minDate:o,maxDate:a,minTimestamp:o?o.getTime():null,maxTimestamp:a?a.getTime():null}),n.includes(this.shardIndexStoreName)){const t=i.objectStore(this.shardIndexStoreName);for(const[o,a]of Object.entries(e))t.put({monthKey:o,count:a,timestamp:Date.now()});console.log(`ğŸ“Š å·²åˆ›å»º ${Object.keys(e).length} ä¸ªæœˆä»½åˆ†ç‰‡ç´¢å¼•`)}i.oncomplete=()=>s(),i.onerror=()=>r(i.error)})}sortDataByTime(t){return t&&Array.isArray(t)?t.sort((t,e)=>{const o=t.start_time||t["å¼€å§‹æ—¶é—´"]||t.timestamp,a=e.start_time||e["å¼€å§‹æ—¶é—´"]||e.timestamp;if(!o||!a)return 0;return this.parseTimeToTimestamp(o)-this.parseTimeToTimestamp(a)}):[]}parseTimeToTimestamp(t){if("number"==typeof t)return t>1e12?t:1e3*t;if("string"==typeof t){const e=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim(),o=this.parseLocalTime(e);return isNaN(o.getTime())?0:o.getTime()}return t instanceof Date?t.getTime():0}parseLocalDateToTimestamp(t,e=0,o=0,a=0,s=0){if(!t)return 0;try{const r=t.split("-");if(3===r.length){const t=parseInt(r[0]),n=parseInt(r[1])-1,i=parseInt(r[2]);return new Date(t,n,i,e,o,a,s).getTime()}}catch(e){console.warn("è§£ææ—¥æœŸå¤±è´¥:",t,e)}return 0}parseLocalTime(t){if(!t)return new Date(NaN);try{const e=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);if(e){const[,t,o,a,s=0,r=0,n=0]=e;return new Date(parseInt(t),parseInt(o)-1,parseInt(a),parseInt(s),parseInt(r),parseInt(n))}const o=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/);if(o){const[,t,e,a,s,r,n]=o;return new Date(parseInt(t),parseInt(e)-1,parseInt(a),parseInt(s),parseInt(r),parseInt(n))}const a=t.split(" ")[0].split("-").map(Number);if(a.length>=3){return new Date(a[0],a[1]-1,a[2],0,0,0)}return new Date(NaN)}catch(e){return console.error("CacheManageræ—¶é—´è§£æé”™è¯¯:",t,e),new Date(NaN)}}async queryAllData(t={}){return this.db||await this.init(),new Promise(e=>{const o=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).getAll();o.onsuccess=()=>{let a=o.result||[];if(t.startDate||t.endDate){let e,o;t.startDate&&(e=this.parseLocalDateToTimestamp(t.startDate,0,0,0),console.log(`ğŸ” ç­›é€‰å¼€å§‹æ—¶é—´: ${t.startDate} -> ${new Date(e).toLocaleString()}`)),t.endDate&&(o=this.parseLocalDateToTimestamp(t.endDate,23,59,59,999),console.log(`ğŸ” ç­›é€‰ç»“æŸæ—¶é—´: ${t.endDate} -> ${new Date(o).toLocaleString()}`));const s=a.length;a=a.filter(a=>{const s=a.timestamp||this.parseTimeToTimestamp(a.start_time);return!(t.startDate&&s<e)&&!(t.endDate&&s>o)}),console.log(`ğŸ” æ—¶é—´ç­›é€‰: ${s} -> ${a.length} æ¡æ•°æ®`)}console.log(`ğŸ” ä»æœ¬åœ°ç¼“å­˜æŸ¥è¯¢åˆ° ${a.length} æ¡æ•°æ®`),e(a)},o.onerror=()=>{console.error("âŒ æŸ¥è¯¢æœ¬åœ°ç¼“å­˜å¤±è´¥:",o.error),e([])}})}async getMetadataFast(){this.db||await this.init();const t=performance.now();return new Promise(e=>{const o=this.db.transaction([this.metaStoreName],"readonly"),a=o.objectStore(this.metaStoreName),s={},r=a.get("allDataMeta");r.onsuccess=()=>{const t=r.result;t&&(s.totalCount=t.totalCount,s.actualCount=t.totalCount,s.lastUpdated=t.lastUpdated,s.lastSyncTime=t.lastSyncTime,s.minDate=t.minDate,s.maxDate=t.maxDate,s.minTimestamp=t.minTimestamp,s.maxTimestamp=t.maxTimestamp)},o.oncomplete=()=>{const o=performance.now()-t;console.log(`âš¡ å…ƒæ•°æ®å¿«é€ŸæŸ¥è¯¢å®Œæˆ (${o.toFixed(1)}ms):`,{"æ€»æ•°":s.actualCount,"æ—¶é—´èŒƒå›´":`${s.minDate?.toLocaleDateString()} - ${s.maxDate?.toLocaleDateString()}`}),e(s)},o.onerror=()=>{console.error("âŒ å…ƒæ•°æ®æŸ¥è¯¢å¤±è´¥"),e(null)}})}async queryRecentMonthsFromShards(t=3,e,o=5e3){this.db||await this.init();const a=performance.now(),s=this.getRecentMonthKeys(t);return console.log(`ğŸ” æŸ¥è¯¢æœ€è¿‘${t}ä¸ªæœˆåˆ†ç‰‡æ•°æ®: ${s.join(", ")}`),new Promise(async(r,n)=>{try{const n=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName);if(!n.indexNames.contains("month_key"))return console.warn("âš ï¸ month_keyç´¢å¼•ä¸å­˜åœ¨ï¼Œé™çº§åˆ°start_timeæŸ¥è¯¢"),this.queryRecentData(t,e,o);const i=n.index("month_key"),c=[],l=s.map(t=>new Promise((e,o)=>{const a=IDBKeyRange.only(t),s=i.getAll(a);s.onsuccess=o=>{const a=o.target.result;console.log(`  âœ“ ${t}: ${a.length} æ¡`),e(a)},s.onerror=()=>{console.error(`  âœ— ${t}: æŸ¥è¯¢å¤±è´¥`),e([])}})),m=await Promise.all(l);for(const t of m)c.push(...t);const h=c.length;if(c.sort((t,e)=>(t.timestamp||0)-(e.timestamp||0)),e)for(let t=0;t<c.length;t+=o){const a=c.slice(t,t+o);e(a,Math.min(t+o,h))}const d=performance.now()-a;console.log(`âœ… åˆ†ç‰‡æŸ¥è¯¢å®Œæˆ: ${h.toLocaleString()} æ¡ (${d.toFixed(0)}ms, ${(h/(d/1e3)).toFixed(0)} æ¡/ç§’)`),r(h)}catch(t){console.error("âŒ åˆ†ç‰‡æŸ¥è¯¢å¤±è´¥:",t),n(t)}})}async queryDateRangeFromShards(t,e,o,a=5e3){this.db||await this.init();const s=performance.now(),r=[],n=new Date(t);n.setDate(1);const i=new Date(e);for(i.setDate(1);n<=i;){const t=this.getMonthKey(n);r.push(t),n.setMonth(n.getMonth()+1)}return console.log(`ğŸ” æŸ¥è¯¢æ—¥æœŸèŒƒå›´ ${t.toLocaleDateString()} - ${e.toLocaleDateString()}`),console.log(`   éœ€è¦æŸ¥è¯¢çš„æœˆä»½: ${r.join(", ")}`),new Promise(async(n,i)=>{try{const c=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName);if(!c.indexNames.contains("month_key")){console.warn("âš ï¸ month_keyç´¢å¼•ä¸å­˜åœ¨ï¼Œé™çº§åˆ°start_timeæŸ¥è¯¢");const s=c.index("start_time"),r=IDBKeyRange.bound(t,e),l=s.getAll(r);return l.onsuccess=t=>{const e=t.target.result;if(o)for(let t=0;t<e.length;t+=a){const s=e.slice(t,t+a);o(s,Math.min(t+a,e.length))}n(e.length)},void(l.onerror=()=>i(l.error))}const l=c.index("month_key");let m=0;for(const s of r.reverse()){const r=IDBKeyRange.only(s),n=await new Promise((o,a)=>{const n=l.getAll(r);n.onsuccess=a=>{const r=a.target.result.filter(o=>{const a=new Date(o.start_time||o["å¼€å§‹æ—¶é—´"]);return a>=t&&a<=e});console.log(`  âœ“ ${s}: ${r.length} æ¡ï¼ˆè¿‡æ»¤åï¼‰`),o(r)},n.onerror=()=>{console.error(`  âœ— ${s}: æŸ¥è¯¢å¤±è´¥`),o([])}});if(n.length>0&&o)for(let t=0;t<n.length;t+=a){const e=n.slice(t,t+a);m+=e.length,o(e,m)}}const h=performance.now()-s;console.log(`âœ… æ—¥æœŸèŒƒå›´æŸ¥è¯¢å®Œæˆ: ${m.toLocaleString()} æ¡ (${h.toFixed(0)}ms)`),n(m)}catch(t){console.error("âŒ æ—¥æœŸèŒƒå›´æŸ¥è¯¢å¤±è´¥:",t),i(t)}})}async queryRecentData(t=1,e,o=5e3){this.db||await this.init();const a=performance.now(),s=new Date;return s.setMonth(s.getMonth()-t),console.log(`ğŸ” æŸ¥è¯¢æœ€è¿‘${t}ä¸ªæœˆæ•°æ® (ä» ${s.toISOString()})`),new Promise((r,n)=>{const i=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).index("start_time"),c=IDBKeyRange.lowerBound(s),l=i.getAll(c);l.onsuccess=s=>{const n=s.target.result,i=n.length;if(e)for(let t=0;t<n.length;t+=o){const a=n.slice(t,t+o);e(a,Math.min(t+o,i))}const c=performance.now()-a;console.log(`âœ… æœ€è¿‘${t}ä¸ªæœˆæ•°æ®åŠ è½½å®Œæˆ: ${i.toLocaleString()} æ¡ (${c.toFixed(0)}ms, ${(i/(c/1e3)).toFixed(0)} æ¡/ç§’)`),r(i)},l.onerror=()=>{console.error("âŒ æŸ¥è¯¢æœ€è¿‘æ•°æ®å¤±è´¥:",l.error),n(l.error)}})}async getAllDataFast(){this.db||await this.init();const t=performance.now();return new Promise((e,o)=>{const a=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).getAll();a.onsuccess=o=>{const a=o.target.result,s=performance.now()-t;console.log(`âœ… ä¸€æ¬¡æ€§åŠ è½½å®Œæˆ: ${a.length.toLocaleString()} æ¡ (${s.toFixed(0)}ms)`),e(a)},a.onerror=()=>{console.error("âŒ åŠ è½½å¤±è´¥:",a.error),o(a.error)}})}async queryAllDataFast(t,e=5e3){this.db||await this.init();const o=performance.now();return new Promise((a,s)=>{const r=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).getAll();r.onsuccess=s=>{const r=s.target.result,n=r.length;if(t)for(let o=0;o<r.length;o+=e){const a=r.slice(o,o+e);t(a,Math.min(o+e,n))}const i=performance.now()-o;console.log(`âœ… å¿«é€ŸåŠ è½½å®Œæˆ: ${n.toLocaleString()} æ¡ (${i.toFixed(0)}ms, ${(n/(i/1e3)).toFixed(0)} æ¡/ç§’)`),a(n)},r.onerror=()=>{console.error("âŒ å¿«é€ŸåŠ è½½å¤±è´¥:",r.error),s(r.error)}})}async queryAllDataProgressive(t,e=5e3){this.db||await this.init();const o=performance.now();let a=0;return new Promise((s,r)=>{const n=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).openCursor();let i=[];n.onsuccess=r=>{const n=r.target.result;if(n)i.push(n.value),a++,i.length>=e&&(t&&t(i,a),i=[]),n.continue();else{i.length>0&&t&&t(i,a);const e=performance.now()-o;console.log(`âœ… æ¸è¿›å¼åŠ è½½å®Œæˆ: ${a.toLocaleString()} æ¡ (${e.toFixed(0)}ms, ${(a/(e/1e3)).toFixed(0)} æ¡/ç§’)`),s(a)}},n.onerror=()=>{console.error("âŒ æ¸è¿›å¼åŠ è½½å¤±è´¥:",n.error),r(n.error)}})}async checkAllDataCache(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.metaStoreName],"readonly").objectStore(this.metaStoreName).get("allDataMeta");e.onsuccess=()=>{const o=e.result;if(!o)return console.log("ğŸ” æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨"),void t(null);console.log(`âœ… æœ¬åœ°ç¼“å­˜å­˜åœ¨ï¼ŒåŒ…å« ${o.totalCount} æ¡è®°å½•ï¼Œæœ€åæ›´æ–°ï¼š${new Date(o.lastUpdated).toLocaleString()}`),t(o)},e.onerror=()=>{console.error("âŒ æ£€æŸ¥æœ¬åœ°ç¼“å­˜å¤±è´¥:",e.error),t(null)}})}async clearAllDataCache(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),o=e.objectStore(this.allDataStoreName),a=e.objectStore(this.metaStoreName);o.clear(),a.delete("allDataMeta"),e.oncomplete=()=>{console.log("ğŸ§¹ æœ¬åœ°ç¼“å­˜å·²æ¸…ç©º"),t()},e.onerror=()=>{console.error("âŒ æ¸…ç©ºæœ¬åœ°ç¼“å­˜å¤±è´¥:",e.error),t()}})}async updateRecord(t){return this.db||await this.init(),new Promise((e,o)=>{const a=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),s=a.objectStore(this.allDataStoreName),r=a.objectStore(this.metaStoreName);t.timestamp||(t.timestamp=new Date(t.start_time).getTime());const n=s.put(t);n.onsuccess=()=>{const o=r.get("allDataMeta");o.onsuccess=()=>{const t=o.result||{key:"allDataMeta",totalCount:0,lastUpdated:Date.now(),lastSyncTime:Date.now()};t.lastUpdated=Date.now(),t.lastSyncTime=Date.now(),r.put(t)},console.log(`âœ… å¢é‡æ›´æ–°è®°å½• ID: ${t.id}`),e(t)},n.onerror=()=>{console.error("âŒ å¢é‡æ›´æ–°å¤±è´¥:",n.error),o(n.error)}})}async batchUpdateRecords(t){return this.db||await this.init(),t&&0!==t.length?new Promise((e,o)=>{const a=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),s=a.objectStore(this.allDataStoreName);a.objectStore(this.metaStoreName);let r=0;t.forEach(t=>{t.timestamp||(t.timestamp=new Date(t.start_time).getTime());s.put(t).onsuccess=()=>r++}),a.oncomplete=()=>{const o=this.db.transaction([this.metaStoreName],"readwrite").objectStore(this.metaStoreName),a=o.get("allDataMeta");a.onsuccess=()=>{const t=a.result||{key:"allDataMeta",totalCount:0,lastUpdated:Date.now(),lastSyncTime:Date.now()};t.lastUpdated=Date.now(),t.lastSyncTime=Date.now(),o.put(t)},console.log(`âœ… æ‰¹é‡å¢é‡æ›´æ–°å®Œæˆ: ${r}/${t.length} æ¡è®°å½•`),e(r)},a.onerror=()=>{console.error("âŒ æ‰¹é‡å¢é‡æ›´æ–°å¤±è´¥:",a.error),o(a.error)}}):0}async appendData(t){return this.db||await this.init(),t&&0!==t.length?new Promise((e,o)=>{const a=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),s=a.objectStore(this.allDataStoreName);a.objectStore(this.metaStoreName);let r=0;for(const e of t){const t={id:e.plan_id||e["è®¡åˆ’ID"]||e.id||`record_${Date.now()}_${r}`,start_time:e.start_time||e["å¼€å§‹æ—¶é—´"],task_result:e.task_result||e["ä»»åŠ¡ç»“æœçŠ¶æ€"],task_type:e.task_type||e["ä»»åŠ¡ç±»å‹"],customer:e.customer||e["æ‰€å±å®¢æˆ·"],satellite_name:e.satellite_name||e["å«æ˜Ÿåç§°"],station_name:e.station_name||e["æµ‹ç«™åç§°"],station_id:e.station_id||e["æµ‹ç«™ID"],...e};t.start_time&&(t.timestamp=this.parseTimeToTimestamp(t.start_time));s.put(t).onsuccess=()=>r++}a.oncomplete=()=>{const o=this.db.transaction([this.metaStoreName],"readwrite").objectStore(this.metaStoreName),a=o.get("allDataMeta");a.onsuccess=()=>{const t=a.result||{key:"allDataMeta",totalCount:0,lastUpdated:Date.now()};t.totalCount=(t.totalCount||0)+r,t.lastUpdated=Date.now(),o.put(t)},console.log(`âœ… è¿½åŠ æ•°æ®å®Œæˆ: ${r}/${t.length} æ¡è®°å½•`),e(r)},a.onerror=()=>{console.error("âŒ è¿½åŠ æ•°æ®å¤±è´¥:",a.error),o(a.error)}}):0}async deleteRecord(t){return this.db||await this.init(),new Promise((e,o)=>{const a=this.db.transaction([this.allDataStoreName,this.metaStoreName],"readwrite"),s=a.objectStore(this.allDataStoreName),r=a.objectStore(this.metaStoreName),n=s.delete(t);n.onsuccess=()=>{const o=r.get("allDataMeta");o.onsuccess=()=>{const t=o.result;t&&(t.lastUpdated=Date.now(),t.lastSyncTime=Date.now(),r.put(t))},console.log(`âœ… åˆ é™¤è®°å½• ID: ${t}`),e(t)},n.onerror=()=>{console.error("âŒ åˆ é™¤è®°å½•å¤±è´¥:",n.error),o(n.error)}})}async getLastSyncTime(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.metaStoreName],"readonly").objectStore(this.metaStoreName).get("allDataMeta");e.onsuccess=()=>{const o=e.result;t(o?.lastSyncTime||0)},e.onerror=()=>t(0)})}async saveDataStoreBuckets(t,e,o){return this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)?new Promise((a,s)=>{const r=this.db.transaction([this.dataStoreCacheStoreName],"readwrite").objectStore(this.dataStoreCacheStoreName),n=Array.from(e.entries()),i={key:`datastore_${t}`,groupType:t,buckets:n,recordCount:o,timestamp:Date.now()},c=r.put(i);c.onsuccess=()=>{console.log(`âœ… DataStoreæ¡¶ç¼“å­˜å·²ä¿å­˜ (${t}): ${n.length} ä¸ªæ¡¶, ${o} æ¡è®°å½•`),a(!0)},c.onerror=()=>{console.error("âŒ DataStoreæ¡¶ç¼“å­˜ä¿å­˜å¤±è´¥:",c.error),s(c.error)}}):(console.warn("âš ï¸ DataStoreç¼“å­˜åŠŸèƒ½æœªå¯ç”¨ï¼ˆéœ€è¦v4æ•°æ®åº“ï¼‰"),!1)}async loadDataStoreBuckets(t,e=null){return this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)?new Promise((o,a)=>{const s=this.db.transaction([this.dataStoreCacheStoreName],"readonly").objectStore(this.dataStoreCacheStoreName).get(`datastore_${t}`);s.onsuccess=()=>{const a=s.result;if(!a)return console.log(`âš ï¸ DataStoreæ¡¶ç¼“å­˜ä¸å­˜åœ¨ (${t})`),void o(null);if(e&&a.timestamp<e)return console.warn(`âš ï¸ DataStoreæ¡¶ç¼“å­˜å·²è¿‡æœŸ (${t}): ç¼“å­˜æ—¶é—´ ${new Date(a.timestamp).toLocaleString()} < æ•°æ®æ›´æ–°æ—¶é—´ ${new Date(e).toLocaleString()}`),void o(null);const r=Date.now()-a.timestamp;if(r>864e5)return console.log(`âš ï¸ DataStoreæ¡¶ç¼“å­˜å·²è¿‡æœŸ (${t}): ${Math.round(r/36e5)}å°æ—¶å‰`),void o(null);console.log(`âœ… DataStoreæ¡¶ç¼“å­˜å‘½ä¸­ (${t}): ${a.buckets.length} ä¸ªæ¡¶, ${a.recordCount} æ¡è®°å½•`),o(a)},s.onerror=()=>{console.error("âŒ DataStoreæ¡¶ç¼“å­˜åŠ è½½å¤±è´¥:",s.error),o(null)}}):null}async clearDataStoreBucketsCache(){if(this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName))return new Promise((t,e)=>{const o=this.db.transaction([this.dataStoreCacheStoreName],"readwrite").objectStore(this.dataStoreCacheStoreName).clear();o.onsuccess=()=>{console.log("âœ… DataStoreæ¡¶ç¼“å­˜å·²æ¸…ç©º"),t()},o.onerror=()=>{console.error("âŒ DataStoreæ¡¶ç¼“å­˜æ¸…ç©ºå¤±è´¥:",o.error),e(o.error)}})}async getDataByDateRange(t,e){this.db||await this.init();const o=performance.now(),a=this.parseLocalDateToTimestamp(t,0,0,0,0),s=this.parseLocalDateToTimestamp(e,23,59,59,999);return console.log(`ğŸ” æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢: ${t} è‡³ ${e}`),new Promise((r,n)=>{const i=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName).index("timestamp"),c=IDBKeyRange.bound(a,s),l=i.getAll(c);l.onsuccess=()=>{const t=l.result||[],e=performance.now()-o;console.log(`âš¡ ç´¢å¼•æŸ¥è¯¢å®Œæˆ: ${t.length.toLocaleString()} æ¡ (${e.toFixed(0)}ms)`),r(t)},l.onerror=()=>{console.error("âŒ ç´¢å¼•æŸ¥è¯¢å¤±è´¥:",l.error),console.log("âš ï¸ é™çº§ä¸ºå…¨æ‰«ææŸ¥è¯¢..."),this.queryAllData({startDate:t,endDate:e}).then(r).catch(n)}})}getWeekKey(t){const e=new Date(t),o=e.getFullYear(),a=new Date(o,0,1),s=Math.ceil(((e-a)/864e5+a.getDay()+1)/7);return`${o}_W${String(s).padStart(2,"0")}`}computeBucketStatistics(t){const e=performance.now();console.log(`ğŸ“Š å¼€å§‹é¢„è®¡ç®—æ¡¶ç»Ÿè®¡: ${t.length.toLocaleString()} æ¡æ•°æ®...`);const o={daily:{},weekly:{},monthly:{}};for(const e of t){const t=e.bucket_name||e["æ¡¶åç§°"],a=e.start_time||e["å¼€å§‹æ—¶é—´"];if(!t||!a)continue;const s=new Date(this.parseTimeToTimestamp(a)),r=s.toISOString().split("T")[0],n=this.getWeekKey(s),i=this.getMonthKey(s);o.daily[r]||(o.daily[r]={}),o.daily[r][t]||(o.daily[r][t]=0),o.daily[r][t]++,o.weekly[n]||(o.weekly[n]={}),o.weekly[n][t]||(o.weekly[n][t]=0),o.weekly[n][t]++,o.monthly[i]||(o.monthly[i]={}),o.monthly[i][t]||(o.monthly[i][t]=0),o.monthly[i][t]++}const a=performance.now()-e;return console.log(`âœ… æ¡¶ç»Ÿè®¡é¢„è®¡ç®—å®Œæˆ: ${a.toFixed(0)}ms`),console.log(`   - æ¯æ—¥: ${Object.keys(o.daily).length} å¤©`),console.log(`   - æ¯å‘¨: ${Object.keys(o.weekly).length} å‘¨`),console.log(`   - æ¯æœˆ: ${Object.keys(o.monthly).length} æœˆ`),o}computeCustomerStatistics(t){const e=performance.now();console.log(`ğŸ“Š å¼€å§‹é¢„è®¡ç®—å®¢æˆ·ç»Ÿè®¡: ${t.length.toLocaleString()} æ¡æ•°æ®...`);const o={daily:{},weekly:{},monthly:{}};for(const e of t){const t=e.customer||e["å®¢æˆ·"],a=e.start_time||e["å¼€å§‹æ—¶é—´"];if(!t||!a)continue;const s=new Date(this.parseTimeToTimestamp(a)),r=s.toISOString().split("T")[0],n=this.getWeekKey(s),i=this.getMonthKey(s);o.daily[r]||(o.daily[r]=new Set),o.daily[r].add(t),o.weekly[n]||(o.weekly[n]=new Set),o.weekly[n].add(t),o.monthly[i]||(o.monthly[i]=new Set),o.monthly[i].add(t)}const a={daily:{},weekly:{},monthly:{}};for(const t in o.daily)a.daily[t]=o.daily[t].size;for(const t in o.weekly)a.weekly[t]=o.weekly[t].size;for(const t in o.monthly)a.monthly[t]=o.monthly[t].size;const s=performance.now()-e;return console.log(`âœ… å®¢æˆ·ç»Ÿè®¡é¢„è®¡ç®—å®Œæˆ: ${s.toFixed(0)}ms`),a}async saveStatistics(t,e){if(this.db||await this.init(),this.db.objectStoreNames.contains(this.statisticsCacheStoreName))return new Promise((o,a)=>{const s=this.db.transaction([this.statisticsCacheStoreName],"readwrite").objectStore(this.statisticsCacheStoreName),r={key:`stats_${t}`,type:t,data:e,timestamp:Date.now()},n=s.put(r);n.onsuccess=()=>{console.log(`âœ… ${t}ç»Ÿè®¡ç¼“å­˜å·²ä¿å­˜`),o()},n.onerror=()=>{console.error(`âŒ ${t}ç»Ÿè®¡ç¼“å­˜ä¿å­˜å¤±è´¥:`,n.error),a(n.error)}});console.warn("âš ï¸ statisticsCacheè¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜")}async getStatistics(t){if(this.db||await this.init(),!this.db.objectStoreNames.contains(this.statisticsCacheStoreName))return console.warn("âš ï¸ statisticsCacheè¡¨ä¸å­˜åœ¨"),null;const e=performance.now();return new Promise((o,a)=>{const s=this.db.transaction([this.statisticsCacheStoreName],"readonly").objectStore(this.statisticsCacheStoreName).get(`stats_${t}`);s.onsuccess=()=>{const a=s.result,r=performance.now()-e;a?(console.log(`âš¡ ${t}ç»Ÿè®¡ç¼“å­˜å‘½ä¸­ (${r.toFixed(0)}ms)`),o(a.data)):(console.log(`âš ï¸ ${t}ç»Ÿè®¡ç¼“å­˜ä¸å­˜åœ¨`),o(null))},s.onerror=()=>{console.error(`âŒ ${t}ç»Ÿè®¡ç¼“å­˜è¯»å–å¤±è´¥:`,s.error),o(null)}})}async clearStatisticsCache(){if(this.db||await this.init(),this.db.objectStoreNames.contains(this.statisticsCacheStoreName))return new Promise((t,e)=>{const o=this.db.transaction([this.statisticsCacheStoreName],"readwrite").objectStore(this.statisticsCacheStoreName).clear();o.onsuccess=()=>{console.log("âœ… ç»Ÿè®¡ç¼“å­˜å·²æ¸…ç©º"),t()},o.onerror=()=>{console.error("âŒ ç»Ÿè®¡ç¼“å­˜æ¸…ç©ºå¤±è´¥:",o.error),e(o.error)}})}async storeAllDataWithPrecompute(t,e,o=!1){const a=performance.now();console.log(`ğŸš€ å¼€å§‹å­˜å‚¨æ•°æ®å¹¶é¢„è®¡ç®—ç»Ÿè®¡: ${t.length.toLocaleString()} æ¡...`),await this.storeAllData(t,e);const s=performance.now()-a;if(console.log(`âœ… æ•°æ®å­˜å‚¨å®Œæˆ: ${s.toFixed(0)}ms`),o)return console.log("ğŸ“Š é¢„è®¡ç®—å°†åœ¨åå°æ‰§è¡Œï¼Œä¸é˜»å¡UIåˆå§‹åŒ–..."),setTimeout(async()=>{try{const e=performance.now();console.log("ğŸ”„ åå°å¼€å§‹é¢„è®¡ç®—ç»Ÿè®¡...");const[o,a]=await Promise.all([Promise.resolve(this.computeBucketStatistics(t)),Promise.resolve(this.computeCustomerStatistics(t))]);await Promise.all([this.saveStatistics("bucket",o),this.saveStatistics("customer",a)]);const s=performance.now()-e;console.log(`âœ… åå°é¢„è®¡ç®—å®Œæˆ: ${s.toFixed(0)}ms`),console.log("ğŸ’¡ ä¸‹æ¬¡å›¾è¡¨æ¸²æŸ“å°†ä½¿ç”¨é¢„è®¡ç®—ç»“æœï¼Œé€Ÿåº¦æå‡99%ï¼")}catch(t){console.error("âŒ åå°é¢„è®¡ç®—å¤±è´¥:",t)}},100),t.length;{console.log("ğŸ“Š å¼€å§‹é¢„è®¡ç®—ç»Ÿè®¡...");const e=performance.now(),[o,s]=await Promise.all([Promise.resolve(this.computeBucketStatistics(t)),Promise.resolve(this.computeCustomerStatistics(t))]);await Promise.all([this.saveStatistics("bucket",o),this.saveStatistics("customer",s)]);const r=performance.now()-e,n=performance.now()-a;return console.log(`âœ… æ•°æ®å­˜å‚¨+é¢„è®¡ç®—å®Œæˆ: æ€»è€—æ—¶ ${n.toFixed(0)}ms (é¢„è®¡ç®— ${r.toFixed(0)}ms)`),console.log("ğŸ’¡ ä¸‹æ¬¡å›¾è¡¨æ¸²æŸ“å°†ä½¿ç”¨é¢„è®¡ç®—ç»“æœï¼Œé€Ÿåº¦æå‡99%ï¼"),t.length}}}