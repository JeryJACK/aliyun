class DataStore{constructor(e={}){this.buckets=new Map,this.recordToBucket=new Map,this.fieldMapping={idField:e.idField||"id",planIdField:e.planIdField||"plan_id",startTimeField:e.startTimeField||"start_time",taskResultField:e.taskResultField||"task_result"}}getRecordKey(e){const t=e[this.fieldMapping.idField];if(null==t){return`${e[this.fieldMapping.planIdField]}_${e[this.fieldMapping.startTimeField]}`}return String(t)}loadData(e,t,r="day"){const n=performance.now();this.clear(),this.addRecordsToBucketBatch(e,t,r);const s=performance.now()-n;console.log(`✅ 数据桶初始化完成: ${this.buckets.size} 个桶, ${e.length} 条记录 (${s.toFixed(2)}ms, ${(e.length/(s/1e3)).toFixed(0)} 条/秒)`)}addRecordsToBucketBatch(e,t,r){if(!e||0===e.length)return;const{startTimeField:n}=this.fieldMapping,s=performance.now(),a=new Map,o=new Map,i=this.recordToBucket;for(let s=0;s<e.length;s++){const c=e[s],l=this.getRecordKey(c);if(i.has(l))continue;const u=c[n];let d;if(u instanceof Date)d=u.getTime();else if("number"==typeof u)d=864e5*(u-25569);else{if("string"!=typeof u)continue;d=new Date(u).getTime()}if(isNaN(d))continue;const g=`${Math.floor(d/864e5)}_${r}`;let h=o.get(g);if(!h){const e=t.createFileDate(new Date(d));h=t.getGroup(e,r),o.set(g,h)}const m=h.key;a.has(m)||a.set(m,{label:h.label,rangeStart:h.rangeStart,rangeEnd:h.rangeEnd,records:[],recordKeys:new Set});const f=a.get(m);f.records.push(c),f.recordKeys.add(l),i.set(l,m)}for(const[e,t]of a){let r=this.buckets.get(e);r||(r={key:e,label:t.label,records:[],rangeStart:t.rangeStart,rangeEnd:t.rangeEnd},this.buckets.set(e,r)),r.records.push(...t.records);for(const r of t.recordKeys)this.recordToBucket.set(r,e)}const c=performance.now()-s;c>10&&console.log(`  ⚡ 极速解析: ${e.length} 条 → ${a.size} 个桶 (${c.toFixed(0)}ms, ${(e.length/(c/1e3)).toFixed(0)} 条/秒)`)}async addRecordsToBucketConcurrent(e,t,r){if(!e||0===e.length)return;const n=1e4;if(e.length<=n)return void this.addRecordsToBucketBatch(e,t,r);const s=performance.now(),a=[];for(let t=0;t<e.length;t+=n)a.push(e.slice(t,t+n));console.log(`🚀 并发解析: ${e.length} 条数据拆分为 ${a.length} 个批次`);for(let e=0;e<a.length;e+=4){const n=a.slice(e,e+4);await Promise.all(n.map(e=>new Promise(n=>{this.addRecordsToBucketBatch(e,t,r),n()})))}const o=performance.now()-s;console.log(`✅ 并发解析完成: ${e.length} 条 (${o.toFixed(0)}ms, ${(e.length/(o/1e3)).toFixed(0)} 条/秒)`)}addRecordToBucket(e,t,r){const{startTimeField:n}=this.fieldMapping;try{const s=e[n];let a;if(s instanceof Date)a=t.createFileDate(s);else if("string"==typeof s)a=new Date(s);else{if("number"!=typeof s)return console.warn("⚠️ 记录缺少有效的时间字段:",e),null;a=new Date(864e5*(s-25569))}if(isNaN(a.getTime()))return console.warn("⚠️ 记录时间字段无效:",e),null;const o=t.getGroup(a,r),i=o.key;this.buckets.has(i)||this.buckets.set(i,{key:i,label:o.label,records:[],rangeStart:o.rangeStart,rangeEnd:o.rangeEnd});const c=this.buckets.get(i),l=this.getRecordKey(e),u=c.records.findIndex(e=>this.getRecordKey(e)===l);return u>=0?c.records[u]=e:c.records.push(e),this.recordToBucket.set(l,i),i}catch(t){return console.warn("添加记录到桶失败:",e,t),null}}updateRecord(e,t,r,n=!1){const s=this.getRecordKey(e),a=this.recordToBucket.get(s),o=[];try{if(a){const e=this.buckets.get(a);if(e){const t=e.records.findIndex(e=>this.getRecordKey(e)===s);t>=0&&(e.records.splice(t,1),o.push(a))}this.recordToBucket.delete(s)}if(!n){const n=this.addRecordToBucket(e,t,r);n&&n!==a&&o.push(n)}}catch(t){console.warn("桶增量更新失败:",e,t)}return o}mergeIncrementalData(e,t,r="day"){const n=performance.now(),s=new Set;e.forEach(e=>{this.updateRecord(e,t,r,!1).forEach(e=>s.add(e))});const a=performance.now()-n;return console.log(`✅ 批量增量合并完成: ${e.length} 条记录, 影响 ${s.size} 个桶 (${a.toFixed(2)}ms)`),Array.from(s)}getStats(e,t=null,r=null){const n=performance.now(),{planIdField:s,taskResultField:a}=this.fieldMapping;let o=Array.from(this.buckets.values());(t||r)&&(o=o.filter(e=>!(t&&e.rangeStart<t)&&!(r&&e.rangeEnd>r))),o.sort((e,t)=>e.rangeStart-t.rangeStart);const i=o.map(t=>{const r=new Set,n=[];return t.records.forEach(e=>{const t=e[s];t&&r.add(t);const o=e[a]||"未知";n.push(o)}),{key:t.key,label:t.label,count:r.size,failureCount:e.countFailures(n),successRate:e.calculateSuccessRate(n,r.size),rangeStart:t.rangeStart,rangeEnd:t.rangeEnd}}),c=performance.now()-n;return console.log(`⚡ 从桶获取统计结果 (${c.toFixed(2)}ms), ${i.length} 个时间段`),i}clear(){this.buckets.clear(),this.recordToBucket.clear()}}class TaskResultAnalyzer{isFailure(e){return["因设备故障失败","因操作失误失败","未跟踪","因卫星方原因失败","任务成功数据处理失误"].includes(e)}isSuccessForRate(e){return["正常","未跟踪","因卫星方原因失败"].includes(e)}countFailures(e){return e.filter(e=>this.isFailure(e)).length}calculateSuccessRate(e,t){if(t<=0)return 0;const r=e.filter(e=>this.isSuccessForRate(e)).length;return parseFloat(parseFloat(r/t*100).toFixed(3))}}class CycleRuleEngine{constructor(){this.config={day:{start:"00:00"},week:{startDay:1,startTime:"00:00"},month:{startDate:1,startTime:"00:00"},quarter:{startMonth:1,startTime:"00:00"}}}updateConfig(e){return this.config={...this.config,...e},!0}parseTimeToHoursMinutes(e){const[t,r]=e.split(":").map(Number);return{hours:t||0,minutes:r||0}}formatDate(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}formatDateCorrected(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}createFileDate(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds())}getDayGroup(e){const t=this.config.day,{hours:r,minutes:n}=this.parseTimeToHoursMinutes(t.start),s=this.createFileDate(e),a=this.createFileDate(s);a.setHours(r,n,0,0);const o=s>=a?new Date(a):new Date(a.getTime()-864e5),i=new Date(o.getTime()+864e5),c=new Date(o);return{key:this.formatDate(c),label:this.formatDateCorrected(c),rangeStart:o,rangeEnd:i}}getWeekGroup(e){const t=this.config.week,r=t.startDay,{hours:n,minutes:s}=this.parseTimeToHoursMinutes(t.startTime),a=this.createFileDate(e);let o=a.getDay()-r;o<0&&(o+=7);const i=this.createFileDate(a);i.setDate(a.getDate()-o),i.setHours(n,s,0,0);const c=a>=i?new Date(i):new Date(i.getTime()-6048e5),l=new Date(c.getTime()+6048e5),u=c.getFullYear(),d=new Date(u,0,1),g=(c-d)/864e5,h=Math.ceil((g+d.getDay()+1)/7),m=["周日","周一","周二","周三","周四","周五","周六"][r];return{key:`${u}-W${String(h).padStart(2,"0")}`,label:`${u}年第${h}周（${m}）`,rangeStart:c,rangeEnd:l}}getMonthGroup(e){const t=this.config.month,r=t.startDate,{hours:n,minutes:s}=this.parseTimeToHoursMinutes(t.startTime),a=this.createFileDate(e),o=a.getFullYear(),i=a.getMonth(),c=new Date(o,i,r);let l;if(c.setHours(n,s,0,0),c.getDate()!==r&&(c.setMonth(c.getMonth()+1,0),c.setHours(n,s,0,0)),a>=c)l=new Date(c);else{l=new Date(0===i?o-1:o,0===i?11:i-1,r),l.setHours(n,s,0,0),l.getDate()!==r&&(l.setMonth(l.getMonth()+1,0),l.setHours(n,s,0,0))}const u=l.getMonth()+1,d=l.getFullYear()+(u>11?1:0),g=new Date(d,u>11?0:u,r);g.setHours(n,s,0,0),g.getDate()!==r&&(g.setMonth(g.getMonth()+1,0),g.setHours(n,s,0,0));const h=l.getFullYear(),m=l.getMonth()+1;return{key:`${h}-${String(m).padStart(2,"0")}`,label:`${h}年${m}月`,rangeStart:l,rangeEnd:g}}getQuarterGroup(e){const t=this.config.quarter,r=parseInt(t.startMonth),{hours:n,minutes:s}=this.parseTimeToHoursMinutes(t.startTime),a=this.createFileDate(e),o=a.getFullYear(),i=a.getMonth()+1;let c;c=1===r?i<=3?1:i<=6?4:i<=9?7:10:4===r?i<=6?4:i<=9?7:i<=12?10:1:7===r?i<=9?7:i<=12?10:i<=3?1:4:i<=12?10:i<=3?1:i<=6?4:7;const l=new Date(c<=i?o:o-1,c-1,1);l.setHours(n,s,0,0);const u=a>=l?l:new Date(l.getTime()-7776e6);let d=c+3,g=u.getFullYear();d>12&&(d-=12,g++);const h=new Date(g,d-1,1);h.setHours(n,s,0,0);const m=u.getFullYear(),f=Math.floor((c-1)/3)+1;return{key:`${m}-Q${f}`,label:`${m}年第${f}季度`,rangeStart:u,rangeEnd:h}}getGroup(e,t){const r=e instanceof Date?e:new Date(e);if(isNaN(r.getTime()))throw console.error("无效的日期:",e),new Error("无效的日期");switch(t){case"day":default:return this.getDayGroup(r);case"week":return this.getWeekGroup(r);case"month":return this.getMonthGroup(r);case"quarter":return this.getQuarterGroup(r)}}}function showError(e){const t=document.getElementById("chartErrorMessage");t?(t.textContent=e,document.getElementById("chartErrorState").classList.remove("hidden"),setTimeout(()=>document.getElementById("chartErrorState").classList.add("hidden"),6e3)):alert(e)}function showSuccess(e){console.info(e);const t=document.createElement("div");t.className="fixed top-4 right-4 bg-success text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full",t.innerHTML=`<i class="fa fa-check-circle mr-2"></i>${e}`,document.body.appendChild(t),setTimeout(()=>t.classList.remove("translate-x-full"),100),setTimeout(()=>{t.classList.add("translate-x-full"),setTimeout(()=>document.body.removeChild(t),300)},3e3)}function showWarning(e){console.warn(e);const t=document.createElement("div");t.className="fixed top-4 right-4 bg-warning text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full",t.innerHTML=`<i class="fa fa-info-circle mr-2"></i>${e}`,document.body.appendChild(t),setTimeout(()=>t.classList.remove("translate-x-full"),100),setTimeout(()=>{t.classList.add("translate-x-full"),setTimeout(()=>document.body.removeChild(t),300)},5e3)}function downloadFile(e,t,r="application/octet-stream"){const n=new Blob([t],{type:r}),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=e,document.body.appendChild(a),a.click(),setTimeout(()=>{document.body.removeChild(a),URL.revokeObjectURL(s)},500)}function chartToCSV(e){if(!e)return"";const t=e.data.labels||[],r=e.data.datasets||[],n=[["分组",...r.map(e=>e.label||"")]];for(let e=0;e<t.length;e++){const s=[t[e]];for(let t=0;t<r.length;t++){const n=r[t].data&&void 0!==r[t].data[e]?r[t].data[e]:"";s.push(n)}n.push(s)}return"\ufeff"+n.map(e=>e.map(e=>{if(null==e)return"";const t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}).join(",")).join("\n")}