class SatelliteApp{constructor(){this.cycleEngine=new CycleRuleEngine,this.taskAnalyzer=new TaskResultAnalyzer,this.fieldMappingValues={idField:"id",planIdField:"plan_id",startTimeField:"start_time",taskResultField:"task_result"},this.dataStore=new DataStore(this.fieldMappingValues),this.chart=null,this.hasSavedState=!!sessionStorage.getItem("satellitePageState"),this.hasSavedStats=!!sessionStorage.getItem("satelliteStatistics"),this.loadSavedConfig(),this.bindElements(),this.bindEvents(),this.data=null,this.isInitializing=!0,this.pendingUpdates=[],this.dataStoreReady=!1,this.pendingStatsRequest=!1,this.dataStoreCacheDirty=!1,this.needFullDataStoreConstruction=!1,this.backgroundLoadingProgress=0,this.isBackgroundLoading=!1,this.backgroundLoadTarget=0,this.dataLoadingStrategy="initial",this.loadedDataRange=null,this.init()}bindElements(){this.startDate=document.getElementById("startDate"),this.endDate=document.getElementById("endDate"),this.groupBy=document.getElementById("groupBy"),this.showDataLabels=document.getElementById("showDataLabels"),this.generateChart=document.getElementById("generateChart"),this.configGroupingBtn=document.getElementById("configGroupingBtn"),this.dataChart=document.getElementById("dataChart"),this.chartEmptyState=document.getElementById("chartEmptyState"),this.chartErrorState=document.getElementById("chartErrorState"),this.chartErrorMessage=document.getElementById("chartErrorMessage"),this.chartLoadingState=document.getElementById("chartLoadingState"),this.totalCount=document.getElementById("totalCount"),this.avgCount=document.getElementById("avgCount"),this.totalFailures=document.getElementById("totalFailures"),this.avgSuccessRate=document.getElementById("avgSuccessRate"),this.maxCount=document.getElementById("maxCount"),this.minCount=document.getElementById("minCount"),this.detailTableBody=document.getElementById("detailTableBody"),this.groupingConfigModal=document.getElementById("groupingConfigModal"),this.modalContent=document.getElementById("modalContent"),this.closeConfigModal=document.getElementById("closeConfigModal"),this.saveGroupingConfig=document.getElementById("saveGroupingConfig"),this.dayStart=document.getElementById("dayStart"),this.dayStartDisplay=document.getElementById("dayStartDisplay"),this.dayEndDisplay=document.getElementById("dayEndDisplay"),this.weekStartDay=document.getElementById("weekStartDay"),this.weekStartTime=document.getElementById("weekStartTime"),this.monthStartDate=document.getElementById("monthStartDate"),this.monthStartTime=document.getElementById("monthStartTime"),this.quarterStartMonth=document.getElementById("quarterStartMonth"),this.quarterStartTime=document.getElementById("quarterStartTime"),this.dbLoading=document.getElementById("dbLoading"),this.noDataAlert=document.getElementById("noDataAlert"),this.cacheStatus=document.getElementById("cacheStatus"),this.refreshCacheBtn=document.getElementById("refreshCacheBtn"),this.clearCacheBtn=document.getElementById("clearCacheBtn"),this.cacheInfo=document.getElementById("cacheInfo"),this.satelliteCount=document.getElementById("satelliteCount"),this.customerCount=document.getElementById("customerCount"),this.satelliteCountCard=document.getElementById("satelliteCountCard"),this.customerCountCard=document.getElementById("customerCountCard"),this.satelliteCountModal=document.getElementById("satelliteCountModal"),this.satelliteModalContent=document.getElementById("satelliteModalContent"),this.closeSatelliteModal=document.getElementById("closeSatelliteModal"),this.satelliteCountChart=document.getElementById("satelliteCountChart"),this.satelliteChartEmpty=document.getElementById("satelliteChartEmpty"),this.satelliteChartLoading=document.getElementById("satelliteChartLoading"),this.customerCountModal=document.getElementById("customerCountModal"),this.customerModalContent=document.getElementById("customerModalContent"),this.closeCustomerModal=document.getElementById("closeCustomerModal"),this.customerCountChart=document.getElementById("customerCountChart"),this.customerChartEmpty=document.getElementById("customerChartEmpty"),this.customerChartLoading=document.getElementById("customerChartLoading"),this.satelliteChart=null,this.customerChart=null}bindEvents(){this.generateChart&&this.generateChart.addEventListener("click",()=>this.generateStatistics()),this.configGroupingBtn&&this.configGroupingBtn.addEventListener("click",()=>this.openGroupingConfig()),this.closeConfigModal&&this.closeConfigModal.addEventListener("click",()=>this.closeGroupingConfig()),this.saveGroupingConfig&&this.saveGroupingConfig.addEventListener("click",()=>this.saveGroupingConfiguration()),this.showDataLabels&&this.showDataLabels.addEventListener("change",()=>this.toggleDataLabels()),this.startDate&&this.startDate.addEventListener("change",()=>this.savePageState()),this.endDate&&this.endDate.addEventListener("change",()=>this.savePageState()),this.groupBy&&this.groupBy.addEventListener("change",()=>{if(this.savePageState(),this.data&&this.dataStore){const t=this.groupBy.value;console.log(`🔄 统计周期已改变为 ${t}，后台重新构建 DataStore...`),this.dataStoreReady=!1,this.buildDataStoreInBackground(t)}}),this.dayStart&&this.dayStart.addEventListener("change",t=>{this.dayStartDisplay.textContent=t.target.value,this.dayEndDisplay.textContent=t.target.value}),this.refreshCacheBtn&&this.refreshCacheBtn.addEventListener("click",()=>this.refreshCache()),this.clearCacheBtn&&this.clearCacheBtn.addEventListener("click",()=>this.clearCache()),this.satelliteCountCard&&this.satelliteCountCard.addEventListener("click",()=>this.showSatelliteCountChart()),this.customerCountCard&&this.customerCountCard.addEventListener("click",()=>this.showCustomerCountChart()),this.closeSatelliteModal&&this.closeSatelliteModal.addEventListener("click",()=>this.closeSatelliteCountModal()),this.closeCustomerModal&&this.closeCustomerModal.addEventListener("click",()=>this.closeCustomerCountModal()),document.querySelectorAll(".chart-download-btn").forEach(t=>{t.addEventListener("click",t=>{const e=t.currentTarget.getAttribute("data-chart"),a=t.currentTarget.getAttribute("data-type");let s=null;if("satelliteChart"===e?s=this.satelliteChart:"customerChart"===e?s=this.customerChart:"mainChart"===e&&(s=this.chart),s){if("image"===a)try{const t=s.toBase64Image(),a=document.createElement("a");a.href=t;const o=(new Date).toISOString().replace(/[:.]/g,"-");a.download=`${e}-${o}.png`,document.body.appendChild(a),a.click(),setTimeout(()=>document.body.removeChild(a),300),showSuccess("图表图片下载成功")}catch(t){console.error("导出图片失败",t),showError("导出图片失败，请检查浏览器支持或数据量是否过大。")}else if("csv"===a)try{const t=chartToCSV(s),a=(new Date).toISOString().replace(/[:.]/g,"-");downloadFile(`${e}-${a}.csv`,t,"text/csv;charset=utf-8;"),showSuccess("图表数据下载成功")}catch(t){console.error("导出 CSV 失败",t),showError("导出 CSV 失败，请查看控制台错误信息。")}}else showError("图表未生成，无法下载")})})}updateSkeletonProgress(t,e){const a=document.getElementById("skeleton-progress"),s=document.getElementById("skeleton-progress-percent");a&&(a.textContent=e),s&&(s.textContent=`${t}%`)}async init(){console.log("🚀 应用初始化开始...");const t=document.getElementById("skeleton-screen");document.getElementById("skeleton-progress");try{this.updateSkeletonProgress(5,"正在检查预计算统计...");const e=await cacheManager.getStatistics("bucket"),a=await cacheManager.getStatistics("customer");if(e&&a)return console.log("⚡ 发现预计算统计缓存，使用极速加载模式！"),this.precomputedStats={bucket:e,customer:a},this.usePrecomputedStats=!0,this.data=[],this.dataLoadingStrategy="precomputed",this.dataStoreReady=!1,this.updateSkeletonProgress(90,"预计算统计已加载"),this.setDefaultDates(),this.updateSkeletonProgress(100,"初始化完成！"),await new Promise(t=>setTimeout(t,300)),t&&t.classList.add("hidden"),this.generateStatistics(),void console.log("✅ 极速初始化完成（使用预计算统计）");console.log("⚠️ 预计算统计不存在，使用常规加载方式"),this.usePrecomputedStats=!1,this.updateSkeletonProgress(10,"正在读取缓存...");const s=await cacheManager.getMetadataFast();if(!(s&&s.actualCount>0))return console.warn("⚠️ 本地缓存为空，显示无数据提示"),t&&t.classList.add("hidden"),void this.noDataAlert.classList.remove("hidden");console.log("📊 缓存元数据:",s),this.displayMetadataStats(s),this.updateSkeletonProgress(20,"缓存元数据读取完成"),this.updateSkeletonProgress(30,"正在加载DataStore...");const o=this.groupBy?this.groupBy.value:"day",n=await cacheManager.loadDataStoreBuckets(o,s.lastUpdated);if(n&&n.buckets){console.log("🚀 使用缓存的DataStore桶结构（极速加载）"),this.updateSkeletonProgress(50,"正在恢复DataStore...");const t=performance.now();this.dataStore.buckets=new Map(n.buckets),this.dataStoreReady=!0;const e=performance.now()-t;console.log(`✅ DataStore恢复完成: ${this.dataStore.buckets.size} 个桶 (${e.toFixed(0)}ms, ${(this.dataStore.buckets.size/(e/1e3)).toFixed(0)} 桶/秒)`),this.updateSkeletonProgress(90,"DataStore恢复完成"),this.data=[],this.dataLoadingStrategy="lazy",console.log("⚡ 跳过 this.data 加载（DataStore缓存已包含所有统计数据）"),console.log("💡 仅在需要时（导出/实时更新）才按需加载原始数据"),this.loadedDataRange=null,this.needFullDataStoreConstruction=!1}else{console.log("⚠️ DataStore缓存未命中，使用快速初始化策略"),this.updateSkeletonProgress(40,"正在快速初始化...");const t=performance.now();this.data=[];let e=0;this.dataStore.clear();const a=new Date;a.setDate(a.getDate()-7),await cacheManager.queryDateRangeFromShards(a,new Date,t=>{e+=t.length,this.data.push(...t),this.dataStore.addRecordsToBucketBatch(t,this.cycleEngine,o);const a=40+Math.min(40,Math.floor(e/50));this.updateSkeletonProgress(a,`正在初始化... ${e} 条`)},5e3);const s=performance.now()-t;console.log(`✅ 快速初始化完成: ${e} 条（最近1周） (${s.toFixed(0)}ms)`),this.updateSkeletonProgress(85,"快速初始化完成"),this.dataStoreReady=!1,this.dataLoadingStrategy="quick",this.loadedDataRange={start:a,end:new Date},console.log(`📅 已加载数据范围: ${a.toLocaleDateString()} - ${(new Date).toLocaleDateString()}`),this.needFullDataStoreConstruction=!0}if(0===this.data.length&&"lazy"!==this.dataLoadingStrategy)return console.warn("⚠️ 本地缓存为空"),t&&t.classList.add("hidden"),void this.noDataAlert.classList.remove("hidden");if(this.noDataAlert.classList.add("hidden"),this.updateSkeletonProgress(92,"正在恢复页面状态..."),this.hasSavedState){this.restorePageState()&&console.log("✅ 页面状态已从sessionStorage恢复")}else this.setDefaultDates();if(this.updateSkeletonProgress(96,"正在渲染图表..."),this.hasSavedStats){this.restoreStatisticsResult()&&console.log("✅ 统计结果已从sessionStorage恢复")}if(this.updateSkeletonProgress(100,"初始化完成！"),await new Promise(t=>setTimeout(t,300)),t&&t.classList.add("hidden"),!this.dataStoreReady||this.needFullDataStoreConstruction?(console.log("✅ 页面初始化完成（DataStore将在后台构建）"),this.buildDataStoreInBackground(o)):console.log("✅ 页面初始化完成（DataStore已就绪，跳过后台构建）"),setTimeout(()=>{this.updateCacheStatus()},100),setTimeout(()=>this.backgroundPreload(),2e3),this.collapseInstructionsAfterLoad(),console.log("✅ 应用初始化完成"),window.sharedDataManager&&(this.data&&this.data.length>0?(window.sharedDataManager.notifyDataLoaded(this.data,"index"),console.log(`📡 已通知 SharedDataManager 数据已加载: ${this.data.length.toLocaleString()} 条`)):"lazy"===this.dataLoadingStrategy&&(console.log("⚡ 延迟加载模式：快速加载数据以支持跨页面共享..."),setTimeout(async()=>{try{const t=await cacheManager.getAllDataFast();this.data=t,window.sharedDataManager.notifyDataLoaded(t,"index"),console.log(`📡 已通知 SharedDataManager 数据已加载（延迟）: ${t.length.toLocaleString()} 条`)}catch(t){console.error("❌ 延迟加载数据失败:",t)}},100))),this.isInitializing=!1,this.pendingUpdates.length>0){console.log(`🔄 初始化完成，处理暂存的 ${this.pendingUpdates.length} 条更新...`);const t=[...this.pendingUpdates];this.pendingUpdates=[],t.forEach(({operation:t,record:e})=>{this.handleRealtimeUpdate(t,e)}),console.log("✅ 暂存更新已全部应用")}}catch(e){console.error("❌ 初始化失败:",e),t&&t.classList.add("hidden"),showError("数据加载失败: "+(e.message||e)),this.isInitializing=!1}}appendDataBatch(t,e){this.dataStore&&this.dataStore.addRecordsToBucketBatch(t,this.cycleEngine,e)}displayMetadataStats(t){console.log(`📊 缓存元数据: ${t.actualCount} 条记录`),t.minDate&&t.maxDate&&console.log(`📅 数据范围: ${t.minDate.toLocaleDateString()} - ${t.maxDate.toLocaleDateString()}`)}showBackgroundLoadingIndicator(){const t=document.getElementById("dbLoading"),e=document.getElementById("dbLoadingText"),a=document.getElementById("dbLoadingProgressBar");t&&e&&(t.classList.remove("hidden"),e.textContent="正在后台加载历史数据...",a&&a.classList.remove("hidden"))}updateBackgroundLoadingIndicator(t,e,a){const s=document.getElementById("dbLoading"),o=document.getElementById("dbLoadingText"),n=document.getElementById("dbLoadingProgressBar"),i=document.getElementById("dbLoadingProgressFill"),r=document.getElementById("dbLoadingProgressText"),l=document.getElementById("dbLoadingCountText");s&&o&&(s.classList.remove("hidden"),o.textContent="正在后台加载历史数据...",n&&n.classList.remove("hidden"),i&&(i.style.width=`${a}%`),r&&(r.textContent=`${a}%`),l&&(l.textContent=`${t.toLocaleString()} / ${e.toLocaleString()}`),a>=100&&setTimeout(()=>{s&&s.classList.add("hidden"),n&&n.classList.add("hidden")},3e3))}async ensureDataLoaded(t=3){if("lazy"!==this.dataLoadingStrategy||this.data.length>0)return;console.log(`🔄 按需加载 this.data（最近${t}个月）...`);const e=performance.now();try{let a=0;await cacheManager.queryRecentMonthsFromShards(t,t=>{a+=t.length,this.data.push(...t)},5e3);const s=performance.now()-e;console.log(`✅ this.data 按需加载完成: ${a.toLocaleString()} 条 (${s.toFixed(0)}ms)`),this.dataLoadingStrategy="loaded"}catch(t){throw console.error("❌ 按需加载 this.data 失败:",t),t}}async loadDateRangeOnDemand(t,e,a,s){try{console.log(`🎯 优先加载日期范围: ${t.toLocaleDateString()} - ${e.toLocaleDateString()}`),this.showBackgroundLoadingIndicator();const o=this.data?this.data.filter(a=>{const s=new Date(a.start_time||a["开始时间"]);return s>=t&&s<=e}):[];console.log(`   已加载数据: ${o.length} 条`);const n=[];let i=0;const r=performance.now();await cacheManager.queryDateRangeFromShards(t,e,t=>{i+=t.length,n.push(...t),this.dataStore.addRecordsToBucketBatch(t,this.cycleEngine,a);const e=new Set(this.data.map(t=>this.dataStore.getRecordKey(t))),o=t.filter(t=>!e.has(this.dataStore.getRecordKey(t)));this.data.push(...o),s&&s(i,n.length),this.updateBackgroundLoadingIndicator(i,i,100)},5e3);const l=performance.now()-r;return console.log(`✅ 目标范围数据加载完成: ${i.toLocaleString()} 条 (${l.toFixed(0)}ms)`),this.loadedDataRange?(this.loadedDataRange.start=t<this.loadedDataRange.start?t:this.loadedDataRange.start,this.loadedDataRange.end=e>this.loadedDataRange.end?e:this.loadedDataRange.end):this.loadedDataRange={start:t,end:e},console.log(`📅 更新已加载范围: ${this.loadedDataRange.start.toLocaleDateString()} - ${this.loadedDataRange.end.toLocaleDateString()}`),setTimeout(()=>{const t=document.getElementById("dbLoading");t&&t.classList.add("hidden")},1e3),i}catch(t){throw console.error("❌ 按需加载失败:",t),t}}buildDataStoreInBackground(t){this.needFullDataStoreConstruction?(console.log("📦 检测到需要完整DataStore，后台加载全部数据..."),setTimeout(()=>{this.buildFullDataStoreInBackground(t)},1e3)):window.requestIdleCallback?requestIdleCallback(()=>{this.executeBuildDataStore(t)},{timeout:500}):setTimeout(()=>{this.executeBuildDataStore(t)},50)}async buildFullDataStoreInBackground(t){try{console.log("🔄 开始渐进式后台加载全部数据（用于完整DataStore）...");const e=performance.now();this.isBackgroundLoading=!0,this.backgroundLoadingProgress=0;const a=await cacheManager.getMetadataFast();this.backgroundLoadTarget=a?.actualCount||0,console.log(`📊 目标加载: ${this.backgroundLoadTarget.toLocaleString()} 条`),this.showBackgroundLoadingIndicator();const s=[];let o=0,n=Date.now();await cacheManager.queryAllDataFast(e=>{o+=e.length,s.push(...e),this.dataStore.addRecordsToBucketBatch(e,this.cycleEngine,t),this.backgroundLoadTarget>0&&(this.backgroundLoadingProgress=Math.round(o/this.backgroundLoadTarget*100)),this.updateBackgroundLoadingIndicator(o,this.backgroundLoadTarget,this.backgroundLoadingProgress);const a=Date.now();(o%5e3==0||a-n>2e3)&&(console.log(`  📦 已加载 ${o.toLocaleString()} / ${this.backgroundLoadTarget.toLocaleString()} 条 (${this.backgroundLoadingProgress}%)`),n=a,this.chart&&this.chart.data&&this.refreshChartIfNeeded())},5e3);const i=performance.now()-e;console.log(`✅ 全部数据加载完成: ${s.length.toLocaleString()} 条 (${i.toFixed(0)}ms)`);const r=this.data?this.data.length:0;this.data=s,console.log(`🔄 更新内存数据: ${r.toLocaleString()} -> ${s.length.toLocaleString()} 条`),this.dataStoreReady=!0,this.needFullDataStoreConstruction=!1,this.isBackgroundLoading=!1,this.backgroundLoadingProgress=100,console.log(`✅ 完整DataStore构建完成: ${this.dataStore.buckets.size} 个桶`);try{await cacheManager.saveDataStoreBuckets(t,this.dataStore.buckets,s.length),this.dataStoreCacheDirty=!1,console.log("💾 完整DataStore桶缓存已保存")}catch(t){console.error("⚠️ DataStore桶缓存保存失败:",t)}this.chart&&this.chart.data&&(console.log("🔄 后台加载完成，最终刷新图表"),this.generateStatistics()),this.pendingStatsRequest&&(console.log("🔄 完整DataStore就绪，执行待处理的统计请求"),this.pendingStatsRequest=!1,this.generateStatistics())}catch(t){console.error("❌ 后台加载全部数据失败:",t),this.isBackgroundLoading=!1}}refreshChartIfNeeded(){if(this._lastChartRefresh&&Date.now()-this._lastChartRefresh<3e3)return;this._lastChartRefresh=Date.now(),console.log("🔄 增量刷新图表（后台数据已更新）");const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value);if(this.dataStore&&this.dataStore.buckets.size>0){const a=this.dataStore.getStats(this.taskAnalyzer,e.startDate,e.endDate);this.updateChart(a,t),this.updateStatCards(a),this.updateDetailTable(a)}}async executeBuildDataStore(t,e=!0){console.log("🔄 后台构建DataStore...");const a=performance.now();this.dataStore.loadData(this.data,this.cycleEngine,t);const s=performance.now()-a;if(console.log(`✅ DataStore构建完成: ${this.dataStore.buckets.size} 个桶 (${s.toFixed(0)}ms)`),this.dataStoreReady=!0,e)try{await cacheManager.saveDataStoreBuckets(t,this.dataStore.buckets,this.data.length),this.dataStoreCacheDirty=!1}catch(t){console.error("⚠️ DataStore桶缓存保存失败（非阻塞）:",t)}this.pendingStatsRequest&&(console.log("🔄 DataStore就绪，执行待处理的统计请求"),this.pendingStatsRequest=!1,this.generateStatistics())}async backgroundPreload(){try{console.log("🔄 后台预加载数据...")}catch(t){console.warn("⚠️ 后台预加载失败（非致命）:",t)}}collapseInstructionsAfterLoad(){"function"==typeof window.collapseInstructions&&window.collapseInstructions()}async handleRealtimeUpdate(t,e){if(this.isInitializing)return this.pendingUpdates.push({operation:t,record:e}),void console.log(`📦 初始化中，暂存更新: ${t} (队列长度: ${this.pendingUpdates.length})`);if(!this.data)return void console.warn("⚠️ 应用未初始化，忽略实时更新");if("lazy"===this.dataLoadingStrategy&&0===this.data.length){console.log("🔄 首次实时更新，触发按需加载 this.data...");try{await this.ensureDataLoaded(3)}catch(t){console.error("❌ 按需加载失败，实时更新将仅更新DataStore")}}const a=performance.now();try{const s=this.groupBy?this.groupBy.value:"day",o=new Set,n=this.dataStore.getRecordKey(e);let i=!1;if(this.dataStoreReady&&!this.needFullDataStoreConstruction)i=!0;else{const t=new Date(e.start_time||e["开始时间"]),a=new Date;a.setMonth(a.getMonth()-3),i=t>=a}if("insert"===t||"update"===t){const t=this.data.findIndex(t=>this.dataStore.getRecordKey(t)===n);if(t>=0){this.dataStore.updateRecord(e,this.cycleEngine,s,!1).forEach(t=>o.add(t)),this.data[t]=e,console.log(`🔄 更新内存记录: ${n}`)}else if(i){this.data.push(e);const t=this.dataStore.addRecordToBucket(e,this.cycleEngine,s);t&&o.add(t),console.log(`➕ 新增内存记录: ${n}`)}else{const t=new Date(e.start_time||e["开始时间"]);console.warn(`⚠️ 超出范围的数据更新 (${t.toLocaleDateString()})，仅更新DataStore桶`);const a=this.dataStore.addRecordToBucket(e,this.cycleEngine,s);a&&o.add(a),this.dataStoreCacheDirty=!0}}else if("delete"===t){const t=this.data.findIndex(t=>this.dataStore.getRecordKey(t)===n);if(t>=0){this.dataStore.updateRecord(this.data[t],this.cycleEngine,s,!0).forEach(t=>o.add(t)),this.data.splice(t,1),console.log(`🗑️ 删除内存记录: ${n}`)}else console.warn(`⚠️ 历史数据删除 (${n})，尝试从DataStore移除`);this.dataStoreCacheDirty=!0}const r=performance.now()-a;console.log(`⚡ 实时数据更新完成 (${r.toFixed(2)}ms)，影响 ${o.size} 个桶`),this.chart&&o.size>0?(console.log(`📊 检测到数据变更，增量刷新图表 (${o.size} 个桶)...`),this.updateChartIncremental(Array.from(o))):o.size>0&&console.log("💡 数据已更新，但当前无图表显示，跳过刷新")}catch(t){console.error("❌ 处理实时更新失败:",t)}}async updateCacheStatus(){try{const t=await cacheManager.checkAllDataCache();t?(this.cacheStatus.textContent="✅ 已缓存",this.cacheStatus.className="text-xs px-2 py-1 rounded-full bg-success/10 text-success",this.cacheInfo.textContent=`${t.totalCount} 条数据 · ${new Date(t.lastUpdated).toLocaleString()}`):(this.cacheStatus.textContent="❌ 无缓存",this.cacheStatus.className="text-xs px-2 py-1 rounded-full bg-danger/10 text-danger",this.cacheInfo.textContent="暂无本地缓存数据")}catch(t){this.cacheStatus.textContent="⚠️ 检查失败",this.cacheStatus.className="text-xs px-2 py-1 rounded-full bg-warning/10 text-warning",this.cacheInfo.textContent="缓存状态检查失败"}}async refreshCache(){try{this.refreshCacheBtn.disabled=!0,this.refreshCacheBtn.innerHTML='<i class="fa fa-spinner fa-spin mr-1"></i>刷新中...',console.log("🔄 用户手动刷新缓存..."),await cacheManager.clearDataStoreBucketsCache();const t=await dataPreloader.autoPreloadAllData();t.success&&(showSuccess(`缓存刷新成功！更新了 ${t.totalCount} 条数据`),await this.init()),this.updateCacheStatus()}catch(t){console.error("❌ 缓存刷新失败:",t),showError("缓存刷新失败: "+t.message)}finally{this.refreshCacheBtn.disabled=!1,this.refreshCacheBtn.innerHTML='<i class="fa fa-refresh mr-1"></i>刷新缓存'}}async clearCache(){if(confirm("确定要清空本地缓存吗？下次访问将重新从数据库加载数据。"))try{this.clearCacheBtn.disabled=!0,this.clearCacheBtn.innerHTML='<i class="fa fa-spinner fa-spin mr-1"></i>清空中...',console.log("🧹 用户清空缓存..."),await cacheManager.clearDataStoreBucketsCache(),await cacheManager.clearAllDataCache(),this.data=null,this.noDataAlert.classList.remove("hidden"),this.chart&&(this.chart.destroy(),this.chart=null),this.satelliteChart&&(this.satelliteChart.destroy(),this.satelliteChart=null),this.customerChart&&(this.customerChart.destroy(),this.customerChart=null),this.updateStatCards([]),this.updateDetailTable([]),showSuccess("本地缓存已清空"),this.updateCacheStatus()}catch(t){console.error("❌ 清空缓存失败:",t),showError("清空缓存失败: "+t.message)}finally{this.clearCacheBtn.disabled=!1,this.clearCacheBtn.innerHTML='<i class="fa fa-trash mr-1"></i>清空缓存'}}setDefaultDates(){const t=new Date,e=new Date;e.setDate(t.getDate()-7);const a=t=>`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;this.startDate&&(this.startDate.value=a(e)),this.endDate&&(this.endDate.value=a(t))}parseDateInputToLocal(t,e=0,a=0,s=0,o=0){if(!t)return null;const n=t.split("-").map(Number),i=n[0],r=n[1]-1,l=n[2];return new Date(i,r,l,e,a,s,o)}computeDateRangeForGroup(t,e,a){let s=null,o=null;const n=t=>{if(!t)return null;const e=t.split("-").map(Number);let a=this.cycleEngine.config.day.start;const[s=0,o=0]=a.split(":").map(t=>parseInt(t,10));return new Date(e[0],e[1]-1,e[2],s,o,0,0)};try{if(e){const a=n(e),o=this.cycleEngine.getGroup(a,t),i=this.parseDateInputToLocal(e,0,0,0,0);s=o.rangeStart<i?i:o.rangeStart}if(a){const e=n(a),s=(this.cycleEngine.getGroup(e,t),new Date(e));s.setDate(s.getDate()+1);o=this.cycleEngine.getGroup(s,t).rangeStart}}catch(t){console.warn("计算日期范围失败，回退到基于本地日历的默认解析",t),e&&(s=this.parseDateInputToLocal(e,0,0,0,0)),a&&(o=this.parseDateInputToLocal(a,23,59,59,999))}return{startDate:s,endDate:o}}async generateStatistics(){const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),a=e.startDate,s=e.endDate;if(this.usePrecomputedStats&&this.precomputedStats){console.log("⚡ 使用预计算统计生成图表（秒开！）");const e=performance.now(),o=this.precomputedStats.bucket["day"===t?"daily":"week"===t?"weekly":"monthly"]||{},n=this.convertPrecomputedToChartData(o,a,s,t);this.updateChart(n,t),this.updateStatCards(n),this.updateDetailTable(n);const i=performance.now()-e;return void console.log(`✅ 预计算统计图表渲染完成 (${i.toFixed(0)}ms) - 99%性能提升！`)}if(this.data||this.dataStore){if(a&&s&&!this.dataStoreReady){let e=!1,o="";if("quick"===this.dataLoadingStrategy&&this.loadedDataRange){(a<this.loadedDataRange.start||s>this.loadedDataRange.end)&&(e=!0,o=`范围超出已加载: ${this.loadedDataRange.start.toLocaleDateString()} - ${this.loadedDataRange.end.toLocaleDateString()}`)}if(!e&&this.data&&this.data.length>0){const t=this.data.filter(t=>{const e=new Date(t.start_time||t["开始时间"]);return e>=a&&e<=s});Math.ceil((s-a)/864e5)>7&&t.length<100&&(e=!0,o=`数据不足: ${t.length} 条`)}if(e){const e=Math.ceil((s-a)/864e5);console.log(`🎯 检测到需要按需加载: 目标范围 ${e} 天，原因: ${o}`),this.chartLoadingState.classList.remove("hidden"),this.chartEmptyState.classList.add("hidden"),this.chartErrorState.classList.add("hidden");try{let e=0,o=0;showInfo("正在加载历史数据，图表将实时更新..."),await this.loadDateRangeOnDemand(a,s,t,(n,i)=>{const r=Date.now();if(r-e>1e3||n%5e3==0){o++,console.log(`   🎬 渐进式渲染 #${o}: ${n} / ${i} 条`),e=r;const l=this.dataStore.getStats(this.taskAnalyzer,a,s);l.length>0&&(this.updateChart(l,t,!0),this.updateStatCards(l),this.updateDetailTable(l))}}),console.log("✅ 目标范围加载完成，最终渲染");const n=this.dataStore.getStats(this.taskAnalyzer,a,s);return this.updateChart(n,t),this.updateStatCards(n),this.updateDetailTable(n),this.saveStatisticsResult(n,t),this.chartLoadingState.classList.add("hidden"),void(this.isBackgroundLoading||(console.log("🔄 继续后台加载剩余历史数据..."),setTimeout(()=>{this.buildFullDataStoreInBackground(t)},1e3)))}catch(t){console.error("❌ 按需加载失败:",t)}}}if(!this.dataStoreReady&&0===this.dataStore.buckets.size)return console.log("⏳ DataStore正在初始化，统计请求已排队..."),this.pendingStatsRequest=!0,this.chartLoadingState.classList.remove("hidden"),this.chartEmptyState.classList.add("hidden"),void this.chartErrorState.classList.add("hidden");!this.dataStoreReady&&this.isBackgroundLoading&&(console.warn(`⚠️ 使用部分数据生成图表 (${this.backgroundLoadingProgress}% 已加载)`),showWarning(`正在后台加载历史数据 (${this.backgroundLoadingProgress}%)，图表将显示部分数据并自动更新`)),this.chartLoadingState.classList.remove("hidden"),this.chartEmptyState.classList.add("hidden"),this.chartErrorState.classList.add("hidden"),this.detailTableBody.innerHTML="";try{let e;if(console.log("📊 开始生成统计结果（基于本地缓存数据）..."),this.dataStore&&this.dataStore.buckets.size>0){const t=performance.now();e=this.dataStore.getStats(this.taskAnalyzer,a,s);const o=performance.now()-t;console.log(`⚡ 使用桶查询生成统计 (${o.toFixed(2)}ms, ${e.length} 个桶)`)}else console.log("⚠️ DataStore 未初始化，使用传统遍历方法"),e=this.groupDataByCycle(t,a,s),console.log(`📈 生成统计组数: ${e.length}`);this.updateChart(e,t),this.updateStatCards(e),this.updateDetailTable(e),this.saveStatisticsResult(e,t)}catch(t){console.error("❌ 生成统计结果失败:",t),this.chartErrorMessage.textContent="生成统计结果时出错: "+t.message,this.chartErrorState.classList.remove("hidden")}finally{this.chartLoadingState.classList.add("hidden")}}else showError("当前没有数据，请先导入数据后重试")}groupDataByCycle(t,e,a){const s={},{planIdField:o,startTimeField:n,taskResultField:i}=this.fieldMappingValues;this.data.forEach(r=>{try{const l=r[n];let c;if(l instanceof Date)c=this.cycleEngine.createFileDate(l);else if("string"==typeof l)c=new Date(l);else{if("number"!=typeof l)return void console.warn("无法解析时间:",r);c=new Date(864e5*(l-25569))}if(isNaN(c.getTime()))return void console.warn("无效的日期值:",l);if(e&&c<e)return;if(a&&c>=a)return;const d=this.cycleEngine.getGroup(c,t);s[d.key]||(s[d.key]={key:d.key,label:d.label,count:0,planIds:new Set,results:[],rangeStart:d.rangeStart,rangeEnd:d.rangeEnd});const h=s[d.key];h.planIds.add(r[o]),h.count=h.planIds.size,h.results.push(r[i]||"未知")}catch(t){console.warn("处理数据项失败:",r,t)}});const r=Object.values(s).sort((t,e)=>t.rangeStart-e.rangeStart);return r.forEach(t=>{t.failureCount=this.taskAnalyzer.countFailures(t.results),t.successRate=this.taskAnalyzer.calculateSuccessRate(t.results,t.count)}),r}updateChart(t,e,a=!1){if(!t||0===t.length)return this.chartEmptyState.classList.remove("hidden"),void(this.chart&&(this.chart.destroy(),this.chart=null));this.chartEmptyState.classList.add("hidden");const s=t.map(t=>t.label),o=t.map(t=>t.count),n=t.map(t=>t.failureCount),i=t.map(t=>parseFloat(t.successRate.toFixed(3))),r=this.showDataLabels.checked;if(this.chart&&a)return this.chart.data.labels=s,this.chart.data.datasets[0].data=o,this.chart.data.datasets[1].data=n,this.chart.data.datasets[2].data=i,void this.chart.update("none");this.chart&&this.chart.destroy();const l=this.dataChart.getContext("2d");Chart.register(ChartDataLabels),this.chart=new Chart(l,{type:"line",data:{labels:s,datasets:[{label:"计划ID数量",data:o,borderColor:"#165DFF",backgroundColor:"rgba(22, 93, 255, 0.1)",borderWidth:2,fill:!1,tension:.3,yAxisID:"y",datalabels:{display:r,color:"#165DFF",anchor:"end",align:"top",font:{size:10,weight:"bold"}}},{label:"失败圈次计数",data:n,borderColor:"#F53F3F",backgroundColor:"rgba(245, 63, 63, 0.1)",borderWidth:2,fill:!1,tension:.3,yAxisID:"y",datalabels:{display:r,color:"#F53F3F",anchor:"end",align:"bottom",font:{size:10,weight:"bold"}}},{label:"成功率(%)",data:i,borderColor:"#00B42A",backgroundColor:"rgba(0, 180, 42, 0.1)",borderWidth:2,fill:!1,tension:.3,yAxisID:"y1",pointRadius:4,pointBackgroundColor:"#00B42A",datalabels:{display:r,color:"#00B42A",anchor:"end",align:"top",font:{size:10,weight:"bold"},formatter:function(t){return t+"%"}}}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:30,bottom:10,left:10,right:10}},interaction:{mode:"index",intersect:!1},scales:{y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"数量"},beginAtZero:!0},y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"成功率(%)"},min:0,max:100,grid:{drawOnChartArea:!1}}},plugins:{legend:{display:!0,position:"bottom",labels:{padding:15,font:{size:12}}},datalabels:{display:r},tooltip:{callbacks:{label:function(t){let e=t.dataset.label||"";return e&&(e+=": "),2===t.datasetIndex?e+=t.parsed.y+"%":e+=t.parsed.y,e}}}}}})}updateChartIncremental(t){if(console.log("🔍 开始增量更新，受影响的桶:",t),!this.chart)return void console.warn("⚠️ 图表不存在，跳过增量更新");if(!this.dataStore||0===t.length)return void console.warn("⚠️ DataStore 不存在或无受影响的桶，跳过更新");const e=performance.now();try{const a=this.groupBy.value,s=this.computeDateRangeForGroup(a,this.startDate.value,this.endDate.value),o=s.startDate,n=s.endDate;console.log(`📊 从 DataStore 获取统计数据 (${a}): ${o?.toLocaleDateString()} - ${n?.toLocaleDateString()}`);const i=this.dataStore.getStats(this.taskAnalyzer,o,n);console.log(`📈 获取到 ${i.length} 个统计分组`);const r=new Map;i.forEach((t,e)=>{r.set(t.key,e)});let l=0;t.forEach(t=>{const e=r.get(t);if(console.log(`🔍 查找桶 ${t} 的索引: ${e}`),void 0!==e&&e<this.chart.data.labels.length){const t=i[e];console.log(`📊 更新索引 ${e} 的数据: count=${t.count}, failure=${t.failureCount}, rate=${t.successRate.toFixed(3)}%`),this.chart.data.datasets[0].data[e]=t.count,this.chart.data.datasets[1].data[e]=t.failureCount,this.chart.data.datasets[2].data[e]=parseFloat(t.successRate.toFixed(3)),l++}else console.warn(`⚠️ 桶 ${t} 不在当前显示范围内 (index: ${e}, chart labels: ${this.chart.data.labels.length})`)}),console.log("🔄 刷新图表显示..."),this.chart.update("none"),this.updateStatCards(i),this.updateDetailTable(i),this.saveStatisticsResult(i,a);const c=performance.now()-e;console.log(`✅ 增量更新完成 (${c.toFixed(2)}ms)，更新了 ${l}/${t.length} 个数据点`)}catch(t){console.error("❌ 增量更新失败:",t),console.error("错误堆栈:",t.stack)}}toggleDataLabels(){if(this.chart){const t=this.showDataLabels.checked;this.chart.data.datasets.forEach(e=>{e.datalabels&&(e.datalabels.display=t)}),this.chart.update("none")}}updateStatCards(t){if(!t||0===t.length)return this.totalCount.textContent="0",this.avgCount.textContent="0",this.totalFailures.textContent="0",this.avgSuccessRate.textContent="0%",this.maxCount&&(this.maxCount.textContent="0"),this.minCount&&(this.minCount.textContent="0"),this.satelliteCount&&(this.satelliteCount.textContent="0"),void(this.customerCount&&(this.customerCount.textContent="0"));const e=t.reduce((t,e)=>t+e.count,0);this.totalCount.textContent=e;const a=(e/t.length).toFixed(1);this.avgCount.textContent=a;const s=t.reduce((t,e)=>t+e.failureCount,0);this.totalFailures.textContent=s;const o=t.filter(t=>t.count>0).map(t=>t.successRate),n=o.length>0?(o.reduce((t,e)=>t+e,0)/o.length).toFixed(3):0;this.avgSuccessRate.textContent=`${n}%`;const i=t.map(t=>t.count);this.maxCount&&(this.maxCount.textContent=Math.max(...i)),this.minCount&&(this.minCount.textContent=Math.min(...i)),this.updateEntityCounts(t)}updateDetailTable(t){if(this.detailTableBody.innerHTML="",!t||0===t.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=5,e.className="px-6 py-4 text-center text-gray-500",e.textContent="没有符合条件的数据",t.appendChild(e),void this.detailTableBody.appendChild(t)}t.forEach(t=>{const e=document.createElement("tr"),a=document.createElement("td");a.className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",a.textContent=t.label,e.appendChild(a);const s=document.createElement("td");s.className="px-6 py-4 whitespace-nowrap text-sm text-gray-500",s.textContent=t.count,e.appendChild(s);const o=document.createElement("td");o.className="px-6 py-4 whitespace-nowrap text-sm text-danger",o.textContent=t.failureCount,e.appendChild(o);const n=document.createElement("td");n.className="px-6 py-4 whitespace-nowrap text-sm text-success",n.textContent=`${t.successRate.toFixed(3)}%`,e.appendChild(n);const i=document.createElement("td");i.className="px-6 py-4 whitespace-nowrap text-sm text-gray-500",i.textContent=`${this.formatDateForDisplayCorrected(t.rangeStart)} 至 ${this.formatDateForDisplayCorrected(t.rangeEnd)}`,e.appendChild(i),this.detailTableBody.appendChild(e)})}formatDateForDisplay(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}formatDateForDisplayCorrected(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}openGroupingConfig(){console.log("🚀 openGroupingConfig 被调用"),console.log("📋 groupingConfigModal:",this.groupingConfigModal),console.log("📋 modalContent:",this.modalContent),this.updateGroupingConfigForm(),this.groupingConfigModal?(this.groupingConfigModal.classList.remove("hidden"),console.log("✅ 模态框显示"),setTimeout(()=>{this.modalContent?(this.modalContent.classList.remove("scale-95","opacity-0"),this.modalContent.classList.add("scale-100","opacity-100"),console.log("✅ 模态框动画完成")):console.error("❌ modalContent 未找到")},10)):console.error("❌ groupingConfigModal 未找到")}closeGroupingConfig(){this.modalContent.classList.remove("scale-100","opacity-100"),this.modalContent.classList.add("scale-95","opacity-0"),setTimeout(()=>{this.groupingConfigModal.classList.add("hidden")},300)}updateGroupingConfigForm(){const t=this.cycleEngine.config,e=this.correctTimeDisplayForGear(t.day.start);this.dayStart.value=e,this.dayStartDisplay.textContent=e,this.dayEndDisplay.textContent=e,this.weekStartDay.value=t.week.startDay,this.weekStartTime.value=this.correctTimeDisplayForGear(t.week.startTime),this.monthStartDate.value=t.month.startDate,this.monthStartTime.value=this.correctTimeDisplayForGear(t.month.startTime),this.quarterStartMonth.value=t.quarter.startMonth,this.quarterStartTime.value=this.correctTimeDisplayForGear(t.quarter.startTime)}correctTimeDisplayForGear(t){return t}correctTimeInputForStorage(t){return t}findFieldValue(t,e){for(const a of e)if(void 0!==t[a]&&null!==t[a]&&""!==t[a])return t[a];const a=Object.keys(t);for(const s of e){const e=a.find(t=>t.toLowerCase().includes(s.toLowerCase())||t.includes(s));if(e&&void 0!==t[e]&&null!==t[e]&&""!==t[e])return t[e]}return null}updateEntityCounts(t){if(!t||0===t.length)return this.satelliteCount&&(this.satelliteCount.textContent="0"),void(this.customerCount&&(this.customerCount.textContent="0"));const e=new Set,a=new Set,{planIdField:s,startTimeField:o,taskResultField:n}=this.fieldMappingValues;if(this.data){const t=this.groupBy.value,s=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),n=s.startDate,i=s.endDate;this.data.forEach(t=>{try{const s=t[o];let r;if(s instanceof Date)r=this.cycleEngine.createFileDate(s);else if("string"==typeof s)r=new Date(s);else{if("number"!=typeof s)return;r=new Date(864e5*(s-25569))}if(isNaN(r.getTime()))return;if(n&&r<n)return;if(i&&r>=i)return;const l=this.findFieldValue(t,["satellite_name","satellite","卫星名称","卫星","星"]),c=this.findFieldValue(t,["customer","client","客户","用户","所属客户"]);l&&""!==l.toString().trim()&&e.add(l.toString().trim()),c&&""!==c.toString().trim()&&a.add(c.toString().trim())}catch(e){console.warn("处理实体数据项失败:",t,e)}})}this.satelliteCount&&(this.satelliteCount.textContent=e.size),this.customerCount&&(this.customerCount.textContent=a.size),console.log("卫星数量统计:",e.size,"个卫星:",Array.from(e).slice(0,10)),console.log("客户数量统计:",a.size,"个客户:",Array.from(a).slice(0,10))}async saveGroupingConfiguration(){const t={day:{start:this.correctTimeInputForStorage(this.dayStart.value)},week:{startDay:parseInt(this.weekStartDay.value),startTime:this.correctTimeInputForStorage(this.weekStartTime.value)},month:{startDate:parseInt(this.monthStartDate.value),startTime:this.correctTimeInputForStorage(this.monthStartTime.value)},quarter:{startMonth:parseInt(this.quarterStartMonth.value),startTime:this.correctTimeInputForStorage(this.quarterStartTime.value)}};console.log("💾 保存新的周期配置:",t),console.log("🔧 更新前的配置:",this.cycleEngine.config),this.cycleEngine.updateConfig(t),console.log("✅ 更新后的配置:",this.cycleEngine.config);try{const t=JSON.parse(localStorage.getItem("satelliteAppData")||"{}");t.cycleConfig=this.cycleEngine.config,localStorage.setItem("satelliteAppData",JSON.stringify(t)),console.log("💾 配置已保存到本地存储")}catch(t){console.warn("保存配置失败:",t)}if(console.log("🔄 配置已更新，重新加载 DataStore..."),this.data&&this.dataStore){const t=this.groupBy.value;this.dataStore.loadData(this.data,this.cycleEngine,t)}console.log("🔄 重新生成统计..."),this.generateStatistics(),showSuccess("周期配置已更新，统计数据已刷新"),this.closeGroupingConfig()}loadSavedConfig(){try{const t=JSON.parse(localStorage.getItem("satelliteAppData")||"{}");t.cycleConfig&&(console.log("🔧 加载保存的配置:",t.cycleConfig),this.cycleEngine.updateConfig(t.cycleConfig),console.log("✅ 配置加载完成:",this.cycleEngine.config),setTimeout(()=>{this.updateGroupingConfigForm&&this.updateGroupingConfigForm()},100))}catch(t){console.warn("加载配置失败:",t)}}savePageState(){try{const t={startDate:this.startDate?.value||"",endDate:this.endDate?.value||"",groupBy:this.groupBy?.value||"day",showDataLabels:this.showDataLabels?.checked||!1,timestamp:Date.now()};sessionStorage.setItem("satellitePageState",JSON.stringify(t)),console.log("💾 页面状态已保存:",t)}catch(t){console.warn("保存页面状态失败:",t)}}restorePageState(){try{const t=sessionStorage.getItem("satellitePageState");if(!t)return console.log("📋 无保存的页面状态"),!1;const e=JSON.parse(t);return console.log("🔄 恢复页面状态:",e),e.startDate&&this.startDate&&(this.startDate.value=e.startDate),e.endDate&&this.endDate&&(this.endDate.value=e.endDate),e.groupBy&&this.groupBy&&(this.groupBy.value=e.groupBy),this.showDataLabels&&(this.showDataLabels.checked=e.showDataLabels||!1),console.log("✅ 页面状态恢复完成"),!0}catch(t){return console.warn("恢复页面状态失败:",t),!1}}clearPageState(){try{sessionStorage.removeItem("satellitePageState"),console.log("🗑️ 页面状态已清空")}catch(t){console.warn("清空页面状态失败:",t)}}saveStatisticsResult(t,e){try{if(!t||0===t.length)return void console.log("📊 统计结果为空，不保存");const a={stats:t,groupType:e,generatedAt:Date.now()};sessionStorage.setItem("satelliteStatistics",JSON.stringify(a)),console.log("💾 统计结果已保存:",{statsCount:t.length,groupType:e})}catch(t){console.warn("保存统计结果失败:",t)}}restoreStatisticsResult(){try{const t=sessionStorage.getItem("satelliteStatistics");if(!t)return console.log("📊 无保存的统计结果"),!1;const e=JSON.parse(t);return console.log("🔄 恢复统计结果:",{statsCount:e.stats.length,groupType:e.groupType,generatedAt:new Date(e.generatedAt).toLocaleString()}),this.chartLoadingState&&this.chartLoadingState.classList.add("hidden"),this.chartEmptyState&&this.chartEmptyState.classList.add("hidden"),requestAnimationFrame(()=>{this.updateChart(e.stats,e.groupType),this.updateStatCards(e.stats),this.updateDetailTable(e.stats),console.log("✅ 统计结果恢复完成")}),!0}catch(t){return console.warn("恢复统计结果失败:",t),!1}}clearStatisticsResult(){try{sessionStorage.removeItem("satelliteStatistics"),console.log("🗑️ 统计结果已清空")}catch(t){console.warn("清空统计结果失败:",t)}}showSatelliteCountChart(){this.data&&this.fieldMappingValues?(this.satelliteCountModal.classList.remove("hidden"),setTimeout(()=>{this.satelliteModalContent.classList.remove("scale-95","opacity-0"),this.satelliteModalContent.classList.add("scale-100","opacity-100")},10),this.generateSatelliteCountChart()):showError("当前没有数据，请先导入数据后重试")}showCustomerCountChart(){this.data&&this.fieldMappingValues?(this.customerCountModal.classList.remove("hidden"),setTimeout(()=>{this.customerModalContent.classList.remove("scale-95","opacity-0"),this.customerModalContent.classList.add("scale-100","opacity-100")},10),this.generateCustomerCountChart()):showError("当前没有数据，请先导入数据后重试")}closeSatelliteCountModal(){this.satelliteModalContent.classList.remove("scale-100","opacity-100"),this.satelliteModalContent.classList.add("scale-95","opacity-0"),setTimeout(()=>{this.satelliteCountModal.classList.add("hidden")},300)}closeCustomerCountModal(){this.customerModalContent.classList.remove("scale-100","opacity-100"),this.customerModalContent.classList.add("scale-95","opacity-0"),setTimeout(()=>{this.customerCountModal.classList.add("hidden")},300)}generateSatelliteCountChart(){this.satelliteChartLoading.classList.remove("hidden"),this.satelliteChartEmpty.classList.add("hidden");try{this.satelliteChart&&this.satelliteChart.destroy();const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),a=e.startDate,s=e.endDate,o=this.groupSatelliteDataByCycle(t,a,s);if(0===o.length)return void this.satelliteChartEmpty.classList.remove("hidden");const n=o.map(t=>t.label),i=o.map(t=>t.satelliteCount),r=this.satelliteCountChart.getContext("2d");this.satelliteChart=new Chart(r,{type:"line",data:{labels:n,datasets:[{label:"卫星数量",data:i,borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",borderWidth:3,fill:!0,tension:.3,pointRadius:6,pointBackgroundColor:"#2563eb",pointBorderColor:"#ffffff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:30,bottom:10,left:10,right:10}},interaction:{mode:"index",intersect:!1},scales:{y:{beginAtZero:!0,title:{display:!0,text:"卫星数量"}}},plugins:{tooltip:{callbacks:{label:function(t){return`卫星数量: ${t.parsed.y}`}}},datalabels:{display:!0,color:"#2563eb",font:{size:12,weight:"bold"},anchor:"center",align:"top",offset:8}}}})}catch(t){console.error("生成卫星数量趋势图失败:",t),this.satelliteChartEmpty.classList.remove("hidden")}finally{this.satelliteChartLoading.classList.add("hidden")}}generateCustomerCountChart(){this.customerChartLoading.classList.remove("hidden"),this.customerChartEmpty.classList.add("hidden");try{this.customerChart&&this.customerChart.destroy();const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),a=e.startDate,s=e.endDate,o=this.groupCustomerDataByCycle(t,a,s);if(0===o.length)return void this.customerChartEmpty.classList.remove("hidden");const n=o.map(t=>t.label),i=o.map(t=>t.customerCount),r=this.customerCountChart.getContext("2d");this.customerChart=new Chart(r,{type:"line",data:{labels:n,datasets:[{label:"客户数量",data:i,borderColor:"#7c3aed",backgroundColor:"rgba(124, 58, 237, 0.1)",borderWidth:3,fill:!0,tension:.3,pointRadius:6,pointBackgroundColor:"#7c3aed",pointBorderColor:"#ffffff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:30,bottom:10,left:10,right:10}},interaction:{mode:"index",intersect:!1},scales:{y:{beginAtZero:!0,title:{display:!0,text:"客户数量"}}},plugins:{tooltip:{callbacks:{label:function(t){return`客户数量: ${t.parsed.y}`}}},datalabels:{display:!0,color:"#7c3aed",font:{size:12,weight:"bold"},anchor:"center",align:"top",offset:8}}}})}catch(t){console.error("生成客户数量趋势图失败:",t),this.customerChartEmpty.classList.remove("hidden")}finally{this.customerChartLoading.classList.add("hidden")}}groupSatelliteDataByCycle(t,e,a){const s={},{planIdField:o,startTimeField:n,taskResultField:i}=this.fieldMappingValues;this.data.forEach(o=>{try{const i=o[n];let r;if(i instanceof Date)r=this.cycleEngine.createFileDate(i);else if("string"==typeof i)r=new Date(i);else{if("number"!=typeof i)return;r=new Date(864e5*(i-25569))}if(isNaN(r.getTime()))return;if(e&&r<e)return;if(a&&r>a)return;const l=this.cycleEngine.getGroup(r,t);s[l.key]||(s[l.key]={key:l.key,label:l.label,satellites:new Set,rangeStart:l.rangeStart,rangeEnd:l.rangeEnd});const c=this.findFieldValue(o,["satellite_name","satellite","卫星名称","卫星","星"]);c&&""!==c.toString().trim()&&s[l.key].satellites.add(c.toString().trim())}catch(t){console.warn("处理卫星数据项失败:",o,t)}});const r=Object.values(s).sort((t,e)=>t.rangeStart-e.rangeStart);return r.forEach(t=>{t.satelliteCount=t.satellites.size}),r}groupCustomerDataByCycle(t,e,a){const s={},{planIdField:o,startTimeField:n,taskResultField:i}=this.fieldMappingValues;this.data.forEach(o=>{try{const i=o[n];let r;if(i instanceof Date)r=this.cycleEngine.createFileDate(i);else if("string"==typeof i)r=new Date(i);else{if("number"!=typeof i)return;r=new Date(864e5*(i-25569))}if(isNaN(r.getTime()))return;if(e&&r<e)return;if(a&&r>a)return;const l=this.cycleEngine.getGroup(r,t);s[l.key]||(s[l.key]={key:l.key,label:l.label,customers:new Set,rangeStart:l.rangeStart,rangeEnd:l.rangeEnd});const c=this.findFieldValue(o,["customer","client","客户","用户","所属客户"]);c&&""!==c.toString().trim()&&s[l.key].customers.add(c.toString().trim())}catch(t){console.warn("处理客户数据项失败:",o,t)}});const r=Object.values(s).sort((t,e)=>t.rangeStart-e.rangeStart);return r.forEach(t=>{t.customerCount=t.customers.size}),r}convertPrecomputedToChartData(t,e,a,s){const o=[];for(const n in t){const i=t[n];let r,l;if("day"===s?(r=new Date(n),l=new Date(n),l.setHours(23,59,59,999)):"week"===s?(r=this.parseWeekKey(n),l=new Date(r),l.setDate(l.getDate()+6),l.setHours(23,59,59,999)):(r=this.parseMonthKey(n),l=new Date(r.getFullYear(),r.getMonth()+1,0,23,59,59,999)),r<e||l>a)continue;const c={rangeStart:r,rangeEnd:l,label:this.formatGroupLabel(r,l,s),buckets:new Map,total:0};for(const t in i){const e=i[t];c.buckets.set(t,e),c.total+=e}o.push(c)}return o.sort((t,e)=>t.rangeStart-e.rangeStart),o}parseWeekKey(t){const e=t.split("_W"),a=parseInt(e[0]),s=7*(parseInt(e[1])-1)-new Date(a,0,1).getDay()+1;return new Date(a,0,1+s)}parseMonthKey(t){const e=t.split("_"),a=parseInt(e[0]),s=parseInt(e[1])-1;return new Date(a,s,1)}formatGroupLabel(t,e,a){if("day"===a)return t.toLocaleDateString("zh-CN");if("week"===a)return`${t.toLocaleDateString("zh-CN")} - ${e.toLocaleDateString("zh-CN")}`;return`${t.getFullYear()}年${t.getMonth()+1}月`}}!function(){const t=performance.getEntriesByType("navigation")[0]?.type;"reload"===t?(console.log("🔄 检测到页面刷新，清空 sessionStorage 状态"),sessionStorage.removeItem("satellitePageState"),sessionStorage.removeItem("satelliteStatistics")):console.log("🌐 页面正常加载（非刷新）")}();