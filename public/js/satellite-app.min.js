class SatelliteApp{constructor(){this.cycleEngine=new CycleRuleEngine,this.taskAnalyzer=new TaskResultAnalyzer,this.fieldMappingValues={idField:"id",planIdField:"plan_id",startTimeField:"start_time",taskResultField:"task_result"},this.dataStore=new DataStore(this.fieldMappingValues),this.chart=null,this.hasSavedState=!!sessionStorage.getItem("satellitePageState"),this.hasSavedStats=!!sessionStorage.getItem("satelliteStatistics"),this.loadSavedConfig(),this.bindElements(),this.bindEvents(),this.data=null,this.isInitializing=!0,this.pendingUpdates=[],this.dataStoreReady=!1,this.pendingStatsRequest=!1,this.dataStoreCacheDirty=!1,this.needFullDataStoreConstruction=!1,this.backgroundLoadingProgress=0,this.isBackgroundLoading=!1,this.backgroundLoadTarget=0,this.dataLoadingStrategy="initial",this.loadedDataRange=null,this.init()}bindElements(){this.startDate=document.getElementById("startDate"),this.endDate=document.getElementById("endDate"),this.groupBy=document.getElementById("groupBy"),this.showDataLabels=document.getElementById("showDataLabels"),this.generateChart=document.getElementById("generateChart"),this.configGroupingBtn=document.getElementById("configGroupingBtn"),this.dataChart=document.getElementById("dataChart"),this.chartEmptyState=document.getElementById("chartEmptyState"),this.chartErrorState=document.getElementById("chartErrorState"),this.chartErrorMessage=document.getElementById("chartErrorMessage"),this.chartLoadingState=document.getElementById("chartLoadingState"),this.totalCount=document.getElementById("totalCount"),this.avgCount=document.getElementById("avgCount"),this.totalFailures=document.getElementById("totalFailures"),this.avgSuccessRate=document.getElementById("avgSuccessRate"),this.maxCount=document.getElementById("maxCount"),this.minCount=document.getElementById("minCount"),this.detailTableBody=document.getElementById("detailTableBody"),this.groupingConfigModal=document.getElementById("groupingConfigModal"),this.modalContent=document.getElementById("modalContent"),this.closeConfigModal=document.getElementById("closeConfigModal"),this.saveGroupingConfig=document.getElementById("saveGroupingConfig"),this.dayStart=document.getElementById("dayStart"),this.dayStartDisplay=document.getElementById("dayStartDisplay"),this.dayEndDisplay=document.getElementById("dayEndDisplay"),this.weekStartDay=document.getElementById("weekStartDay"),this.weekStartTime=document.getElementById("weekStartTime"),this.monthStartDate=document.getElementById("monthStartDate"),this.monthStartTime=document.getElementById("monthStartTime"),this.quarterStartMonth=document.getElementById("quarterStartMonth"),this.quarterStartTime=document.getElementById("quarterStartTime"),this.dbLoading=document.getElementById("dbLoading"),this.noDataAlert=document.getElementById("noDataAlert"),this.cacheStatus=document.getElementById("cacheStatus"),this.refreshCacheBtn=document.getElementById("refreshCacheBtn"),this.clearCacheBtn=document.getElementById("clearCacheBtn"),this.cacheInfo=document.getElementById("cacheInfo"),this.satelliteCount=document.getElementById("satelliteCount"),this.customerCount=document.getElementById("customerCount"),this.satelliteCountCard=document.getElementById("satelliteCountCard"),this.customerCountCard=document.getElementById("customerCountCard"),this.satelliteCountModal=document.getElementById("satelliteCountModal"),this.satelliteModalContent=document.getElementById("satelliteModalContent"),this.closeSatelliteModal=document.getElementById("closeSatelliteModal"),this.satelliteCountChart=document.getElementById("satelliteCountChart"),this.satelliteChartEmpty=document.getElementById("satelliteChartEmpty"),this.satelliteChartLoading=document.getElementById("satelliteChartLoading"),this.customerCountModal=document.getElementById("customerCountModal"),this.customerModalContent=document.getElementById("customerModalContent"),this.closeCustomerModal=document.getElementById("closeCustomerModal"),this.customerCountChart=document.getElementById("customerCountChart"),this.customerChartEmpty=document.getElementById("customerChartEmpty"),this.customerChartLoading=document.getElementById("customerChartLoading"),this.satelliteChart=null,this.customerChart=null}bindEvents(){this.generateChart&&this.generateChart.addEventListener("click",()=>this.generateStatistics()),this.configGroupingBtn&&this.configGroupingBtn.addEventListener("click",()=>this.openGroupingConfig()),this.closeConfigModal&&this.closeConfigModal.addEventListener("click",()=>this.closeGroupingConfig()),this.saveGroupingConfig&&this.saveGroupingConfig.addEventListener("click",()=>this.saveGroupingConfiguration()),this.showDataLabels&&this.showDataLabels.addEventListener("change",()=>this.toggleDataLabels()),this.startDate&&this.startDate.addEventListener("change",()=>this.savePageState()),this.endDate&&this.endDate.addEventListener("change",()=>this.savePageState()),this.groupBy&&this.groupBy.addEventListener("change",()=>{if(this.savePageState(),this.data&&this.dataStore){const t=this.groupBy.value;console.log(`ğŸ”„ ç»Ÿè®¡å‘¨æœŸå·²æ”¹å˜ä¸º ${t}ï¼Œåå°é‡æ–°æ„å»º DataStore...`),this.dataStoreReady=!1,this.buildDataStoreInBackground(t)}}),this.dayStart&&this.dayStart.addEventListener("change",t=>{this.dayStartDisplay.textContent=t.target.value,this.dayEndDisplay.textContent=t.target.value}),this.refreshCacheBtn&&this.refreshCacheBtn.addEventListener("click",()=>this.refreshCache()),this.clearCacheBtn&&this.clearCacheBtn.addEventListener("click",()=>this.clearCache()),this.satelliteCountCard&&this.satelliteCountCard.addEventListener("click",()=>this.showSatelliteCountChart()),this.customerCountCard&&this.customerCountCard.addEventListener("click",()=>this.showCustomerCountChart()),this.closeSatelliteModal&&this.closeSatelliteModal.addEventListener("click",()=>this.closeSatelliteCountModal()),this.closeCustomerModal&&this.closeCustomerModal.addEventListener("click",()=>this.closeCustomerCountModal()),document.querySelectorAll(".chart-download-btn").forEach(t=>{t.addEventListener("click",t=>{const e=t.currentTarget.getAttribute("data-chart"),a=t.currentTarget.getAttribute("data-type");let s=null;if("satelliteChart"===e?s=this.satelliteChart:"customerChart"===e?s=this.customerChart:"mainChart"===e&&(s=this.chart),s){if("image"===a)try{const t=s.toBase64Image(),a=document.createElement("a");a.href=t;const o=(new Date).toISOString().replace(/[:.]/g,"-");a.download=`${e}-${o}.png`,document.body.appendChild(a),a.click(),setTimeout(()=>document.body.removeChild(a),300),showSuccess("å›¾è¡¨å›¾ç‰‡ä¸‹è½½æˆåŠŸ")}catch(t){console.error("å¯¼å‡ºå›¾ç‰‡å¤±è´¥",t),showError("å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ”¯æŒæˆ–æ•°æ®é‡æ˜¯å¦è¿‡å¤§ã€‚")}else if("csv"===a)try{const t=chartToCSV(s),a=(new Date).toISOString().replace(/[:.]/g,"-");downloadFile(`${e}-${a}.csv`,t,"text/csv;charset=utf-8;"),showSuccess("å›¾è¡¨æ•°æ®ä¸‹è½½æˆåŠŸ")}catch(t){console.error("å¯¼å‡º CSV å¤±è´¥",t),showError("å¯¼å‡º CSV å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚")}}else showError("å›¾è¡¨æœªç”Ÿæˆï¼Œæ— æ³•ä¸‹è½½")})})}updateSkeletonProgress(t,e){const a=document.getElementById("skeleton-progress"),s=document.getElementById("skeleton-progress-percent");a&&(a.textContent=e),s&&(s.textContent=`${t}%`)}async init(){console.log("ğŸš€ åº”ç”¨åˆå§‹åŒ–å¼€å§‹...");const t=document.getElementById("skeleton-screen");document.getElementById("skeleton-progress");try{this.updateSkeletonProgress(5,"æ­£åœ¨æ£€æŸ¥é¢„è®¡ç®—ç»Ÿè®¡...");const e=await cacheManager.getStatistics("bucket"),a=await cacheManager.getStatistics("customer");if(e&&a)return console.log("âš¡ å‘ç°é¢„è®¡ç®—ç»Ÿè®¡ç¼“å­˜ï¼Œä½¿ç”¨æé€ŸåŠ è½½æ¨¡å¼ï¼"),this.precomputedStats={bucket:e,customer:a},this.usePrecomputedStats=!0,this.data=[],this.dataLoadingStrategy="precomputed",this.dataStoreReady=!1,this.updateSkeletonProgress(90,"é¢„è®¡ç®—ç»Ÿè®¡å·²åŠ è½½"),this.setDefaultDates(),this.updateSkeletonProgress(100,"åˆå§‹åŒ–å®Œæˆï¼"),await new Promise(t=>setTimeout(t,300)),t&&t.classList.add("hidden"),this.generateStatistics(),void console.log("âœ… æé€Ÿåˆå§‹åŒ–å®Œæˆï¼ˆä½¿ç”¨é¢„è®¡ç®—ç»Ÿè®¡ï¼‰");console.log("âš ï¸ é¢„è®¡ç®—ç»Ÿè®¡ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¸¸è§„åŠ è½½æ–¹å¼"),this.usePrecomputedStats=!1,this.updateSkeletonProgress(10,"æ­£åœ¨è¯»å–ç¼“å­˜...");const s=await cacheManager.getMetadataFast();if(!(s&&s.actualCount>0))return console.warn("âš ï¸ æœ¬åœ°ç¼“å­˜ä¸ºç©ºï¼Œæ˜¾ç¤ºæ— æ•°æ®æç¤º"),t&&t.classList.add("hidden"),void this.noDataAlert.classList.remove("hidden");console.log("ğŸ“Š ç¼“å­˜å…ƒæ•°æ®:",s),this.displayMetadataStats(s),this.updateSkeletonProgress(20,"ç¼“å­˜å…ƒæ•°æ®è¯»å–å®Œæˆ"),this.updateSkeletonProgress(30,"æ­£åœ¨åŠ è½½DataStore...");const o=this.groupBy?this.groupBy.value:"day",n=await cacheManager.loadDataStoreBuckets(o,s.lastUpdated);if(n&&n.buckets){console.log("ğŸš€ ä½¿ç”¨ç¼“å­˜çš„DataStoreæ¡¶ç»“æ„ï¼ˆæé€ŸåŠ è½½ï¼‰"),this.updateSkeletonProgress(50,"æ­£åœ¨æ¢å¤DataStore...");const t=performance.now();this.dataStore.buckets=new Map(n.buckets),this.dataStoreReady=!0;const e=performance.now()-t;console.log(`âœ… DataStoreæ¢å¤å®Œæˆ: ${this.dataStore.buckets.size} ä¸ªæ¡¶ (${e.toFixed(0)}ms, ${(this.dataStore.buckets.size/(e/1e3)).toFixed(0)} æ¡¶/ç§’)`),this.updateSkeletonProgress(90,"DataStoreæ¢å¤å®Œæˆ"),this.data=[],this.dataLoadingStrategy="lazy",console.log("âš¡ è·³è¿‡ this.data åŠ è½½ï¼ˆDataStoreç¼“å­˜å·²åŒ…å«æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼‰"),console.log("ğŸ’¡ ä»…åœ¨éœ€è¦æ—¶ï¼ˆå¯¼å‡º/å®æ—¶æ›´æ–°ï¼‰æ‰æŒ‰éœ€åŠ è½½åŸå§‹æ•°æ®"),this.loadedDataRange=null,this.needFullDataStoreConstruction=!1}else{console.log("âš ï¸ DataStoreç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨å¿«é€Ÿåˆå§‹åŒ–ç­–ç•¥"),this.updateSkeletonProgress(40,"æ­£åœ¨å¿«é€Ÿåˆå§‹åŒ–...");const t=performance.now();this.data=[];let e=0;this.dataStore.clear();const a=new Date;a.setDate(a.getDate()-7),await cacheManager.queryDateRangeFromShards(a,new Date,t=>{e+=t.length,this.data.push(...t),this.dataStore.addRecordsToBucketBatch(t,this.cycleEngine,o);const a=40+Math.min(40,Math.floor(e/50));this.updateSkeletonProgress(a,`æ­£åœ¨åˆå§‹åŒ–... ${e} æ¡`)},5e3);const s=performance.now()-t;console.log(`âœ… å¿«é€Ÿåˆå§‹åŒ–å®Œæˆ: ${e} æ¡ï¼ˆæœ€è¿‘1å‘¨ï¼‰ (${s.toFixed(0)}ms)`),this.updateSkeletonProgress(85,"å¿«é€Ÿåˆå§‹åŒ–å®Œæˆ"),this.dataStoreReady=!1,this.dataLoadingStrategy="quick",this.loadedDataRange={start:a,end:new Date},console.log(`ğŸ“… å·²åŠ è½½æ•°æ®èŒƒå›´: ${a.toLocaleDateString()} - ${(new Date).toLocaleDateString()}`),this.needFullDataStoreConstruction=!0}if(0===this.data.length&&"lazy"!==this.dataLoadingStrategy)return console.warn("âš ï¸ æœ¬åœ°ç¼“å­˜ä¸ºç©º"),t&&t.classList.add("hidden"),void this.noDataAlert.classList.remove("hidden");if(this.noDataAlert.classList.add("hidden"),this.updateSkeletonProgress(92,"æ­£åœ¨æ¢å¤é¡µé¢çŠ¶æ€..."),this.hasSavedState){this.restorePageState()&&console.log("âœ… é¡µé¢çŠ¶æ€å·²ä»sessionStorageæ¢å¤")}else this.setDefaultDates();if(this.updateSkeletonProgress(96,"æ­£åœ¨æ¸²æŸ“å›¾è¡¨..."),this.hasSavedStats){this.restoreStatisticsResult()&&console.log("âœ… ç»Ÿè®¡ç»“æœå·²ä»sessionStorageæ¢å¤")}if(this.updateSkeletonProgress(100,"åˆå§‹åŒ–å®Œæˆï¼"),await new Promise(t=>setTimeout(t,300)),t&&t.classList.add("hidden"),!this.dataStoreReady||this.needFullDataStoreConstruction?(console.log("âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼ˆDataStoreå°†åœ¨åå°æ„å»ºï¼‰"),this.buildDataStoreInBackground(o)):console.log("âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼ˆDataStoreå·²å°±ç»ªï¼Œè·³è¿‡åå°æ„å»ºï¼‰"),setTimeout(()=>{this.updateCacheStatus()},100),setTimeout(()=>this.backgroundPreload(),2e3),this.collapseInstructionsAfterLoad(),console.log("âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),window.sharedDataManager&&(this.data&&this.data.length>0?(window.sharedDataManager.notifyDataLoaded(this.data,"index"),console.log(`ğŸ“¡ å·²é€šçŸ¥ SharedDataManager æ•°æ®å·²åŠ è½½: ${this.data.length.toLocaleString()} æ¡`)):"lazy"===this.dataLoadingStrategy&&(console.log("âš¡ å»¶è¿ŸåŠ è½½æ¨¡å¼ï¼šå¿«é€ŸåŠ è½½æ•°æ®ä»¥æ”¯æŒè·¨é¡µé¢å…±äº«..."),setTimeout(async()=>{try{const t=await cacheManager.getAllDataFast();this.data=t,window.sharedDataManager.notifyDataLoaded(t,"index"),console.log(`ğŸ“¡ å·²é€šçŸ¥ SharedDataManager æ•°æ®å·²åŠ è½½ï¼ˆå»¶è¿Ÿï¼‰: ${t.length.toLocaleString()} æ¡`)}catch(t){console.error("âŒ å»¶è¿ŸåŠ è½½æ•°æ®å¤±è´¥:",t)}},100))),this.isInitializing=!1,this.pendingUpdates.length>0){console.log(`ğŸ”„ åˆå§‹åŒ–å®Œæˆï¼Œå¤„ç†æš‚å­˜çš„ ${this.pendingUpdates.length} æ¡æ›´æ–°...`);const t=[...this.pendingUpdates];this.pendingUpdates=[],t.forEach(({operation:t,record:e})=>{this.handleRealtimeUpdate(t,e)}),console.log("âœ… æš‚å­˜æ›´æ–°å·²å…¨éƒ¨åº”ç”¨")}}catch(e){console.error("âŒ åˆå§‹åŒ–å¤±è´¥:",e),t&&t.classList.add("hidden"),showError("æ•°æ®åŠ è½½å¤±è´¥: "+(e.message||e)),this.isInitializing=!1}}appendDataBatch(t,e){this.dataStore&&this.dataStore.addRecordsToBucketBatch(t,this.cycleEngine,e)}displayMetadataStats(t){console.log(`ğŸ“Š ç¼“å­˜å…ƒæ•°æ®: ${t.actualCount} æ¡è®°å½•`),t.minDate&&t.maxDate&&console.log(`ğŸ“… æ•°æ®èŒƒå›´: ${t.minDate.toLocaleDateString()} - ${t.maxDate.toLocaleDateString()}`)}showBackgroundLoadingIndicator(){const t=document.getElementById("dbLoading"),e=document.getElementById("dbLoadingText"),a=document.getElementById("dbLoadingProgressBar");t&&e&&(t.classList.remove("hidden"),e.textContent="æ­£åœ¨åå°åŠ è½½å†å²æ•°æ®...",a&&a.classList.remove("hidden"))}updateBackgroundLoadingIndicator(t,e,a){const s=document.getElementById("dbLoading"),o=document.getElementById("dbLoadingText"),n=document.getElementById("dbLoadingProgressBar"),i=document.getElementById("dbLoadingProgressFill"),r=document.getElementById("dbLoadingProgressText"),l=document.getElementById("dbLoadingCountText");s&&o&&(s.classList.remove("hidden"),o.textContent="æ­£åœ¨åå°åŠ è½½å†å²æ•°æ®...",n&&n.classList.remove("hidden"),i&&(i.style.width=`${a}%`),r&&(r.textContent=`${a}%`),l&&(l.textContent=`${t.toLocaleString()} / ${e.toLocaleString()}`),a>=100&&setTimeout(()=>{s&&s.classList.add("hidden"),n&&n.classList.add("hidden")},3e3))}async ensureDataLoaded(t=3){if("lazy"!==this.dataLoadingStrategy||this.data.length>0)return;console.log(`ğŸ”„ æŒ‰éœ€åŠ è½½ this.dataï¼ˆæœ€è¿‘${t}ä¸ªæœˆï¼‰...`);const e=performance.now();try{let a=0;await cacheManager.queryRecentMonthsFromShards(t,t=>{a+=t.length,this.data.push(...t)},5e3);const s=performance.now()-e;console.log(`âœ… this.data æŒ‰éœ€åŠ è½½å®Œæˆ: ${a.toLocaleString()} æ¡ (${s.toFixed(0)}ms)`),this.dataLoadingStrategy="loaded"}catch(t){throw console.error("âŒ æŒ‰éœ€åŠ è½½ this.data å¤±è´¥:",t),t}}async loadDateRangeOnDemand(t,e,a,s){try{console.log(`ğŸ¯ ä¼˜å…ˆåŠ è½½æ—¥æœŸèŒƒå›´: ${t.toLocaleDateString()} - ${e.toLocaleDateString()}`),this.showBackgroundLoadingIndicator();const o=this.data?this.data.filter(a=>{const s=new Date(a.start_time||a["å¼€å§‹æ—¶é—´"]);return s>=t&&s<=e}):[];console.log(`   å·²åŠ è½½æ•°æ®: ${o.length} æ¡`);const n=[];let i=0;const r=performance.now();await cacheManager.queryDateRangeFromShards(t,e,t=>{i+=t.length,n.push(...t),this.dataStore.addRecordsToBucketBatch(t,this.cycleEngine,a);const e=new Set(this.data.map(t=>this.dataStore.getRecordKey(t))),o=t.filter(t=>!e.has(this.dataStore.getRecordKey(t)));this.data.push(...o),s&&s(i,n.length),this.updateBackgroundLoadingIndicator(i,i,100)},5e3);const l=performance.now()-r;return console.log(`âœ… ç›®æ ‡èŒƒå›´æ•°æ®åŠ è½½å®Œæˆ: ${i.toLocaleString()} æ¡ (${l.toFixed(0)}ms)`),this.loadedDataRange?(this.loadedDataRange.start=t<this.loadedDataRange.start?t:this.loadedDataRange.start,this.loadedDataRange.end=e>this.loadedDataRange.end?e:this.loadedDataRange.end):this.loadedDataRange={start:t,end:e},console.log(`ğŸ“… æ›´æ–°å·²åŠ è½½èŒƒå›´: ${this.loadedDataRange.start.toLocaleDateString()} - ${this.loadedDataRange.end.toLocaleDateString()}`),setTimeout(()=>{const t=document.getElementById("dbLoading");t&&t.classList.add("hidden")},1e3),i}catch(t){throw console.error("âŒ æŒ‰éœ€åŠ è½½å¤±è´¥:",t),t}}buildDataStoreInBackground(t){this.needFullDataStoreConstruction?(console.log("ğŸ“¦ æ£€æµ‹åˆ°éœ€è¦å®Œæ•´DataStoreï¼Œåå°åŠ è½½å…¨éƒ¨æ•°æ®..."),setTimeout(()=>{this.buildFullDataStoreInBackground(t)},1e3)):window.requestIdleCallback?requestIdleCallback(()=>{this.executeBuildDataStore(t)},{timeout:500}):setTimeout(()=>{this.executeBuildDataStore(t)},50)}async buildFullDataStoreInBackground(t){try{console.log("ğŸ”„ å¼€å§‹æ¸è¿›å¼åå°åŠ è½½å…¨éƒ¨æ•°æ®ï¼ˆç”¨äºå®Œæ•´DataStoreï¼‰...");const e=performance.now();this.isBackgroundLoading=!0,this.backgroundLoadingProgress=0;const a=await cacheManager.getMetadataFast();this.backgroundLoadTarget=a?.actualCount||0,console.log(`ğŸ“Š ç›®æ ‡åŠ è½½: ${this.backgroundLoadTarget.toLocaleString()} æ¡`),this.showBackgroundLoadingIndicator();const s=[];let o=0,n=Date.now();await cacheManager.queryAllDataFast(e=>{o+=e.length,s.push(...e),this.dataStore.addRecordsToBucketBatch(e,this.cycleEngine,t),this.backgroundLoadTarget>0&&(this.backgroundLoadingProgress=Math.round(o/this.backgroundLoadTarget*100)),this.updateBackgroundLoadingIndicator(o,this.backgroundLoadTarget,this.backgroundLoadingProgress);const a=Date.now();(o%5e3==0||a-n>2e3)&&(console.log(`  ğŸ“¦ å·²åŠ è½½ ${o.toLocaleString()} / ${this.backgroundLoadTarget.toLocaleString()} æ¡ (${this.backgroundLoadingProgress}%)`),n=a,this.chart&&this.chart.data&&this.refreshChartIfNeeded())},5e3);const i=performance.now()-e;console.log(`âœ… å…¨éƒ¨æ•°æ®åŠ è½½å®Œæˆ: ${s.length.toLocaleString()} æ¡ (${i.toFixed(0)}ms)`);const r=this.data?this.data.length:0;this.data=s,console.log(`ğŸ”„ æ›´æ–°å†…å­˜æ•°æ®: ${r.toLocaleString()} -> ${s.length.toLocaleString()} æ¡`),this.dataStoreReady=!0,this.needFullDataStoreConstruction=!1,this.isBackgroundLoading=!1,this.backgroundLoadingProgress=100,console.log(`âœ… å®Œæ•´DataStoreæ„å»ºå®Œæˆ: ${this.dataStore.buckets.size} ä¸ªæ¡¶`);try{await cacheManager.saveDataStoreBuckets(t,this.dataStore.buckets,s.length),this.dataStoreCacheDirty=!1,console.log("ğŸ’¾ å®Œæ•´DataStoreæ¡¶ç¼“å­˜å·²ä¿å­˜")}catch(t){console.error("âš ï¸ DataStoreæ¡¶ç¼“å­˜ä¿å­˜å¤±è´¥:",t)}this.chart&&this.chart.data&&(console.log("ğŸ”„ åå°åŠ è½½å®Œæˆï¼Œæœ€ç»ˆåˆ·æ–°å›¾è¡¨"),this.generateStatistics()),this.pendingStatsRequest&&(console.log("ğŸ”„ å®Œæ•´DataStoreå°±ç»ªï¼Œæ‰§è¡Œå¾…å¤„ç†çš„ç»Ÿè®¡è¯·æ±‚"),this.pendingStatsRequest=!1,this.generateStatistics())}catch(t){console.error("âŒ åå°åŠ è½½å…¨éƒ¨æ•°æ®å¤±è´¥:",t),this.isBackgroundLoading=!1}}refreshChartIfNeeded(){if(this._lastChartRefresh&&Date.now()-this._lastChartRefresh<3e3)return;this._lastChartRefresh=Date.now(),console.log("ğŸ”„ å¢é‡åˆ·æ–°å›¾è¡¨ï¼ˆåå°æ•°æ®å·²æ›´æ–°ï¼‰");const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value);if(this.dataStore&&this.dataStore.buckets.size>0){const a=this.dataStore.getStats(this.taskAnalyzer,e.startDate,e.endDate);this.updateChart(a,t),this.updateStatCards(a),this.updateDetailTable(a)}}async executeBuildDataStore(t,e=!0){console.log("ğŸ”„ åå°æ„å»ºDataStore...");const a=performance.now();this.dataStore.loadData(this.data,this.cycleEngine,t);const s=performance.now()-a;if(console.log(`âœ… DataStoreæ„å»ºå®Œæˆ: ${this.dataStore.buckets.size} ä¸ªæ¡¶ (${s.toFixed(0)}ms)`),this.dataStoreReady=!0,e)try{await cacheManager.saveDataStoreBuckets(t,this.dataStore.buckets,this.data.length),this.dataStoreCacheDirty=!1}catch(t){console.error("âš ï¸ DataStoreæ¡¶ç¼“å­˜ä¿å­˜å¤±è´¥ï¼ˆéé˜»å¡ï¼‰:",t)}this.pendingStatsRequest&&(console.log("ğŸ”„ DataStoreå°±ç»ªï¼Œæ‰§è¡Œå¾…å¤„ç†çš„ç»Ÿè®¡è¯·æ±‚"),this.pendingStatsRequest=!1,this.generateStatistics())}async backgroundPreload(){try{console.log("ğŸ”„ åå°é¢„åŠ è½½æ•°æ®...")}catch(t){console.warn("âš ï¸ åå°é¢„åŠ è½½å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",t)}}collapseInstructionsAfterLoad(){"function"==typeof window.collapseInstructions&&window.collapseInstructions()}async handleRealtimeUpdate(t,e){if(this.isInitializing)return this.pendingUpdates.push({operation:t,record:e}),void console.log(`ğŸ“¦ åˆå§‹åŒ–ä¸­ï¼Œæš‚å­˜æ›´æ–°: ${t} (é˜Ÿåˆ—é•¿åº¦: ${this.pendingUpdates.length})`);if(!this.data)return void console.warn("âš ï¸ åº”ç”¨æœªåˆå§‹åŒ–ï¼Œå¿½ç•¥å®æ—¶æ›´æ–°");if("lazy"===this.dataLoadingStrategy&&0===this.data.length){console.log("ğŸ”„ é¦–æ¬¡å®æ—¶æ›´æ–°ï¼Œè§¦å‘æŒ‰éœ€åŠ è½½ this.data...");try{await this.ensureDataLoaded(3)}catch(t){console.error("âŒ æŒ‰éœ€åŠ è½½å¤±è´¥ï¼Œå®æ—¶æ›´æ–°å°†ä»…æ›´æ–°DataStore")}}const a=performance.now();try{const s=this.groupBy?this.groupBy.value:"day",o=new Set,n=this.dataStore.getRecordKey(e);let i=!1;if(this.dataStoreReady&&!this.needFullDataStoreConstruction)i=!0;else{const t=new Date(e.start_time||e["å¼€å§‹æ—¶é—´"]),a=new Date;a.setMonth(a.getMonth()-3),i=t>=a}if("insert"===t||"update"===t){const t=this.data.findIndex(t=>this.dataStore.getRecordKey(t)===n);if(t>=0){this.dataStore.updateRecord(e,this.cycleEngine,s,!1).forEach(t=>o.add(t)),this.data[t]=e,console.log(`ğŸ”„ æ›´æ–°å†…å­˜è®°å½•: ${n}`)}else if(i){this.data.push(e);const t=this.dataStore.addRecordToBucket(e,this.cycleEngine,s);t&&o.add(t),console.log(`â• æ–°å¢å†…å­˜è®°å½•: ${n}`)}else{const t=new Date(e.start_time||e["å¼€å§‹æ—¶é—´"]);console.warn(`âš ï¸ è¶…å‡ºèŒƒå›´çš„æ•°æ®æ›´æ–° (${t.toLocaleDateString()})ï¼Œä»…æ›´æ–°DataStoreæ¡¶`);const a=this.dataStore.addRecordToBucket(e,this.cycleEngine,s);a&&o.add(a),this.dataStoreCacheDirty=!0}}else if("delete"===t){const t=this.data.findIndex(t=>this.dataStore.getRecordKey(t)===n);if(t>=0){this.dataStore.updateRecord(this.data[t],this.cycleEngine,s,!0).forEach(t=>o.add(t)),this.data.splice(t,1),console.log(`ğŸ—‘ï¸ åˆ é™¤å†…å­˜è®°å½•: ${n}`)}else console.warn(`âš ï¸ å†å²æ•°æ®åˆ é™¤ (${n})ï¼Œå°è¯•ä»DataStoreç§»é™¤`);this.dataStoreCacheDirty=!0}const r=performance.now()-a;console.log(`âš¡ å®æ—¶æ•°æ®æ›´æ–°å®Œæˆ (${r.toFixed(2)}ms)ï¼Œå½±å“ ${o.size} ä¸ªæ¡¶`),this.chart&&o.size>0?(console.log(`ğŸ“Š æ£€æµ‹åˆ°æ•°æ®å˜æ›´ï¼Œå¢é‡åˆ·æ–°å›¾è¡¨ (${o.size} ä¸ªæ¡¶)...`),this.updateChartIncremental(Array.from(o))):o.size>0&&console.log("ğŸ’¡ æ•°æ®å·²æ›´æ–°ï¼Œä½†å½“å‰æ— å›¾è¡¨æ˜¾ç¤ºï¼Œè·³è¿‡åˆ·æ–°")}catch(t){console.error("âŒ å¤„ç†å®æ—¶æ›´æ–°å¤±è´¥:",t)}}async updateCacheStatus(){try{const t=await cacheManager.checkAllDataCache();t?(this.cacheStatus.textContent="âœ… å·²ç¼“å­˜",this.cacheStatus.className="text-xs px-2 py-1 rounded-full bg-success/10 text-success",this.cacheInfo.textContent=`${t.totalCount} æ¡æ•°æ® Â· ${new Date(t.lastUpdated).toLocaleString()}`):(this.cacheStatus.textContent="âŒ æ— ç¼“å­˜",this.cacheStatus.className="text-xs px-2 py-1 rounded-full bg-danger/10 text-danger",this.cacheInfo.textContent="æš‚æ— æœ¬åœ°ç¼“å­˜æ•°æ®")}catch(t){this.cacheStatus.textContent="âš ï¸ æ£€æŸ¥å¤±è´¥",this.cacheStatus.className="text-xs px-2 py-1 rounded-full bg-warning/10 text-warning",this.cacheInfo.textContent="ç¼“å­˜çŠ¶æ€æ£€æŸ¥å¤±è´¥"}}async refreshCache(){try{this.refreshCacheBtn.disabled=!0,this.refreshCacheBtn.innerHTML='<i class="fa fa-spinner fa-spin mr-1"></i>åˆ·æ–°ä¸­...',console.log("ğŸ”„ ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜..."),await cacheManager.clearDataStoreBucketsCache();const t=await dataPreloader.autoPreloadAllData();t.success&&(showSuccess(`ç¼“å­˜åˆ·æ–°æˆåŠŸï¼æ›´æ–°äº† ${t.totalCount} æ¡æ•°æ®`),await this.init()),this.updateCacheStatus()}catch(t){console.error("âŒ ç¼“å­˜åˆ·æ–°å¤±è´¥:",t),showError("ç¼“å­˜åˆ·æ–°å¤±è´¥: "+t.message)}finally{this.refreshCacheBtn.disabled=!1,this.refreshCacheBtn.innerHTML='<i class="fa fa-refresh mr-1"></i>åˆ·æ–°ç¼“å­˜'}}async clearCache(){if(confirm("ç¡®å®šè¦æ¸…ç©ºæœ¬åœ°ç¼“å­˜å—ï¼Ÿä¸‹æ¬¡è®¿é—®å°†é‡æ–°ä»æ•°æ®åº“åŠ è½½æ•°æ®ã€‚"))try{this.clearCacheBtn.disabled=!0,this.clearCacheBtn.innerHTML='<i class="fa fa-spinner fa-spin mr-1"></i>æ¸…ç©ºä¸­...',console.log("ğŸ§¹ ç”¨æˆ·æ¸…ç©ºç¼“å­˜..."),await cacheManager.clearDataStoreBucketsCache(),await cacheManager.clearAllDataCache(),this.data=null,this.noDataAlert.classList.remove("hidden"),this.chart&&(this.chart.destroy(),this.chart=null),this.satelliteChart&&(this.satelliteChart.destroy(),this.satelliteChart=null),this.customerChart&&(this.customerChart.destroy(),this.customerChart=null),this.updateStatCards([]),this.updateDetailTable([]),showSuccess("æœ¬åœ°ç¼“å­˜å·²æ¸…ç©º"),this.updateCacheStatus()}catch(t){console.error("âŒ æ¸…ç©ºç¼“å­˜å¤±è´¥:",t),showError("æ¸…ç©ºç¼“å­˜å¤±è´¥: "+t.message)}finally{this.clearCacheBtn.disabled=!1,this.clearCacheBtn.innerHTML='<i class="fa fa-trash mr-1"></i>æ¸…ç©ºç¼“å­˜'}}setDefaultDates(){const t=new Date,e=new Date;e.setDate(t.getDate()-7);const a=t=>`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;this.startDate&&(this.startDate.value=a(e)),this.endDate&&(this.endDate.value=a(t))}parseDateInputToLocal(t,e=0,a=0,s=0,o=0){if(!t)return null;const n=t.split("-").map(Number),i=n[0],r=n[1]-1,l=n[2];return new Date(i,r,l,e,a,s,o)}computeDateRangeForGroup(t,e,a){let s=null,o=null;const n=t=>{if(!t)return null;const e=t.split("-").map(Number);let a=this.cycleEngine.config.day.start;const[s=0,o=0]=a.split(":").map(t=>parseInt(t,10));return new Date(e[0],e[1]-1,e[2],s,o,0,0)};try{if(e){const a=n(e),o=this.cycleEngine.getGroup(a,t),i=this.parseDateInputToLocal(e,0,0,0,0);s=o.rangeStart<i?i:o.rangeStart}if(a){const e=n(a),s=(this.cycleEngine.getGroup(e,t),new Date(e));s.setDate(s.getDate()+1);o=this.cycleEngine.getGroup(s,t).rangeStart}}catch(t){console.warn("è®¡ç®—æ—¥æœŸèŒƒå›´å¤±è´¥ï¼Œå›é€€åˆ°åŸºäºæœ¬åœ°æ—¥å†çš„é»˜è®¤è§£æ",t),e&&(s=this.parseDateInputToLocal(e,0,0,0,0)),a&&(o=this.parseDateInputToLocal(a,23,59,59,999))}return{startDate:s,endDate:o}}async generateStatistics(){const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),a=e.startDate,s=e.endDate;if(this.usePrecomputedStats&&this.precomputedStats){console.log("âš¡ ä½¿ç”¨é¢„è®¡ç®—ç»Ÿè®¡ç”Ÿæˆå›¾è¡¨ï¼ˆç§’å¼€ï¼ï¼‰");const e=performance.now(),o=this.precomputedStats.bucket["day"===t?"daily":"week"===t?"weekly":"monthly"]||{},n=this.convertPrecomputedToChartData(o,a,s,t);this.updateChart(n,t),this.updateStatCards(n),this.updateDetailTable(n);const i=performance.now()-e;return void console.log(`âœ… é¢„è®¡ç®—ç»Ÿè®¡å›¾è¡¨æ¸²æŸ“å®Œæˆ (${i.toFixed(0)}ms) - 99%æ€§èƒ½æå‡ï¼`)}if(this.data||this.dataStore){if(a&&s&&!this.dataStoreReady){let e=!1,o="";if("quick"===this.dataLoadingStrategy&&this.loadedDataRange){(a<this.loadedDataRange.start||s>this.loadedDataRange.end)&&(e=!0,o=`èŒƒå›´è¶…å‡ºå·²åŠ è½½: ${this.loadedDataRange.start.toLocaleDateString()} - ${this.loadedDataRange.end.toLocaleDateString()}`)}if(!e&&this.data&&this.data.length>0){const t=this.data.filter(t=>{const e=new Date(t.start_time||t["å¼€å§‹æ—¶é—´"]);return e>=a&&e<=s});Math.ceil((s-a)/864e5)>7&&t.length<100&&(e=!0,o=`æ•°æ®ä¸è¶³: ${t.length} æ¡`)}if(e){const e=Math.ceil((s-a)/864e5);console.log(`ğŸ¯ æ£€æµ‹åˆ°éœ€è¦æŒ‰éœ€åŠ è½½: ç›®æ ‡èŒƒå›´ ${e} å¤©ï¼ŒåŸå› : ${o}`),this.chartLoadingState.classList.remove("hidden"),this.chartEmptyState.classList.add("hidden"),this.chartErrorState.classList.add("hidden");try{let e=0,o=0;showInfo("æ­£åœ¨åŠ è½½å†å²æ•°æ®ï¼Œå›¾è¡¨å°†å®æ—¶æ›´æ–°..."),await this.loadDateRangeOnDemand(a,s,t,(n,i)=>{const r=Date.now();if(r-e>1e3||n%5e3==0){o++,console.log(`   ğŸ¬ æ¸è¿›å¼æ¸²æŸ“ #${o}: ${n} / ${i} æ¡`),e=r;const l=this.dataStore.getStats(this.taskAnalyzer,a,s);l.length>0&&(this.updateChart(l,t,!0),this.updateStatCards(l),this.updateDetailTable(l))}}),console.log("âœ… ç›®æ ‡èŒƒå›´åŠ è½½å®Œæˆï¼Œæœ€ç»ˆæ¸²æŸ“");const n=this.dataStore.getStats(this.taskAnalyzer,a,s);return this.updateChart(n,t),this.updateStatCards(n),this.updateDetailTable(n),this.saveStatisticsResult(n,t),this.chartLoadingState.classList.add("hidden"),void(this.isBackgroundLoading||(console.log("ğŸ”„ ç»§ç»­åå°åŠ è½½å‰©ä½™å†å²æ•°æ®..."),setTimeout(()=>{this.buildFullDataStoreInBackground(t)},1e3)))}catch(t){console.error("âŒ æŒ‰éœ€åŠ è½½å¤±è´¥:",t)}}}if(!this.dataStoreReady&&0===this.dataStore.buckets.size)return console.log("â³ DataStoreæ­£åœ¨åˆå§‹åŒ–ï¼Œç»Ÿè®¡è¯·æ±‚å·²æ’é˜Ÿ..."),this.pendingStatsRequest=!0,this.chartLoadingState.classList.remove("hidden"),this.chartEmptyState.classList.add("hidden"),void this.chartErrorState.classList.add("hidden");!this.dataStoreReady&&this.isBackgroundLoading&&(console.warn(`âš ï¸ ä½¿ç”¨éƒ¨åˆ†æ•°æ®ç”Ÿæˆå›¾è¡¨ (${this.backgroundLoadingProgress}% å·²åŠ è½½)`),showWarning(`æ­£åœ¨åå°åŠ è½½å†å²æ•°æ® (${this.backgroundLoadingProgress}%)ï¼Œå›¾è¡¨å°†æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®å¹¶è‡ªåŠ¨æ›´æ–°`)),this.chartLoadingState.classList.remove("hidden"),this.chartEmptyState.classList.add("hidden"),this.chartErrorState.classList.add("hidden"),this.detailTableBody.innerHTML="";try{let e;if(console.log("ğŸ“Š å¼€å§‹ç”Ÿæˆç»Ÿè®¡ç»“æœï¼ˆåŸºäºæœ¬åœ°ç¼“å­˜æ•°æ®ï¼‰..."),this.dataStore&&this.dataStore.buckets.size>0){const t=performance.now();e=this.dataStore.getStats(this.taskAnalyzer,a,s);const o=performance.now()-t;console.log(`âš¡ ä½¿ç”¨æ¡¶æŸ¥è¯¢ç”Ÿæˆç»Ÿè®¡ (${o.toFixed(2)}ms, ${e.length} ä¸ªæ¡¶)`)}else console.log("âš ï¸ DataStore æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ä¼ ç»Ÿéå†æ–¹æ³•"),e=this.groupDataByCycle(t,a,s),console.log(`ğŸ“ˆ ç”Ÿæˆç»Ÿè®¡ç»„æ•°: ${e.length}`);this.updateChart(e,t),this.updateStatCards(e),this.updateDetailTable(e),this.saveStatisticsResult(e,t)}catch(t){console.error("âŒ ç”Ÿæˆç»Ÿè®¡ç»“æœå¤±è´¥:",t),this.chartErrorMessage.textContent="ç”Ÿæˆç»Ÿè®¡ç»“æœæ—¶å‡ºé”™: "+t.message,this.chartErrorState.classList.remove("hidden")}finally{this.chartLoadingState.classList.add("hidden")}}else showError("å½“å‰æ²¡æœ‰æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥æ•°æ®åé‡è¯•")}groupDataByCycle(t,e,a){const s={},{planIdField:o,startTimeField:n,taskResultField:i}=this.fieldMappingValues;this.data.forEach(r=>{try{const l=r[n];let c;if(l instanceof Date)c=this.cycleEngine.createFileDate(l);else if("string"==typeof l)c=new Date(l);else{if("number"!=typeof l)return void console.warn("æ— æ³•è§£ææ—¶é—´:",r);c=new Date(864e5*(l-25569))}if(isNaN(c.getTime()))return void console.warn("æ— æ•ˆçš„æ—¥æœŸå€¼:",l);if(e&&c<e)return;if(a&&c>=a)return;const d=this.cycleEngine.getGroup(c,t);s[d.key]||(s[d.key]={key:d.key,label:d.label,count:0,planIds:new Set,results:[],rangeStart:d.rangeStart,rangeEnd:d.rangeEnd});const h=s[d.key];h.planIds.add(r[o]),h.count=h.planIds.size,h.results.push(r[i]||"æœªçŸ¥")}catch(t){console.warn("å¤„ç†æ•°æ®é¡¹å¤±è´¥:",r,t)}});const r=Object.values(s).sort((t,e)=>t.rangeStart-e.rangeStart);return r.forEach(t=>{t.failureCount=this.taskAnalyzer.countFailures(t.results),t.successRate=this.taskAnalyzer.calculateSuccessRate(t.results,t.count)}),r}updateChart(t,e,a=!1){if(!t||0===t.length)return this.chartEmptyState.classList.remove("hidden"),void(this.chart&&(this.chart.destroy(),this.chart=null));this.chartEmptyState.classList.add("hidden");const s=t.map(t=>t.label),o=t.map(t=>t.count),n=t.map(t=>t.failureCount),i=t.map(t=>parseFloat(t.successRate.toFixed(3))),r=this.showDataLabels.checked;if(this.chart&&a)return this.chart.data.labels=s,this.chart.data.datasets[0].data=o,this.chart.data.datasets[1].data=n,this.chart.data.datasets[2].data=i,void this.chart.update("none");this.chart&&this.chart.destroy();const l=this.dataChart.getContext("2d");Chart.register(ChartDataLabels),this.chart=new Chart(l,{type:"line",data:{labels:s,datasets:[{label:"è®¡åˆ’IDæ•°é‡",data:o,borderColor:"#165DFF",backgroundColor:"rgba(22, 93, 255, 0.1)",borderWidth:2,fill:!1,tension:.3,yAxisID:"y",datalabels:{display:r,color:"#165DFF",anchor:"end",align:"top",font:{size:10,weight:"bold"}}},{label:"å¤±è´¥åœˆæ¬¡è®¡æ•°",data:n,borderColor:"#F53F3F",backgroundColor:"rgba(245, 63, 63, 0.1)",borderWidth:2,fill:!1,tension:.3,yAxisID:"y",datalabels:{display:r,color:"#F53F3F",anchor:"end",align:"bottom",font:{size:10,weight:"bold"}}},{label:"æˆåŠŸç‡(%)",data:i,borderColor:"#00B42A",backgroundColor:"rgba(0, 180, 42, 0.1)",borderWidth:2,fill:!1,tension:.3,yAxisID:"y1",pointRadius:4,pointBackgroundColor:"#00B42A",datalabels:{display:r,color:"#00B42A",anchor:"end",align:"top",font:{size:10,weight:"bold"},formatter:function(t){return t+"%"}}}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:30,bottom:10,left:10,right:10}},interaction:{mode:"index",intersect:!1},scales:{y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"æ•°é‡"},beginAtZero:!0},y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"æˆåŠŸç‡(%)"},min:0,max:100,grid:{drawOnChartArea:!1}}},plugins:{legend:{display:!0,position:"bottom",labels:{padding:15,font:{size:12}}},datalabels:{display:r},tooltip:{callbacks:{label:function(t){let e=t.dataset.label||"";return e&&(e+=": "),2===t.datasetIndex?e+=t.parsed.y+"%":e+=t.parsed.y,e}}}}}})}updateChartIncremental(t){if(console.log("ğŸ” å¼€å§‹å¢é‡æ›´æ–°ï¼Œå—å½±å“çš„æ¡¶:",t),!this.chart)return void console.warn("âš ï¸ å›¾è¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡å¢é‡æ›´æ–°");if(!this.dataStore||0===t.length)return void console.warn("âš ï¸ DataStore ä¸å­˜åœ¨æˆ–æ— å—å½±å“çš„æ¡¶ï¼Œè·³è¿‡æ›´æ–°");const e=performance.now();try{const a=this.groupBy.value,s=this.computeDateRangeForGroup(a,this.startDate.value,this.endDate.value),o=s.startDate,n=s.endDate;console.log(`ğŸ“Š ä» DataStore è·å–ç»Ÿè®¡æ•°æ® (${a}): ${o?.toLocaleDateString()} - ${n?.toLocaleDateString()}`);const i=this.dataStore.getStats(this.taskAnalyzer,o,n);console.log(`ğŸ“ˆ è·å–åˆ° ${i.length} ä¸ªç»Ÿè®¡åˆ†ç»„`);const r=new Map;i.forEach((t,e)=>{r.set(t.key,e)});let l=0;t.forEach(t=>{const e=r.get(t);if(console.log(`ğŸ” æŸ¥æ‰¾æ¡¶ ${t} çš„ç´¢å¼•: ${e}`),void 0!==e&&e<this.chart.data.labels.length){const t=i[e];console.log(`ğŸ“Š æ›´æ–°ç´¢å¼• ${e} çš„æ•°æ®: count=${t.count}, failure=${t.failureCount}, rate=${t.successRate.toFixed(3)}%`),this.chart.data.datasets[0].data[e]=t.count,this.chart.data.datasets[1].data[e]=t.failureCount,this.chart.data.datasets[2].data[e]=parseFloat(t.successRate.toFixed(3)),l++}else console.warn(`âš ï¸ æ¡¶ ${t} ä¸åœ¨å½“å‰æ˜¾ç¤ºèŒƒå›´å†… (index: ${e}, chart labels: ${this.chart.data.labels.length})`)}),console.log("ğŸ”„ åˆ·æ–°å›¾è¡¨æ˜¾ç¤º..."),this.chart.update("none"),this.updateStatCards(i),this.updateDetailTable(i),this.saveStatisticsResult(i,a);const c=performance.now()-e;console.log(`âœ… å¢é‡æ›´æ–°å®Œæˆ (${c.toFixed(2)}ms)ï¼Œæ›´æ–°äº† ${l}/${t.length} ä¸ªæ•°æ®ç‚¹`)}catch(t){console.error("âŒ å¢é‡æ›´æ–°å¤±è´¥:",t),console.error("é”™è¯¯å †æ ˆ:",t.stack)}}toggleDataLabels(){if(this.chart){const t=this.showDataLabels.checked;this.chart.data.datasets.forEach(e=>{e.datalabels&&(e.datalabels.display=t)}),this.chart.update("none")}}updateStatCards(t){if(!t||0===t.length)return this.totalCount.textContent="0",this.avgCount.textContent="0",this.totalFailures.textContent="0",this.avgSuccessRate.textContent="0%",this.maxCount&&(this.maxCount.textContent="0"),this.minCount&&(this.minCount.textContent="0"),this.satelliteCount&&(this.satelliteCount.textContent="0"),void(this.customerCount&&(this.customerCount.textContent="0"));const e=t.reduce((t,e)=>t+e.count,0);this.totalCount.textContent=e;const a=(e/t.length).toFixed(1);this.avgCount.textContent=a;const s=t.reduce((t,e)=>t+e.failureCount,0);this.totalFailures.textContent=s;const o=t.filter(t=>t.count>0).map(t=>t.successRate),n=o.length>0?(o.reduce((t,e)=>t+e,0)/o.length).toFixed(3):0;this.avgSuccessRate.textContent=`${n}%`;const i=t.map(t=>t.count);this.maxCount&&(this.maxCount.textContent=Math.max(...i)),this.minCount&&(this.minCount.textContent=Math.min(...i)),this.updateEntityCounts(t)}updateDetailTable(t){if(this.detailTableBody.innerHTML="",!t||0===t.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=5,e.className="px-6 py-4 text-center text-gray-500",e.textContent="æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®",t.appendChild(e),void this.detailTableBody.appendChild(t)}t.forEach(t=>{const e=document.createElement("tr"),a=document.createElement("td");a.className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",a.textContent=t.label,e.appendChild(a);const s=document.createElement("td");s.className="px-6 py-4 whitespace-nowrap text-sm text-gray-500",s.textContent=t.count,e.appendChild(s);const o=document.createElement("td");o.className="px-6 py-4 whitespace-nowrap text-sm text-danger",o.textContent=t.failureCount,e.appendChild(o);const n=document.createElement("td");n.className="px-6 py-4 whitespace-nowrap text-sm text-success",n.textContent=`${t.successRate.toFixed(3)}%`,e.appendChild(n);const i=document.createElement("td");i.className="px-6 py-4 whitespace-nowrap text-sm text-gray-500",i.textContent=`${this.formatDateForDisplayCorrected(t.rangeStart)} è‡³ ${this.formatDateForDisplayCorrected(t.rangeEnd)}`,e.appendChild(i),this.detailTableBody.appendChild(e)})}formatDateForDisplay(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}formatDateForDisplayCorrected(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}openGroupingConfig(){console.log("ğŸš€ openGroupingConfig è¢«è°ƒç”¨"),console.log("ğŸ“‹ groupingConfigModal:",this.groupingConfigModal),console.log("ğŸ“‹ modalContent:",this.modalContent),this.updateGroupingConfigForm(),this.groupingConfigModal?(this.groupingConfigModal.classList.remove("hidden"),console.log("âœ… æ¨¡æ€æ¡†æ˜¾ç¤º"),setTimeout(()=>{this.modalContent?(this.modalContent.classList.remove("scale-95","opacity-0"),this.modalContent.classList.add("scale-100","opacity-100"),console.log("âœ… æ¨¡æ€æ¡†åŠ¨ç”»å®Œæˆ")):console.error("âŒ modalContent æœªæ‰¾åˆ°")},10)):console.error("âŒ groupingConfigModal æœªæ‰¾åˆ°")}closeGroupingConfig(){this.modalContent.classList.remove("scale-100","opacity-100"),this.modalContent.classList.add("scale-95","opacity-0"),setTimeout(()=>{this.groupingConfigModal.classList.add("hidden")},300)}updateGroupingConfigForm(){const t=this.cycleEngine.config,e=this.correctTimeDisplayForGear(t.day.start);this.dayStart.value=e,this.dayStartDisplay.textContent=e,this.dayEndDisplay.textContent=e,this.weekStartDay.value=t.week.startDay,this.weekStartTime.value=this.correctTimeDisplayForGear(t.week.startTime),this.monthStartDate.value=t.month.startDate,this.monthStartTime.value=this.correctTimeDisplayForGear(t.month.startTime),this.quarterStartMonth.value=t.quarter.startMonth,this.quarterStartTime.value=this.correctTimeDisplayForGear(t.quarter.startTime)}correctTimeDisplayForGear(t){return t}correctTimeInputForStorage(t){return t}findFieldValue(t,e){for(const a of e)if(void 0!==t[a]&&null!==t[a]&&""!==t[a])return t[a];const a=Object.keys(t);for(const s of e){const e=a.find(t=>t.toLowerCase().includes(s.toLowerCase())||t.includes(s));if(e&&void 0!==t[e]&&null!==t[e]&&""!==t[e])return t[e]}return null}updateEntityCounts(t){if(!t||0===t.length)return this.satelliteCount&&(this.satelliteCount.textContent="0"),void(this.customerCount&&(this.customerCount.textContent="0"));const e=new Set,a=new Set,{planIdField:s,startTimeField:o,taskResultField:n}=this.fieldMappingValues;if(this.data){const t=this.groupBy.value,s=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),n=s.startDate,i=s.endDate;this.data.forEach(t=>{try{const s=t[o];let r;if(s instanceof Date)r=this.cycleEngine.createFileDate(s);else if("string"==typeof s)r=new Date(s);else{if("number"!=typeof s)return;r=new Date(864e5*(s-25569))}if(isNaN(r.getTime()))return;if(n&&r<n)return;if(i&&r>=i)return;const l=this.findFieldValue(t,["satellite_name","satellite","å«æ˜Ÿåç§°","å«æ˜Ÿ","æ˜Ÿ"]),c=this.findFieldValue(t,["customer","client","å®¢æˆ·","ç”¨æˆ·","æ‰€å±å®¢æˆ·"]);l&&""!==l.toString().trim()&&e.add(l.toString().trim()),c&&""!==c.toString().trim()&&a.add(c.toString().trim())}catch(e){console.warn("å¤„ç†å®ä½“æ•°æ®é¡¹å¤±è´¥:",t,e)}})}this.satelliteCount&&(this.satelliteCount.textContent=e.size),this.customerCount&&(this.customerCount.textContent=a.size),console.log("å«æ˜Ÿæ•°é‡ç»Ÿè®¡:",e.size,"ä¸ªå«æ˜Ÿ:",Array.from(e).slice(0,10)),console.log("å®¢æˆ·æ•°é‡ç»Ÿè®¡:",a.size,"ä¸ªå®¢æˆ·:",Array.from(a).slice(0,10))}async saveGroupingConfiguration(){const t={day:{start:this.correctTimeInputForStorage(this.dayStart.value)},week:{startDay:parseInt(this.weekStartDay.value),startTime:this.correctTimeInputForStorage(this.weekStartTime.value)},month:{startDate:parseInt(this.monthStartDate.value),startTime:this.correctTimeInputForStorage(this.monthStartTime.value)},quarter:{startMonth:parseInt(this.quarterStartMonth.value),startTime:this.correctTimeInputForStorage(this.quarterStartTime.value)}};console.log("ğŸ’¾ ä¿å­˜æ–°çš„å‘¨æœŸé…ç½®:",t),console.log("ğŸ”§ æ›´æ–°å‰çš„é…ç½®:",this.cycleEngine.config),this.cycleEngine.updateConfig(t),console.log("âœ… æ›´æ–°åçš„é…ç½®:",this.cycleEngine.config);try{const t=JSON.parse(localStorage.getItem("satelliteAppData")||"{}");t.cycleConfig=this.cycleEngine.config,localStorage.setItem("satelliteAppData",JSON.stringify(t)),console.log("ğŸ’¾ é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨")}catch(t){console.warn("ä¿å­˜é…ç½®å¤±è´¥:",t)}if(console.log("ğŸ”„ é…ç½®å·²æ›´æ–°ï¼Œé‡æ–°åŠ è½½ DataStore..."),this.data&&this.dataStore){const t=this.groupBy.value;this.dataStore.loadData(this.data,this.cycleEngine,t)}console.log("ğŸ”„ é‡æ–°ç”Ÿæˆç»Ÿè®¡..."),this.generateStatistics(),showSuccess("å‘¨æœŸé…ç½®å·²æ›´æ–°ï¼Œç»Ÿè®¡æ•°æ®å·²åˆ·æ–°"),this.closeGroupingConfig()}loadSavedConfig(){try{const t=JSON.parse(localStorage.getItem("satelliteAppData")||"{}");t.cycleConfig&&(console.log("ğŸ”§ åŠ è½½ä¿å­˜çš„é…ç½®:",t.cycleConfig),this.cycleEngine.updateConfig(t.cycleConfig),console.log("âœ… é…ç½®åŠ è½½å®Œæˆ:",this.cycleEngine.config),setTimeout(()=>{this.updateGroupingConfigForm&&this.updateGroupingConfigForm()},100))}catch(t){console.warn("åŠ è½½é…ç½®å¤±è´¥:",t)}}savePageState(){try{const t={startDate:this.startDate?.value||"",endDate:this.endDate?.value||"",groupBy:this.groupBy?.value||"day",showDataLabels:this.showDataLabels?.checked||!1,timestamp:Date.now()};sessionStorage.setItem("satellitePageState",JSON.stringify(t)),console.log("ğŸ’¾ é¡µé¢çŠ¶æ€å·²ä¿å­˜:",t)}catch(t){console.warn("ä¿å­˜é¡µé¢çŠ¶æ€å¤±è´¥:",t)}}restorePageState(){try{const t=sessionStorage.getItem("satellitePageState");if(!t)return console.log("ğŸ“‹ æ— ä¿å­˜çš„é¡µé¢çŠ¶æ€"),!1;const e=JSON.parse(t);return console.log("ğŸ”„ æ¢å¤é¡µé¢çŠ¶æ€:",e),e.startDate&&this.startDate&&(this.startDate.value=e.startDate),e.endDate&&this.endDate&&(this.endDate.value=e.endDate),e.groupBy&&this.groupBy&&(this.groupBy.value=e.groupBy),this.showDataLabels&&(this.showDataLabels.checked=e.showDataLabels||!1),console.log("âœ… é¡µé¢çŠ¶æ€æ¢å¤å®Œæˆ"),!0}catch(t){return console.warn("æ¢å¤é¡µé¢çŠ¶æ€å¤±è´¥:",t),!1}}clearPageState(){try{sessionStorage.removeItem("satellitePageState"),console.log("ğŸ—‘ï¸ é¡µé¢çŠ¶æ€å·²æ¸…ç©º")}catch(t){console.warn("æ¸…ç©ºé¡µé¢çŠ¶æ€å¤±è´¥:",t)}}saveStatisticsResult(t,e){try{if(!t||0===t.length)return void console.log("ğŸ“Š ç»Ÿè®¡ç»“æœä¸ºç©ºï¼Œä¸ä¿å­˜");const a={stats:t,groupType:e,generatedAt:Date.now()};sessionStorage.setItem("satelliteStatistics",JSON.stringify(a)),console.log("ğŸ’¾ ç»Ÿè®¡ç»“æœå·²ä¿å­˜:",{statsCount:t.length,groupType:e})}catch(t){console.warn("ä¿å­˜ç»Ÿè®¡ç»“æœå¤±è´¥:",t)}}restoreStatisticsResult(){try{const t=sessionStorage.getItem("satelliteStatistics");if(!t)return console.log("ğŸ“Š æ— ä¿å­˜çš„ç»Ÿè®¡ç»“æœ"),!1;const e=JSON.parse(t);return console.log("ğŸ”„ æ¢å¤ç»Ÿè®¡ç»“æœ:",{statsCount:e.stats.length,groupType:e.groupType,generatedAt:new Date(e.generatedAt).toLocaleString()}),this.chartLoadingState&&this.chartLoadingState.classList.add("hidden"),this.chartEmptyState&&this.chartEmptyState.classList.add("hidden"),requestAnimationFrame(()=>{this.updateChart(e.stats,e.groupType),this.updateStatCards(e.stats),this.updateDetailTable(e.stats),console.log("âœ… ç»Ÿè®¡ç»“æœæ¢å¤å®Œæˆ")}),!0}catch(t){return console.warn("æ¢å¤ç»Ÿè®¡ç»“æœå¤±è´¥:",t),!1}}clearStatisticsResult(){try{sessionStorage.removeItem("satelliteStatistics"),console.log("ğŸ—‘ï¸ ç»Ÿè®¡ç»“æœå·²æ¸…ç©º")}catch(t){console.warn("æ¸…ç©ºç»Ÿè®¡ç»“æœå¤±è´¥:",t)}}showSatelliteCountChart(){this.data&&this.fieldMappingValues?(this.satelliteCountModal.classList.remove("hidden"),setTimeout(()=>{this.satelliteModalContent.classList.remove("scale-95","opacity-0"),this.satelliteModalContent.classList.add("scale-100","opacity-100")},10),this.generateSatelliteCountChart()):showError("å½“å‰æ²¡æœ‰æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥æ•°æ®åé‡è¯•")}showCustomerCountChart(){this.data&&this.fieldMappingValues?(this.customerCountModal.classList.remove("hidden"),setTimeout(()=>{this.customerModalContent.classList.remove("scale-95","opacity-0"),this.customerModalContent.classList.add("scale-100","opacity-100")},10),this.generateCustomerCountChart()):showError("å½“å‰æ²¡æœ‰æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥æ•°æ®åé‡è¯•")}closeSatelliteCountModal(){this.satelliteModalContent.classList.remove("scale-100","opacity-100"),this.satelliteModalContent.classList.add("scale-95","opacity-0"),setTimeout(()=>{this.satelliteCountModal.classList.add("hidden")},300)}closeCustomerCountModal(){this.customerModalContent.classList.remove("scale-100","opacity-100"),this.customerModalContent.classList.add("scale-95","opacity-0"),setTimeout(()=>{this.customerCountModal.classList.add("hidden")},300)}generateSatelliteCountChart(){this.satelliteChartLoading.classList.remove("hidden"),this.satelliteChartEmpty.classList.add("hidden");try{this.satelliteChart&&this.satelliteChart.destroy();const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),a=e.startDate,s=e.endDate,o=this.groupSatelliteDataByCycle(t,a,s);if(0===o.length)return void this.satelliteChartEmpty.classList.remove("hidden");const n=o.map(t=>t.label),i=o.map(t=>t.satelliteCount),r=this.satelliteCountChart.getContext("2d");this.satelliteChart=new Chart(r,{type:"line",data:{labels:n,datasets:[{label:"å«æ˜Ÿæ•°é‡",data:i,borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",borderWidth:3,fill:!0,tension:.3,pointRadius:6,pointBackgroundColor:"#2563eb",pointBorderColor:"#ffffff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:30,bottom:10,left:10,right:10}},interaction:{mode:"index",intersect:!1},scales:{y:{beginAtZero:!0,title:{display:!0,text:"å«æ˜Ÿæ•°é‡"}}},plugins:{tooltip:{callbacks:{label:function(t){return`å«æ˜Ÿæ•°é‡: ${t.parsed.y}`}}},datalabels:{display:!0,color:"#2563eb",font:{size:12,weight:"bold"},anchor:"center",align:"top",offset:8}}}})}catch(t){console.error("ç”Ÿæˆå«æ˜Ÿæ•°é‡è¶‹åŠ¿å›¾å¤±è´¥:",t),this.satelliteChartEmpty.classList.remove("hidden")}finally{this.satelliteChartLoading.classList.add("hidden")}}generateCustomerCountChart(){this.customerChartLoading.classList.remove("hidden"),this.customerChartEmpty.classList.add("hidden");try{this.customerChart&&this.customerChart.destroy();const t=this.groupBy.value,e=this.computeDateRangeForGroup(t,this.startDate.value,this.endDate.value),a=e.startDate,s=e.endDate,o=this.groupCustomerDataByCycle(t,a,s);if(0===o.length)return void this.customerChartEmpty.classList.remove("hidden");const n=o.map(t=>t.label),i=o.map(t=>t.customerCount),r=this.customerCountChart.getContext("2d");this.customerChart=new Chart(r,{type:"line",data:{labels:n,datasets:[{label:"å®¢æˆ·æ•°é‡",data:i,borderColor:"#7c3aed",backgroundColor:"rgba(124, 58, 237, 0.1)",borderWidth:3,fill:!0,tension:.3,pointRadius:6,pointBackgroundColor:"#7c3aed",pointBorderColor:"#ffffff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:30,bottom:10,left:10,right:10}},interaction:{mode:"index",intersect:!1},scales:{y:{beginAtZero:!0,title:{display:!0,text:"å®¢æˆ·æ•°é‡"}}},plugins:{tooltip:{callbacks:{label:function(t){return`å®¢æˆ·æ•°é‡: ${t.parsed.y}`}}},datalabels:{display:!0,color:"#7c3aed",font:{size:12,weight:"bold"},anchor:"center",align:"top",offset:8}}}})}catch(t){console.error("ç”Ÿæˆå®¢æˆ·æ•°é‡è¶‹åŠ¿å›¾å¤±è´¥:",t),this.customerChartEmpty.classList.remove("hidden")}finally{this.customerChartLoading.classList.add("hidden")}}groupSatelliteDataByCycle(t,e,a){const s={},{planIdField:o,startTimeField:n,taskResultField:i}=this.fieldMappingValues;this.data.forEach(o=>{try{const i=o[n];let r;if(i instanceof Date)r=this.cycleEngine.createFileDate(i);else if("string"==typeof i)r=new Date(i);else{if("number"!=typeof i)return;r=new Date(864e5*(i-25569))}if(isNaN(r.getTime()))return;if(e&&r<e)return;if(a&&r>a)return;const l=this.cycleEngine.getGroup(r,t);s[l.key]||(s[l.key]={key:l.key,label:l.label,satellites:new Set,rangeStart:l.rangeStart,rangeEnd:l.rangeEnd});const c=this.findFieldValue(o,["satellite_name","satellite","å«æ˜Ÿåç§°","å«æ˜Ÿ","æ˜Ÿ"]);c&&""!==c.toString().trim()&&s[l.key].satellites.add(c.toString().trim())}catch(t){console.warn("å¤„ç†å«æ˜Ÿæ•°æ®é¡¹å¤±è´¥:",o,t)}});const r=Object.values(s).sort((t,e)=>t.rangeStart-e.rangeStart);return r.forEach(t=>{t.satelliteCount=t.satellites.size}),r}groupCustomerDataByCycle(t,e,a){const s={},{planIdField:o,startTimeField:n,taskResultField:i}=this.fieldMappingValues;this.data.forEach(o=>{try{const i=o[n];let r;if(i instanceof Date)r=this.cycleEngine.createFileDate(i);else if("string"==typeof i)r=new Date(i);else{if("number"!=typeof i)return;r=new Date(864e5*(i-25569))}if(isNaN(r.getTime()))return;if(e&&r<e)return;if(a&&r>a)return;const l=this.cycleEngine.getGroup(r,t);s[l.key]||(s[l.key]={key:l.key,label:l.label,customers:new Set,rangeStart:l.rangeStart,rangeEnd:l.rangeEnd});const c=this.findFieldValue(o,["customer","client","å®¢æˆ·","ç”¨æˆ·","æ‰€å±å®¢æˆ·"]);c&&""!==c.toString().trim()&&s[l.key].customers.add(c.toString().trim())}catch(t){console.warn("å¤„ç†å®¢æˆ·æ•°æ®é¡¹å¤±è´¥:",o,t)}});const r=Object.values(s).sort((t,e)=>t.rangeStart-e.rangeStart);return r.forEach(t=>{t.customerCount=t.customers.size}),r}convertPrecomputedToChartData(t,e,a,s){const o=[];for(const n in t){const i=t[n];let r,l;if("day"===s?(r=new Date(n),l=new Date(n),l.setHours(23,59,59,999)):"week"===s?(r=this.parseWeekKey(n),l=new Date(r),l.setDate(l.getDate()+6),l.setHours(23,59,59,999)):(r=this.parseMonthKey(n),l=new Date(r.getFullYear(),r.getMonth()+1,0,23,59,59,999)),r<e||l>a)continue;const c={rangeStart:r,rangeEnd:l,label:this.formatGroupLabel(r,l,s),buckets:new Map,total:0};for(const t in i){const e=i[t];c.buckets.set(t,e),c.total+=e}o.push(c)}return o.sort((t,e)=>t.rangeStart-e.rangeStart),o}parseWeekKey(t){const e=t.split("_W"),a=parseInt(e[0]),s=7*(parseInt(e[1])-1)-new Date(a,0,1).getDay()+1;return new Date(a,0,1+s)}parseMonthKey(t){const e=t.split("_"),a=parseInt(e[0]),s=parseInt(e[1])-1;return new Date(a,s,1)}formatGroupLabel(t,e,a){if("day"===a)return t.toLocaleDateString("zh-CN");if("week"===a)return`${t.toLocaleDateString("zh-CN")} - ${e.toLocaleDateString("zh-CN")}`;return`${t.getFullYear()}å¹´${t.getMonth()+1}æœˆ`}}!function(){const t=performance.getEntriesByType("navigation")[0]?.type;"reload"===t?(console.log("ğŸ”„ æ£€æµ‹åˆ°é¡µé¢åˆ·æ–°ï¼Œæ¸…ç©º sessionStorage çŠ¶æ€"),sessionStorage.removeItem("satellitePageState"),sessionStorage.removeItem("satelliteStatistics")):console.log("ğŸŒ é¡µé¢æ­£å¸¸åŠ è½½ï¼ˆéåˆ·æ–°ï¼‰")}();