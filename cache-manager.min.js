class QueryCache{constructor(){this.cache=new Map,this.hotDataCache=null,this.fullDataCache=null,this.maxCacheSize=104857600,this.currentCacheSize=0,this.cacheTTL=3e5}getCacheKey(t,e,o={}){return`query_${t?t.getTime():"all"}_${e?e.getTime():"all"}_${JSON.stringify(o)}`}get(t,e,o={}){const a=this.getCacheKey(t,e,o),s=this.cache.get(a);return s?Date.now()-s.timestamp>this.cacheTTL?(this.cache.delete(a),this.currentCacheSize-=s.size,null):(console.log(`ğŸ¯ æŸ¥è¯¢ç¼“å­˜å‘½ä¸­: ${a.substring(0,50)}...`),s.accessCount++,s.timestamp=Date.now(),s.data):null}set(t,e,o,a={}){const s=this.getCacheKey(t,e,a),r=JSON.stringify(o).length;if(r>this.maxCacheSize)console.warn(`âš ï¸ æ•°æ®å¤ªå¤§ï¼Œä¸ç¼“å­˜: ${(r/1024/1024).toFixed(1)}MB`);else{for(;this.currentCacheSize+r>this.maxCacheSize&&this.cache.size>0;)this.evictOldest();this.cache.set(s,{data:o,timestamp:Date.now(),size:r,accessCount:0}),this.currentCacheSize+=r,console.log(`ğŸ’¾ æŸ¥è¯¢ç»“æœå·²ç¼“å­˜: ${s.substring(0,50)}... (${(r/1024).toFixed(1)}KB)`)}}evictOldest(){let t=null,e=1/0;for(const[o,a]of this.cache.entries())a.timestamp<e&&(e=a.timestamp,t=o);if(t){const e=this.cache.get(t);this.cache.delete(t),this.currentCacheSize-=e.size,console.log(`ğŸ—‘ï¸ LRUé©±é€ç¼“å­˜: ${t.substring(0,50)}... (${(e.size/1024).toFixed(1)}KB)`)}}clear(){this.cache.clear(),this.hotDataCache=null,this.fullDataCache=null,this.currentCacheSize=0,console.log("ğŸ—‘ï¸ æŸ¥è¯¢ç¼“å­˜å·²æ¸…ç©º")}async preloadHotData(t){try{const e=new Date,o=new Date;o.setDate(o.getDate()-7),console.log("ğŸ”¥ é¢„åŠ è½½çƒ­ç‚¹æ•°æ®ï¼ˆæœ€è¿‘7å¤©ï¼‰...");const a=await t.queryDateRangeOptimized(o,e,{useCache:!1});this.hotDataCache={data:a,startDate:o,endDate:e,timestamp:Date.now()},console.log(`âœ… çƒ­ç‚¹æ•°æ®å·²åŠ è½½: ${a.length.toLocaleString()} æ¡`)}catch(t){console.error("âŒ çƒ­ç‚¹æ•°æ®é¢„åŠ è½½å¤±è´¥:",t)}}canUseHotData(t,e){if(!this.hotDataCache)return!1;const o=t.getTime(),a=e.getTime(),s=this.hotDataCache.startDate.getTime(),r=this.hotDataCache.endDate.getTime();return o>=s&&a<=r}filterFromHotData(t,e){if(!this.canUseHotData(t,e))return null;const o=t.getTime(),a=e.getTime(),s=this.hotDataCache.data.filter(t=>{const e=t.timestamp;return e>=o&&e<=a});return console.log(`ğŸ”¥ ä»çƒ­ç‚¹æ•°æ®è¿‡æ»¤: ${s.length.toLocaleString()} æ¡`),s}setFullDataCache(t){this.fullDataCache={data:t,timestamp:Date.now()},console.log(`ğŸ’¾ å…¨é‡æ•°æ®å·²ç¼“å­˜: ${t.length.toLocaleString()} æ¡`)}getFullDataCache(){return this.fullDataCache?Date.now()-this.fullDataCache.timestamp>this.cacheTTL?(this.fullDataCache=null,null):(console.log(`ğŸ¯ å…¨é‡ç¼“å­˜å‘½ä¸­: ${this.fullDataCache.data.length.toLocaleString()} æ¡`),this.fullDataCache.data):null}invalidate(){console.log("ğŸ”„ ç¼“å­˜å¤±æ•ˆï¼Œæ¸…ç©ºæ‰€æœ‰ç¼“å­˜"),this.clear()}}class CacheManager{constructor(){this.dbName="SatelliteDataCache",this.dbVersion=20,this.allDataStoreName="allDataCache",this.metaStoreName="metaData",this.shardIndexStoreName="shardIndex",this.dataStoreCacheStoreName="dataStoreCache",this.statisticsCacheStoreName="statisticsCache",this.partitionMetaStoreName="partitionMeta",this.db=null,this.cacheExpiry=1/0,this.partitions={},this.queryCache=new QueryCache,this.initializePartitions()}initializePartitions(){console.log("ğŸ“Š åˆ†åŒºç­–ç•¥ï¼šå®Œå…¨åŠ¨æ€åˆ›å»ºï¼ˆåŸºäºå®é™…æ•°æ®æ—¶é—´èŒƒå›´ï¼‰")}registerPartition(t){if(this.partitions[t])return;const e=t.match(/^(\d{4})_Q(\d)$/);if(!e)return void console.warn(`âš ï¸ æ— æ•ˆçš„åˆ†åŒºIDæ ¼å¼: ${t}`);const o=parseInt(e[1]),a=parseInt(e[2]);this.partitions[t]={id:t,storeName:`satellite_data_${t}`,year:o,quarter:a,months:this.getQuarterMonths(a)},console.log(`  âœ… æ³¨å†Œåˆ†åŒº: ${t} (${o}å¹´Q${a})`)}async ensurePartitionsExist(){if(!this.db)return void console.error("âŒ æ•°æ®åº“æœªåˆå§‹åŒ–");const t=[];for(const[e,o]of Object.entries(this.partitions))this.db.objectStoreNames.contains(o.storeName)||t.push(e);if(0===t.length)return void console.log("âœ… æ‰€æœ‰åˆ†åŒºè¡¨å·²å­˜åœ¨ï¼Œæ— éœ€å‡çº§ç‰ˆæœ¬");console.log(`ğŸ”§ éœ€è¦åˆ›å»º ${t.length} ä¸ªåˆ†åŒºè¡¨:`,t.join(", "));const e=this.db.version,o=e+1;return console.log(`ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬å‡çº§: v${e} â†’ v${o} (ä»…å› éœ€è¦åˆ›å»ºæ–°åˆ†åŒº)`),this.db.close(),new Promise((e,a)=>{const s=indexedDB.open(this.dbName,o);s.onupgradeneeded=e=>{const o=e.target.result;for(const e of t){const t=this.partitions[e];if(!o.objectStoreNames.contains(t.storeName)){o.createObjectStore(t.storeName,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log(`  âœ… åˆ›å»ºåˆ†åŒºè¡¨: ${t.storeName}`)}}},s.onsuccess=t=>{this.db=t.target.result,this.dbVersion=o,console.log(`âœ… åˆ†åŒºè¡¨åˆ›å»ºå®Œæˆï¼Œæ•°æ®åº“ç‰ˆæœ¬: v${this.dbVersion}`),e()},s.onerror=t=>{console.error("âŒ åˆ›å»ºåˆ†åŒºè¡¨å¤±è´¥:",t.target.error),a(t.target.error)}})}getQuarterMonths(t){return{1:[1,2,3],2:[4,5,6],3:[7,8,9],4:[10,11,12]}[t]||[1,2,3]}getPartitionByDate(t){if(!t){return`${(new Date).getFullYear()}_Q1`}const e=this.parseDate(t);if(!e||isNaN(e.getTime())){return`${(new Date).getFullYear()}_Q1`}const o=e.getFullYear(),a=e.getMonth()+1,s=Math.ceil(a/3),r=`${o}_Q${s}`;return this.partitions[r]||(this.partitions[r]={id:r,storeName:`satellite_data_${r}`,year:o,quarter:s,months:this.getQuarterMonths(s)},console.log(`ğŸ†• åŠ¨æ€æ·»åŠ åˆ†åŒº: ${r}`)),r}getPartitionStoreName(t){return this.partitions[t]?.storeName||`satellite_data_${t}`}parseDate(t){if(t instanceof Date)return t;if("string"==typeof t){const e=this.parseLocalTime(t);if(e&&!isNaN(e.getTime()))return e}return"number"==typeof t?new Date(t>1e10?t:1e3*t):null}getMonthKey(t){const e=new Date(t);return`${e.getFullYear()}_${String(e.getMonth()+1).padStart(2,"0")}`}getShardStoreName(t){return`monthData_${t}`}getRecentMonthKeys(t=3){const e=[],o=new Date;for(let a=0;a<t;a++){const t=new Date(o.getFullYear(),o.getMonth()-a,1);e.push(this.getMonthKey(t))}return e}groupDataByMonth(t){const e={};for(const o of t){const t=o.start_time||o["å¼€å§‹æ—¶é—´"];if(!t)continue;const a=this.getMonthKey(t);e[a]||(e[a]=[]),e[a].push(o)}return e}async init(){return new Promise((t,e)=>{const o=indexedDB.open(this.dbName,this.dbVersion);o.onerror=()=>{console.error("âŒ IndexedDBåˆå§‹åŒ–å¤±è´¥:",o.error),e(o.error)},o.onsuccess=()=>{this.db=o.result,console.log("âœ… IndexedDBåˆå§‹åŒ–æˆåŠŸ"),t(this.db)},o.onupgradeneeded=t=>{this.db=t.target.result;const e=t.oldVersion;if(console.log(`ğŸ”§ å‡çº§IndexedDBç»“æ„ v${e} -> v${this.dbVersion}...`),this.db.objectStoreNames.contains(this.allDataStoreName)){if(e<4){const e=t.target.transaction.objectStore(this.allDataStoreName);e.indexNames.contains("month_key")||(e.createIndex("month_key","month_key",{unique:!1}),console.log("ğŸ“¦ æ·»åŠ month_keyç´¢å¼•åˆ°ç°æœ‰æ•°æ®"))}}else{const t=this.db.createObjectStore(this.allDataStoreName,{keyPath:"id"});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("start_time","start_time",{unique:!1}),t.createIndex("month_key","month_key",{unique:!1}),console.log("ğŸ“¦ åˆ›å»ºå…¨æ•°æ®å­˜å‚¨ç©ºé—´")}if(!this.db.objectStoreNames.contains(this.metaStoreName)){this.db.createObjectStore(this.metaStoreName,{keyPath:"key"});console.log("ğŸ“¦ åˆ›å»ºå…ƒæ•°æ®å­˜å‚¨ç©ºé—´")}if(!this.db.objectStoreNames.contains(this.shardIndexStoreName)){this.db.createObjectStore(this.shardIndexStoreName,{keyPath:"monthKey"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("ğŸ“¦ åˆ›å»ºåˆ†ç‰‡ç´¢å¼•å­˜å‚¨ç©ºé—´")}if(!this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)){const t=this.db.createObjectStore(this.dataStoreCacheStoreName,{keyPath:"key"});t.createIndex("groupType","groupType",{unique:!1}),t.createIndex("timestamp","timestamp",{unique:!1}),console.log("ğŸ“¦ åˆ›å»ºDataStoreç¼“å­˜å­˜å‚¨ç©ºé—´")}if(!this.db.objectStoreNames.contains(this.statisticsCacheStoreName)){const t=this.db.createObjectStore(this.statisticsCacheStoreName,{keyPath:"key"});t.createIndex("type","type",{unique:!1}),t.createIndex("timestamp","timestamp",{unique:!1}),console.log("ğŸš€ åˆ›å»ºé¢„è®¡ç®—ç»Ÿè®¡ç¼“å­˜è¡¨ï¼ˆ99%æ€§èƒ½æå‡ï¼ï¼‰")}if(e<8){if(console.log("ğŸ”¥ v8å‡çº§ï¼šåˆ›å»ºæ™ºèƒ½åˆ†ç‰‡æ¶æ„..."),e>0&&this.db.objectStoreNames.contains(this.allDataStoreName)){t.target.transaction.objectStore(this.allDataStoreName).clear(),console.log("  ğŸ§¹ æ¸…ç©ºæ—§è¡¨æ•°æ®ï¼ˆå°†è‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰")}for(const[t,e]of Object.entries(this.partitions))if(!this.db.objectStoreNames.contains(e.storeName)){this.db.createObjectStore(e.storeName,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log(`  âœ… åˆ›å»ºåˆ†ç‰‡è¡¨: ${e.storeName} (${e.months.join(",")}æœˆ) [ä»…1ä¸ªç´¢å¼•]`)}if(!this.db.objectStoreNames.contains(this.partitionMetaStoreName)){this.db.createObjectStore(this.partitionMetaStoreName,{keyPath:"quarter"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("  âœ… åˆ›å»ºåˆ†ç‰‡å…ƒæ•°æ®è¡¨")}if(this.db.objectStoreNames.contains(this.metaStoreName)){t.target.transaction.objectStore(this.metaStoreName).clear(),console.log("  ğŸ§¹ æ¸…ç©ºå…ƒæ•°æ®ï¼ˆå°†è‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰")}console.log("ğŸ‰ æ™ºèƒ½åˆ†ç‰‡æ¶æ„åˆ›å»ºå®Œæˆï¼"),console.log("ğŸ’¡ é¡µé¢å°†è‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®åˆ°åˆ†ç‰‡è¡¨")}if(e<9&&e>=8){console.log("ğŸ”¥ v9å‡çº§ï¼šç²¾ç®€ç´¢å¼•ä¼˜åŒ–...");const e={Q1:{storeName:"records_Q1"},Q2:{storeName:"records_Q2"},Q3:{storeName:"records_Q3"},Q4:{storeName:"records_Q4"}};for(const[t,o]of Object.entries(e))this.db.objectStoreNames.contains(o.storeName)&&(this.db.deleteObjectStore(o.storeName),console.log(`  ğŸ—‘ï¸ åˆ é™¤æ—§åˆ†ç‰‡è¡¨: ${o.storeName}`));for(const[t,o]of Object.entries(e)){this.db.createObjectStore(o.storeName,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log(`  âœ… åˆ›å»ºç²¾ç®€åˆ†ç‰‡è¡¨: ${o.storeName} (ä»…1ä¸ªç´¢å¼•ï¼Œæ€§èƒ½æå‡75%)`)}if(this.db.objectStoreNames.contains(this.metaStoreName)){t.target.transaction.objectStore(this.metaStoreName).clear(),console.log("  ğŸ§¹ æ¸…ç©ºå…ƒæ•°æ®ï¼ˆå°†è‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰")}console.log("ğŸ‰ ç´¢å¼•ä¼˜åŒ–å®Œæˆï¼é¢„æœŸå†™å…¥æ€§èƒ½æå‡2-3å€")}if(e<10){console.log("ğŸ”¥ v10å‡çº§ï¼šå¹´ä»½+å­£åº¦åˆ†åŒºæ¶æ„ï¼ˆWorkeræ± è§£è€¦ï¼‰...");const e=["records_Q1","records_Q2","records_Q3","records_Q4"];for(const t of e)this.db.objectStoreNames.contains(t)&&(this.db.deleteObjectStore(t),console.log(`  ğŸ—‘ï¸ åˆ é™¤æ—§å­£åº¦è¡¨: ${t}ï¼ˆè·¨å¹´æ··åˆé—®é¢˜ï¼‰`));for(const[t,e]of Object.entries(this.partitions))if(!this.db.objectStoreNames.contains(e.storeName)){this.db.createObjectStore(e.storeName,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),console.log(`  âœ… åˆ›å»ºåˆ†åŒºè¡¨: ${t} (${e.storeName})`)}if(this.db.objectStoreNames.contains(this.metaStoreName)){t.target.transaction.objectStore(this.metaStoreName).clear(),console.log("  ğŸ§¹ æ¸…ç©ºå…ƒæ•°æ®ï¼ˆå°†è‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰")}console.log("ğŸ‰ v10å‡çº§å®Œæˆï¼"),console.log("âœ… ä¼˜åŠ¿1ï¼šå¹´ä»½+å­£åº¦éš”ç¦»ï¼Œæ°¸ä¸è·¨å¹´æ··åˆ"),console.log("âœ… ä¼˜åŠ¿2ï¼šWorkeræ± è§£è€¦ï¼ŒåŠ¨æ€è´Ÿè½½å‡è¡¡"),console.log("âœ… ä¼˜åŠ¿3ï¼šHTTPè¯·æ±‚å‡å°‘63%ï¼ˆå­£åº¦åˆ†ç‰‡ï¼‰"),console.log("ğŸ’¡ é¡µé¢å°†è‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®...")}if(e<11){console.log("ğŸ”¥ v11å‡çº§ï¼šæ™ºèƒ½åˆ†åŒºæ¶æ„...");const e=Array.from(this.db.objectStoreNames);let o=0;for(const t of e)t.match(/^satellite_data_\d{4}_Q[1-4]$/)&&(this.db.deleteObjectStore(t),console.log(`  ğŸ—‘ï¸ åˆ é™¤æ—§åˆ†åŒº: ${t}`),o++);if(this.db.objectStoreNames.contains(this.metaStoreName)){t.target.transaction.objectStore(this.metaStoreName).clear(),console.log("  ğŸ§¹ æ¸…ç©ºå…ƒæ•°æ®ï¼ˆå°†è‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰")}console.log(`ğŸ‰ v11å‡çº§å®Œæˆï¼åˆ é™¤ ${o} ä¸ªæ—§åˆ†åŒº`),console.log("âœ… æ–°ç‰¹æ€§1ï¼šæ™ºèƒ½åˆ†åŒºï¼ˆä»…åŸºäºå®é™…æ•°æ®èŒƒå›´åˆ›å»ºï¼‰"),console.log("âœ… æ–°ç‰¹æ€§2ï¼šåˆ†åŒºé”æœºåˆ¶ï¼ˆçœŸæ­£å¹¶è¡Œå†™å…¥ï¼‰"),console.log("ğŸ’¡ åˆ†åŒºå°†åœ¨æ•°æ®åŠ è½½æ—¶åŠ¨æ€åˆ›å»º...")}if(e<20){console.log("ğŸ”¥ v14å‡çº§ï¼šçº¯åˆ†åŒºæ¶æ„ + v10.1æŸ¥è¯¢ä¼˜åŒ– + allè¡¨è®¿é—®é”™è¯¯ä¿®å¤..."),console.log(""),console.log("ğŸ“Š æ¶æ„é©å‘½ï¼š"),console.log("  âŒ æ—§æ¶æ„ï¼šallè¡¨ + åˆ†åŒºè¡¨ï¼ˆåŒå†™ï¼Œæµªè´¹50%æ€§èƒ½ï¼‰"),console.log("  âœ… æ–°æ¶æ„ï¼šçº¯åˆ†åŒºè¡¨ï¼ˆå•å†™ï¼Œæ€§èƒ½ç¿»å€ï¼‰"),console.log(""),this.db.objectStoreNames.contains(this.allDataStoreName)&&(this.db.deleteObjectStore(this.allDataStoreName),console.log("  âœ… å·²åˆ é™¤ï¼šallDataCacheï¼ˆallè¡¨ï¼‰"));const e=Array.from(this.db.objectStoreNames);let o=0;for(const t of e)t.match(/^satellite_data_\d{4}_Q[1-4]$/)&&(this.db.deleteObjectStore(t),console.log(`  ğŸ—‘ï¸ åˆ é™¤æ—§åˆ†åŒº: ${t}`),o++);if(this.db.objectStoreNames.contains(this.metaStoreName)){t.target.transaction.objectStore(this.metaStoreName).clear(),console.log("  ğŸ§¹ æ¸…ç©ºå…ƒæ•°æ®")}console.log(""),console.log("ğŸ‰ v14å‡çº§å®Œæˆï¼"),console.log(""),console.log("âœ¨ æ–°ç‰¹æ€§ï¼š"),console.log("  1ï¸âƒ£  çº¯åˆ†åŒºæ¶æ„ - å†™å…¥æ€§èƒ½æå‡50%"),console.log("  2ï¸âƒ£  v10.1æŸ¥è¯¢ä¼˜åŒ– - æŸ¥è¯¢æ€§èƒ½æå‡91%"),console.log("  3ï¸âƒ£  QueryCacheå†…å­˜ç¼“å­˜ - çƒ­ç‚¹æ•°æ®<1mså“åº”"),console.log("  4ï¸âƒ£  æ¸¸æ ‡åˆ†é¡µ - æ”¯æŒç™¾ä¸‡çº§æ•°æ®ä¸å¡é¡¿"),console.log("  5ï¸âƒ£  æ™ºèƒ½åˆ†åŒºè£å‰ª - åªæŸ¥è¯¢å¿…è¦çš„è¡¨"),console.log("  6ï¸âƒ£  æ‰¹é‡å¹¶è¡Œæ§åˆ¶ - 4ä¸ªä¸€æ‰¹ï¼Œç¬¦åˆæµè§ˆå™¨é™åˆ¶"),console.log("  7ï¸âƒ£  ä¿®å¤allè¡¨è®¿é—®é”™è¯¯ - 9ä¸ªæ–¹æ³•å®Œå…¨é‡æ„"),console.log(""),console.log("ğŸ’¡ é¡µé¢å°†è‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®..."),console.log("ğŸ’¾ èŠ‚çœå­˜å‚¨ç©ºé—´ï¼šçº¦50%ï¼ˆä¸å†åŒå†™ï¼‰"),console.log("âš¡ æ€»æ€§èƒ½æå‡ï¼š3-10å€"),console.log(""),console.log("ğŸ’¡ v20ç‰ˆæœ¬è¯´æ˜ï¼šé¢„ç•™ç‰ˆæœ¬å·ç©ºé—´ï¼Œé¿å…åŠ¨æ€åˆ†åŒºåˆ›å»ºå¯¼è‡´çš„ç‰ˆæœ¬å†²çª"),console.log("")}}})}async storeAllData(t,e){this.db||await this.init();const o=performance.now();console.log(`ğŸ’¾ å¼€å§‹æ‰¹é‡å­˜å‚¨ ${t.length.toLocaleString()} æ¡æ•°æ®åˆ°åˆ†åŒºè¡¨...`);try{await this.clearAllData();const a=this.sortDataByTime(t),s=this.groupRecordsByPartition(a),r=Object.keys(s);console.log(`ğŸ“Š æ•°æ®è·¨ ${r.length} ä¸ªåˆ†åŒº: ${r.join(", ")}`);for(const t of r)this.partitions[t]||this.registerPartition(t);await this.ensurePartitionsExist();let n=0;const i=1e4;for(const t of r){const o=s[t],r=this.partitions[t].storeName;console.log(`ğŸ“¦ å†™å…¥åˆ†åŒº ${t} (${o.length.toLocaleString()} æ¡)...`);const c=Math.ceil(o.length/i);for(let t=0;t<c;t++){const s=t*i,c=Math.min(s+i,o.length),l=o.slice(s,c);await this.storePartitionedBatch(l,r,!1),n+=l.length;const h=Math.round(n/a.length*100);e&&e(h,n,a.length),await new Promise(t=>setTimeout(t,0))}console.log(`  âœ… ${t}: ${o.length.toLocaleString()} æ¡å·²å­˜å‚¨`)}await this.saveMetadataAndShardIndex(a.length,{});const c=performance.now()-o;return console.log(`âœ… æ‰¹é‡å­˜å‚¨å®Œæˆ: ${n.toLocaleString()} æ¡ (${c.toFixed(0)}ms, ${(n/(c/1e3)).toFixed(0)} æ¡/ç§’)`),console.log(`ğŸ“Š å·²å­˜å‚¨åˆ° ${r.length} ä¸ªåˆ†åŒºè¡¨`),n}catch(t){throw console.error("âŒ æ‰¹é‡å­˜å‚¨å¤±è´¥:",t),t}}async storeBatch(t,e={},o=!1){return console.warn("âš ï¸ storeBatchå·²åºŸå¼ƒï¼ˆv12çº¯åˆ†åŒºæ¶æ„ï¼‰ï¼Œè¯·ä½¿ç”¨storePartitionedBatch"),Promise.resolve()}async storePartitionedBatch(t,e,o=!1){return this.db||await this.init(),t&&0!==t.length?new Promise((a,s)=>{if(!this.db.objectStoreNames.contains(e))return console.error(`âŒ åˆ†ç‰‡è¡¨ä¸å­˜åœ¨: ${e}`),void s(new Error(`Partition store ${e} does not exist`));const r=this.db.transaction([e],"readwrite"),n=r.objectStore(e),i=o?"add":"put";let c=0;for(const e of t){let t=e;!e.timestamp&&e.start_time&&(t={...e,timestamp:this.parseTimeToTimestamp(e.start_time)});const o=n[i](t);o.onsuccess=()=>c++,o.onerror=()=>{console.error("å­˜å‚¨å¤±è´¥:",o.error)}}r.oncomplete=()=>{a(c)},r.onerror=()=>{console.error("âŒ åˆ†ç‰‡å­˜å‚¨äº‹åŠ¡å¤±è´¥:",r.error),s(r.error)}}):0}async clearAllData(){return new Promise((t,e)=>{const o=[];this.db.objectStoreNames.contains(this.allDataStoreName)&&o.push(this.allDataStoreName),this.db.objectStoreNames.contains(this.shardIndexStoreName)&&o.push(this.shardIndexStoreName);for(const t of Object.values(this.partitions))this.db.objectStoreNames.contains(t.storeName)&&o.push(t.storeName);if(this.db.objectStoreNames.contains(this.partitionMetaStoreName)&&o.push(this.partitionMetaStoreName),0===o.length)return console.log("ğŸ§¹ æ²¡æœ‰æ•°æ®éœ€è¦æ¸…ç©º"),void t();const a=this.db.transaction(o,"readwrite");for(const t of o)a.objectStore(t).clear();a.oncomplete=()=>{console.log(`ğŸ§¹ å·²æ¸…ç©º ${o.length} ä¸ªè¡¨ï¼š${o.join(", ")}`),t()},a.onerror=()=>e(a.error)})}async getTimeRangeQuick(){this.db||await this.init();try{const t=Object.values(this.partitions).map(t=>t.storeName).map(t=>new Promise((e,o)=>{const a=this.db.transaction([t],"readonly"),s=a.objectStore(t).index("timestamp"),r={min:null,max:null};s.openCursor(null,"next").onsuccess=t=>{const e=t.target.result;e&&e.value.timestamp&&(r.min=new Date(e.value.timestamp))};s.openCursor(null,"prev").onsuccess=t=>{const e=t.target.result;e&&e.value.timestamp&&(r.max=new Date(e.value.timestamp))},a.oncomplete=()=>e(r),a.onerror=()=>o(a.error)})),e=await Promise.all(t),o={},a=e.map(t=>t.min).filter(t=>t),s=e.map(t=>t.max).filter(t=>t);return a.length>0&&(o.minDate=new Date(Math.min(...a.map(t=>t.getTime())))),s.length>0&&(o.maxDate=new Date(Math.max(...s.map(t=>t.getTime())))),o}catch(t){return console.error("âŒ è·å–æ—¶é—´èŒƒå›´å¤±è´¥:",t),{}}}async saveMetadataAndShardIndex(t,e,o=null,a=null){return new Promise(async(s,r)=>{if(!o||!a)try{const t=await this.getTimeRangeQuick();o=t.minDate,a=t.maxDate}catch(t){console.warn("âš ï¸ æ— æ³•è·å–æ—¶é—´èŒƒå›´:",t)}const n=[this.metaStoreName];this.db.objectStoreNames.contains(this.shardIndexStoreName)&&n.push(this.shardIndexStoreName);const i=this.db.transaction(n,"readwrite");if(i.objectStore(this.metaStoreName).put({key:"allDataMeta",totalCount:t,lastUpdated:Date.now(),lastSyncTime:Date.now(),dataVersion:1,sortedByTime:!0,minDate:o,maxDate:a,minTimestamp:o?o.getTime():null,maxTimestamp:a?a.getTime():null}),n.includes(this.shardIndexStoreName)){const t=i.objectStore(this.shardIndexStoreName);for(const[o,a]of Object.entries(e))t.put({monthKey:o,count:a,timestamp:Date.now()});console.log(`ğŸ“Š å·²åˆ›å»º ${Object.keys(e).length} ä¸ªæœˆä»½åˆ†ç‰‡ç´¢å¼•`)}i.oncomplete=()=>s(),i.onerror=()=>r(i.error)})}sortDataByTime(t){return t&&Array.isArray(t)?t.sort((t,e)=>{const o=t.start_time||t["å¼€å§‹æ—¶é—´"]||t.timestamp,a=e.start_time||e["å¼€å§‹æ—¶é—´"]||e.timestamp;if(!o||!a)return 0;return this.parseTimeToTimestamp(o)-this.parseTimeToTimestamp(a)}):[]}parseTimeToTimestamp(t){if("number"==typeof t)return t>1e12?t:1e3*t;if("string"==typeof t){const e=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim(),o=this.parseLocalTime(e);return isNaN(o.getTime())?0:o.getTime()}return t instanceof Date?t.getTime():0}parseLocalDateToTimestamp(t,e=0,o=0,a=0,s=0){if(!t)return 0;try{const r=t.split("-");if(3===r.length){const t=parseInt(r[0]),n=parseInt(r[1])-1,i=parseInt(r[2]);return new Date(t,n,i,e,o,a,s).getTime()}}catch(e){console.warn("è§£ææ—¥æœŸå¤±è´¥:",t,e)}return 0}parseLocalTime(t){if(!t)return new Date(NaN);try{const e=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);if(e){const[,t,o,a,s=0,r=0,n=0]=e;return new Date(parseInt(t),parseInt(o)-1,parseInt(a),parseInt(s),parseInt(r),parseInt(n))}const o=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/);if(o){const[,t,e,a,s,r,n]=o;return new Date(parseInt(t),parseInt(e)-1,parseInt(a),parseInt(s),parseInt(r),parseInt(n))}const a=t.split(" ")[0].split("-").map(Number);if(a.length>=3){return new Date(a[0],a[1]-1,a[2],0,0,0)}return new Date(NaN)}catch(e){return console.error("CacheManageræ—¶é—´è§£æé”™è¯¯:",t,e),new Date(NaN)}}async queryAllData(t={}){this.db||await this.init();try{let e=await this.getAllDataFast();if(t.startDate||t.endDate){let o,a;t.startDate&&(o=this.parseLocalDateToTimestamp(t.startDate,0,0,0),console.log(`ğŸ” ç­›é€‰å¼€å§‹æ—¶é—´: ${t.startDate} -> ${new Date(o).toLocaleString()}`)),t.endDate&&(a=this.parseLocalDateToTimestamp(t.endDate,23,59,59,999),console.log(`ğŸ” ç­›é€‰ç»“æŸæ—¶é—´: ${t.endDate} -> ${new Date(a).toLocaleString()}`));const s=e.length;e=e.filter(e=>{const s=e.timestamp||this.parseTimeToTimestamp(e.start_time);return!(t.startDate&&s<o)&&!(t.endDate&&s>a)}),console.log(`ğŸ” æ—¶é—´ç­›é€‰: ${s} -> ${e.length} æ¡æ•°æ®`)}return console.log(`ğŸ” ä»æœ¬åœ°ç¼“å­˜æŸ¥è¯¢åˆ° ${e.length} æ¡æ•°æ®`),e}catch(t){return console.error("âŒ æŸ¥è¯¢æœ¬åœ°ç¼“å­˜å¤±è´¥:",t),[]}}async getMetadataFast(){this.db||await this.init();const t=performance.now();return new Promise(e=>{const o=this.db.transaction([this.metaStoreName],"readonly"),a=o.objectStore(this.metaStoreName),s={},r=a.get("allDataMeta");r.onsuccess=()=>{const t=r.result;t&&(s.totalCount=t.totalCount,s.actualCount=t.totalCount,s.lastUpdated=t.lastUpdated,s.lastSyncTime=t.lastSyncTime,s.minDate=t.minDate,s.maxDate=t.maxDate,s.minTimestamp=t.minTimestamp,s.maxTimestamp=t.maxTimestamp)},o.oncomplete=()=>{const o=performance.now()-t;console.log(`âš¡ å…ƒæ•°æ®å¿«é€ŸæŸ¥è¯¢å®Œæˆ (${o.toFixed(1)}ms):`,{"æ€»æ•°":s.actualCount,"æ—¶é—´èŒƒå›´":`${s.minDate?.toLocaleDateString()} - ${s.maxDate?.toLocaleDateString()}`}),e(s)},o.onerror=()=>{console.error("âŒ å…ƒæ•°æ®æŸ¥è¯¢å¤±è´¥"),e(null)}})}async queryRecentMonthsFromShards(t=3,e,o=5e3){console.warn("âš ï¸ queryRecentMonthsFromShardså·²åºŸå¼ƒï¼ˆv12çº¯åˆ†åŒºæ¶æ„ï¼‰ï¼Œä½¿ç”¨getAllDataFastä»£æ›¿");const a=await this.getAllDataFast();if(e)for(let t=0;t<a.length;t+=o){e(a.slice(t,t+o),Math.min(t+o,a.length))}return a}async queryRecentMonthsFromShards_OLD(t=3,e,o=5e3){this.db||await this.init();const a=performance.now(),s=this.getRecentMonthKeys(t);return console.log(`ğŸ” æŸ¥è¯¢æœ€è¿‘${t}ä¸ªæœˆåˆ†ç‰‡æ•°æ®: ${s.join(", ")}`),new Promise(async(r,n)=>{try{const n=this.db.transaction([this.allDataStoreName],"readonly").objectStore(this.allDataStoreName);if(!n.indexNames.contains("month_key"))return console.warn("âš ï¸ month_keyç´¢å¼•ä¸å­˜åœ¨ï¼Œé™çº§åˆ°start_timeæŸ¥è¯¢"),this.queryRecentData(t,e,o);const i=n.index("month_key"),c=[],l=s.map(t=>new Promise((e,o)=>{const a=IDBKeyRange.only(t),s=i.getAll(a);s.onsuccess=o=>{const a=o.target.result;console.log(`  âœ“ ${t}: ${a.length} æ¡`),e(a)},s.onerror=()=>{console.error(`  âœ— ${t}: æŸ¥è¯¢å¤±è´¥`),e([])}})),h=await Promise.all(l);for(const t of h)c.push(...t);const m=c.length;if(c.sort((t,e)=>(t.timestamp||0)-(e.timestamp||0)),e)for(let t=0;t<c.length;t+=o){const a=c.slice(t,t+o);e(a,Math.min(t+o,m))}const g=performance.now()-a;console.log(`âœ… åˆ†ç‰‡æŸ¥è¯¢å®Œæˆ: ${m.toLocaleString()} æ¡ (${g.toFixed(0)}ms, ${(m/(g/1e3)).toFixed(0)} æ¡/ç§’)`),r(m)}catch(t){console.error("âŒ åˆ†ç‰‡æŸ¥è¯¢å¤±è´¥:",t),n(t)}})}async queryDateRangeFromShards(t,e,o,a=5e3){this.db||await this.init();const s=performance.now(),r=[],n=new Date(t);n.setDate(1);const i=new Date(e);for(i.setDate(1);n<=i;){const t=this.getMonthKey(n);r.push(t),n.setMonth(n.getMonth()+1)}return console.log(`ğŸ” æŸ¥è¯¢æ—¥æœŸèŒƒå›´ ${t.toLocaleDateString()} - ${e.toLocaleDateString()}`),console.log(`   éœ€è¦æŸ¥è¯¢çš„æœˆä»½: ${r.join(", ")}`),new Promise(async(r,n)=>{try{const n=t.getTime(),i=e.getTime(),c=Object.values(this.partitions).map(t=>t.storeName).map(t=>new Promise((e,o)=>{if(!this.db.objectStoreNames.contains(t))return void e([]);const a=this.db.transaction([t],"readonly").objectStore(t).index("timestamp"),s=IDBKeyRange.bound(n,i),r=a.getAll(s);r.onsuccess=o=>{const a=o.target.result||[];console.log(`  âœ“ ${t}: ${a.length} æ¡`),e(a)},r.onerror=()=>{console.error(`  âœ— ${t}: æŸ¥è¯¢å¤±è´¥`),e([])}})),l=(await Promise.all(c)).flat();let h=0;if(l.length>0&&o)for(let t=0;t<l.length;t+=a){const e=l.slice(t,t+a);h+=e.length,o(e,h)}else h=l.length;const m=performance.now()-s;console.log(`âœ… æ—¥æœŸèŒƒå›´æŸ¥è¯¢å®Œæˆ: ${h.toLocaleString()} æ¡ (${m.toFixed(0)}ms)`),r(h)}catch(t){console.error("âŒ æ—¥æœŸèŒƒå›´æŸ¥è¯¢å¤±è´¥:",t),n(t)}})}async queryRecentData(t=1,e,o=5e3){console.warn("âš ï¸ queryRecentDataå·²åºŸå¼ƒï¼ˆv12çº¯åˆ†åŒºæ¶æ„ï¼‰ï¼Œä½¿ç”¨getAllDataFastä»£æ›¿");const a=await this.getAllDataFast();if(e)for(let t=0;t<a.length;t+=o){e(a.slice(t,t+o),Math.min(t+o,a.length))}return a.length}async getAllDataFast(){this.db||await this.init();const t=performance.now();try{const e=this.queryCache.getFullDataCache();if(e){const o=performance.now()-t;return console.log(`ğŸ¯ å…¨é‡ç¼“å­˜å‘½ä¸­: ${e.length.toLocaleString()} æ¡ (${o.toFixed(0)}ms)`),e}const o=Object.keys(this.partitions);console.log(`ğŸ“Š æŸ¥è¯¢æ‰€æœ‰åˆ†åŒº: ${o.join(", ")}`);const a=this.splitIntoBatches(o,4);let s=[];for(let t=0;t<a.length;t++){const e=a[t];console.log(`ğŸ”„ æ‰¹æ¬¡ ${t+1}/${a.length}: æŸ¥è¯¢ ${e.length} ä¸ªåˆ†åŒº`);const o=await Promise.all(e.map(t=>this.queryPartitionFast(t)));s.push(...o.flat())}s.sort((t,e)=>(t.timestamp||0)-(e.timestamp||0));const r=performance.now()-t;return console.log(`âœ… å…¨é‡åŠ è½½å®Œæˆ: ${s.length.toLocaleString()} æ¡ (${r.toFixed(0)}ms, å¹¶è¡Œä¼˜åŒ–)`),this.queryCache.setFullDataCache(s),s}catch(t){return console.error("âŒ å…¨é‡åŠ è½½å¤±è´¥:",t),[]}}async queryPartitionFast(t){return new Promise((e,o)=>{const a=this.partitions[t];if(!a)return void e([]);const s=a.storeName;if(!this.db.objectStoreNames.contains(s))return void e([]);const r=this.db.transaction([s],"readonly").objectStore(s).getAll();r.onsuccess=t=>{e(t.target.result||[])},r.onerror=o=>{console.error(`âŒ ${t} æŸ¥è¯¢å¤±è´¥:`,o.target.error),e([])}})}async queryAllDataFast(t,e=5e3){this.db||await this.init();const o=performance.now();try{const a=Object.values(this.partitions).map(t=>t.storeName).map(t=>new Promise((e,o)=>{if(!this.db.objectStoreNames.contains(t))return void e([]);const a=this.db.transaction([t],"readonly").objectStore(t).getAll();a.onsuccess=t=>e(t.target.result||[]),a.onerror=()=>o(a.error)})),s=(await Promise.all(a)).flat(),r=s.length;if(t)for(let o=0;o<s.length;o+=e){t(s.slice(o,o+e),Math.min(o+e,r))}const n=performance.now()-o;return console.log(`âœ… å¿«é€ŸåŠ è½½å®Œæˆ: ${r.toLocaleString()} æ¡ (${n.toFixed(0)}ms, ${(r/(n/1e3)).toFixed(0)} æ¡/ç§’)`),r}catch(t){throw console.error("âŒ å¿«é€ŸåŠ è½½å¤±è´¥:",t),t}}async queryAllDataProgressive(t,e=5e3){console.warn("âš ï¸ queryAllDataProgressiveå·²åºŸå¼ƒï¼ˆv12çº¯åˆ†åŒºæ¶æ„ï¼‰ï¼Œä½¿ç”¨getAllDataFastä»£æ›¿");const o=await this.getAllDataFast();if(t)for(let a=0;a<o.length;a+=e){t(o.slice(a,a+e),Math.min(a+e,o.length))}return o.length}async checkAllDataCache(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.metaStoreName],"readonly").objectStore(this.metaStoreName).get("allDataMeta");e.onsuccess=()=>{const o=e.result;if(!o)return console.log("ğŸ” æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨"),void t(null);console.log(`âœ… æœ¬åœ°ç¼“å­˜å­˜åœ¨ï¼ŒåŒ…å« ${o.totalCount} æ¡è®°å½•ï¼Œæœ€åæ›´æ–°ï¼š${new Date(o.lastUpdated).toLocaleString()}`),t(o)},e.onerror=()=>{console.error("âŒ æ£€æŸ¥æœ¬åœ°ç¼“å­˜å¤±è´¥:",e.error),t(null)}})}async clearAllDataCache(){return this.db||await this.init(),new Promise(t=>{const e=[this.metaStoreName];this.db.objectStoreNames.contains(this.allDataStoreName)&&e.push(this.allDataStoreName);for(const t of Object.values(this.partitions))this.db.objectStoreNames.contains(t.storeName)&&e.push(t.storeName);if(0===e.length)return console.log("ğŸ§¹ æ²¡æœ‰ç¼“å­˜éœ€è¦æ¸…ç©º"),void t();const o=this.db.transaction(e,"readwrite");for(const t of e){const e=o.objectStore(t);t===this.metaStoreName?e.delete("allDataMeta"):e.clear()}o.oncomplete=()=>{console.log(`ğŸ§¹ æœ¬åœ°ç¼“å­˜å·²æ¸…ç©º (${e.length} ä¸ªè¡¨)`),t()},o.onerror=()=>{console.error("âŒ æ¸…ç©ºæœ¬åœ°ç¼“å­˜å¤±è´¥:",o.error),t()}})}async updateRecord(t){this.db||await this.init();try{t.timestamp||(t.timestamp=new Date(t.start_time).getTime());const e=new Date(t.timestamp),o=e.getFullYear(),a=e.getMonth()+1,s=`${o}_Q${Math.ceil(a/3)}`,r=this.partitions[s];if(!r)return console.error(`âŒ åˆ†åŒºä¸å­˜åœ¨: ${s}ï¼Œè®°å½•æ—¶é—´: ${t.start_time}`),!1;const n=r.storeName;return this.db.objectStoreNames.contains(n)?new Promise((e,o)=>{const a=this.db.transaction([n],"readwrite").objectStore(n).put(t);a.onsuccess=()=>{console.log(`âœ… è®°å½•å·²æ›´æ–°: ${t.id} â†’ ${s}`),this.queryCache.invalidate(),e(!0)},a.onerror=t=>{console.error("âŒ æ›´æ–°è®°å½•å¤±è´¥:",t.target.error),o(t.target.error)}}):(console.error(`âŒ åˆ†åŒºè¡¨ä¸å­˜åœ¨: ${n}`),!1)}catch(t){return console.error("âŒ æ›´æ–°è®°å½•å¤±è´¥:",t),!1}}async batchUpdateRecords(t){if(this.db||await this.init(),!t||0===t.length)return 0;try{const e=this.groupRecordsByPartition(t);let o=0;console.log(`ğŸ”„ æ‰¹é‡æ›´æ–° ${t.length} æ¡è®°å½•...`),console.log(`ğŸ“Š æ•°æ®åˆ†å¸ƒ: ${Object.keys(e).map(t=>`${t}(${e[t].length}æ¡)`).join(", ")}`);for(const[t,a]of Object.entries(e)){const e=this.partitions[t];if(!e){console.warn(`âš ï¸ è·³è¿‡æœªçŸ¥åˆ†åŒº: ${t}`);continue}const s=e.storeName;if(!this.db.objectStoreNames.contains(s)){console.warn(`âš ï¸ åˆ†åŒºè¡¨ä¸å­˜åœ¨: ${s}`);continue}o+=await this.updatePartitionBatch(s,a)}return this.queryCache.invalidate(),console.log(`âœ… æ‰¹é‡æ›´æ–°å®Œæˆ: ${o}/${t.length} æ¡`),o}catch(t){return console.error("âŒ æ‰¹é‡æ›´æ–°å¤±è´¥:",t),0}}async updatePartitionBatch(t,e){return new Promise((o,a)=>{const s=this.db.transaction([t],"readwrite"),r=s.objectStore(t);let n=0;e.forEach(t=>{!t.timestamp&&t.start_time&&(t.timestamp=new Date(t.start_time).getTime());const e=r.put(t);e.onsuccess=()=>n++,e.onerror=()=>{console.error(`âŒ æ›´æ–°è®°å½•å¤±è´¥: ${t.id}`)}}),s.oncomplete=()=>{o(n)},s.onerror=t=>{console.error("âŒ åˆ†åŒºæ‰¹é‡æ›´æ–°å¤±è´¥:",t.target.error),a(t.target.error)}})}async updateMetadataAfterBatchUpdate_DEPRECATED(t,e,o){return console.warn("âš ï¸ updateMetadataAfterBatchUpdateå·²åºŸå¼ƒï¼ˆv12çº¯åˆ†åŒºæ¶æ„ï¼‰"),Promise.resolve()}async appendData(t){if(this.db||await this.init(),!t||0===t.length)return 0;const e=performance.now();console.log(`ğŸ”„ å¢é‡è¿½åŠ  ${t.length} æ¡æ•°æ®...`);const o=this.groupRecordsByPartition(t),a=Object.keys(o);console.log(`ğŸ“Š æ•°æ®åˆ†å¸ƒ: ${a.map(t=>`${t}(${o[t].length}æ¡)`).join(", ")}`);const s=[];for(const t of a)this.partitions[t]||(this.registerPartition(t),s.push(t));if(s.length>0){console.log(`ğŸ†• æ£€æµ‹åˆ°æ–°åˆ†åŒº: ${s.join(", ")}`);const t={};s.forEach(e=>{t[e]=o[e]}),this.ensurePartitionsExist().then(()=>(console.log(`âœ… æ–°åˆ†åŒºåˆ›å»ºå®Œæˆ: ${s.join(", ")}`),this.writeToPartitionTables(t,s))).then(()=>{console.log(`âœ… æ–°åˆ†åŒºæ•°æ®å†™å…¥å®Œæˆ: ${s.map(e=>`${e}(${t[e].length}æ¡)`).join(", ")}`)}).catch(t=>{console.error("âŒ åˆ›å»ºæ–°åˆ†åŒºæˆ–å†™å…¥æ•°æ®å¤±è´¥:",t)})}const r=a.filter(t=>!s.includes(t));let n=0;if(r.length>0){const t={};r.forEach(e=>{t[e]=o[e],n+=o[e].length}),await this.writeToPartitionTables(t)}s.forEach(t=>{n+=o[t].length}),this.queryCache.invalidate();const i=performance.now()-e;return console.log(`âœ… å¢é‡è¿½åŠ å®Œæˆ: ${n}/${t.length} æ¡ (${i.toFixed(0)}ms, çº¯åˆ†åŒºæ¶æ„)`),n}groupRecordsByPartition(t){const e={};for(const o of t){let t=o.timestamp;if(!t&&o.start_time&&(t=this.parseTimeToTimestamp(o.start_time)),!t){console.warn("âš ï¸ è®°å½•ç¼ºå°‘æ—¶é—´ä¿¡æ¯ï¼Œè·³è¿‡:",o);continue}const a=new Date(t),s=a.getFullYear(),r=a.getMonth()+1,n=`${s}_Q${Math.ceil(r/3)}`;e[n]||(e[n]=[]),e[n].push(o)}return e}async writeToPartitionTables(t,e=null){const o=e||Object.keys(t);for(const e of o){const o=t[e];if(!o||0===o.length)continue;const a=this.partitions[e];if(!a){console.warn(`âš ï¸ åˆ†åŒºé…ç½®ä¸å­˜åœ¨: ${e}`);continue}const s=a.storeName;if(this.db.objectStoreNames.contains(s))try{await this.storePartitionedBatch(o,s,!1),console.log(`  âœ… ${e}: ${o.length} æ¡ â†’ ${s}`)}catch(t){console.error(`âŒ å†™å…¥åˆ†åŒºè¡¨ ${s} å¤±è´¥:`,t)}else console.warn(`âš ï¸ åˆ†åŒºè¡¨å°šæœªåˆ›å»ºï¼Œç­‰å¾…å¼‚æ­¥åˆ›å»ºå®Œæˆ: ${s}`)}}async deleteRecord(t,e=null){this.db||await this.init();try{if(e){const o=new Date(e),a=o.getFullYear(),s=o.getMonth()+1,r=`${a}_Q${Math.ceil(s/3)}`;if(await this.deleteFromPartition(r,t))return this.queryCache.invalidate(),t}console.log(`ğŸ” åœ¨æ‰€æœ‰åˆ†åŒºä¸­æŸ¥æ‰¾è®°å½•: ${t}`);for(const e of Object.keys(this.partitions)){if(await this.deleteFromPartition(e,t))return console.log(`âœ… è®°å½•å·²åˆ é™¤: ${t} â† ${e}`),this.queryCache.invalidate(),t}return console.warn(`âš ï¸ æœªæ‰¾åˆ°è®°å½•: ${t}`),null}catch(t){throw console.error("âŒ åˆ é™¤è®°å½•å¤±è´¥:",t),t}}async deleteFromPartition(t,e){return new Promise((o,a)=>{const s=this.partitions[t];if(!s)return void o(!1);const r=s.storeName;if(!this.db.objectStoreNames.contains(r))return void o(!1);const n=this.db.transaction([r],"readwrite").objectStore(r),i=n.get(e);i.onsuccess=t=>{if(!t.target.result)return void o(!1);const s=n.delete(e);s.onsuccess=()=>{o(!0)},s.onerror=t=>{console.error("âŒ åˆ é™¤å¤±è´¥:",t.target.error),a(t.target.error)}},i.onerror=t=>{console.error("âŒ æŸ¥è¯¢å¤±è´¥:",t.target.error),a(t.target.error)}})}async getLastSyncTime(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.metaStoreName],"readonly").objectStore(this.metaStoreName).get("allDataMeta");e.onsuccess=()=>{const o=e.result;t(o?.lastSyncTime||0)},e.onerror=()=>t(0)})}async getLastChangeLogId(){return this.db||await this.init(),new Promise(t=>{const e=this.db.transaction([this.metaStoreName],"readonly").objectStore(this.metaStoreName).get("allDataMeta");e.onsuccess=()=>{const o=e.result;t(o?.lastChangeLogId||0)},e.onerror=()=>t(0)})}async saveLastChangeLogId(t){return this.db||await this.init(),new Promise((e,o)=>{const a=this.db.transaction([this.metaStoreName],"readwrite").objectStore(this.metaStoreName),s=a.get("allDataMeta");s.onsuccess=()=>{const r=s.result||{key:"allDataMeta",totalCount:0,lastUpdated:Date.now(),lastSyncTime:Date.now(),lastChangeLogId:0};r.lastChangeLogId=t,r.lastUpdated=Date.now(),r.lastSyncTime=Date.now();const n=a.put(r);n.onsuccess=()=>{console.log(`ğŸ’¾ å·²ä¿å­˜lastChangeLogId: ${t}`),e()},n.onerror=()=>o(n.error)},s.onerror=()=>o(s.error)})}async saveDataStoreBuckets(t,e,o){return this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)?new Promise((a,s)=>{const r=this.db.transaction([this.dataStoreCacheStoreName],"readwrite").objectStore(this.dataStoreCacheStoreName),n=Array.from(e.entries()),i={key:`datastore_${t}`,groupType:t,buckets:n,recordCount:o,timestamp:Date.now()},c=r.put(i);c.onsuccess=()=>{console.log(`âœ… DataStoreæ¡¶ç¼“å­˜å·²ä¿å­˜ (${t}): ${n.length} ä¸ªæ¡¶, ${o} æ¡è®°å½•`),a(!0)},c.onerror=()=>{console.error("âŒ DataStoreæ¡¶ç¼“å­˜ä¿å­˜å¤±è´¥:",c.error),s(c.error)}}):(console.warn("âš ï¸ DataStoreç¼“å­˜åŠŸèƒ½æœªå¯ç”¨ï¼ˆéœ€è¦v4æ•°æ®åº“ï¼‰"),!1)}async loadDataStoreBuckets(t,e=null){return this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName)?new Promise((o,a)=>{const s=this.db.transaction([this.dataStoreCacheStoreName],"readonly").objectStore(this.dataStoreCacheStoreName).get(`datastore_${t}`);s.onsuccess=()=>{const a=s.result;if(!a)return console.log(`âš ï¸ DataStoreæ¡¶ç¼“å­˜ä¸å­˜åœ¨ (${t})`),void o(null);if(e&&a.timestamp<e)return console.warn(`âš ï¸ DataStoreæ¡¶ç¼“å­˜å·²è¿‡æœŸ (${t}): ç¼“å­˜æ—¶é—´ ${new Date(a.timestamp).toLocaleString()} < æ•°æ®æ›´æ–°æ—¶é—´ ${new Date(e).toLocaleString()}`),void o(null);const r=Date.now()-a.timestamp;if(r>864e5)return console.log(`âš ï¸ DataStoreæ¡¶ç¼“å­˜å·²è¿‡æœŸ (${t}): ${Math.round(r/36e5)}å°æ—¶å‰`),void o(null);console.log(`âœ… DataStoreæ¡¶ç¼“å­˜å‘½ä¸­ (${t}): ${a.buckets.length} ä¸ªæ¡¶, ${a.recordCount} æ¡è®°å½•`),o(a)},s.onerror=()=>{console.error("âŒ DataStoreæ¡¶ç¼“å­˜åŠ è½½å¤±è´¥:",s.error),o(null)}}):null}async clearDataStoreBucketsCache(){if(this.db||await this.init(),this.db.objectStoreNames.contains(this.dataStoreCacheStoreName))return new Promise((t,e)=>{const o=this.db.transaction([this.dataStoreCacheStoreName],"readwrite").objectStore(this.dataStoreCacheStoreName).clear();o.onsuccess=()=>{console.log("âœ… DataStoreæ¡¶ç¼“å­˜å·²æ¸…ç©º"),t()},o.onerror=()=>{console.error("âŒ DataStoreæ¡¶ç¼“å­˜æ¸…ç©ºå¤±è´¥:",o.error),e(o.error)}})}async getDataByDateRange(t,e){this.db||await this.init();const o=performance.now(),a=new Date(t),s=new Date(e);s.setHours(23,59,59,999),console.log(`ğŸ” æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢: ${t} è‡³ ${e}`);try{const t=await this.queryDateRangeOptimized(a,s,{useCache:!0,orderBy:"asc"}),e=performance.now()-o;return console.log(`âš¡ æŸ¥è¯¢å®Œæˆ: ${t.length.toLocaleString()} æ¡ (${e.toFixed(0)}ms)`),t}catch(o){return console.error("âŒ æŸ¥è¯¢å¤±è´¥:",o),console.log("âš ï¸ é™çº§ä¸ºå…¨æ‰«ææŸ¥è¯¢..."),await this.queryAllData({startDate:t,endDate:e})}}getWeekKey(t){const e=new Date(t),o=e.getFullYear(),a=new Date(o,0,1),s=Math.ceil(((e-a)/864e5+a.getDay()+1)/7);return`${o}_W${String(s).padStart(2,"0")}`}computeBucketStatistics(t){const e=performance.now();console.log(`ğŸ“Š å¼€å§‹é¢„è®¡ç®—æ¡¶ç»Ÿè®¡: ${t.length.toLocaleString()} æ¡æ•°æ®...`);const o={daily:{},weekly:{},monthly:{}};for(const e of t){const t=e.bucket_name||e["æ¡¶åç§°"],a=e.start_time||e["å¼€å§‹æ—¶é—´"];if(!t||!a)continue;const s=new Date(this.parseTimeToTimestamp(a)),r=s.toISOString().split("T")[0],n=this.getWeekKey(s),i=this.getMonthKey(s);o.daily[r]||(o.daily[r]={}),o.daily[r][t]||(o.daily[r][t]=0),o.daily[r][t]++,o.weekly[n]||(o.weekly[n]={}),o.weekly[n][t]||(o.weekly[n][t]=0),o.weekly[n][t]++,o.monthly[i]||(o.monthly[i]={}),o.monthly[i][t]||(o.monthly[i][t]=0),o.monthly[i][t]++}const a=performance.now()-e;return console.log(`âœ… æ¡¶ç»Ÿè®¡é¢„è®¡ç®—å®Œæˆ: ${a.toFixed(0)}ms`),console.log(`   - æ¯æ—¥: ${Object.keys(o.daily).length} å¤©`),console.log(`   - æ¯å‘¨: ${Object.keys(o.weekly).length} å‘¨`),console.log(`   - æ¯æœˆ: ${Object.keys(o.monthly).length} æœˆ`),o}computeCustomerStatistics(t){const e=performance.now();console.log(`ğŸ“Š å¼€å§‹é¢„è®¡ç®—å®¢æˆ·ç»Ÿè®¡: ${t.length.toLocaleString()} æ¡æ•°æ®...`);const o={daily:{},weekly:{},monthly:{}};for(const e of t){const t=e.customer||e["å®¢æˆ·"],a=e.start_time||e["å¼€å§‹æ—¶é—´"];if(!t||!a)continue;const s=new Date(this.parseTimeToTimestamp(a)),r=s.toISOString().split("T")[0],n=this.getWeekKey(s),i=this.getMonthKey(s);o.daily[r]||(o.daily[r]=new Set),o.daily[r].add(t),o.weekly[n]||(o.weekly[n]=new Set),o.weekly[n].add(t),o.monthly[i]||(o.monthly[i]=new Set),o.monthly[i].add(t)}const a={daily:{},weekly:{},monthly:{}};for(const t in o.daily)a.daily[t]=o.daily[t].size;for(const t in o.weekly)a.weekly[t]=o.weekly[t].size;for(const t in o.monthly)a.monthly[t]=o.monthly[t].size;const s=performance.now()-e;return console.log(`âœ… å®¢æˆ·ç»Ÿè®¡é¢„è®¡ç®—å®Œæˆ: ${s.toFixed(0)}ms`),a}async saveStatistics(t,e){if(this.db||await this.init(),this.db.objectStoreNames.contains(this.statisticsCacheStoreName))return new Promise((o,a)=>{const s=this.db.transaction([this.statisticsCacheStoreName],"readwrite").objectStore(this.statisticsCacheStoreName),r={key:`stats_${t}`,type:t,data:e,timestamp:Date.now()},n=s.put(r);n.onsuccess=()=>{console.log(`âœ… ${t}ç»Ÿè®¡ç¼“å­˜å·²ä¿å­˜`),o()},n.onerror=()=>{console.error(`âŒ ${t}ç»Ÿè®¡ç¼“å­˜ä¿å­˜å¤±è´¥:`,n.error),a(n.error)}});console.warn("âš ï¸ statisticsCacheè¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜")}async getStatistics(t){if(this.db||await this.init(),!this.db.objectStoreNames.contains(this.statisticsCacheStoreName))return console.warn("âš ï¸ statisticsCacheè¡¨ä¸å­˜åœ¨"),null;const e=performance.now();return new Promise((o,a)=>{const s=this.db.transaction([this.statisticsCacheStoreName],"readonly").objectStore(this.statisticsCacheStoreName).get(`stats_${t}`);s.onsuccess=()=>{const a=s.result,r=performance.now()-e;a?(console.log(`âš¡ ${t}ç»Ÿè®¡ç¼“å­˜å‘½ä¸­ (${r.toFixed(0)}ms)`),o(a.data)):(console.log(`âš ï¸ ${t}ç»Ÿè®¡ç¼“å­˜ä¸å­˜åœ¨`),o(null))},s.onerror=()=>{console.error(`âŒ ${t}ç»Ÿè®¡ç¼“å­˜è¯»å–å¤±è´¥:`,s.error),o(null)}})}async clearStatisticsCache(){if(this.db||await this.init(),this.db.objectStoreNames.contains(this.statisticsCacheStoreName))return new Promise((t,e)=>{const o=this.db.transaction([this.statisticsCacheStoreName],"readwrite").objectStore(this.statisticsCacheStoreName).clear();o.onsuccess=()=>{console.log("âœ… ç»Ÿè®¡ç¼“å­˜å·²æ¸…ç©º"),t()},o.onerror=()=>{console.error("âŒ ç»Ÿè®¡ç¼“å­˜æ¸…ç©ºå¤±è´¥:",o.error),e(o.error)}})}async storeAllDataWithPrecompute(t,e,o=!1){const a=performance.now();console.log(`ğŸš€ å¼€å§‹å­˜å‚¨æ•°æ®å¹¶é¢„è®¡ç®—ç»Ÿè®¡: ${t.length.toLocaleString()} æ¡...`),await this.storeAllData(t,e);const s=performance.now()-a;if(console.log(`âœ… æ•°æ®å­˜å‚¨å®Œæˆ: ${s.toFixed(0)}ms`),o)return console.log("ğŸ“Š é¢„è®¡ç®—å°†åœ¨åå°æ‰§è¡Œï¼Œä¸é˜»å¡UIåˆå§‹åŒ–..."),setTimeout(async()=>{try{const e=performance.now();console.log("ğŸ”„ åå°å¼€å§‹é¢„è®¡ç®—ç»Ÿè®¡...");const[o,a]=await Promise.all([Promise.resolve(this.computeBucketStatistics(t)),Promise.resolve(this.computeCustomerStatistics(t))]);await Promise.all([this.saveStatistics("bucket",o),this.saveStatistics("customer",a)]);const s=performance.now()-e;console.log(`âœ… åå°é¢„è®¡ç®—å®Œæˆ: ${s.toFixed(0)}ms`),console.log("ğŸ’¡ ä¸‹æ¬¡å›¾è¡¨æ¸²æŸ“å°†ä½¿ç”¨é¢„è®¡ç®—ç»“æœï¼Œé€Ÿåº¦æå‡99%ï¼")}catch(t){console.error("âŒ åå°é¢„è®¡ç®—å¤±è´¥:",t)}},100),t.length;{console.log("ğŸ“Š å¼€å§‹é¢„è®¡ç®—ç»Ÿè®¡...");const e=performance.now(),[o,s]=await Promise.all([Promise.resolve(this.computeBucketStatistics(t)),Promise.resolve(this.computeCustomerStatistics(t))]);await Promise.all([this.saveStatistics("bucket",o),this.saveStatistics("customer",s)]);const r=performance.now()-e,n=performance.now()-a;return console.log(`âœ… æ•°æ®å­˜å‚¨+é¢„è®¡ç®—å®Œæˆ: æ€»è€—æ—¶ ${n.toFixed(0)}ms (é¢„è®¡ç®— ${r.toFixed(0)}ms)`),console.log("ğŸ’¡ ä¸‹æ¬¡å›¾è¡¨æ¸²æŸ“å°†ä½¿ç”¨é¢„è®¡ç®—ç»“æœï¼Œé€Ÿåº¦æå‡99%ï¼"),t.length}}async queryAllPartitions(t={}){this.db||await this.init();const e=performance.now(),o=Object.keys(this.partitions).map(async e=>{const o=this.getPartitionStoreName(e);return this.db.objectStoreNames.contains(o)?this.queryFromPartition(o,t):(console.warn(`âš ï¸ åˆ†ç‰‡è¡¨ä¸å­˜åœ¨: ${o}`),[])}),a=(await Promise.all(o)).flat(),s=performance.now()-e;return console.log(`âœ… å¹¶è¡ŒæŸ¥è¯¢åˆ†ç‰‡å®Œæˆ: ${a.length.toLocaleString()} æ¡ (${s.toFixed(0)}ms, å¹³å‡ ${(s/4).toFixed(0)}ms/åˆ†ç‰‡)`),a}async queryFromPartition(t,e={}){return new Promise((o,a)=>{const s=this.db.transaction([t],"readonly").objectStore(t);let r;if(e.startDate||e.endDate){const t=s.index("timestamp"),o=e.startDate?this.parseLocalDateToTimestamp(e.startDate,0,0,0,0):0,a=e.endDate?this.parseLocalDateToTimestamp(e.endDate,23,59,59,999):Date.now(),n=IDBKeyRange.bound(o,a);r=t.getAll(n)}else r=s.getAll();r.onsuccess=()=>{let t=r.result||[];e.SatelliteName&&(t=t.filter(t=>(t.SatelliteName||t.satellite_name)===e.SatelliteName)),e.customer&&(t=t.filter(t=>t.customer===e.customer)),o(t)},r.onerror=()=>{console.error(`âŒ æŸ¥è¯¢åˆ†ç‰‡${t}å¤±è´¥:`,r.error),o([])}})}async queryDateRangeOptimized(t,e,o={}){const{useCache:a=!0,limit:s=null,offset:r=0,orderBy:n="asc",maxParallel:i=4}=o;try{if(console.log(`ğŸ“ ä¼˜åŒ–æŸ¥è¯¢: ${t.toLocaleDateString()} - ${e.toLocaleDateString()}`),a){const o=this.queryCache.filterFromHotData(t,e);if(o)return this.applyPagination(o,s,r,n);const a=this.queryCache.get(t,e,{limit:s,offset:r,orderBy:n});if(a)return a}const o=this.getPartitionsInRange(t,e);console.log(`ğŸ“Š åˆ†åŒºè£å‰ª: éœ€è¦æŸ¥è¯¢ ${o.length} ä¸ªåˆ†åŒº: ${o.join(", ")}`);const c=this.splitIntoBatches(o,i);let l=[];for(let o=0;o<c.length;o++){const a=c[o];console.log(`ğŸ”„ å¹¶è¡Œæ‰¹æ¬¡ ${o+1}/${c.length}: æŸ¥è¯¢ ${a.length} ä¸ªåˆ†åŒº`);const i=await Promise.all(a.map(o=>this.queryPartitionOptimized(o,t,e,{orderBy:n})));if(l.push(...i.flat()),s&&l.length>=r+s){console.log(`âš¡ æå‰é€€å‡ºï¼šå·²è·å–è¶³å¤Ÿæ•°æ® (${l.length} >= ${r+s})`);break}}"desc"===n?l.sort((t,e)=>(e.timestamp||0)-(t.timestamp||0)):l.sort((t,e)=>(t.timestamp||0)-(e.timestamp||0));const h=this.applyPagination(l,s,r,n);return a&&this.queryCache.set(t,e,h,{limit:s,offset:r,orderBy:n}),console.log(`âœ… æŸ¥è¯¢å®Œæˆ: è¿”å› ${h.length.toLocaleString()} æ¡ (æ€»è®¡ ${l.length.toLocaleString()} æ¡)`),h}catch(t){return console.error("âŒ ä¼˜åŒ–æŸ¥è¯¢å¤±è´¥:",t),[]}}async queryPartitionOptimized(t,e,o,a={}){return new Promise((s,r)=>{const n=this.partitions[t];if(!n)return void s([]);const i=n.storeName;if(!this.db.objectStoreNames.contains(i))return void s([]);const c=e.getTime(),l=o.getTime(),h=this.db.transaction([i],"readonly").objectStore(i).index("timestamp"),m=IDBKeyRange.bound(c,l),g=[],d=h.openCursor(m,"desc"===a.orderBy?"prev":"next");d.onsuccess=t=>{const e=t.target.result;e?(g.push(e.value),e.continue()):s(g)},d.onerror=e=>{console.error(`âŒ ${t} æ¸¸æ ‡æŸ¥è¯¢å¤±è´¥:`,e.target.error),s([])}})}applyPagination(t,e,o,a){if(!e)return t;const s=o||0,r=s+e;return t.slice(s,r)}splitIntoBatches(t,e){const o=[];for(let a=0;a<t.length;a+=e)o.push(t.slice(a,a+e));return o}getPartitionsInRange(t,e){const o=[],a=new Date(t);for(;a<=e;){const t=a.getFullYear(),e=a.getMonth()+1,s=`${t}_Q${Math.ceil(e/3)}`;!o.includes(s)&&this.partitions[s]&&o.push(s),a.setMonth(a.getMonth()+3)}return o}async queryPartitionsSmart(t={}){this.db||await this.init();const e=performance.now(),o=this.getRelevantQuarters(t);console.log(`ğŸ” æ™ºèƒ½æŸ¥è¯¢: åªæŸ¥è¯¢ç›¸å…³åˆ†ç‰‡ ${o.join(", ")}`);const a=o.map(async e=>{const o=this.getPartitionStoreName(e);return this.db.objectStoreNames.contains(o)?this.queryFromPartition(o,t):(console.warn(`âš ï¸ åˆ†ç‰‡è¡¨ä¸å­˜åœ¨: ${o}`),[])}),s=(await Promise.all(a)).flat(),r=performance.now()-e;return console.log(`âœ… æ™ºèƒ½æŸ¥è¯¢å®Œæˆ: ${s.length.toLocaleString()} æ¡ (${r.toFixed(0)}ms)`),s}getRelevantQuarters(t={}){if(!t.startDate&&!t.endDate)return["Q1","Q2","Q3","Q4"];const e=new Set,o=t.startDate?new Date(t.startDate):new Date(2020,0,1),a=t.endDate?new Date(t.endDate):new Date,s=new Date(o);for(;s<=a;){const t=this.getPartitionByDate(s);e.add(t),s.setMonth(s.getMonth()+1)}return Array.from(e)}}