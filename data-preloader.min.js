class DataPreloader{constructor(){this.isPreloading=!1,this.preloadProgress=0}async autoPreloadAllData(t=!1,e=null){try{console.log("ğŸš€ é¡µé¢åŠ è½½ï¼šå¼€å§‹æ™ºèƒ½é¢„è½½æ•°æ®..."),this.isPreloading=!0,this.updatePreloadStatus("æ­£åœ¨æ£€æŸ¥æœ¬åœ°ç¼“å­˜...","loading");const o=await cacheManager.checkAllDataCache();if(t)console.log("ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ¨¡å¼ï¼Œè·³è¿‡ç¼“å­˜æ£€æŸ¥...");else if(o&&o.totalCount>0){const t=Date.now()-o.lastUpdated,e=Math.round(t/6e4);Math.round(t/36e5);return console.log(`âœ… ä½¿ç”¨IndexedDBç¼“å­˜ï¼ˆ${o.totalCount.toLocaleString()} æ¡è®°å½•ï¼Œ${e}åˆ†é’Ÿå‰æ›´æ–°ï¼‰`),this.updatePreloadStatus(`âœ… ä»æœ¬åœ°ç¼“å­˜åŠ è½½ ${o.totalCount.toLocaleString()} æ¡æ•°æ®ï¼ˆç§’é€ŸåŠ è½½ï¼‰`,"success"),this.isPreloading=!1,e>30?(console.log(`â±ï¸ ç¼“å­˜å·² ${e} åˆ†é’Ÿæœªæ›´æ–°ï¼Œå¯åŠ¨å¢é‡å¹¶å‘åŠ è½½...`),setTimeout(async()=>{try{const t=await this.incrementalParallelLoad(o.lastUpdated);t.totalCount>0&&(console.log(`âœ… å¢é‡æ›´æ–°å®Œæˆï¼šæ–°å¢ ${t.totalCount} æ¡æ•°æ®`),window.satelliteApp&&window.satelliteApp.refreshData&&window.satelliteApp.refreshData())}catch(t){console.error("âŒ å¢é‡æ›´æ–°å¤±è´¥:",t)}},100)):console.log(`ğŸ’¡ ç¼“å­˜å¾ˆæ–° (${e}åˆ†é’Ÿå‰æ›´æ–°)ï¼Œä¾èµ–WebSocketå®æ—¶åŒæ­¥`),{success:!0,totalCount:o.totalCount}}o&&0===o.totalCount?(console.log("âš ï¸ ç¼“å­˜å…ƒæ•°æ®æ˜¾ç¤º0æ¡è®°å½•ï¼Œå¯èƒ½æ˜¯æ–°å»ºæ•°æ®åº“æˆ–æ•°æ®å·²æ¸…ç©º"),console.log("ğŸ“¡ æ‰§è¡Œå…¨é‡æ•°æ®åŠ è½½...")):console.log("ğŸ“¡ ç¼“å­˜ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¹¶è¡Œåˆ†ç‰‡åŠ è½½å…¨é‡æ•°æ®..."),this.updatePreloadStatus("æ­£åœ¨å¹¶è¡Œè·å–æ•°æ®...","loading");const a=await this.parallelShardedLoad((t,o,a)=>{this.updatePreloadStatus(`æ­£åœ¨åŠ è½½æ•°æ®... ${o.toLocaleString()}/${a.toLocaleString()} (${t}%)`,"loading"),e&&e(t,o,a)});return this.updatePreloadStatus(`âœ… æˆåŠŸåŠ è½½å…¨é‡æ•°æ®ï¼ˆ${a.totalCount.toLocaleString()} æ¡ï¼‰`,"success"),this.isPreloading=!1,console.log("ğŸ¯ å…¨é‡æ•°æ®å·²ç¼“å­˜ï¼Œæ”¯æŒè·¨é¡µé¢å®Œæ•´å…±äº«"),{success:!0,totalCount:a.totalCount}}catch(t){console.error("âŒ æ•°æ®é¢„è½½å¤±è´¥:",t),this.updatePreloadStatus("âŒ æœ€è¿‘æ•°æ®åŠ è½½å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ...","warning");try{const t=await this.fallbackLoadAll();return this.isPreloading=!1,t}catch(t){throw console.error("âŒ é™çº§æ–¹æ¡ˆä¹Ÿå¤±è´¥:",t),this.updatePreloadStatus(`âŒ æ•°æ®é¢„è½½å¤±è´¥: ${t.message}`,"error"),this.isPreloading=!1,t}}}async incrementalParallelLoad(t,e){const o=performance.now();console.log("ğŸš€ å¯åŠ¨å¢é‡å¹¶å‘åŠ è½½ï¼ˆåªè·å–æ–°å¢æ•°æ®ï¼‰...");try{const a=new Date(t),n=new Date,r=n-a,s=r/864e5;let l;console.log(`ğŸ“Š å¢é‡æ—¶é—´èŒƒå›´: ${a.toLocaleString()} â†’ ${n.toLocaleString()} (${s.toFixed(1)}å¤©)`);const c=r/36e5;if(c<=12?(l=[{start:a.toISOString(),end:n.toISOString(),label:`${Math.round(60*c)}åˆ†é’Ÿ`}],console.log(`ğŸ“Š æ—¶é—´èŒƒå›´ ${c.toFixed(1)} å°æ—¶ï¼Œä½¿ç”¨å•æ¬¡è¯·æ±‚ï¼ˆé¿å…è¿‡åº¦åˆ†ç‰‡ï¼‰`)):l=c<=24?this.generateHourlyShards(a,n,6):s<=7?this.generateHourlyShards(a,n,12):s<=30?this.generateDailyShards(a,n):s<=90?this.generateWeeklyShards(a,n):this.generateMonthlyShards(a,n),console.log(`ğŸ“Š ç”Ÿæˆ ${l.length} ä¸ªå¢é‡åˆ†ç‰‡ï¼ˆå¹¶è¡ŒåŠ è½½ï¼‰`),0===l.length)return console.log("âœ… æ— éœ€å¢é‡æ›´æ–°"),{success:!0,totalCount:0};const i=this.calculateOptimalConcurrency(l.length);let g=0,h=0,d=0;const u=[];let $=!1;const m=3,w=1e3,p=async t=>{let o=0,a=[],n=[];for(;!$||u.length>0||a.length>0;){if(0===u.length&&a.length<w&&!$){await new Promise(t=>setTimeout(t,10));continue}if(u.length>0){const{records:t,shard:e,downloadTime:o}=u.shift();t&&t.length>0&&(a.push(...t),n.push({shard:e,downloadTime:o,count:t.length}),h++)}if((a.length>=w||$&&0===u.length)&&a.length>0)try{const r=performance.now();await cacheManager.appendData(a);const s=performance.now()-r,c=n.length,i=a.length,d=n.reduce((t,e)=>t+e.downloadTime,0)/c;if(c>1)console.log(`  ğŸ’¾ StorageWorker${t} åˆå¹¶è¿½åŠ  ${c} ä¸ªåˆ†ç‰‡: ${i.toLocaleString()} æ¡ (å¹³å‡ä¸‹è½½${d.toFixed(0)}ms + å­˜å‚¨${s.toFixed(0)}ms)`),console.log(`     ğŸ“¦ åˆå¹¶æ˜ç»†: ${n.map(t=>`${t.shard.label}(${t.count})`).join(", ")}`);else{const e=n[0];console.log(`  ğŸ’¾ StorageWorker${t} è¿½åŠ  ${e.shard.label}: ${i.toLocaleString()} æ¡ (ä¸‹è½½${e.downloadTime.toFixed(0)}ms + å­˜å‚¨${s.toFixed(0)}ms)`)}o+=i,g+=i;const u=Math.round(h/l.length*100);e&&e(u,g,g),a=[],n=[]}catch(e){console.error(`âŒ StorageWorker${t} å­˜å‚¨æ‰¹æ¬¡å¤±è´¥:`,e),a=[],n=[]}}console.log(`âœ… StorageWorker${t} å®Œæˆï¼Œè¿½åŠ  ${o.toLocaleString()} æ¡æ•°æ®`)},S=async t=>{for(;d<l.length;){const e=l[d++];try{const o=performance.now(),a=await this.fetchShardData(e),n=performance.now()-o;a&&a.length>0&&(console.log(`  âœ“ Worker${t} ä¸‹è½½+è§£æ ${e.label}: ${a.length.toLocaleString()} æ¡ (${n.toFixed(0)}ms)`),u.push({records:a,shard:e,downloadTime:n}))}catch(t){console.error(`âŒ å¢é‡åˆ†ç‰‡ ${e.label} å¤±è´¥:`,t)}await new Promise(t=>setTimeout(t,0))}},D=Array.from({length:m},(t,e)=>p(e+1)),f=Array.from({length:i},(t,e)=>S(e+1));console.log(`ğŸ”¥ å¢é‡åŠ è½½ï¼šå¯åŠ¨ ${i} ä¸ªä¸‹è½½Worker`),await Promise.all(f),console.log(`âœ… å¢é‡ä¸‹è½½å®Œæˆï¼Œç­‰å¾… ${m} ä¸ªå­˜å‚¨Workeræ¸…ç©ºé˜Ÿåˆ—...`),$=!0,await Promise.all(D);const y=performance.now()-o;return console.log(`âœ… å¢é‡å¹¶å‘åŠ è½½å®Œæˆ: ${g.toLocaleString()} æ¡æ–°å¢æ•°æ® (${(y/1e3).toFixed(1)}ç§’)`),{success:!0,totalCount:g}}catch(t){throw console.error("âŒ å¢é‡å¹¶å‘åŠ è½½å¤±è´¥:",t),t}}async parallelShardedLoad(t){const e=performance.now();console.log("ğŸš€ å¯åŠ¨æµæ°´çº¿å¹¶è¡ŒåŠ è½½ï¼ˆæ™ºèƒ½åˆ†ç‰‡æ¶æ„ï¼‰...");try{let o,a,n;console.log("ğŸ“¡ æŸ¥è¯¢æ•°æ®ç»Ÿè®¡ä¿¡æ¯ä»¥è·å–ç²¾ç¡®èŒƒå›´...");const r=performance.now();try{const T=getApiUrl("stats"),b=await fetch(T),k=await b.json(),A=performance.now()-r;if(!k.success||!k.data)throw new Error("ç»Ÿè®¡æ•°æ®æ ¼å¼é”™è¯¯");{const F=k.data;n=F.total_records,o=new Date(F.earliest_time),a=new Date(F.latest_time);const x=Math.ceil((a-o)/864e5);console.log(`âœ… StatsæŸ¥è¯¢å®Œæˆ: ${n.toLocaleString()} æ¡è®°å½•`),console.log(`âœ… ç²¾ç¡®æ—¶é—´èŒƒå›´: ${o.toLocaleDateString()} - ${a.toLocaleDateString()} (${x}å¤©)`);const _=F.cached?"ç¼“å­˜":"SQLèšåˆæŸ¥è¯¢",O=F.cached?"âš¡âš¡":"âš¡";console.log(`${O} ç»Ÿè®¡æŸ¥è¯¢è€—æ—¶: ${A.toFixed(0)}ms (${_})`)}}catch(W){console.warn("âš ï¸ StatsæŸ¥è¯¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤2å¹´èŒƒå›´:",W.message),a=new Date,o=new Date,o.setFullYear(o.getFullYear()-2),console.log(`ğŸ“Š é™çº§èŒƒå›´: ${o.toLocaleDateString()} - ${a.toLocaleDateString()} (2å¹´)`)}const s=this.generateAdaptiveShards(o,a);s.sort((t,e)=>new Date(t.start)-new Date(e.start)),console.log(`ğŸ“Š ç”Ÿæˆ ${s.length} ä¸ªåˆ†ç‰‡ï¼ˆå·²æŒ‰æ—¶é—´æ’åºï¼Œä¼˜åŒ–B-treeå†™å…¥æ€§èƒ½ï¼‰`),console.log("ğŸ“‹ åˆ†ç‰‡é¡ºåº:",s.map(t=>t.partitionId).join(" â†’ ")),console.log(`ğŸ¯ æ™ºèƒ½åˆ†åŒºï¼šæ ¹æ®å®é™…æ•°æ®èŒƒå›´ ${o.toLocaleDateString()} - ${a.toLocaleDateString()} åŠ¨æ€åˆ›å»ºåˆ†åŒº`);for(const C of s)cacheManager.registerPartition(C.partitionId);console.log(`âœ… å·²æ³¨å†Œ ${s.length} ä¸ªåˆ†åŒº:`,s.map(t=>t.partitionId).join(", ")),await cacheManager.ensurePartitionsExist(),console.log("âœ… IndexedDBåˆ†åŒºè¡¨å·²å°±ç»ª");const l=this.calculateOptimalConcurrency(s.length);let c=0,i=0,g=0,h=0;await cacheManager.clearAllData(),console.log(`ğŸ“¥ å¯åŠ¨ ${l} ä¸ªå¹¶å‘workerå¤„ç† ${s.length} ä¸ªåˆ†ç‰‡`),console.log(`âš¡ å¹¶å‘ç­–ç•¥ï¼š${l} workers Ã— ${Math.ceil(s.length/l)} è½® = æœ€å¤§åŒ–ååé‡`);const d={};for(const H of s)d[H.partitionId]=[];console.log("ğŸ“¦ åˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—æ± :",Object.keys(d).join(", "));let u=!1;const $=3,m=5e4,w=new Set,p=async e=>{let o=0;for(console.log(`ğŸ’¾ StorageWorker${e} å¯åŠ¨ï¼ˆåˆ†åŒºé”æ¨¡å¼ï¼‰`);!u||S();){let a=!1,n=null;for(const[r,l]of Object.entries(d)){if(0===l.length)continue;if(w.has(r))continue;w.add(r),a=!0,n=r;const h=l.length,d=cacheManager.getPartitionStoreName(r);console.log(`  ğŸ”’ Worker${e} é”å®šåˆ†åŒº ${r} (${h.toLocaleString()} æ¡å¾…å¤„ç†)`);try{const a=performance.now();let n=0;for(;l.length>0;){let t;t=l.length<=.4*m?l.length:Math.min(l.length,m);const a=l.splice(0,t),s=performance.now();await cacheManager.storePartitionedBatch(a,d,!0);const i=performance.now()-s;n+=a.length,o+=a.length,c+=a.length;const g=a.length/(i/1e3);console.log(`  ğŸ’¾ Worker${e} â†’ ${r}: ${a.length.toLocaleString()} æ¡ (${i.toFixed(0)}ms, ${g.toFixed(0)} æ¡/ç§’)`)}const h=performance.now()-a,u=n/(h/1e3);console.log(`  âœ… Worker${e} å®Œæˆåˆ†åŒº ${r}: ${n.toLocaleString()} æ¡ (æ€»è®¡${h.toFixed(0)}ms, ${u.toFixed(0)} æ¡/ç§’)`),i++;const $=Math.min(30,Math.round(g/s.length*30)),w=Math.round(i/s.length*70);t&&t($+w,c,c)}catch(t){console.error(`âŒ Worker${e} å­˜å‚¨${n}å¤±è´¥:`,t)}finally{w.delete(n),console.log(`  ğŸ”“ Worker${e} é‡Šæ”¾åˆ†åŒº ${n}`)}break}a||await new Promise(t=>setTimeout(t,10))}console.log(`âœ… StorageWorker${e} å®Œæˆï¼Œå­˜å‚¨ ${o.toLocaleString()} æ¡æ•°æ®`)};function S(){return Object.values(d).some(t=>t.length>0)}const D=async t=>{for(;h<s.length;){const e=h++,o=s[e];try{const e=performance.now(),a=await this.fetchShardData(o),n=performance.now()-e;if(a&&a.length>0){console.log(`  âœ“ Worker${t} ä¸‹è½½+è§£æ ${o.label}: ${a.length.toLocaleString()} æ¡ (${n.toFixed(0)}ms)`);const e=o.partitionId;d[e].push(...a),console.log(`    ğŸ“ è·¯ç”±: ${e} â† ${a.length.toLocaleString()} æ¡`),g++}}catch(e){console.error(`âŒ Worker${t} ä¸‹è½½åˆ†ç‰‡ ${o.label} å¤±è´¥:`,e)}await new Promise(t=>setTimeout(t,0))}},f=Array.from({length:$},(t,e)=>p(e+1));console.log(`ğŸ’¾ å¯åŠ¨ ${$} ä¸ªå­˜å‚¨Workerå¹¶è¡Œå¤„ç†`);const y=Array.from({length:l},(t,e)=>D(e+1));let L,M;console.log(`ğŸ”¥ æ¶æ„ä¼˜åŒ–ï¼šå¯åŠ¨ ${l} ä¸ªä¸‹è½½Workerï¼ˆä¸å—${s.length}ä¸ªåˆ†ç‰‡é™åˆ¶ï¼‰`),await Promise.all(y),console.log(`âœ… æ‰€æœ‰ä¸‹è½½Workerå®Œæˆï¼Œç­‰å¾… ${$} ä¸ªå­˜å‚¨Workeræ¸…ç©ºé˜Ÿåˆ—...`),u=!0,await Promise.all(f),console.log("ğŸ“Š ä¿å­˜å…ƒæ•°æ®å’Œç´¢å¼•...");try{const j=await cacheManager.getTimeRangeQuick();L=j.minDate,M=j.maxDate,console.log(`ğŸ“… æ•°æ®æ—¶é—´èŒƒå›´: ${L?.toLocaleDateString()} - ${M?.toLocaleDateString()}`)}catch(E){console.warn("âš ï¸ è·å–æ—¶é—´èŒƒå›´å¤±è´¥:",E)}await cacheManager.saveMetadataAndShardIndex(c,{},L,M);const I=performance.now()-e,P=(c/(I/1e3)).toFixed(0);return console.log(`âœ… æµæ°´çº¿å¹¶è¡ŒåŠ è½½å®Œæˆ: ${c.toLocaleString()} æ¡ (${(I/1e3).toFixed(1)}ç§’, ${P} æ¡/ç§’)`),console.log("âš¡ æ€§èƒ½æå‡ï¼šä¸‹è½½å’Œå­˜å‚¨å®Œå…¨å¹¶è¡Œï¼Œæ— ç­‰å¾…æ—¶é—´"),console.log(`ğŸ’¾ å…ƒæ•°æ®å·²ä¿å­˜: totalCount=${c}, minDate=${L?.toISOString()}, maxDate=${M?.toISOString()}`),console.log("ğŸ“Š æ€§èƒ½å¯¹æ¯”åˆ†æ:"),console.log(`   - å®é™…ååé‡: ${P} æ¡/ç§’`),console.log("   - ä¼˜åŒ–ç›®æ ‡: 12,600 æ¡/ç§’"),console.log(`   - è¾¾æˆç‡: ${(P/12600*100).toFixed(1)}%`),P>=8e3?console.log(`âœ… æ€§èƒ½ä¼˜ç§€: ${P} æ¡/ç§’`):P>=5e3?console.log(`ğŸŸ¡ æ€§èƒ½è‰¯å¥½: ${P} æ¡/ç§’ï¼ˆå»ºè®®ä¼˜åŒ–ç½‘ç»œè¿æ¥ï¼‰`):P>=3e3?console.log(`ğŸŸ  æ€§èƒ½ä¸€èˆ¬: ${P} æ¡/ç§’ï¼ˆå¯èƒ½å—ç½‘ç»œæˆ–CPUé™åˆ¶ï¼‰`):(console.warn(`âš ï¸ æ€§èƒ½åä½: ${P} æ¡/ç§’ï¼Œå¯èƒ½ç“¶é¢ˆ:`),console.warn("   1. ç½‘ç»œå¸¦å®½é™åˆ¶ï¼ˆä¸‹è½½æ…¢ï¼‰- æ£€æŸ¥ç½‘ç»œè¿æ¥"),console.warn("   2. CPUæ€§èƒ½é™åˆ¶ï¼ˆé¢„å¤„ç†æ…¢ï¼‰- å‡å°‘å¹¶å‘æ•°"),console.warn("   3. IndexedDBå†™å…¥é™åˆ¶ï¼ˆç£ç›˜IOæ…¢ï¼‰- å¢åŠ æ‰¹æ¬¡å¤§å°"),console.warn("   4. æ•°æ®é‡è¿‡å¤§ - è€ƒè™‘åˆ†æ‰¹åŠ è½½")),{success:!0,totalCount:c}}catch(U){throw console.error("âŒ æµæ°´çº¿å¹¶è¡ŒåŠ è½½å¤±è´¥:",U),U}}generateAdaptiveShards(t,e){const o=(e-t)/864e5,a=this.generateYearQuarterShards(t,e);return console.log(`ğŸ’¡ æ•°æ®èŒƒå›´ ${o.toFixed(0)} å¤©ï¼Œv10ä¼˜åŒ–ï¼šå¹´ä»½+å­£åº¦åˆ†ç‰‡ï¼Œç”Ÿæˆ ${a.length} ä¸ªåˆ†ç‰‡`),console.log(`ğŸ“Š é¢„ä¼°ï¼šæ¯åˆ†ç‰‡çº¦ ${Math.round(1e3*o/a.length).toLocaleString()} æ¡æ•°æ®ï¼ˆå‡è®¾æ—¥å‡1000æ¡ï¼‰`),console.log(`ğŸš€ HTTPè¯·æ±‚ä¼˜åŒ–ï¼š${a.length}ä¸ªå­£åº¦è¯·æ±‚ï¼ˆç›¸æ¯”v9çš„11ä¸ªæœˆåº¦è¯·æ±‚ï¼Œå‡å°‘çº¦${Math.round(100*(1-a.length/11))}%ï¼‰`),a}generateYearQuarterShards(t,e){const o=[],a=new Date(t);for(a.setHours(0,0,0,0);a<e;){const n=a.getFullYear(),r=a.getMonth()+1,s=Math.ceil(r/3),l=3*s,c=new Date(n,3*(s-1)+1-1,1),i=new Date(n,l,0,23,59,59,999);i>e&&i.setTime(e.getTime()),c<t&&c.setTime(t.getTime());const g=`${n}_Q${s}`;o.push({partitionId:g,start:c.toISOString(),end:i.toISOString(),label:`${n}å¹´Q${s}`}),a.setMonth(a.getMonth()+3)}return console.log("ğŸ“Š ç”Ÿæˆå¹´ä»½+å­£åº¦åˆ†ç‰‡:",o.map(t=>t.partitionId).join(", ")),o}calculateOptimalConcurrency(t){return t<=2?t:t<=8||t<=20?6:8}generateBiWeeklyShards(t,e){const o=[],a=new Date(t);for(a.setHours(0,0,0,0);a<e;){const t=new Date(a),n=new Date(a);n.setDate(n.getDate()+14),n>e&&n.setTime(e.getTime()),o.push({start:t.toISOString(),end:n.toISOString(),label:`${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()}-${n.getMonth()+1}/${n.getDate()}`}),a.setDate(a.getDate()+14)}return o}generateBiMonthlyShards(t,e){const o=[],a=new Date(t);for(a.setHours(0,0,0,0);a<e;){const t=new Date(a),n=new Date(a);n.setMonth(n.getMonth()+2),n>e&&n.setTime(e.getTime()),o.push({start:t.toISOString(),end:n.toISOString(),label:`${t.getFullYear()}/${t.getMonth()+1}-${n.getFullYear()}/${n.getMonth()+1}`}),a.setMonth(a.getMonth()+2)}return o}generateHourlyShards(t,e,o=3){const a=[],n=new Date(t);for(;n<e;){const t=new Date(n),r=new Date(n);r.setHours(r.getHours()+o),r>e&&r.setTime(e.getTime());const s=Math.round((r-t)/36e5);a.push({start:t.toISOString(),end:r.toISOString(),label:`${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:00 (${s}h)`}),n.setHours(n.getHours()+o)}return a}generateDailyShards(t,e){const o=[],a=new Date(t);for(a.setHours(0,0,0,0);a<e;){const t=new Date(a),n=new Date(a);n.setDate(n.getDate()+1),n>e&&n.setTime(e.getTime()),o.push({start:t.toISOString(),end:n.toISOString(),label:`${t.getMonth()+1}/${t.getDate()}`}),a.setDate(a.getDate()+1)}return o}generateWeeklyShards(t,e){const o=[],a=new Date(t);for(a.setHours(0,0,0,0);a<e;){const t=new Date(a),n=new Date(a);n.setDate(n.getDate()+7),n>e&&n.setTime(e.getTime()),o.push({start:t.toISOString(),end:n.toISOString(),label:`${t.getMonth()+1}/${t.getDate()}-${n.getMonth()+1}/${n.getDate()}`}),a.setDate(a.getDate()+7)}return o}generateMonthlyShards(t,e){const o=[],a=new Date(t);for(a.setHours(0,0,0,0);a<e;){const t=new Date(a),n=new Date(a);n.setMonth(n.getMonth()+1),n>e&&n.setTime(e.getTime()),o.push({start:t.toISOString(),end:n.toISOString(),label:`${t.getFullYear()}/${t.getMonth()+1}`}),a.setMonth(a.getMonth()+1)}return o}generateQuarterlyShards(t,e){const o=[],a=new Date(t);for(;a<e;){const t=new Date(a),n=new Date(a);n.setMonth(n.getMonth()+3),n>e&&n.setTime(e.getTime()),o.push({start:t.toISOString(),end:n.toISOString(),label:`${t.getFullYear()}Q${Math.floor(t.getMonth()/3)+1}`}),a.setMonth(a.getMonth()+3)}return o}async fetchShardData(t){try{const e=getApiUrl("records")+`?startDate=${t.start}&endDate=${t.end}&no_limit=true`;console.log(`  ğŸ” å¢é‡è¯·æ±‚: ${t.label}`),console.log(`     URL: ${e}`),console.log(`     æ—¶é—´èŒƒå›´: ${new Date(t.start).toLocaleString()} ~ ${new Date(t.end).toLocaleString()}`);const o=await fetch(e,{method:"GET",headers:{Accept:"application/json","Accept-Encoding":"gzip, deflate, br"}});if(!o.ok)return console.warn(`âš ï¸ åˆ†ç‰‡ ${t.label} è¯·æ±‚å¤±è´¥: ${o.status}`),[];const a=await o.json();if(a.success&&a.data.records){if(console.log(`  âœ“ å¢é‡å“åº”: ${t.label} = ${a.data.records.length.toLocaleString()} æ¡`),a.data.records.length>0){const t=a.data.records[0],e=a.data.records[a.data.records.length-1];console.log(`     æ•°æ®æ—¶é—´èŒƒå›´: ${t.start_time} ~ ${e.start_time}`)}return this.preprocessRecords(a.data.records)}return console.log(`  âš ï¸ å¢é‡å“åº”æ ¼å¼å¼‚å¸¸: ${t.label}`,a),[]}catch(e){return console.error(`âŒ åˆ†ç‰‡ ${t.label} åŠ è½½å¤±è´¥:`,e),[]}}preprocessRecords(t){const e=[];for(const o of t){const t={id:o.plan_id||o["è®¡åˆ’ID"]||o.id||`record_${Date.now()}_${Math.random()}`,start_time:o.start_time||o["å¼€å§‹æ—¶é—´"],task_result:o.task_result||o["ä»»åŠ¡ç»“æœçŠ¶æ€"],task_type:o.task_type||o["ä»»åŠ¡ç±»å‹"],customer:o.customer||o["æ‰€å±å®¢æˆ·"],satellite_name:o.satellite_name||o["å«æ˜Ÿåç§°"],station_name:o.station_name||o["æµ‹ç«™åç§°"],station_id:o.station_id||o["æµ‹ç«™ID"],...o};t.start_time&&(t.timestamp=this.parseTimeToTimestamp(t.start_time)),e.push(t)}return e.sort((t,e)=>(t.timestamp||0)-(e.timestamp||0)),e}parseTimeToTimestamp(t){if("number"==typeof t)return t>1e12?t:1e3*t;if("string"==typeof t){const e=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim(),o=this.parseLocalTime(e);return isNaN(o.getTime())?0:o.getTime()}return t instanceof Date?t.getTime():0}parseLocalTime(t){if(!t)return new Date(NaN);try{const e=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);if(e){const[,t,o,a,n=0,r=0,s=0]=e;return new Date(parseInt(t),parseInt(o)-1,parseInt(a),parseInt(n),parseInt(r),parseInt(s))}const o=t.replace(/[TZ]/g," ").replace(/[+-]\d{2}:\d{2}$/,"").trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/);if(o){const[,t,e,a,n,r,s]=o;return new Date(parseInt(t),parseInt(e)-1,parseInt(a),parseInt(n),parseInt(r),parseInt(s))}const a=t.split(" ")[0].split("-").map(Number);return a.length>=3?new Date(a[0],a[1]-1,a[2],0,0,0):new Date(NaN)}catch(e){return console.error("æ—¶é—´è§£æé”™è¯¯:",t,e),new Date(NaN)}}async loadHistoricalData(){try{console.log("ğŸ”„ åå°ä»»åŠ¡ï¼šå¼€å§‹åŠ è½½å†å²æ•°æ®...");const t=await cacheManager.getMetadataFast();if(!t||!t.minDate)return void console.log("âš ï¸ æ— æ³•è·å–å…ƒæ•°æ®ï¼Œè·³è¿‡å†å²æ•°æ®åŠ è½½");const e=t.minDate,o=new Date;if(o.setFullYear(o.getFullYear()-2),e<=o)return void console.log("âœ… å†å²æ•°æ®å·²å®Œæ•´ï¼Œæ— éœ€åŠ è½½");console.log(`ğŸ“¡ åŠ è½½å†å²æ•°æ®: ${o.toLocaleDateString()} ~ ${e.toLocaleDateString()}`);const a=getApiUrl("records")+`?startDate=${o.toISOString()}&endDate=${e.toISOString()}&no_limit=true`,n=await fetch(a,{headers:{Accept:"application/json","Accept-Encoding":"gzip, deflate, br"}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(r.success&&r.data.records&&r.data.records.length>0){const t=r.data.records;console.log(`âœ… è·å– ${t.length} æ¡å†å²æ•°æ®`),await cacheManager.appendData(t),console.log("âœ… å†å²æ•°æ®å·²è¿½åŠ åˆ°ç¼“å­˜"),window.sharedDataManager&&window.sharedDataManager.notifyDataUpdate("insert",t)}else console.log("â„¹ï¸ æ— æ›´å¤šå†å²æ•°æ®")}catch(t){console.error("âš ï¸ åå°åŠ è½½å†å²æ•°æ®å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",t)}}async fallbackLoadAll(){console.log("ğŸ”„ ä½¿ç”¨é™çº§æ–¹æ¡ˆï¼šåŠ è½½å…¨é‡æ•°æ®..."),this.updatePreloadStatus("æ­£åœ¨ä»æ•°æ®åº“è·å–å…¨éƒ¨æ•°æ®...","loading");const t=await this.fetchAllDataFromAPI();if(t&&t.length>0){console.log(`ğŸ“¥ æˆåŠŸè·å– ${t.length.toLocaleString()} æ¡æ•°æ®`),this.updatePreloadStatus(`æ­£åœ¨ç¼“å­˜ ${t.length.toLocaleString()} æ¡æ•°æ®...`,"loading");const e=await cacheManager.storeAllDataWithPrecompute(t,(t,e,o)=>{this.updatePreloadStatus(`æ­£åœ¨ç¼“å­˜æ•°æ®... ${e.toLocaleString()}/${o.toLocaleString()} (${t}%)`,"loading")},!0);return this.updatePreloadStatus(`âœ… æˆåŠŸåŠ è½½ ${e.toLocaleString()} æ¡æ•°æ®ï¼ˆé¢„è®¡ç®—åœ¨åå°æ‰§è¡Œï¼‰`,"success"),{success:!0,totalCount:e}}throw new Error("æ— æ³•è·å–æ•°æ®")}async backgroundUpdate(){try{console.log("ğŸ”„ åå°é™é»˜æ›´æ–°ç¼“å­˜...");const t=await this.fetchAllDataFromAPI();t&&t.length>0&&(await cacheManager.storeAllDataWithPrecompute(t,null,!0),console.log(`âœ… åå°ç¼“å­˜æ›´æ–°å®Œæˆï¼Œæ›´æ–°äº† ${t.length} æ¡æ•°æ®ï¼ˆé¢„è®¡ç®—åœ¨åå°æ‰§è¡Œï¼‰`))}catch(t){console.warn("âš ï¸ åå°ç¼“å­˜æ›´æ–°å¤±è´¥:",t)}}async fetchAllDataFromAPI(){try{console.log("ğŸ“¡ å¼€å§‹ä»APIä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®ï¼ˆæ— æ¡æ•°é™åˆ¶ï¼‰...");const t={order_by:"start_time",sort:"ASC",no_limit:!0,fetch_all:!0};console.log("ğŸ” APIè°ƒç”¨å‚æ•°:",t);const e=await this.fetchSinglePageFromAPI(t);return e&&e.length>0?(console.log(`âœ… æˆåŠŸä¸€æ¬¡æ€§è·å– ${e.length} æ¡è®°å½•`),e):(console.log("âš ï¸ æœªè·å–åˆ°ä»»ä½•æ•°æ®"),[])}catch(t){return console.error("âŒ è·å–å…¨æ•°æ®å¤±è´¥:",t),console.log("ğŸ”„ ä¸€æ¬¡æ€§è·å–å¤±è´¥ï¼Œå›é€€åˆ°åˆ†é¡µè·å–æ¨¡å¼..."),await this.fetchAllDataWithPagination()}}async fetchAllDataWithPagination(){try{console.log("ğŸ“¡ ä½¿ç”¨åˆ†é¡µæ¨¡å¼è·å–æ‰€æœ‰æ•°æ®...");let t=[],e=0;const o=1e4;let a=!0,n=1,r=0;const s=5;for(;a;){console.log(`ğŸ“„ [é¡µé¢ ${n}] è·å–æ•°æ® (offset: ${e}, å·²ç´¯è®¡: ${t.length} æ¡)...`);const l={offset:e,limit:o,order_by:"start_time",sort:"ASC"},c=await this.fetchSinglePageFromAPI(l);c&&c.length>0?(t.push(...c),console.log(`âœ… [é¡µé¢ ${n}] è·å– ${c.length} æ¡ï¼Œç´¯è®¡: ${t.length} æ¡`),r=0,e+=o,n++):(r++,r>=s?(a=!1,console.log(`ğŸ æ•°æ®è·å–å®Œæˆï¼Œæ€»è®¡: ${t.length} æ¡è®°å½•`)):(e+=o,n++)),await new Promise(t=>setTimeout(t,10))}return t}catch(t){throw console.error("âŒ åˆ†é¡µè·å–æ•°æ®å¤±è´¥:",t),t}}async fetchSinglePageFromAPI(t){try{const e={};for(const[o,a]of Object.entries(t))null!=a&&""!==a&&(e[o]=a);const o=new URLSearchParams(e).toString(),a=getApiUrl("records"),n=await fetch(`${a}?${o}`,{method:"GET",mode:"cors",credentials:"omit",headers:{Accept:"application/json","Accept-Encoding":"gzip, deflate, br","Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const r=await n.json();if(!r.success)throw new Error(r.error||"è·å–æ•°æ®å¤±è´¥");return r.data.records||[]}catch(t){throw console.error("âŒ å•é¡µAPIè°ƒç”¨å¤±è´¥:",t),t}}updatePreloadStatus(t,e="info"){const o=document.getElementById("dbLoading"),a=document.getElementById("dbLoadingText"),n=document.getElementById("dbLoadingProgressBar");if(o)switch(a&&(a.textContent=t),n&&n.classList.add("hidden"),o.className="mb-6 p-3 rounded-lg",e){case"loading":o.classList.add("bg-primary/10","text-primary"),o.classList.remove("hidden");break;case"success":o.classList.add("bg-success/10","text-success"),setTimeout(()=>o.classList.add("hidden"),3e3);break;case"warning":o.classList.add("bg-warning/10","text-warning");break;case"error":o.classList.add("bg-danger/10","text-danger");break;default:o.classList.add("bg-primary/10","text-primary")}}}