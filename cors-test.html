<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS 完整测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">CORS 完整测试</h1>

        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-xl font-semibold mb-4">测试步骤</h2>

            <button id="testConfig" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-2">
                1. 测试 config.js 加载
            </button>
            <div id="configResult" class="mt-2 p-4 bg-gray-50 rounded mb-4"></div>

            <button id="testGetApiUrl" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mb-2">
                2. 测试 getApiUrl 函数
            </button>
            <div id="getApiUrlResult" class="mt-2 p-4 bg-gray-50 rounded mb-4"></div>

            <button id="testOptions" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 mb-2">
                3. 测试 OPTIONS 请求
            </button>
            <div id="optionsResult" class="mt-2 p-4 bg-gray-50 rounded mb-4"></div>

            <button id="testRecords" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 mb-2">
                4. 测试 records GET 请求
            </button>
            <div id="recordsResult" class="mt-2 p-4 bg-gray-50 rounded mb-4"></div>

            <button id="testAll" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                运行所有测试
            </button>
        </div>
    </div>

    <!-- 加载 config.js -->
    <script src="./public/js/config.js?v=2"></script>

    <script>
        // 测试 1: 检查 config.js 是否正确加载
        document.getElementById('testConfig').addEventListener('click', () => {
            const resultDiv = document.getElementById('configResult');

            const checks = {
                'window.CONFIG': typeof window.CONFIG !== 'undefined',
                'window.getApiUrl': typeof window.getApiUrl !== 'undefined',
                'window.API': typeof window.API !== 'undefined',
                'CONFIG.API_ENDPOINTS': window.CONFIG && typeof window.CONFIG.API_ENDPOINTS !== 'undefined',
                'CONFIG.API_ENDPOINTS.records': window.CONFIG && window.CONFIG.API_ENDPOINTS && window.CONFIG.API_ENDPOINTS.records
            };

            let html = '<p class="font-semibold mb-2">Config.js 加载检查:</p>';
            for (const [key, value] of Object.entries(checks)) {
                html += `<p class="${value ? 'text-green-600' : 'text-red-600'}">${value ? '✅' : '❌'} ${key}: ${value ? '存在' : '不存在'}</p>`;
            }

            if (checks['CONFIG.API_ENDPOINTS.records']) {
                html += `<p class="mt-2"><strong>Records URL:</strong> ${window.CONFIG.API_ENDPOINTS.records}</p>`;
            }

            resultDiv.innerHTML = html;
        });

        // 测试 2: 测试 getApiUrl 函数
        document.getElementById('testGetApiUrl').addEventListener('click', () => {
            const resultDiv = document.getElementById('getApiUrlResult');

            try {
                if (typeof getApiUrl === 'undefined') {
                    resultDiv.innerHTML = '<p class="text-red-600">❌ getApiUrl 未定义</p>';
                    return;
                }

                const url = getApiUrl('records');
                resultDiv.innerHTML = `
                    <p class="text-green-600 font-semibold">✅ getApiUrl 函数正常</p>
                    <p class="mt-2"><strong>返回的 URL:</strong></p>
                    <p class="bg-gray-100 p-2 rounded mt-1">${url}</p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">❌ getApiUrl 执行失败</p>
                    <p class="mt-2"><strong>错误:</strong> ${error.message}</p>
                `;
            }
        });

        // 测试 3: OPTIONS 请求
        document.getElementById('testOptions').addEventListener('click', async () => {
            const resultDiv = document.getElementById('optionsResult');
            resultDiv.innerHTML = '<p class="text-blue-600">正在测试 OPTIONS...</p>';

            try {
                const url = getApiUrl('records');
                console.log('Testing OPTIONS to:', url);

                const response = await fetch(url, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                resultDiv.innerHTML = `
                    <p class="text-green-600 font-semibold">✅ OPTIONS 请求成功</p>
                    <p class="mt-2"><strong>状态码:</strong> ${response.status}</p>
                    <p class="mt-2"><strong>CORS 响应头:</strong></p>
                    <pre class="bg-gray-100 p-2 rounded mt-1 text-sm">${JSON.stringify(corsHeaders, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('OPTIONS error:', error);
                resultDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">❌ OPTIONS 请求失败</p>
                    <p class="mt-2"><strong>错误:</strong> ${error.message}</p>
                `;
            }
        });

        // 测试 4: GET 请求
        document.getElementById('testRecords').addEventListener('click', async () => {
            const resultDiv = document.getElementById('recordsResult');
            resultDiv.innerHTML = '<p class="text-blue-600">正在测试 GET 请求...</p>';

            try {
                const url = getApiUrl('records');
                console.log('Testing GET to:', url + '?page=1&limit=10');

                const response = await fetch(`${url}?page=1&limit=10`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                const data = await response.json();
                console.log('Response data:', data);

                resultDiv.innerHTML = `
                    <p class="text-green-600 font-semibold">✅ GET 请求成功</p>
                    <p class="mt-2"><strong>状态码:</strong> ${response.status}</p>
                    <p class="mt-2"><strong>响应数据:</strong></p>
                    <pre class="bg-gray-100 p-2 rounded mt-1 text-sm overflow-auto max-h-96">${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('GET error:', error);
                resultDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">❌ GET 请求失败</p>
                    <p class="mt-2"><strong>错误类型:</strong> ${error.name}</p>
                    <p class="mt-2"><strong>错误信息:</strong> ${error.message}</p>
                    <p class="mt-2 text-sm text-gray-600">请检查浏览器控制台的 Network 标签</p>
                `;
            }
        });

        // 运行所有测试
        document.getElementById('testAll').addEventListener('click', async () => {
            document.getElementById('testConfig').click();
            await new Promise(resolve => setTimeout(resolve, 500));

            document.getElementById('testGetApiUrl').click();
            await new Promise(resolve => setTimeout(resolve, 500));

            document.getElementById('testOptions').click();
            await new Promise(resolve => setTimeout(resolve, 1500));

            document.getElementById('testRecords').click();
        });

        // 页面加载时自动运行第一个测试
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('testConfig').click();
        });
    </script>
</body>
</html>
