<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¶‹åŠ¿åˆ†æ - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</title>
    <!-- å¤–éƒ¨èµ„æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="./public/js/config.js?v=4"></script>
    <script src="./public/js/shared-data-manager.js"></script>

    <!-- Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        success: '#00B42A',
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .modal-backdrop {
                backdrop-filter: blur(2px);
            }
            .filter-select {
                @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all;
            }
            .chart-container {
                @apply h-80 border border-gray-200 rounded-lg p-4 relative mb-8;
            }
            .tab-item {
                @apply px-4 py-2 rounded-md cursor-pointer transition-all;
            }
            .tab-item-active {
                @apply bg-primary text-white;
            }
            .tab-item-inactive {
                @apply bg-gray-100 text-gray-700 hover:bg-gray-200;
            }
            .dropdown-container {
                @apply relative;
            }
            .dropdown-content {
                @apply absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg overflow-hidden max-h-60 overflow-y-auto;
            }
            .multiselect-checkbox {
                @apply mr-2 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded;
            }
            .selected-tags {
                @apply flex flex-wrap gap-2 mt-1;
            }
            .selected-tag {
                @apply bg-primary/10 text-primary text-xs px-2 py-1 rounded-full flex items-center;
            }
            .tag-remove {
                @apply ml-1 cursor-pointer hover:text-primary/80;
            }
            .select-all-item {
                @apply px-4 py-2 border-b border-gray-100 font-medium text-primary cursor-pointer hover:bg-primary/5;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-line-chart text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</h1>
            </div>

            <nav class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">é¦–é¡µ</a>
                <a href="trend-analysis.html" class="text-primary font-medium border-b-2 border-primary px-1 py-5">æ•°æ®è¶‹åŠ¿åˆ†æ</a>
                 <a href="data-distribution.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">æ•°æ®åˆ†å¸ƒ</a>
                <a href="circle-warning.html" class="text-gray-600 hover:text-primary transition-colors px-1 py-5">æ•°æ®é¢„è­¦</a>
            </nav>

            <button class="md:hidden text-gray-600 hover:text-primary" id="mobileMenuBtn">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>

        <div class="md:hidden hidden bg-white border-t border-gray-200" id="mobileMenu">
            <div class="container mx-auto px-4 py-2">
                <a href="index.html" class="block py-3 text-gray-600 hover:text-primary">é¦–é¡µ</a>
                <a href="trend-analysis.html" class="block py-3 text-primary font-medium">æ•°æ®è¶‹åŠ¿åˆ†æ</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <h2 class="text-xl font-bold mb-6 text-gray-800">æ•°æ®è¶‹åŠ¿åˆ†æ</h2>

        <!-- æ•°æ®çŠ¶æ€æç¤ºåŒº -->
        <div id="dbLoading" class="mb-6 p-3 bg-primary/10 text-primary rounded-lg flex items-center hidden">
            <i class="fa fa-spinner fa-spin mr-2"></i>
            <span>æ­£åœ¨ä»æ•°æ®åº“åŠ è½½æ•°æ®...</span>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                <div id="loadingProgress" class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">
                <span id="loadingStatus">å‡†å¤‡åŠ è½½...</span>
            </div>
        </div>

        <div id="noDataAlert" class="bg-warning/10 text-warning p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span>è¯·å…ˆåœ¨é¦–é¡µå¯¼å…¥æ•°æ®ï¼Œç„¶åå†è¿›è¡Œè¶‹åŠ¿åˆ†æ</span>
            <div class="mt-3 flex gap-2">
                <button id="refreshDataBtn" class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-primary/90 transition-colors">
                    <i class="fa fa-refresh mr-1"></i>åˆ·æ–°æ•°æ®
                </button>
                <a href="index.html" class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                    <i class="fa fa-home mr-1"></i>è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>

        <div id="dataStructureAlert" class="bg-warning/10 text-warning p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span>æ•°æ®ç»“æ„è¯†åˆ«å¼‚å¸¸</span>
            <div class="mt-2 text-sm">
                <p id="structureMsg">ç³»ç»Ÿæ£€æµ‹åˆ°æ•°æ®æ ¼å¼å¯èƒ½ä¸ç¬¦åˆé¢„æœŸï¼Œå·²å°è¯•è‡ªåŠ¨ä¿®å¤ã€‚</p>
                <div id="structureDetails" class="mt-1 bg-white p-2 rounded text-xs"></div>
            </div>
        </div>

        <div id="dbErrorAlert" class="bg-danger/10 text-danger p-4 rounded-lg mb-6 hidden">
            <i class="fa fa-exclamation-circle mr-2"></i>
            <span id="dbErrorMsg">æ•°æ®åº“æ“ä½œå‡ºé”™</span>
            <div id="dbErrorDetails" class="mt-2 text-sm hidden">
                <p>é”™è¯¯è¯¦æƒ…:</p>
                <pre class="bg-white p-2 rounded text-xs"></pre>
            </div>
            <button id="fixDbBtn" class="mt-2 text-sm bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors hidden">
                å°è¯•ä¿®å¤æ•°æ®åº“
            </button>
        </div>

        <div id="debugInfo" class="bg-gray-100 p-4 rounded-lg mb-6 hidden">
            <h3 class="font-medium text-gray-700 mb-2">è°ƒè¯•ä¿¡æ¯</h3>
            <pre id="debugContent" class="text-sm text-gray-600"></pre>
        </div>

        <!-- ç­›é€‰æ¡ä»¶åŒºåŸŸ -->
        <section id="filterSection" class="mb-8 bg-white rounded-lg p-6 card-shadow hidden">
            <h3 class="text-lg font-semibold mb-4">ç­›é€‰æ¡ä»¶</h3>

            <!-- æ—¶é—´èŒƒå›´å’Œå‘¨æœŸè®¾ç½® -->
            <div class="grid grid-cols-5 gap-4 mb-6 pb-6 border-b border-gray-100">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç»Ÿè®¡å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" class="filter-select">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç»Ÿè®¡ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" class="filter-select">
                </div>
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label class="block text-sm font-medium text-gray-700">ç»Ÿè®¡å‘¨æœŸ</label>
                        <button id="configGroupingBtn" class="text-gray-500 hover:text-primary transition-colors p-1" title="é…ç½®å‘¨æœŸè§„åˆ™">
                            <i class="fa fa-cog"></i>
                        </button>
                    </div>
                    <select id="groupBy" class="filter-select">
                        <option value="day">æŒ‰æ—¥</option>
                        <option value="week">æŒ‰å‘¨</option>
                        <option value="month">æŒ‰æœˆ</option>
                        <option value="quarter">æŒ‰å­£åº¦</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="resetFilters" class="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        é‡ç½®ç­›é€‰
                    </button>
                </div>
                <div class="flex items-end">
                    <button id="applyFilters" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        åº”ç”¨ç­›é€‰å¹¶ç”Ÿæˆå›¾è¡¨
                    </button>
                </div>
            </div>

            <!-- å¤šæ¡ä»¶ç­›é€‰åŒºåŸŸï¼ˆæ”¯æŒå¤šé€‰å’Œå…¨é€‰ï¼‰- å•è¡Œ5åˆ—å¸ƒå±€ -->
            <div class="grid grid-cols-5 gap-4 mb-4">
                <!-- æµ‹ç«™åç§°ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æµ‹ç«™åç§° <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="stationDropdown">
                        <span id="stationDisplay">è¯·é€‰æ‹©æµ‹ç«™</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="stationTags"></div>
                    <div class="dropdown-content hidden" id="stationOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢æµ‹ç«™..." class="w-full p-1 text-sm border border-gray-200 rounded" id="stationSearch">
                        </div>
                        <div class="select-all-item" id="selectAllStations">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="stationValue" value="">
                </div>

                <!-- å®¢æˆ·åç§°ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ·åç§° <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="customerDropdown">
                        <span id="customerDisplay">è¯·é€‰æ‹©å®¢æˆ·</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="customerTags"></div>
                    <div class="dropdown-content hidden" id="customerOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢å®¢æˆ·..." class="w-full p-1 text-sm border border-gray-200 rounded" id="customerSearch">
                        </div>
                        <div class="select-all-item" id="selectAllCustomers">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="customerValue" value="">
                </div>

                <!-- å«æ˜Ÿåç§°ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å«æ˜Ÿåç§° <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="satelliteDropdown">
                        <span id="satelliteDisplay">è¯·é€‰æ‹©å«æ˜Ÿ</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="satelliteTags"></div>
                    <div class="dropdown-content hidden" id="satelliteOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢å«æ˜Ÿ..." class="w-full p-1 text-sm border border-gray-200 rounded" id="satelliteSearch">
                        </div>
                        <div class="select-all-item" id="selectAllSatellites">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="satelliteValue" value="">
                </div>

                <!-- ä»»åŠ¡ç±»å‹ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç±»å‹ <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="typeDropdown">
                        <span id="typeDisplay">è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="typeTags"></div>
                    <div class="dropdown-content hidden" id="typeOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢ç±»å‹..." class="w-full p-1 text-sm border border-gray-200 rounded" id="typeSearch">
                        </div>
                        <div class="select-all-item" id="selectAllTypes">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="typeValue" value="">
                </div>

                <!-- ä»»åŠ¡ç»“æœçŠ¶æ€ç­›é€‰ï¼ˆå¤šé€‰ï¼‰ -->
                <div class="dropdown-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç»“æœçŠ¶æ€ <span class="text-xs text-gray-500">(å¯å¤šé€‰)</span></label>
                    <div class="flex items-center justify-between filter-select cursor-pointer" id="statusDropdown">
                        <span id="statusDisplay">è¯·é€‰æ‹©ä»»åŠ¡çŠ¶æ€</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </div>
                    <div class="selected-tags" id="statusTags"></div>
                    <div class="dropdown-content hidden" id="statusOptions">
                        <div class="p-2 border-b border-gray-100">
                            <input type="text" placeholder="æœç´¢çŠ¶æ€..." class="w-full p-1 text-sm border border-gray-200 rounded" id="statusSearch">
                        </div>
                        <div class="select-all-item" id="selectAllStatuses">
                            <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                        </div>
                        <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <input type="hidden" id="statusValue" value="">
                </div>
            </div>
        </section>

        <!-- å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
        <section id="chartsSection" class="space-y-8 hidden">
            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>æµ‹ç«™åç§°è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex items-center gap-3">
                        <!-- æµ‹ç«™åç§°ç­›é€‰ -->
                        <div class="dropdown-container relative">
                            <div class="flex items-center justify-between filter-select cursor-pointer min-w-[180px]" id="stationChartDropdown">
                                <span id="stationChartDisplay" class="text-sm truncate">è¯·é€‰æ‹©æµ‹ç«™</span>
                                <i class="fa fa-chevron-down text-xs ml-2"></i>
                            </div>
                            <div class="selected-tags" id="stationChartTags"></div>
                            <div class="dropdown-content hidden absolute top-full left-0 z-50 bg-white border border-gray-200 rounded-md shadow-lg min-w-[200px]" id="stationChartOptions">
                                <div class="p-2 border-b border-gray-100">
                                    <input type="text" placeholder="æœç´¢æµ‹ç«™..." class="w-full p-1 text-sm border border-gray-200 rounded" id="stationChartSearch">
                                </div>
                                <div class="select-all-item" id="selectAllStationChart">
                                    <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                                </div>
                            </div>
                            <input type="hidden" id="stationChartValue" value="">
                        </div>
                        
                        <button id="resetStationChart" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" title="é‡ç½®å½“å‰å›¾è¡¨ç­›é€‰">
                            <i class="fa fa-refresh"></i>
                        </button>
                        
                        <div class="h-4 w-px bg-gray-300"></div>
                        
                        <label class="flex items-center px-2 py-1 bg-secondary/10 text-secondary rounded cursor-pointer hover:bg-secondary/20 transition" title="ç‚¹å‡»æ˜¾ç¤º/éšè—å›¾è¡¨æ¯ä¸ªç‚¹çš„æ•°å€¼">
                            <input type="checkbox" id="showStationLabels" class="mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                            <span class="text-sm font-medium">æ˜¾ç¤ºæ•°æ®æ ‡ç­¾</span>
                        </label>
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="stationChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                            <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                        </button>
                        <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                data-chart="stationChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                            <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                        </button>
                    </div>
                </h3>
                
                <div class="chart-container">
                    <canvas id="stationChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="stationChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>å®¢æˆ·åç§°è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex items-center gap-4">
                        <!-- å®¢æˆ·åç§°ç­›é€‰ï¼ˆå›¾è¡¨ä¸“ç”¨ï¼‰ -->
                        <div class="dropdown-container relative" style="min-width: 160px;">
                            <div class="flex items-center justify-between filter-select cursor-pointer text-sm" id="customerChartDropdown">
                                <span id="customerChartDisplay" class="truncate" style="max-width: 120px;">è¯·é€‰æ‹©å®¢æˆ·</span>
                                <i class="fa fa-chevron-down text-xs ml-2"></i>
                            </div>
                            <div class="selected-tags" id="customerChartTags"></div>
                            <div class="dropdown-content hidden absolute top-full left-0 z-50" id="customerChartOptions" style="min-width: 200px;">
                                <div class="p-2 border-b border-gray-100">
                                    <input type="text" placeholder="æœç´¢å®¢æˆ·..." class="w-full p-1 text-sm border border-gray-200 rounded" id="customerChartSearch">
                                </div>
                                <div class="select-all-item" id="selectAllCustomerChart">
                                    <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                                </div>
                            </div>
                            <input type="hidden" id="customerChartValue" value="">
                        </div>
                        
                        <button id="resetCustomerChart" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" title="é‡ç½®å½“å‰å›¾è¡¨ç­›é€‰">
                            <i class="fa fa-refresh mr-1"></i>é‡ç½®ç­›é€‰
                        </button>
                        
                        <!-- åˆ†éš”çº¿ -->
                        <div class="w-px h-6 bg-gray-300"></div>
                        
                        <div class="flex gap-2">
                            <label class="flex items-center px-2 py-1 bg-secondary/10 text-secondary rounded cursor-pointer hover:bg-secondary/20 transition" title="ç‚¹å‡»æ˜¾ç¤º/éšè—å›¾è¡¨æ¯ä¸ªç‚¹çš„æ•°å€¼">
                                <input type="checkbox" id="showCustomerLabels" class="mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                                <span class="text-sm font-medium">æ˜¾ç¤ºæ•°æ®æ ‡ç­¾</span>
                            </label>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="customerChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                                <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                            </button>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="customerChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                                <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                            </button>
                        </div>
                    </div>
                </h3>
                
                <div class="chart-container">
                    <canvas id="customerChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="customerChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>å«æ˜Ÿåç§°è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex items-center gap-4">
                        <!-- å«æ˜Ÿåç§°ç­›é€‰ï¼ˆå›¾è¡¨ä¸“ç”¨ï¼‰ -->
                        <div class="dropdown-container relative" style="min-width: 160px;">
                            <div class="flex items-center justify-between filter-select cursor-pointer text-sm" id="satelliteChartDropdown">
                                <span id="satelliteChartDisplay" class="truncate" style="max-width: 120px;">è¯·é€‰æ‹©å«æ˜Ÿåç§°</span>
                                <i class="fa fa-chevron-down text-xs ml-2"></i>
                            </div>
                            <div class="selected-tags" id="satelliteChartTags"></div>
                            <div class="dropdown-content hidden absolute top-full left-0 z-50" id="satelliteChartOptions" style="min-width: 200px;">
                                <div class="p-2">
                                    <input type="text" placeholder="æœç´¢å«æ˜Ÿ..." class="w-full px-3 py-1 border border-gray-300 rounded text-sm" id="satelliteChartSearch">
                                </div>
                                <div class="select-all-item" id="selectAllSatelliteChart">
                                    <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                                </div>
                                <div id="satelliteChartList"></div>
                            </div>
                            <input type="hidden" id="satelliteChartValue" value="">
                        </div>
                        
                        <button id="resetSatelliteChart" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" title="é‡ç½®å½“å‰å›¾è¡¨ç­›é€‰">
                            <i class="fa fa-refresh mr-1"></i>é‡ç½®ç­›é€‰
                        </button>
                        
                        <!-- åˆ†éš”çº¿ -->
                        <div class="w-px h-6 bg-gray-300"></div>
                        
                        <div class="flex gap-2">
                            <label class="flex items-center px-2 py-1 bg-secondary/10 text-secondary rounded cursor-pointer hover:bg-secondary/20 transition" title="ç‚¹å‡»æ˜¾ç¤º/éšè—å›¾è¡¨æ¯ä¸ªç‚¹çš„æ•°å€¼">
                                <input type="checkbox" id="showSatelliteLabels" class="mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                                <span class="text-sm font-medium">æ˜¾ç¤ºæ•°æ®æ ‡ç­¾</span>
                            </label>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="satelliteChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                                <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                            </button>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="satelliteChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                                <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                            </button>
                        </div>
                    </div>
                </h3>
                
                <div class="chart-container">
                    <canvas id="satelliteChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="satelliteChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>ä»»åŠ¡ç±»å‹è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex items-center gap-4">
                        <!-- ä»»åŠ¡ç±»å‹ç­›é€‰ -->
                        <div class="dropdown-container relative" style="min-width: 160px;">
                            <div class="flex items-center justify-between filter-select cursor-pointer text-sm" id="typeChartDropdown">
                                <span id="typeChartDisplay" class="truncate" style="max-width: 120px;">è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹</span>
                                <i class="fa fa-chevron-down text-xs ml-2"></i>
                            </div>
                            <div class="selected-tags" id="typeChartTags"></div>
                            <div class="dropdown-content hidden absolute top-full left-0 z-50" id="typeChartOptions" style="min-width: 200px;">
                                <div class="p-2">
                                    <input type="text" placeholder="æœç´¢ç±»å‹..." class="w-full px-3 py-1 border border-gray-300 rounded text-sm" id="typeChartSearch">
                                </div>
                                <div class="select-all-item" id="selectAllTypeChart">
                                    <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                                </div>
                                <div id="typeChartList"></div>
                            </div>
                            <input type="hidden" id="typeChartValue" value="">
                        </div>

                        <button id="resetTypeChart" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" title="é‡ç½®å½“å‰å›¾è¡¨ç­›é€‰">
                            <i class="fa fa-refresh mr-1"></i>é‡ç½®ç­›é€‰
                        </button>

                        <!-- åˆ†éš”çº¿ -->
                        <div class="w-px h-6 bg-gray-300"></div>

                        <div class="flex gap-2">
                            <label class="flex items-center px-2 py-1 bg-secondary/10 text-secondary rounded cursor-pointer hover:bg-secondary/20 transition" title="ç‚¹å‡»æ˜¾ç¤º/éšè—å›¾è¡¨æ¯ä¸ªç‚¹çš„æ•°å€¼">
                                <input type="checkbox" id="showTypeLabels" class="mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                                <span class="text-sm font-medium">æ˜¾ç¤ºæ•°æ®æ ‡ç­¾</span>
                            </label>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="typeChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                                <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                            </button>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="typeChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                                <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                            </button>
                        </div>
                    </div>
                </h3>

                <div class="chart-container">
                    <canvas id="typeChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="typeChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span>ä»»åŠ¡ç»“æœçŠ¶æ€è¶‹åŠ¿åˆ†æ</span>
                    <div class="flex items-center gap-4">
                        <!-- ä»»åŠ¡ç»“æœçŠ¶æ€ç­›é€‰ -->
                        <div class="dropdown-container relative" style="min-width: 160px;">
                            <div class="flex items-center justify-between filter-select cursor-pointer text-sm" id="statusChartDropdown">
                                <span id="statusChartDisplay" class="truncate" style="max-width: 120px;">è¯·é€‰æ‹©ä»»åŠ¡çŠ¶æ€</span>
                                <i class="fa fa-chevron-down text-xs ml-2"></i>
                            </div>
                            <div class="selected-tags" id="statusChartTags"></div>
                            <div class="dropdown-content hidden absolute top-full left-0 z-50" id="statusChartOptions" style="min-width: 200px;">
                                <div class="p-2">
                                    <input type="text" placeholder="æœç´¢çŠ¶æ€..." class="w-full px-3 py-1 border border-gray-300 rounded text-sm" id="statusChartSearch">
                                </div>
                                <div class="select-all-item" id="selectAllStatusChart">
                                    <i class="fa fa-check-square-o mr-2"></i>å…¨é€‰
                                </div>
                                <div id="statusChartList"></div>
                            </div>
                            <input type="hidden" id="statusChartValue" value="">
                        </div>

                        <button id="resetStatusChart" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" title="é‡ç½®å½“å‰å›¾è¡¨ç­›é€‰">
                            <i class="fa fa-refresh mr-1"></i>é‡ç½®ç­›é€‰
                        </button>

                        <!-- åˆ†éš”çº¿ -->
                        <div class="w-px h-6 bg-gray-300"></div>

                        <div class="flex gap-2">
                            <label class="flex items-center px-2 py-1 bg-secondary/10 text-secondary rounded cursor-pointer hover:bg-secondary/20 transition" title="ç‚¹å‡»æ˜¾ç¤º/éšè—å›¾è¡¨æ¯ä¸ªç‚¹çš„æ•°å€¼">
                                <input type="checkbox" id="showStatusLabels" class="mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                                <span class="text-sm font-medium">æ˜¾ç¤ºæ•°æ®æ ‡ç­¾</span>
                            </label>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="statusChart" data-type="image" title="ä¸‹è½½å›¾è¡¨å›¾ç‰‡">
                                <i class="fa fa-download mr-1"></i>ä¸‹è½½å›¾è¡¨
                            </button>
                            <button class="chart-download-btn px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"
                                    data-chart="statusChart" data-type="csv" title="ä¸‹è½½å›¾è¡¨æ•°æ®">
                                <i class="fa fa-table mr-1"></i>ä¸‹è½½æ•°æ®
                            </button>
                        </div>
                    </div>
                </h3>

                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500 hidden" id="statusChartEmpty">
                        <div class="text-center">
                            <i class="fa fa-line-chart text-4xl mb-2"></i>
                            <p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- å‘¨æœŸè§„åˆ™é…ç½®æ¨¡æ€æ¡† -->
    <div id="groupingConfigModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md p-6 transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">å‘¨æœŸè§„åˆ™é…ç½®</h3>
                <button id="closeConfigModal" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <div class="mb-6 pb-4 border-b border-gray-100">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar-o text-primary mr-2"></i>æŒ‰æ—¥å‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å‘¨æœŸèµ·å§‹æ—¶é—´</label>
                        <input type="time" id="dayStart" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                    <div>
                        <p class="block text-sm text-gray-600 mb-1">å‘¨æœŸèŒƒå›´</p>
                        <div class="p-2 border border-gray-200 rounded-md bg-gray-50 text-sm">
                            Xæ—¥ <span id="dayStartDisplay">00:00</span> è‡³ X+1æ—¥ <span id="dayEndDisplay">00:00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6 pb-4 border-b border-gray-100">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar-week-o text-primary mr-2"></i>æŒ‰å‘¨å‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å‘¨èµ·å§‹æ—¥</label>
                        <select id="weekStartDay" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                            <option value="0">å‘¨æ—¥</option>
                            <option value="1" selected>å‘¨ä¸€</option>
                            <option value="2">å‘¨äºŒ</option>
                            <option value="3">å‘¨ä¸‰</option>
                            <option value="4">å‘¨å››</option>
                            <option value="5">å‘¨äº”</option>
                            <option value="6">å‘¨å…­</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">èµ·å§‹æ—¶é—´</label>
                        <input type="time" id="weekStartTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                </div>
            </div>

            <div class="mb-6 pb-4 border-b border-gray-100">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar text-primary mr-2"></i>æŒ‰æœˆå‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">æœˆèµ·å§‹æ—¥æœŸ</label>
                        <input type="number" id="monthStartDate" min="1" max="31" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">èµ·å§‹æ—¶é—´</label>
                        <input type="time" id="monthStartTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-medium mb-3 flex items-center">
                    <i class="fa fa-calendar-check-o text-primary mr-2"></i>æŒ‰å­£åº¦å‘¨æœŸ
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å­£åº¦èµ·å§‹æœˆä»½</label>
                        <select id="quarterStartMonth" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                            <option value="1">1æœˆï¼ˆQ1:1-3æœˆï¼‰</option>
                            <option value="4">4æœˆï¼ˆQ2:4-6æœˆï¼‰</option>
                            <option value="7">7æœˆï¼ˆQ3:7-9æœˆï¼‰</option>
                            <option value="10">10æœˆï¼ˆQ4:10-12æœˆï¼‰</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">èµ·å§‹æ—¶é—´</label>
                        <input type="time" id="quarterStartTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all" value="00:00">
                    </div>
                </div>
            </div>

            <button id="saveGroupingConfig" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                ä¿å­˜é…ç½®
            </button>
        </div>
    </div>

    <script>
        // å­—æ®µæ˜ å°„é…ç½®ï¼ˆæ”¯æŒè‹±æ–‡å’Œä¸­æ–‡å­—æ®µåï¼‰
        const FIELD_MAPPING = {
            'å®¢æˆ·åç§°': 'customer',
            'å«æ˜Ÿåç§°': 'satellite_name', 
            'æµ‹ç«™åç§°': 'station_name',
            'ä»»åŠ¡ç»“æœçŠ¶æ€': 'task_result',
            'ä»»åŠ¡ç±»å‹': 'task_type',
            'å¼€å§‹æ—¶é—´': 'start_time'
        };

        // å­—æ®µæ˜ å°„å¤‡é€‰æ–¹æ¡ˆï¼ˆå‘åå…¼å®¹ï¼‰
        const FIELD_MAPPING_FALLBACK = {
            'å®¢æˆ·åç§°': 'æ‰€å±å®¢æˆ·',
            'å«æ˜Ÿåç§°': 'å«æ˜Ÿåç§°',
            'æµ‹ç«™åç§°': 'æµ‹ç«™åç§°', 
            'ä»»åŠ¡ç»“æœçŠ¶æ€': 'ä»»åŠ¡ç»“æœçŠ¶æ€',
            'ä»»åŠ¡ç±»å‹': 'ä»»åŠ¡ç±»å‹',
            'å¼€å§‹æ—¶é—´': 'å¼€å§‹æ—¶é—´'
        };

        // æ™ºèƒ½è·å–å­—æ®µå€¼çš„å‡½æ•°
        function getFieldValue(item, systemField) {
            if (!item) return '';
            
            // ä¼˜å…ˆä½¿ç”¨æ–°çš„è‹±æ–‡å­—æ®µå
            const primaryField = FIELD_MAPPING[systemField];
            if (primaryField && item[primaryField] !== undefined && item[primaryField] !== null) {
                return item[primaryField];
            }
            
            // å¦‚æœè‹±æ–‡å­—æ®µä¸å­˜åœ¨ï¼Œå°è¯•ä¸­æ–‡å­—æ®µå
            const fallbackField = FIELD_MAPPING_FALLBACK[systemField];
            if (fallbackField && item[fallbackField] !== undefined && item[fallbackField] !== null) {
                return item[fallbackField];
            }
            
            return '';
        }

        // æ—¶é—´è½¬æ¢å‡½æ•°å·²åˆ é™¤ï¼Œä¸å†éœ€è¦UTCä¸åŒ—äº¬æ—¶é—´è½¬æ¢

        // IndexedDBå·¥å…·ç±»ï¼ˆä¸å˜ï¼‰
        class SatelliteDB {
            constructor() {
                this.dbName = 'SatelliteDataCache';
                this.storeName = 'allDataCache';
                this.db = null;
                this.initialized = false;
                this.initPromise = null;
                this.TIMEOUT_DURATION = 15000;
                this.requiredIndex = 'byTimestamp';
            }

            async init() {
                if (this.initialized) return Promise.resolve(this.db);
                if (this.initPromise) return this.initPromise;

                this.initPromise = Promise.race([
                    new Promise((resolve, reject) => {
                        const request = indexedDB.open(this.dbName, 4); // ğŸ†• å‡çº§åˆ°v4ä»¥åŒ¹é…index.html

                        request.onupgradeneeded = (event) => {
                            this.db = event.target.result;
                            const oldVersion = event.oldVersion;

                            // åˆ›å»º allDataCache storeï¼ˆä¸»æ•°æ®å­˜å‚¨ï¼‰
                            if (!this.db.objectStoreNames.contains(this.storeName)) {
                                const store = this.db.createObjectStore(this.storeName, { keyPath: 'id' });
                                store.createIndex(this.requiredIndex, 'timestamp', { unique: false });
                                console.log('ğŸ“¦ åˆ›å»º allDataCache å­˜å‚¨ç©ºé—´');
                            }

                            // ğŸ†• åˆ›å»º metaData storeï¼ˆå…ƒæ•°æ®å­˜å‚¨ï¼Œä¸ index.html ä¿æŒä¸€è‡´ï¼‰
                            if (!this.db.objectStoreNames.contains('metaData')) {
                                this.db.createObjectStore('metaData', { keyPath: 'key' });
                                console.log('ğŸ“¦ åˆ›å»º metaData å­˜å‚¨ç©ºé—´');
                            }

                            // ğŸ†• v3->v4å‡çº§ï¼šå‘åå…¼å®¹ï¼Œä¸å½±å“å·²æœ‰æ•°æ®
                            if (oldVersion > 0) {
                                console.log(`ğŸ”§ æ•°æ®åº“å‡çº§: v${oldVersion} -> v4`);
                            }
                        };

                        request.onsuccess = (event) => {
                            this.db = event.target.result;
                            this.initialized = true;
                            resolve(this.db);
                        };

                        request.onerror = (event) => {
                            this.initialized = false;
                            reject(event.target.error);
                        };
                    }),
                    new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('æ•°æ®åº“è¿æ¥è¶…æ—¶')), this.TIMEOUT_DURATION);
                    })
                ]);

                return this.initPromise;
            }

            async ensureInitialized() {
                if (!this.initialized) await this.init();
                return this.db;
            }

            async getAllDataWithProgress(progressCallback) {
                await this.ensureInitialized();
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const cursorRequest = store.openCursor(null, 'prev');

                return new Promise((resolve, reject) => {
                    const results = [];
                    let count = 0;

                    cursorRequest.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            results.push(cursor.value);
                            count++;
                            if (progressCallback) progressCallback(Math.min(100, count * 10), count, count);
                            cursor.continue();
                        } else {
                            resolve(results);
                        }
                    };

                    cursorRequest.onerror = (event) => reject(event.target.error);
                });
            }

            async hasData() {
                const count = await this.getTotalCount();
                return count > 0;
            }

            async getTotalCount() {
                await this.ensureInitialized();
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                return new Promise((resolve) => {
                    const countRequest = store.count();
                    countRequest.onsuccess = () => resolve(countRequest.result);
                });
            }

            async clearData() {
                await this.ensureInitialized();
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                return new Promise((resolve) => {
                    const request = store.clear();
                    request.onsuccess = () => resolve(true);
                });
            }
        }

        // å‘¨æœŸè§„åˆ™å¼•æ“ï¼ˆä¿ç•™ç°æœ‰é€»è¾‘ï¼‰
        class CycleRuleEngine {
            constructor() {
                this.config = {
                    day: { start: '00:00' },
                    week: { startDay: 1, startTime: '00:00' },
                    month: { startDate: 1, startTime: '00:00' },
                    quarter: { startMonth: 1, startTime: '00:00' }
                };
                this.loadConfig();
            }

            loadConfig() {
                const savedConfig = localStorage.getItem('cycleRules');
                if (savedConfig) this.config = JSON.parse(savedConfig);
            }

            saveConfig() {
                localStorage.setItem('cycleRules', JSON.stringify(this.config));
            }

            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                this.saveConfig();
            }

            groupByStartTime(data, groupBy, planIdField, startTimeField) {
                const sortedData = [...data].sort((a, b) => {
                    // a[startTimeField] å¯èƒ½æ˜¯ Date æˆ– å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸º Date å¯¹è±¡æ¯”è¾ƒ
                    const dateA = a[startTimeField] instanceof Date ? a[startTimeField] : new Date(a[startTimeField]);
                    const dateB = b[startTimeField] instanceof Date ? b[startTimeField] : new Date(b[startTimeField]);
                    return dateA - dateB;
                });

                const groups = {};
                const groupMetadata = {};

                sortedData.forEach(item => {
                    const startTime = item[startTimeField];
                    if (!startTime) return;

                    const itemDate = startTime instanceof Date ? startTime : new Date(startTime);
                    let group;

                    switch (groupBy) {
                        case 'day': group = this.getDayGroup(itemDate); break;
                        case 'week': group = this.getWeekGroup(itemDate); break;
                        case 'month': group = this.getMonthGroup(itemDate); break;
                        case 'quarter': group = this.getQuarterGroup(itemDate); break;
                        default: return;
                    }

                    if (!groups[group.key]) {
                        groups[group.key] = [];
                        groupMetadata[group.key] = group;
                    }
                    groups[group.key].push(item);
                });

                const sortedKeys = Object.keys(groups).sort((a, b) =>
                    groupMetadata[a].rangeStart - groupMetadata[b].rangeStart
                );

                return { groups, groupMetadata, sortedKeys };
            }

            getDayGroup(date) {
                const dayConfig = this.config.day;
                const { hours, minutes } = this.parseTimeToHoursMinutes(dayConfig.start);

                // åˆ›å»ºä¸¥æ ¼çš„æ–‡ä»¶æ—¶é—´å¯¹è±¡ï¼Œä¸è€ƒè™‘æµè§ˆå™¨æ—¶åŒº
                const fileDate = this.createFileDate(date);

                // åˆ›å»ºå‚è€ƒæ—¥æœŸï¼šä¸åŸå§‹æ—¥æœŸåŒä¸€å¤©çš„å‘¨æœŸèµ·å§‹æ—¶é—´ç‚¹ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const referenceStart = this.createFileDate(fileDate);
                referenceStart.setHours(hours, minutes, 0, 0);

                // è®¡ç®—å‘¨æœŸèµ·å§‹æ—¶é—´ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const cycleStart = fileDate >= referenceStart
                    ? new Date(referenceStart)
                    : new Date(referenceStart.getTime() - 24 * 60 * 60 * 1000);

                // å‘¨æœŸç»“æŸæ—¶é—´ = å‘¨æœŸèµ·å§‹æ—¶é—´ + 1å¤©ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const cycleEnd = new Date(cycleStart.getTime() + 24 * 60 * 60 * 1000);

                // å‘¨æœŸæ ‡ç­¾ä¸ºå‘¨æœŸèµ·å§‹æ—¶é—´çš„æ—¥æœŸï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const groupDate = new Date(cycleStart);
                const groupKey = this.formatDate(groupDate);
                const groupLabel = this.formatDateCorrected(groupDate);

                return {
                    key: groupKey,
                    label: groupLabel,
                    rangeStart: cycleStart,
                    rangeEnd: cycleEnd
                };
            }

            getWeekGroup(date) {
                const weekConfig = this.config.week;
                const startDay = weekConfig.startDay; // 0=å‘¨æ—¥, 1=å‘¨ä¸€...6=å‘¨å…­
                const { hours, minutes } = this.parseTimeToHoursMinutes(weekConfig.startTime);

                // åˆ›å»ºä¸¥æ ¼çš„æ–‡ä»¶æ—¶é—´å¯¹è±¡
                const fileDate = this.createFileDate(date);

                // è·å–å½“å‰æ—¥æœŸæ˜¯æ˜ŸæœŸå‡ ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const currentDay = fileDate.getDay();

                // è®¡ç®—è·ç¦»æœ¬å‘¨èµ·å§‹æ—¥çš„å¤©æ•°å·®
                let dayDiff = currentDay - startDay;
                if (dayDiff < 0) {
                    dayDiff += 7; // å¦‚æœæ˜¯ä¸Šå‘¨çš„æ—¥æœŸï¼Œè°ƒæ•´å·®å€¼
                }

                // åˆ›å»ºå‚è€ƒæ—¥æœŸï¼šæœ¬å‘¨èµ·å§‹æ—¥çš„èµ·å§‹æ—¶é—´ç‚¹ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const referenceStart = this.createFileDate(fileDate);
                referenceStart.setDate(fileDate.getDate() - dayDiff);
                referenceStart.setHours(hours, minutes, 0, 0);

                // è®¡ç®—å‘¨æœŸèµ·å§‹æ—¶é—´ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const cycleStart = fileDate >= referenceStart
                    ? new Date(referenceStart)
                    : new Date(referenceStart.getTime() - 7 * 24 * 60 * 60 * 1000);

                // å‘¨æœŸç»“æŸæ—¶é—´ = å‘¨æœŸèµ·å§‹æ—¶é—´ + 7å¤©ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const cycleEnd = new Date(cycleStart.getTime() + 7 * 24 * 60 * 60 * 1000);

                // è®¡ç®—å¹´ä»½å’Œå‘¨æ•°ï¼ˆç›´æ¥ä½¿ç”¨å‘¨æœŸèµ·å§‹æ—¶é—´ï¼Œä¸éœ€è¦ä¿®æ­£ï¼‰
                const year = cycleStart.getFullYear();
                const firstDayOfYear = new Date(year, 0, 1);
                const pastDaysOfYear = (cycleStart - firstDayOfYear) / 86400000;
                const week = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);

                const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                const startDayName = weekDays[startDay];

                return {
                    key: `${year}-W${String(week).padStart(2, '0')}`,
                    label: `${year}å¹´ç¬¬${week}å‘¨ï¼ˆ${startDayName}ï¼‰`,
                    rangeStart: cycleStart,
                    rangeEnd: cycleEnd
                };
            }

            getMonthGroup(date) {
                const monthConfig = this.config.month;
                const startDate = monthConfig.startDate;
                const { hours, minutes } = this.parseTimeToHoursMinutes(monthConfig.startTime);

                // åˆ›å»ºä¸¥æ ¼çš„æ–‡ä»¶æ—¶é—´å¯¹è±¡
                const fileDate = this.createFileDate(date);

                const currentYear = fileDate.getFullYear();
                const currentMonth = fileDate.getMonth(); // 0-11ï¼ˆæ–‡ä»¶æ—¶é—´æœˆä»½ï¼‰

                // åˆ›å»ºå‚è€ƒæ—¥æœŸï¼šæœ¬æœˆèµ·å§‹æ—¥çš„èµ·å§‹æ—¶é—´ç‚¹ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const referenceStart = new Date(currentYear, currentMonth, startDate);
                referenceStart.setHours(hours, minutes, 0, 0);

                // å¤„ç†æœˆä»½æœ€åä¸€å¤©å¯èƒ½å°äºstartDateçš„æƒ…å†µï¼ˆå¦‚2æœˆ30æ—¥ï¼‰
                if (referenceStart.getDate() !== startDate) {
                    // è‡ªåŠ¨è°ƒæ•´ä¸ºå½“æœˆæœ€åä¸€å¤©
                    referenceStart.setMonth(referenceStart.getMonth() + 1, 0);
                    referenceStart.setHours(hours, minutes, 0, 0);
                }

                // è®¡ç®—å‘¨æœŸèµ·å§‹æ—¶é—´ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                let cycleStart;
                if (fileDate >= referenceStart) {
                    cycleStart = new Date(referenceStart);
                } else {
                    // ä¸Šä¸ªæœˆçš„èµ·å§‹æ—¶é—´ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                    const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                    const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;

                    cycleStart = new Date(prevYear, prevMonth, startDate);
                    cycleStart.setHours(hours, minutes, 0, 0);

                    // å†æ¬¡æ£€æŸ¥ä¸Šä¸ªæœˆçš„æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                    if (cycleStart.getDate() !== startDate) {
                        cycleStart.setMonth(cycleStart.getMonth() + 1, 0);
                        cycleStart.setHours(hours, minutes, 0, 0);
                    }
                }

                // è®¡ç®—å‘¨æœŸç»“æŸæ—¶é—´ï¼ˆä¸‹ä¸ªæœˆçš„èµ·å§‹æ—¶é—´ï¼Œæ–‡ä»¶æ—¶é—´ï¼‰
                const nextMonth = cycleStart.getMonth() + 1;
                const nextYear = cycleStart.getFullYear() + (nextMonth > 11 ? 1 : 0);
                const adjustedNextMonth = nextMonth > 11 ? 0 : nextMonth;

                const cycleEnd = new Date(nextYear, adjustedNextMonth, startDate);
                cycleEnd.setHours(hours, minutes, 0, 0);

                // å¤„ç†ä¸‹ä¸ªæœˆæ—¥æœŸå¯èƒ½æ— æ•ˆçš„æƒ…å†µ
                if (cycleEnd.getDate() !== startDate) {
                    cycleEnd.setMonth(cycleEnd.getMonth() + 1, 0);
                    cycleEnd.setHours(hours, minutes, 0, 0);
                }

                const groupKey = `${cycleStart.getFullYear()}-${String(cycleStart.getMonth() + 1).padStart(2, '0')}`;
                const groupLabel = `${cycleStart.getFullYear()}å¹´${cycleStart.getMonth() + 1}æœˆ`;

                return {
                    key: groupKey,
                    label: groupLabel,
                    rangeStart: cycleStart,
                    rangeEnd: cycleEnd
                };
            }

            getQuarterGroup(date) {
                const quarterConfig = this.config.quarter;
                const startMonth = parseInt(quarterConfig.startMonth); // 1,4,7,10
                const { hours, minutes } = this.parseTimeToHoursMinutes(quarterConfig.startTime);

                // åˆ›å»ºä¸¥æ ¼çš„æ–‡ä»¶æ—¶é—´å¯¹è±¡
                const fileDate = this.createFileDate(date);

                const currentYear = fileDate.getFullYear();
                const currentMonth = fileDate.getMonth() + 1; // 1-12ï¼ˆæ–‡ä»¶æ—¶é—´æœˆä»½ï¼‰

                // ç¡®å®šå½“å‰å­£åº¦çš„èµ·å§‹æœˆä»½
                let currentQuarterStart;
                if (startMonth === 1) {
                    currentQuarterStart = currentMonth <= 3 ? 1 :
                                        currentMonth <= 6 ? 4 :
                                        currentMonth <= 9 ? 7 : 10;
                } else if (startMonth === 4) {
                    currentQuarterStart = currentMonth <= 6 ? 4 :
                                        currentMonth <= 9 ? 7 :
                                        currentMonth <= 12 ? 10 : 1;
                } else if (startMonth === 7) {
                    currentQuarterStart = currentMonth <= 9 ? 7 :
                                        currentMonth <= 12 ? 10 :
                                        currentMonth <= 3 ? 1 : 4;
                } else { // startMonth === 10
                    currentQuarterStart = currentMonth <= 12 ? 10 :
                                        currentMonth <= 3 ? 1 :
                                        currentMonth <= 6 ? 4 : 7;
                }

                // åˆ›å»ºå‚è€ƒæ—¥æœŸï¼šæœ¬å­£åº¦èµ·å§‹æœˆ1æ—¥çš„èµ·å§‹æ—¶é—´ç‚¹ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const referenceStart = new Date(
                    currentQuarterStart <= currentMonth ? currentYear : currentYear - 1,
                    currentQuarterStart - 1, // è½¬æ¢ä¸º0-basedæœˆä»½
                    1
                );
                referenceStart.setHours(hours, minutes, 0, 0);

                // è®¡ç®—å‘¨æœŸèµ·å§‹æ—¶é—´ï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
                const cycleStart = fileDate >= referenceStart ? referenceStart :
                    new Date(referenceStart.getTime() - 3 * 30 * 24 * 60 * 60 * 1000); // å¤§çº¦3ä¸ªæœˆå‰

                // è®¡ç®—å‘¨æœŸç»“æŸæ—¶é—´ï¼ˆä¸‹ä¸€å­£åº¦çš„èµ·å§‹æ—¶é—´ï¼Œæ–‡ä»¶æ—¶é—´ï¼‰
                let nextQuarterStart = currentQuarterStart + 3;
                let nextQuarterYear = cycleStart.getFullYear();

                if (nextQuarterStart > 12) {
                    nextQuarterStart = nextQuarterStart - 12;
                    nextQuarterYear++;
                }

                const cycleEnd = new Date(nextQuarterYear, nextQuarterStart - 1, 1);
                cycleEnd.setHours(hours, minutes, 0, 0);

                // ç”Ÿæˆæ ‡ç­¾ï¼ˆç›´æ¥ä½¿ç”¨å‘¨æœŸèµ·å§‹æ—¶é—´ï¼Œä¸éœ€è¦ä¿®æ­£ï¼‰
                const year = cycleStart.getFullYear();
                const quarter = Math.floor((currentQuarterStart - 1) / 3) + 1;

                return {
                    key: `${year}-Q${quarter}`,
                    label: `${year}å¹´ç¬¬${quarter}å­£åº¦`,
                    rangeStart: cycleStart,
                    rangeEnd: cycleEnd
                };
            }

            parseTimeToHoursMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return { hours: hours || 0, minutes: minutes || 0 };
            }

            // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DDï¼ˆæ–‡ä»¶æ—¶é—´ï¼‰
            formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼ˆä¸å†éœ€è¦æ—¶åŒºä¿®æ­£ï¼Œæ•°æ®åº“æ—¶é—´å·²æ˜¯åŒ—äº¬æ—¶é—´ï¼‰
            formatDateCorrected(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            // åˆ›å»ºä¸¥æ ¼åŸºäºæ–‡ä»¶æ—¶é—´çš„æ—¥æœŸå¯¹è±¡ï¼Œä¸è¿›è¡Œä»»ä½•æ—¶åŒºè½¬æ¢
            createFileDate(originalDate) {
                // ç²¾ç¡®å¤åˆ¶åŸå§‹æ—¥æœŸçš„å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼Œå®Œå…¨åŸºäºæ–‡ä»¶ä¸­çš„æ—¶é—´
                return new Date(
                    originalDate.getFullYear(),
                    originalDate.getMonth(),
                    originalDate.getDate(),
                    originalDate.getHours(),
                    originalDate.getMinutes(),
                    originalDate.getSeconds()
                );
            }

            // è·å–æ—¥æœŸæ‰€å±çš„å‘¨æœŸç»„ï¼ˆå®Œå…¨åŸºäºæ–‡ä»¶æ—¶é—´ï¼‰
            getGroup(date, groupType) {
                // ç¡®ä¿è¾“å…¥æ˜¯Dateå¯¹è±¡
                const dateObj = date instanceof Date ? date : new Date(date);

                // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
                if (isNaN(dateObj.getTime())) {
                    console.error('æ— æ•ˆçš„æ—¥æœŸ:', date);
                    throw new Error('æ— æ•ˆçš„æ—¥æœŸ');
                }

                // æ‰€æœ‰æ—¶é—´å¤„ç†éƒ½åŸºäºæ–‡ä»¶ä¸­çš„åŸå§‹æ—¶é—´ï¼Œä¸è¿›è¡Œæ—¶åŒºè½¬æ¢
                switch (groupType) {
                    case 'day':
                        return this.getDayGroup(dateObj);
                    case 'week':
                        return this.getWeekGroup(dateObj);
                    case 'month':
                        return this.getMonthGroup(dateObj);
                    case 'quarter':
                        return this.getQuarterGroup(dateObj);
                    default:
                        console.error('æœªçŸ¥çš„åˆ†ç»„ç±»å‹:', groupType);
                        return this.getDayGroup(dateObj);
                }
            }

            getWeekNumber(date) {
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ—¥æœŸï¼ˆç®€åŒ–é€»è¾‘ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (startDateInput) startDateInput.value = formatDate(sevenDaysAgo);
            if (endDateInput) endDateInput.value = formatDate(today);
        });

        // å›¾è¡¨ç”Ÿæˆå™¨ï¼ˆæ›²çº¿å›¾ï¼‰
        class ChartGenerator {
            constructor() {
                this.charts = {};
                this.colors = [
                    '#165DFF', '#36CFC9', '#722ED1', '#FF7D00', '#F53F3F',
                    '#00B42A', '#86909C', '#F7BA1E', '#E53E3E', '#48BB78',
                    '#3182CE', '#805AD5', '#ED8936', '#ECC94B', '#6B46C1'
                ];
                this.lineStyles = ['solid', 'dashed', 'dotted'];
            }

            destroyChart(chartId) {
                if (this.charts[chartId]) {
                    this.charts[chartId].destroy();
                    delete this.charts[chartId];
                }
            }

            generateTrendChart(chartId, title, xLabels, datasets) {
                // æ£€æŸ¥ Chart.js æ˜¯å¦å·²åŠ è½½
                if (typeof Chart === 'undefined') {
                    console.error('âŒ Chart.js æœªåŠ è½½ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨:', chartId);
                    const emptyState = document.getElementById(`${chartId}Empty`);
                    if (emptyState) {
                        emptyState.classList.remove('hidden');
                        emptyState.innerHTML = '<p class="text-red-500">å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
                    }
                    return;
                }

                this.destroyChart(chartId);
                const ctx = document.getElementById(chartId).getContext('2d');
                const emptyState = document.getElementById(`${chartId}Empty`);

                const hasData = datasets.some(dataset => dataset.data.some(v => v > 0));
                if (!hasData) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    return null;
                }

                if (emptyState) emptyState.classList.add('hidden');
                
                // è·å–å¯¹åº”çš„æ•°æ®æ ‡ç­¾æ˜¾ç¤ºè®¾ç½®
                const showLabelsCheckbox = document.getElementById(`show${chartId.charAt(0).toUpperCase() + chartId.slice(1, -5)}Labels`);
                const showLabels = showLabelsCheckbox ? showLabelsCheckbox.checked : false;
                
                // æ³¨å†Œæ•°æ®æ ‡ç­¾æ’ä»¶
                Chart.register(ChartDataLabels);
                
                console.log(`Creating chart ${chartId} with ${datasets.length} datasets`);
                
                // éªŒè¯æ•°æ®é›†
                datasets.forEach((dataset, i) => {
                    console.log(`Dataset ${i}: ${dataset.label}, data points: ${dataset.data.length}`);
                });

                // æ›²çº¿å›¾æ ·å¼é…ç½®
                const styledDatasets = datasets.map((dataset, i) => ({
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: this.colors[i % this.colors.length],
                    backgroundColor: `${this.colors[i % this.colors.length]}20`,
                    borderWidth: 2,
                    borderDash: this.lineStyles[i % this.lineStyles.length] === 'dashed' ? [5, 5] :
                                this.lineStyles[i % this.lineStyles.length] === 'dotted' ? [2, 2] : [],
                    tension: 0.3,
                    fill: false,
                    pointBackgroundColor: this.colors[i % this.colors.length],
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBorderWidth: 2,
                    pointBorderColor: this.colors[i % this.colors.length],
                    datalabels: {
                        display: showLabels,
                        color: this.colors[i % this.colors.length],
                        anchor: 'end',
                        align: i % 2 === 0 ? 'top' : 'bottom',
                        font: {
                            size: 10,
                            weight: 'bold'
                        }
                    }
                }));

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: xLabels,
                        datasets: styledDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: '#165DFF',
                                borderWidth: 2,
                                cornerRadius: 6,
                                displayColors: true,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const timeLabel = tooltipItems[0].label;
                                        return `æ—¶é—´ç‚¹: ${timeLabel}`;
                                    },
                                    label: function(context) {
                                        const seriesName = context.dataset.label;
                                        const value = context.raw;
                                        const timeLabel = context.label;
                                        
                                        // æ˜¾ç¤ºç³»åˆ—åç§°ã€æ•°å€¼å’Œæ—¶é—´ä¿¡æ¯
                                        return `${seriesName}: ${value} æ¬¡`;
                                    },
                                    footer: function(tooltipItems) {
                                        // è®¡ç®—è¯¥æ—¶é—´ç‚¹çš„æ€»æ•°
                                        const total = tooltipItems.reduce((sum, item) => sum + item.raw, 0);
                                        return total > 0 ? `æ€»è®¡: ${total} æ¬¡` : '';
                                    }
                                },
                                // è‡ªå®šä¹‰æ’åºï¼Œè®©æ•°å€¼å¤§çš„æ˜¾ç¤ºåœ¨å‰é¢
                                itemSort: function(a, b) {
                                    return b.raw - a.raw;
                                }
                            },
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    stepSize: 1
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });

                this.charts[chartId] = chart;
                return chart;
            }
            
            toggleDataLabels(chartId) {
                const chart = this.charts[chartId];
                if (chart) {
                    const showLabelsCheckbox = document.getElementById(`show${chartId.charAt(0).toUpperCase() + chartId.slice(1, -5)}Labels`);
                    const showLabels = showLabelsCheckbox ? showLabelsCheckbox.checked : false;
                    
                    // æ›´æ–°æ‰€æœ‰æ•°æ®é›†çš„æ ‡ç­¾æ˜¾ç¤ºè®¾ç½®
                    chart.data.datasets.forEach(dataset => {
                        if (dataset.datalabels) {
                            dataset.datalabels.display = showLabels;
                        }
                    });
                    
                    // æ›´æ–°å›¾è¡¨
                    chart.update('none'); // ä½¿ç”¨ 'none' æ¨¡å¼å®ç°å³æ—¶æ›´æ–°
                }
            }
        }

        // æ”¯æŒå…¨é€‰çš„å¤šé€‰ä¸‹æ‹‰ç»„ä»¶ï¼ˆä¸å˜ï¼‰
        class MultiSelectDropdown {
            constructor(dropdownId, optionsId, displayId, valueId, tagsId, searchId, selectAllId, onChange) {
                this.dropdownId = dropdownId;
                this.optionsId = optionsId;
                this.displayId = displayId;
                this.valueId = valueId;
                this.tagsId = tagsId;
                this.searchId = searchId;
                this.selectAllId = selectAllId;
                this.onChange = onChange;

                this.selectedValues = [];
                this.allOptions = [];
                this.isAllSelected = false;

                this.init();
            }

            init() {
                const dropdownEl = document.getElementById(this.dropdownId);
                if (dropdownEl) {
                    dropdownEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown();
                    });
                }

                const searchEl = document.getElementById(this.searchId);
                if (searchEl) {
                    searchEl.addEventListener('input', (e) => {
                        this.filterOptions(e.target.value);
                    });
                }

                const selectAllCheckbox = document.getElementById(this.selectAllId);
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleSelectAll();
                    });
                }

                document.addEventListener('click', (e) => {
                    const optionsContainer = document.getElementById(this.optionsId);
                    const isClickInside = optionsContainer && (optionsContainer.contains(e.target) ||
                                          (dropdownEl && dropdownEl.contains(e.target)));

                    if (!isClickInside) {
                        this.closeDropdown();
                    }
                });
            }

            setOptions(options) {
                this.allOptions = [...options];
                this.renderOptions();
            }

            renderOptions(filter = '') {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;

                while (optionsContainer.children.length > 2) {
                    optionsContainer.removeChild(optionsContainer.lastChild);
                }

                const filteredOptions = this.allOptions.filter(option =>
                    option.label.toLowerCase().includes(filter.toLowerCase())
                );

                filteredOptions.forEach(option => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'tab-item tab-item-inactive flex items-center p-2';
                    optionEl.innerHTML = `
                        <input type="checkbox" class="multiselect-checkbox"
                               data-value="${option.value}"
                               ${this.selectedValues.includes(option.value) ? 'checked' : ''}>
                        <span>${option.label}</span>
                    `;

                    optionEl.querySelector('input').addEventListener('change', (e) => {
                        e.stopPropagation();
                        this.toggleSelection(option.value, e.target.checked);
                    });

                    optionEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = optionEl.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                            const ev = new Event('change', { bubbles: false });
                            checkbox.dispatchEvent(ev);
                        }
                    });

                    optionsContainer.appendChild(optionEl);
                });

                this.updateSelectAllStatus();
            }

            filterOptions(keyword) {
                this.renderOptions(keyword);
            }

            toggleSelection(value, isChecked) {
                if (isChecked && !this.selectedValues.includes(value)) {
                    this.selectedValues.push(value);
                } else if (!isChecked && this.selectedValues.includes(value)) {
                    this.selectedValues = this.selectedValues.filter(v => v !== value);
                }

                this.updateDisplay();
                this.updateTags();
                this.updateSelectAllStatus();

                // ã€è‡ªåŠ¨æ¸…é™¤æœç´¢æ¡†ã€‘é€‰æ‹©åè‡ªåŠ¨æ¸…ç©ºæœç´¢å†…å®¹
                const searchEl = document.getElementById(this.searchId);
                if (searchEl) {
                    searchEl.value = '';
                    this.filterOptions(''); // é‡ç½®è¿‡æ»¤ï¼Œæ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
                }

                if (this.onChange) {
                    this.onChange([...this.selectedValues]);
                }

                this.openDropdown();
            }

            toggleSelectAll() {
                const selectAllEl = document.getElementById(this.selectAllId);
                if (!selectAllEl) return;
                let checkbox = selectAllEl.querySelector('input[type="checkbox"]');

                if (!checkbox) {
                    this.updateSelectAllStatus();
                    checkbox = selectAllEl.querySelector('input[type="checkbox"]');
                    if (!checkbox) return;
                }

                checkbox.checked = !checkbox.checked;
                const event = new Event('change', { bubbles: false });
                checkbox.dispatchEvent(event);
            }

            updateSelectAllStatus() {
                const optionsContainer = document.getElementById(this.optionsId);
                const selectAllEl = document.getElementById(this.selectAllId);
                if (!optionsContainer || !selectAllEl) return;

                const checkboxes = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]'))
                    .filter(cb => !cb.closest('#' + this.selectAllId));

                const visibleOptionsCount = checkboxes.length;
                const selectedCount = checkboxes.filter(cb => cb.checked).length;

                let checkbox = selectAllEl.querySelector('input[type="checkbox"]');

                if (!checkbox) {
                    selectAllEl.innerHTML = '';

                    checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'mr-1';
                    checkbox.id = `${this.selectAllId}-checkbox`;

                    const label = document.createElement('span');
                    label.textContent = 'å…¨é€‰';

                    selectAllEl.appendChild(checkbox);
                    selectAllEl.appendChild(label);

                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        const optionCheckboxes = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]'))
                            .filter(cb => !cb.closest('#' + this.selectAllId));

                        if (e.target.checked) {
                            this.selectedValues = optionCheckboxes
                                .map(cb => cb.dataset.value)
                                .filter(Boolean);

                            optionCheckboxes.forEach(cb => cb.checked = true);
                        } else {
                            this.selectedValues = [];
                            optionCheckboxes.forEach(cb => cb.checked = false);
                        }

                        this.updateDisplay();
                        this.updateTags();

                        if (this.onChange) this.onChange([...this.selectedValues]);
                        this.openDropdown();
                    });
                }

                const isAllSelected = visibleOptionsCount > 0 && selectedCount === visibleOptionsCount;
                checkbox.checked = isAllSelected;
            }

            updateDisplay() {
                const displayEl = document.getElementById(this.displayId);
                if (!displayEl) return;
                if (this.selectedValues.length === 0) {
                    displayEl.textContent = 'è¯·é€‰æ‹©';
                } else if (this.selectedValues.length === 1) {
                    const selectedOption = this.allOptions.find(opt => opt.value === this.selectedValues[0]);
                    displayEl.textContent = selectedOption ? selectedOption.label : 'å·²é€‰æ‹©';
                } else if (this.selectedValues.length === this.allOptions.length) {
                    displayEl.textContent = 'å…¨éƒ¨å·²é€‰æ‹©';
                } else {
                    displayEl.textContent = `å·²é€‰æ‹© ${this.selectedValues.length} é¡¹`;
                }

                const hiddenInput = document.getElementById(this.valueId);
                if (hiddenInput) hiddenInput.value = JSON.stringify(this.selectedValues);
            }

            updateTags() {
                const tagsContainer = document.getElementById(this.tagsId);
                if (!tagsContainer) return;
                tagsContainer.innerHTML = '';

                if (this.selectedValues.length > 5) {
                    const tagEl = document.createElement('div');
                    tagEl.className = 'selected-tag';
                    tagEl.innerHTML = `å·²é€‰æ‹© ${this.selectedValues.length} é¡¹ <span class="tag-remove" data-clear="all">Ã—</span>`;

                    tagEl.querySelector('.tag-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.clearSelection();
                    });

                    tagsContainer.appendChild(tagEl);
                    return;
                }

                this.selectedValues.forEach(value => {
                    const option = this.allOptions.find(opt => opt.value === value);
                    if (!option) return;

                    const tagEl = document.createElement('div');
                    tagEl.className = 'selected-tag';
                    tagEl.innerHTML = `
                        ${option.label}
                        <span class="tag-remove" data-value="${value}">Ã—</span>
                    `;

                    tagEl.querySelector('.tag-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleSelection(e.target.dataset.value, false);
                    });

                    tagsContainer.appendChild(tagEl);
                });
            }

            clearSelection() {
                this.selectedValues = [];
                this.updateDisplay();
                this.updateTags();
                this.updateSelectAllStatus();
                const searchInput = document.getElementById(this.searchId);
                this.renderOptions(searchInput ? searchInput.value : '');
                if (this.onChange) this.onChange([]);
            }

            toggleDropdown() {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;
                optionsContainer.classList.toggle('hidden');
            }

            closeDropdown() {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;
                optionsContainer.classList.add('hidden');
            }

            openDropdown() {
                const optionsContainer = document.getElementById(this.optionsId);
                if (!optionsContainer) return;
                optionsContainer.classList.remove('hidden');
            }

            getSelectedValues() {
                return [...this.selectedValues];
            }

            // ã€åŒå‘åŒæ­¥ã€‘è®¾ç½®é€‰ä¸­çš„å€¼ï¼ˆä¸è§¦å‘ onChange å›è°ƒï¼‰
            setSelectedValues(values) {
                // è®¾ç½®é€‰ä¸­çš„å€¼
                this.selectedValues = [...values];

                // æ›´æ–°æ˜¾ç¤º
                this.updateDisplay();
                this.updateTags();

                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                const optionsContainer = document.getElementById(this.optionsId);
                if (optionsContainer) {
                    const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        const value = cb.dataset.value;
                        if (value) {
                            cb.checked = this.selectedValues.includes(value);
                        }
                    });
                }

                // æ›´æ–°å…¨é€‰çŠ¶æ€
                this.updateSelectAllStatus();
            }
        }

        // ä¸‹è½½å·¥å…·å‡½æ•°ï¼ˆé€šç”¨ï¼‰
        function downloadFile(filename, content, mimeType = 'application/octet-stream') {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 500);
        }

        function chartToCSV(chart) {
            if (!chart) return '';
            const labels = chart.data.labels || [];
            const datasets = chart.data.datasets || [];

            const header = ['åˆ†ç»„', ...datasets.map(ds => ds.label || '')];
            const rows = [header];

            for (let i = 0; i < labels.length; i++) {
                const row = [labels[i]];
                for (let j = 0; j < datasets.length; j++) {
                    const value = datasets[j].data && typeof datasets[j].data[i] !== 'undefined'
                        ? datasets[j].data[i]
                        : '';
                    row.push(value);
                }
                rows.push(row);
            }

            const csvLines = rows.map(cols => cols.map(cell => {
                if (cell === null || typeof cell === 'undefined') return '';
                const cellStr = String(cell);
                if (/[",\n]/.test(cellStr)) {
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }
                return cellStr;
            }).join(','));

            return '\uFEFF' + csvLines.join('\n');
        }

        // ä¸»åº”ç”¨ç±»
        class TrendAnalysisApp {
            constructor() {
                // ã€ä¿®å¤ã€‘æ¸…é™¤æ—§çš„é¡µé¢çŠ¶æ€ï¼ˆç¡®ä¿åˆ·æ–°åä»åˆå§‹åŒ–çŠ¶æ€å¼€å§‹ï¼‰
                sessionStorage.removeItem('trendAnalysisPageState');
                sessionStorage.removeItem('trendAnalysisFilters');
                sessionStorage.removeItem('trendAnalysisCharts');
                console.log('ğŸ§¹ å·²æ¸…é™¤è¶‹åŠ¿åˆ†æé¡µé¢çš„æ—§çŠ¶æ€ï¼Œä»åˆå§‹åŒ–çŠ¶æ€å¼€å§‹');

                this.db = new SatelliteDB();
                this.cycleEngine = new CycleRuleEngine();
                this.chartGenerator = new ChartGenerator();

                // é¢„æ£€æŸ¥ sessionStorageï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ä¿å­˜çš„çŠ¶æ€ï¼ˆåˆ·æ–°åå§‹ç»ˆä¸º falseï¼‰
                this.hasSavedState = false;
                this.hasSavedFilters = false;
                this.hasSavedCharts = false;

                this.initMultiSelects();

                this.data = null;
                this.autoApplyTimer = null; // è‡ªåŠ¨åº”ç”¨ç­›é€‰é˜²æŠ–å®šæ—¶å™¨
                this.timeChangeTimer = null; // æ—¶é—´æ”¹å˜é˜²æŠ–å®šæ—¶å™¨
                this.groupByChangeTimer = null; // åˆ†ç»„æ”¹å˜é˜²æŠ–å®šæ—¶å™¨
                this.chartRebuildTimer = null; // å›¾è¡¨é‡å»ºé˜²æŠ–å®šæ—¶å™¨ï¼ˆ200msï¼‰
                this.pendingChartRebuild = false; // æ˜¯å¦æœ‰å¾…é‡å»ºçš„å›¾è¡¨
                this.isChartRebuilding = false; // æ˜¯å¦æ­£åœ¨é‡å»ºå›¾è¡¨
                this.filteredData = null;
                this.rawData = null;
                this.filterValues = {
                    'æµ‹ç«™åç§°': [],
                    'å®¢æˆ·åç§°': [],
                    'å«æ˜Ÿåç§°': [],
                    'ä»»åŠ¡ç»“æœçŠ¶æ€': [],
                    'ä»»åŠ¡ç±»å‹': []
                };

                // ã€åŒå‘åŒæ­¥ã€‘é˜²æ­¢å¾ªç¯è§¦å‘çš„æ ‡å¿—
                this.isSyncingFilters = false;

                // ç›‘å¬ç¼“å­˜å˜åŒ–
                this.lastCacheCheckTime = null;
                this.cacheCheckInterval = null;

                this.init();
            }

            initMultiSelects() {
                // é¡¶éƒ¨ç­›é€‰ç»„ä»¶
                // ã€çº§è”ä¼˜åŒ–ã€‘é¡¶éƒ¨ç­›é€‰å™¨çš„çº§è”é¡ºåºï¼šæµ‹ç«™ â†’ ç”¨æˆ· â†’ å«æ˜Ÿ â†’ ä»»åŠ¡ç±»å‹ â†’ ä»»åŠ¡ç»“æœçŠ¶æ€
                this.stationSelect = new MultiSelectDropdown(
                    'stationDropdown', 'stationOptions', 'stationDisplay',
                    'stationValue', 'stationTags', 'stationSearch', 'selectAllStations',
                    (values) => {
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘ä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°
                        if (!this.isSyncingFilters) {
                            // æµ‹ç«™é€‰æ‹© â†’ å½±å“å®¢æˆ·ã€å«æ˜Ÿã€ä»»åŠ¡ç±»å‹ã€çŠ¶æ€
                            this.updateCustomerOptions();
                            this.updateSatelliteOptions();
                            this.updateTypeOptions();
                            this.updateStatusOptions();
                            this.updateChartFilterOptions();
                            // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°åº•éƒ¨ç­›é€‰å™¨
                            this.syncTopToBottom('station', values);
                            // ã€æ–°å¢ã€‘è‡ªåŠ¨åº”ç”¨ç­›é€‰
                            this.autoApplyFilters();
                        }
                    }
                );

                this.customerSelect = new MultiSelectDropdown(
                    'customerDropdown', 'customerOptions', 'customerDisplay',
                    'customerValue', 'customerTags', 'customerSearch', 'selectAllCustomers',
                    (values) => {
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘ä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°
                        if (!this.isSyncingFilters) {
                            // å®¢æˆ·é€‰æ‹© â†’ å½±å“å«æ˜Ÿã€ä»»åŠ¡ç±»å‹ã€çŠ¶æ€
                            this.updateSatelliteOptions();
                            this.updateTypeOptions();
                            this.updateStatusOptions();
                            this.updateChartFilterOptions();
                            // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°åº•éƒ¨ç­›é€‰å™¨
                            this.syncTopToBottom('customer', values);
                            // ã€æ–°å¢ã€‘è‡ªåŠ¨åº”ç”¨ç­›é€‰
                            this.autoApplyFilters();
                        }
                    }
                );

                this.satelliteSelect = new MultiSelectDropdown(
                    'satelliteDropdown', 'satelliteOptions', 'satelliteDisplay',
                    'satelliteValue', 'satelliteTags', 'satelliteSearch', 'selectAllSatellites',
                    (values) => {
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘ä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°
                        if (!this.isSyncingFilters) {
                            // å«æ˜Ÿé€‰æ‹© â†’ å½±å“ä»»åŠ¡ç±»å‹ã€çŠ¶æ€
                            this.updateTypeOptions();
                            this.updateStatusOptions();
                            this.updateChartFilterOptions();
                            // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°åº•éƒ¨ç­›é€‰å™¨
                            this.syncTopToBottom('satellite', values);
                            // ã€æ–°å¢ã€‘è‡ªåŠ¨åº”ç”¨ç­›é€‰
                            this.autoApplyFilters();
                        }
                    }
                );

                this.typeSelect = new MultiSelectDropdown(
                    'typeDropdown', 'typeOptions', 'typeDisplay',
                    'typeValue', 'typeTags', 'typeSearch', 'selectAllTypes',
                    (values) => {
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘ä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°
                        if (!this.isSyncingFilters) {
                            // ä»»åŠ¡ç±»å‹é€‰æ‹© â†’ å½±å“ä»»åŠ¡ç»“æœçŠ¶æ€
                            this.updateStatusOptions();
                            this.updateChartFilterOptions();
                            // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°åº•éƒ¨ç­›é€‰å™¨
                            this.syncTopToBottom('type', values);
                            // ã€æ–°å¢ã€‘è‡ªåŠ¨åº”ç”¨ç­›é€‰
                            this.autoApplyFilters();
                        }
                    }
                );

                this.statusSelect = new MultiSelectDropdown(
                    'statusDropdown', 'statusOptions', 'statusDisplay',
                    'statusValue', 'statusTags', 'statusSearch', 'selectAllStatuses',
                    (values) => {
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘ä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°
                        if (!this.isSyncingFilters) {
                            // çŠ¶æ€é€‰æ‹© â†’ ä¸å½±å“å…¶ä»–ç­›é€‰å™¨ï¼ˆçº§è”æœ«ç«¯ï¼‰
                            this.updateChartFilterOptions();
                            // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°åº•éƒ¨ç­›é€‰å™¨
                            this.syncTopToBottom('status', values);
                            // ã€æ–°å¢ã€‘è‡ªåŠ¨åº”ç”¨ç­›é€‰
                            this.autoApplyFilters();
                        }
                    }
                );

                // ã€çº§è”ä¼˜åŒ–ã€‘åº•éƒ¨å›¾è¡¨ä¸“ç”¨ç­›é€‰å™¨ï¼šæµ‹ç«™ â†’ å®¢æˆ· â†’ å«æ˜Ÿ â†’ ç±»å‹ â†’ çŠ¶æ€
                this.stationChartSelect = new MultiSelectDropdown(
                    'stationChartDropdown', 'stationChartOptions', 'stationChartDisplay',
                    'stationChartValue', 'stationChartTags', 'stationChartSearch', 'selectAllStationChart',
                    (values) => {
                        // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°é¡¶éƒ¨ç­›é€‰å™¨ï¼ˆä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹ï¼‰
                        if (!this.isSyncingFilters) {
                            this.syncBottomToTop('station', values);
                            // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åªéœ€è°ƒç”¨ä¸€æ¬¡ autoApplyFiltersï¼Œå®ƒä¼šå¤„ç†æ‰€æœ‰æ›´æ–°
                            this.autoApplyFilters();
                            // æµ‹ç«™æ”¹å˜ â†’ æ›´æ–°å®¢æˆ·ã€å«æ˜Ÿã€ç±»å‹ã€çŠ¶æ€é€‰é¡¹
                            this.updateCustomerChartOptions();
                            this.updateSatelliteChartOptions();
                            this.updateTypeChartOptions();
                            this.updateStatusChartOptions();
                            this.generateStationChartWithFilter();
                        }
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åŒæ­¥æ—¶è·³è¿‡æ‰€æœ‰æ›´æ–°ï¼Œé¿å…é‡å¤è®¡ç®—
                    }
                );

                this.customerChartSelect = new MultiSelectDropdown(
                    'customerChartDropdown', 'customerChartOptions', 'customerChartDisplay',
                    'customerChartValue', 'customerChartTags', 'customerChartSearch', 'selectAllCustomerChart',
                    (values) => {
                        // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°é¡¶éƒ¨ç­›é€‰å™¨ï¼ˆä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹ï¼‰
                        if (!this.isSyncingFilters) {
                            this.syncBottomToTop('customer', values);
                            // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åªéœ€è°ƒç”¨ä¸€æ¬¡ autoApplyFiltersï¼Œå®ƒä¼šå¤„ç†æ‰€æœ‰æ›´æ–°
                            this.autoApplyFilters();
                            // å®¢æˆ·æ”¹å˜ â†’ æ›´æ–°å«æ˜Ÿã€ç±»å‹ã€çŠ¶æ€é€‰é¡¹
                            this.updateSatelliteChartOptions();
                            this.updateTypeChartOptions();
                            this.updateStatusChartOptions();
                            this.generateCustomerChartWithFilter();
                        }
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åŒæ­¥æ—¶è·³è¿‡æ‰€æœ‰æ›´æ–°ï¼Œé¿å…é‡å¤è®¡ç®—
                    }
                );

                this.satelliteChartSelect = new MultiSelectDropdown(
                    'satelliteChartDropdown', 'satelliteChartOptions', 'satelliteChartDisplay',
                    'satelliteChartValue', 'satelliteChartTags', 'satelliteChartSearch', 'selectAllSatelliteChart',
                    (values) => {
                        // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°é¡¶éƒ¨ç­›é€‰å™¨ï¼ˆä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹ï¼‰
                        if (!this.isSyncingFilters) {
                            this.syncBottomToTop('satellite', values);
                            // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åªéœ€è°ƒç”¨ä¸€æ¬¡ autoApplyFiltersï¼Œå®ƒä¼šå¤„ç†æ‰€æœ‰æ›´æ–°
                            this.autoApplyFilters();
                            // å«æ˜Ÿæ”¹å˜ â†’ æ›´æ–°ç±»å‹ã€çŠ¶æ€é€‰é¡¹
                            this.updateTypeChartOptions();
                            this.updateStatusChartOptions();
                            this.generateSatelliteChartWithFilter();
                        }
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åŒæ­¥æ—¶è·³è¿‡æ‰€æœ‰æ›´æ–°ï¼Œé¿å…é‡å¤è®¡ç®—
                    }
                );

                this.typeChartSelect = new MultiSelectDropdown(
                    'typeChartDropdown', 'typeChartOptions', 'typeChartDisplay',
                    'typeChartValue', 'typeChartTags', 'typeChartSearch', 'selectAllTypeChart',
                    (values) => {
                        // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°é¡¶éƒ¨ç­›é€‰å™¨ï¼ˆä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹ï¼‰
                        if (!this.isSyncingFilters) {
                            this.syncBottomToTop('type', values);
                            // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åªéœ€è°ƒç”¨ä¸€æ¬¡ autoApplyFiltersï¼Œå®ƒä¼šå¤„ç†æ‰€æœ‰æ›´æ–°
                            this.autoApplyFilters();
                            // ç±»å‹æ”¹å˜ â†’ æ›´æ–°çŠ¶æ€é€‰é¡¹
                            this.updateStatusChartOptions();
                            this.generateTypeChartWithFilter();
                        }
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åŒæ­¥æ—¶è·³è¿‡æ‰€æœ‰æ›´æ–°ï¼Œé¿å…é‡å¤è®¡ç®—
                    }
                );

                this.statusChartSelect = new MultiSelectDropdown(
                    'statusChartDropdown', 'statusChartOptions', 'statusChartDisplay',
                    'statusChartValue', 'statusChartTags', 'statusChartSearch', 'selectAllStatusChart',
                    (values) => {
                        // ã€åŒå‘åŒæ­¥ã€‘åŒæ­¥åˆ°é¡¶éƒ¨ç­›é€‰å™¨ï¼ˆä»…åœ¨éåŒæ­¥çŠ¶æ€ä¸‹ï¼‰
                        if (!this.isSyncingFilters) {
                            this.syncBottomToTop('status', values);
                            // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åªéœ€è°ƒç”¨ä¸€æ¬¡ autoApplyFiltersï¼Œå®ƒä¼šå¤„ç†æ‰€æœ‰æ›´æ–°
                            this.autoApplyFilters();
                            // çŠ¶æ€æ”¹å˜ â†’ çº§è”æœ«ç«¯ï¼Œä»…é‡æ–°ç”ŸæˆçŠ¶æ€å›¾è¡¨
                            this.generateStatusChartWithFilter();
                        }
                        // ã€æ€§èƒ½ä¼˜åŒ–ã€‘åŒæ­¥æ—¶è·³è¿‡æ‰€æœ‰æ›´æ–°ï¼Œé¿å…é‡å¤è®¡ç®—
                    }
                );
            }

            async init() {
                this.setupEventListeners();
                await this.loadData();
                this.addDebugButtons();
                this.bindDownloadButtons();
                this.updateTimeDisplays();
                this.setupBroadcastListener();
            }

            // è®¾ç½®è·¨é¡µé¢å¹¿æ’­ç›‘å¬å™¨
            setupBroadcastListener() {
                // ã€ä¿®å¤ã€‘å»¶è¿Ÿæ£€æŸ¥ SharedDataManagerï¼Œç»™å®ƒåˆå§‹åŒ–æ—¶é—´
                setTimeout(() => {
                    if (!window.sharedDataManager) {
                        console.warn('âš ï¸ SharedDataManager æœªåˆå§‹åŒ–ï¼Œè·¨é¡µé¢åŒæ­¥ä¸å¯ç”¨');
                        console.warn('ğŸ’¡ è¯·ç¡®ä¿ shared-data-manager.js å·²æ­£ç¡®åŠ è½½');
                        return;
                    }

                    this._setupBroadcastListenerInternal();
                }, 100);
            }

            // å†…éƒ¨æ–¹æ³•ï¼šçœŸæ­£è®¾ç½®å¹¿æ’­ç›‘å¬å™¨
            _setupBroadcastListenerInternal() {
                if (!window.sharedDataManager) return;

                // ã€ä¼˜åŒ–ã€‘ç›‘å¬å…¶ä»–é¡µé¢çš„æ•°æ®æ›´æ–°ï¼ˆé›¶ç‚¹å‡ æ¯«ç§’å“åº”ï¼‰
                window.sharedDataManager.onDataUpdate = (operation, record) => {
                    const perfStart = performance.now();
                    console.log(`ğŸ“¡ æ”¶åˆ°è·¨é¡µé¢æ›´æ–°å¹¿æ’­: ${operation}`, record);

                    if (!this.data) {
                        console.warn('âš ï¸ æœ¬é¡µé¢æ•°æ®æœªåŠ è½½ï¼Œè·³è¿‡æ›´æ–°');
                        return;
                    }

                    // === ç¬¬1æ­¥ï¼šç«‹å³å¢é‡æ›´æ–°å†…å­˜æ•°æ®ï¼ˆé›¶ç‚¹å‡ æ¯«ç§’ï¼‰===
                    const memoryStart = performance.now();
                    let updated = false;
                    if (operation === 'insert' || operation === 'update') {
                        updated = this.incrementalUpdateRecord(record);
                    } else if (operation === 'delete') {
                        const recordId = record.id || record.plan_id;
                        updated = this.incrementalDeleteRecord(recordId);
                    }
                    const memoryTime = performance.now() - memoryStart;
                    console.log(`â±ï¸ [1/2] å†…å­˜æ›´æ–°è€—æ—¶: ${memoryTime.toFixed(2)}ms`);

                    // === ç¬¬2æ­¥ï¼šæ™ºèƒ½æ›´æ–°å›¾è¡¨ï¼ˆåªæ›´æ–°å—å½±å“çš„å›¾è¡¨ï¼‰===
                    if (updated && this.filteredData) {
                        const chartStart = performance.now();

                        // å°è¯•æ™ºèƒ½æ›´æ–°ï¼ˆåªæ›´æ–°å—å½±å“çš„å›¾è¡¨ï¼Œä¸é‡å»ºï¼‰
                        const smartUpdated = this.smartUpdateCharts(record, operation);

                        const chartTime = performance.now() - chartStart;
                        console.log(`â±ï¸ [2/2] å›¾è¡¨æ›´æ–°è€—æ—¶: ${chartTime.toFixed(2)}ms (æ™ºèƒ½æ›´æ–°: ${smartUpdated ? 'æˆåŠŸâœ…' : 'é™çº§â¬‡ï¸'})`);

                        // å¦‚æœæ™ºèƒ½æ›´æ–°å¤±è´¥ï¼Œä½¿ç”¨é˜²æŠ–é‡å»ºï¼ˆ200msï¼‰
                        if (!smartUpdated) {
                            this.pendingChartRebuild = true;
                            this.scheduleChartRebuild();
                        }

                        const totalTime = performance.now() - perfStart;
                        console.log(`âœ… æ€»å“åº”æ—¶é—´: ${totalTime.toFixed(2)}ms`);
                    }
                };

                // ã€ä¼˜åŒ–ã€‘ç›‘å¬æ¸è¿›å¼æ•°æ®åŠ è½½
                window.sharedDataManager.onProgressiveLoad = async (newRecord, currentCount, totalCount) => {
                    // index.html æ­£åœ¨åŠ è½½æ•°æ®æ—¶ï¼Œé€šçŸ¥æœ¬é¡µé¢æœ‰æ–°æ•°æ®å¯ç”¨
                    console.log(`ğŸ“Š æ¸è¿›å¼åŠ è½½é€šçŸ¥ï¼š${currentCount}/${totalCount} æ¡æ•°æ®å·²å¯ç”¨`);

                    // å¦‚æœæœ¬é¡µé¢æ•°æ®æœªåˆå§‹åŒ–ï¼Œå°è¯•ä» IndexedDB è¯»å–æœ€æ–°æ•°æ®
                    if (!this.data || this.data.length === 0) {
                        console.log('ğŸ’¡ æ£€æµ‹åˆ°æ•°æ®æ­£åœ¨åŠ è½½ï¼Œç­‰å¾…æ•°æ®å°±ç»ª...');
                        // å¯ä»¥é€‰æ‹©ç­‰å¾…åŠ è½½å®Œæˆï¼Œæˆ–è€…æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
                    }

                    // å¦‚æœæœ¬é¡µé¢å·²æœ‰æ•°æ®ï¼Œä¸”æ–°æ•°æ®é‡æ˜æ˜¾å¢åŠ ï¼ˆ> 10%ï¼‰ï¼Œå¯ä»¥é€‰æ‹©åˆ·æ–°
                    else if (currentCount > this.data.length * 1.1) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°æ–°æ•°æ®é‡å¢åŠ ï¼Œå»ºè®®åˆ·æ–°é¡µé¢ä»¥è·å–æœ€æ–°æ•°æ®');
                        // å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªæç¤ºï¼Œè®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦åˆ·æ–°
                    }
                };

                // ğŸ†• ç›‘å¬å®æ—¶æ•°æ®æ›´æ–°ï¼ˆä»indexé¡µé¢æ¨é€ï¼‰
                window.sharedDataManager.onDataUpdate = (operation, record) => {
                    console.log(`ğŸ“¡ æ”¶åˆ°æ•°æ®æ›´æ–°: ${operation}`, record?.id || record?.plan_id);
                    this.handleRealtimeUpdate(operation, record);
                };

                // ç›‘å¬æ•°æ®é‡è½½äº‹ä»¶
                window.sharedDataManager.onDataReload = async () => {
                    console.log('ğŸ“¡ å…¶ä»–é¡µé¢é‡è½½äº†æ•°æ®ï¼Œæœ¬é¡µé¢ä¹Ÿéœ€è¦é‡è½½');
                    await this.reloadData();
                };

                // ğŸ†• ç›‘å¬æ•°æ®è¯·æ±‚ï¼ˆå…¶ä»–é¡µé¢è¯·æ±‚å…±äº«æ•°æ®ï¼‰
                window.sharedDataManager.onDataRequest = () => {
                    console.log('ğŸ“¨ æ”¶åˆ°å…¶ä»–é¡µé¢çš„æ•°æ®è¯·æ±‚');
                    // onDataRequest å›è°ƒåªæ˜¯é€šçŸ¥ï¼Œå®é™…å“åº”åœ¨ SharedDataManager å†…éƒ¨å¤„ç†
                    // åªæœ‰å½“æœ¬é¡µé¢çš„ this.data å·²åŠ è½½æ—¶ï¼ŒSharedDataManager æ‰ä¼šå“åº”
                };

                console.log('âœ… è·¨é¡µé¢å¹¿æ’­ç›‘å¬å™¨å·²è®¾ç½®ï¼ˆåŒ…å«å®æ—¶æ›´æ–°ï¼‰');
            }

            // ğŸ†• å¤„ç†å®æ—¶æ•°æ®æ›´æ–°ï¼ˆå‚è€ƒindex.htmlå®ç°ï¼‰
            handleRealtimeUpdate(operation, record) {
                if (!this.data || this.data.length === 0) {
                    console.log('âš ï¸ æœ¬åœ°æ•°æ®æœªåŠ è½½ï¼Œè·³è¿‡å®æ—¶æ›´æ–°');
                    return;
                }

                try {
                    const recordId = record.plan_id || record['è®¡åˆ’ID'] || record.id;

                    if (operation === 'insert' || operation === 'update') {
                        // æŸ¥æ‰¾ç°æœ‰è®°å½•
                        const existingIndex = this.data.findIndex(r =>
                            (r.plan_id || r['è®¡åˆ’ID'] || r.id) === recordId
                        );

                        if (existingIndex >= 0) {
                            // æ›´æ–°ç°æœ‰è®°å½•
                            this.data[existingIndex] = record;
                            console.log(`âœ… æ›´æ–°è®°å½•: ${recordId}`);
                        } else {
                            // æ–°å¢è®°å½•
                            this.data.push(record);
                            console.log(`â• æ–°å¢è®°å½•: ${recordId}`);
                        }

                        // å¢é‡åˆ·æ–°å›¾è¡¨
                        this.refreshChartsIncremental(record);

                    } else if (operation === 'delete') {
                        // åˆ é™¤è®°å½•
                        const deleteIndex = this.data.findIndex(r =>
                            (r.plan_id || r['è®¡åˆ’ID'] || r.id) === recordId
                        );

                        if (deleteIndex >= 0) {
                            this.data.splice(deleteIndex, 1);
                            console.log(`ğŸ—‘ï¸ åˆ é™¤è®°å½•: ${recordId}`);

                            // åˆ é™¤æ“ä½œéœ€è¦é‡æ–°ç”Ÿæˆå›¾è¡¨
                            this.refreshAllCharts();
                        }
                    }

                } catch (error) {
                    console.error('âŒ å¤„ç†å®æ—¶æ›´æ–°å¤±è´¥:', error);
                }
            }

            // ğŸ†• å¢é‡åˆ·æ–°å›¾è¡¨ï¼ˆåªåˆ·æ–°å—å½±å“çš„å›¾è¡¨ï¼‰
            refreshChartsIncremental(record) {
                // ä½¿ç”¨èŠ‚æµï¼Œé¿å…é¢‘ç¹åˆ·æ–°
                if (this._lastChartRefresh && Date.now() - this._lastChartRefresh < 2000) {
                    console.log('â±ï¸ åˆ·æ–°èŠ‚æµä¸­ï¼Œè·³è¿‡æœ¬æ¬¡åˆ·æ–°');
                    return;
                }

                this._lastChartRefresh = Date.now();

                // æ£€æŸ¥è®°å½•æ˜¯å¦åœ¨å½“å‰ç­›é€‰èŒƒå›´å†…
                const recordTime = new Date(record.start_time || record['å¼€å§‹æ—¶é—´']);
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);

                if (recordTime < startDate || recordTime > endDate) {
                    console.log('ğŸ“… è®°å½•ä¸åœ¨å½“å‰æ—¶é—´èŒƒå›´å†…ï¼Œè·³è¿‡åˆ·æ–°');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦ç¬¦åˆå½“å‰ç­›é€‰æ¡ä»¶
                if (!this.matchesCurrentFilters(record)) {
                    console.log('ğŸ” è®°å½•ä¸ç¬¦åˆå½“å‰ç­›é€‰æ¡ä»¶ï¼Œè·³è¿‡åˆ·æ–°');
                    return;
                }

                console.log('ğŸ”„ å¢é‡åˆ·æ–°å›¾è¡¨');
                this.refreshAllCharts();
            }

            // ğŸ†• æ£€æŸ¥è®°å½•æ˜¯å¦åŒ¹é…å½“å‰ç­›é€‰æ¡ä»¶
            matchesCurrentFilters(record) {
                // è·å–å½“å‰ç­›é€‰æ¡ä»¶
                const filters = {
                    station: this.stationSelect.getSelectedValues(),
                    customer: this.customerSelect.getSelectedValues(),
                    satellite: this.satelliteSelect.getSelectedValues(),
                    type: this.typeSelect.getSelectedValues(),
                    status: this.statusSelect.getSelectedValues()
                };

                // æ£€æŸ¥å„ä¸ªç­›é€‰æ¡ä»¶
                if (filters.station.length > 0 && !filters.station.includes(record.station || record['æµ‹ç«™'])) {
                    return false;
                }
                if (filters.customer.length > 0 && !filters.customer.includes(record.customer || record['æ‰€å±å®¢æˆ·'])) {
                    return false;
                }
                if (filters.satellite.length > 0 && !filters.satellite.includes(record.satellite_name || record['å«æ˜Ÿåç§°'])) {
                    return false;
                }
                if (filters.type.length > 0 && !filters.type.includes(record.task_type || record['ä»»åŠ¡ç±»å‹'])) {
                    return false;
                }
                if (filters.status.length > 0 && !filters.status.includes(record.task_result || record['ä»»åŠ¡ç»“æœçŠ¶æ€'])) {
                    return false;
                }

                return true;
            }

            // ğŸ†• åˆ·æ–°æ‰€æœ‰å›¾è¡¨
            refreshAllCharts() {
                console.log('ğŸ”„ åˆ·æ–°æ‰€æœ‰å›¾è¡¨');

                // é‡æ–°åº”ç”¨ç­›é€‰å¹¶ç”Ÿæˆå›¾è¡¨
                this.applyFilters();
            }

            setupEventListeners() {
                const applyBtn = document.getElementById('applyFilters');
                if (applyBtn) applyBtn.addEventListener('click', () => this.applyFilters());
                const resetBtn = document.getElementById('resetFilters');
                if (resetBtn) resetBtn.addEventListener('click', () => this.resetFilters());
                const configBtn = document.getElementById('configGroupingBtn');
                if (configBtn) configBtn.addEventListener('click', () => this.openCycleConfigModal());
                const closeModalBtn = document.getElementById('closeConfigModal');
                if (closeModalBtn) closeModalBtn.addEventListener('click', () => this.closeCycleConfigModal());
                const saveConfigBtn = document.getElementById('saveGroupingConfig');
                if (saveConfigBtn) saveConfigBtn.addEventListener('click', () => this.saveCycleConfig());
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => {
                    document.getElementById('mobileMenu').classList.toggle('hidden');
                });

                // æ·»åŠ æ•°æ®åˆ·æ–°æŒ‰é’®äº‹ä»¶ç›‘å¬
                const refreshDataBtn = document.getElementById('refreshDataBtn');
                if (refreshDataBtn) refreshDataBtn.addEventListener('click', () => this.refreshData());

                // å¯åŠ¨ç¼“å­˜ç›‘å¬
                this.startCacheMonitoring();

                // ã€ä¼˜åŒ–ã€‘æ·»åŠ é¡µé¢çŠ¶æ€è‡ªåŠ¨ä¿å­˜ç›‘å¬å™¨ + è‡ªåŠ¨åº”ç”¨ç­›é€‰
                const startDateEl = document.getElementById('startDate');
                const endDateEl = document.getElementById('endDate');
                const groupByEl = document.getElementById('groupBy');

                if (startDateEl) startDateEl.addEventListener('change', () => {
                    this.savePageState();
                    // ã€æ–°å¢ã€‘æ—¶é—´æ”¹å˜æ—¶ï¼Œä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼Œåªæ›´æ–°ç›¸å…³å›¾è¡¨
                    this.updateChartsOnTimeChange();
                });
                if (endDateEl) endDateEl.addEventListener('change', () => {
                    this.savePageState();
                    // ã€æ–°å¢ã€‘æ—¶é—´æ”¹å˜æ—¶ï¼Œä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼Œåªæ›´æ–°ç›¸å…³å›¾è¡¨
                    this.updateChartsOnTimeChange();
                });
                if (groupByEl) groupByEl.addEventListener('change', () => {
                    this.savePageState();
                    // ã€æ–°å¢ã€‘åˆ†ç»„æ”¹å˜æ—¶ï¼Œä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼Œé‡æ–°ç”Ÿæˆæ‰€æœ‰å›¾è¡¨
                    this.updateChartsOnGroupByChange();
                });

                const dayStartEl = document.getElementById('dayStart');
                if (dayStartEl) dayStartEl.addEventListener('change', (e) => {
                    // ç›´æ¥æ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„æ—¶é—´ï¼Œæ— è½¬æ¢
                    const displayTime = e.target.value;
                    document.getElementById('dayStartDisplay').textContent = displayTime;
                    document.getElementById('dayEndDisplay').textContent = displayTime;
                });

                // æ•°æ®æ ‡ç­¾å¤é€‰æ¡†äº‹ä»¶
                const labelCheckboxes = [
                    { id: 'showStationLabels', chartId: 'stationChart' },
                    { id: 'showCustomerLabels', chartId: 'customerChart' },
                    { id: 'showSatelliteLabels', chartId: 'satelliteChart' },
                    { id: 'showStatusLabels', chartId: 'statusChart' },
                    { id: 'showTypeLabels', chartId: 'typeChart' }
                ];

                labelCheckboxes.forEach(({ id, chartId }) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', () => this.chartGenerator.toggleDataLabels(chartId));
                    }
                });


                // å›¾è¡¨é‡ç½®æŒ‰é’®äº‹ä»¶
                const resetChartButtons = [
                    { id: 'resetStationChart', selector: 'stationChartSelect', generator: () => this.generateStationChartWithFilter() },
                    { 
                    id: 'resetCustomerChart', 
                    selector: 'customerChartSelect', 
                    generator: () => {
                        this.customerChartSelect.clearSelection();
                        // é‡ç½®å®¢æˆ·å›¾è¡¨åï¼Œæ¢å¤æ‰€æœ‰åç»­å›¾è¡¨çš„é€‰é¡¹
                        this.initializeAllChartOptions();
                        this.generateCustomerChartWithFilter();
                        this.generateSatelliteChartWithFilter();
                        this.generateStatusChartWithFilter();
                        this.generateTypeChartWithFilter();
                    }
                },
                    { 
                    id: 'resetSatelliteChart', 
                    selector: 'satelliteChartSelect', 
                    generator: () => {
                        this.satelliteChartSelect.clearSelection();
                        // é‡ç½®å«æ˜Ÿå›¾è¡¨åï¼Œæ¢å¤çŠ¶æ€å’Œç±»å‹å›¾è¡¨çš„é€‰é¡¹
                        this.updateInterModuleCascading('satellite');
                        this.generateSatelliteChartWithFilter();
                    }
                },
                    { 
                        id: 'resetStatusChart', 
                        selector: 'statusChartSelect', 
                        generator: () => {
                            this.statusChartSelect.clearSelection();
                            this.generateStatusChartWithFilter();
                        }
                    },
                    { 
                        id: 'resetTypeChart', 
                        selector: 'typeChartSelect', 
                        generator: () => {
                            this.typeChartSelect.clearSelection();
                            this.generateTypeChartWithFilter();
                        }
                    }
                ];

                resetChartButtons.forEach(({ id, selector, generator }) => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.addEventListener('click', () => {
                            // æ‰§è¡Œè‡ªå®šä¹‰çš„é‡ç½®é€»è¾‘
                            generator();
                        });
                    }
                });
            }

            openCycleConfigModal() {
                const modal = document.getElementById('groupingConfigModal');
                const modalContent = document.getElementById('modalContent');

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);

                // ç›´æ¥æ˜¾ç¤ºå­˜å‚¨çš„æ—¶é—´ï¼Œæ— è½¬æ¢
                const timeValue = this.cycleEngine.config.day.start;
                document.getElementById('dayStart').value = timeValue;
                document.getElementById('dayStartDisplay').textContent = timeValue;
                document.getElementById('dayEndDisplay').textContent = timeValue;

                document.getElementById('weekStartDay').value = this.cycleEngine.config.week.startDay;
                document.getElementById('weekStartTime').value = this.cycleEngine.config.week.startTime;

                document.getElementById('monthStartDate').value = this.cycleEngine.config.month.startDate;
                document.getElementById('monthStartTime').value = this.cycleEngine.config.month.startTime;

                document.getElementById('quarterStartMonth').value = this.cycleEngine.config.quarter.startMonth;
                document.getElementById('quarterStartTime').value = this.cycleEngine.config.quarter.startTime;
            }

            closeCycleConfigModal() {
                const modal = document.getElementById('groupingConfigModal');
                const modalContent = document.getElementById('modalContent');

                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');

                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            saveCycleConfig() {
                const newConfig = {
                    day: {
                        start: document.getElementById('dayStart').value // ç›´æ¥ä¿å­˜ç”¨æˆ·è¾“å…¥çš„æ—¶é—´
                    },
                    week: {
                        startDay: parseInt(document.getElementById('weekStartDay').value),
                        startTime: document.getElementById('weekStartTime').value
                    },
                    month: {
                        startDate: parseInt(document.getElementById('monthStartDate').value),
                        startTime: document.getElementById('monthStartTime').value
                    },
                    quarter: {
                        startMonth: parseInt(document.getElementById('quarterStartMonth').value),
                        startTime: document.getElementById('quarterStartTime').value
                    }
                };

                this.cycleEngine.updateConfig(newConfig);
                this.closeCycleConfigModal();

                // ã€ä¿®å¤ã€‘é…ç½®æ›´æ–°åï¼Œå¦‚æœæœ‰æ•°æ®å°±é‡æ–°ç”Ÿæˆå›¾è¡¨
                if (this.data) {
                    console.log('ğŸ”„ ç»Ÿè®¡å‘¨æœŸè§„åˆ™å·²æ›´æ–°ï¼Œé‡æ–°ç”Ÿæˆå›¾è¡¨');
                    this.applyFilters();
                }
            }

            async loadData() {
                const dbLoading = document.getElementById('dbLoading');

                try {
                    // ğŸ†• ã€ä¼˜å…ˆçº§1ã€‘å°è¯•ä»å…¶ä»–é¡µé¢ï¼ˆindex.htmlï¼‰è·å–å†…å­˜ä¸­çš„æ•°æ®
                    if (window.sharedDataManager) {
                        console.log('ğŸ” å°è¯•ä»å…¶ä»–é¡µé¢è·å–å…±äº«æ•°æ®...');

                        try {
                            const response = await window.sharedDataManager.requestData('trend-analysis', 1000); // 1ç§’è¶…æ—¶

                            if (response && response.data && response.data.length > 0) {
                                console.log(`âš¡ æˆåŠŸè·å–å…±äº«æ•°æ®: ${response.data.length.toLocaleString()} æ¡ (æ¥æº: ${response.metadata.source})`);
                                console.log('ğŸ¯ é›¶åŠ è½½æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨å…¶ä»–é¡µé¢å†…å­˜ä¸­çš„æ•°æ®ï¼Œæ— éœ€è®¿é—® IndexedDB');

                                this.rawData = response.data;
                                this.data = response.data;

                                // ç›´æ¥è¿›å…¥åˆå§‹åŒ–æµç¨‹
                                this.extractFilterValues();
                                this.initializeFilters();

                                document.getElementById('filterSection').classList.remove('hidden');
                                document.getElementById('chartsSection').classList.remove('hidden');
                                this.updateDebugInfo();

                                console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼ˆé›¶åŠ è½½æ¨¡å¼ï¼‰');
                                return; // æˆåŠŸè·å–å…±äº«æ•°æ®ï¼Œç›´æ¥è¿”å›
                            }
                        } catch (error) {
                            console.log('â±ï¸ å…±äº«æ•°æ®è¯·æ±‚è¶…æ—¶æˆ–å¤±è´¥ï¼Œé™çº§åˆ° IndexedDB åŠ è½½');
                        }
                    }

                    // ğŸ†• ã€ä¼˜å…ˆçº§2ã€‘æ£€æŸ¥æ˜¯å¦æœ‰æ–°é²œçš„ IndexedDB ç¼“å­˜
                    const hasSharedData = window.sharedDataManager && window.sharedDataManager.isDataFresh();

                    if (hasSharedData) {
                        const metadata = window.sharedDataManager.getMetadata();
                        console.log(`âœ… æ£€æµ‹åˆ°æ–°é²œçš„å…±äº«æ•°æ® (${metadata.recordCount} æ¡ï¼Œæ¥æº: ${metadata.source})`);
                        console.log('âš¡ æé€ŸåŠ è½½æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨å…±äº«æ•°æ®ï¼Œå®Œå…¨è·³è¿‡è¿›åº¦æ˜¾ç¤º');

                        // æé€ŸåŠ è½½ï¼ˆå®Œå…¨ä¸æ˜¾ç¤ºè¿›åº¦æ¡ï¼‰
                        const rawData = await this.db.getAllDataWithProgress(() => {});
                        this.rawData = rawData;
                        this.data = Array.isArray(rawData) ? rawData : [];

                        console.log(`âš¡ æé€ŸåŠ è½½å®Œæˆ: ${this.data.length.toLocaleString()} æ¡æ•°æ®`);
                    } else {
                        // åŸæœ‰çš„åŠ è½½é€»è¾‘ï¼ˆæ˜¾ç¤ºè¿›åº¦ï¼‰
                        if (dbLoading) dbLoading.classList.remove('hidden');

                        if (!await this.db.hasData()) {
                            if (dbLoading) dbLoading.classList.add('hidden');
                            document.getElementById('noDataAlert').classList.remove('hidden');
                            return;
                        }

                        const rawData = await this.db.getAllDataWithProgress((p) => {
                            document.getElementById('loadingProgress').style.width = `${p}%`;
                        });

                        this.rawData = rawData;
                        // ä»æ–°çš„ç¼“å­˜ç»“æ„ä¸­è·å–æ•°æ®ï¼šrawDataç›´æ¥æ˜¯æ•°æ®æ•°ç»„
                        this.data = Array.isArray(rawData) ? rawData : [];

                        if (dbLoading) dbLoading.classList.add('hidden');
                        console.log(`ğŸ“Š æ•°æ®åŠ è½½å®Œæˆ: ${this.data.length.toLocaleString()} æ¡æ•°æ®`);
                    }

                    this.extractFilterValues();
                    this.initializeFilters();

                    if (dbLoading) dbLoading.classList.add('hidden');
                    document.getElementById('filterSection').classList.remove('hidden');
                    document.getElementById('chartsSection').classList.remove('hidden');

                    this.updateDebugInfo();

                    // ğŸ†• é€šçŸ¥ SharedDataManager æ•°æ®å·²åŠ è½½ï¼Œä»¥ä¾¿å“åº”å…¶ä»–é¡µé¢çš„è¯·æ±‚
                    if (window.sharedDataManager && this.data) {
                        window.sharedDataManager.notifyDataLoaded(this.data, 'trend-analysis');
                        console.log('ğŸ“¡ å·²é€šçŸ¥ SharedDataManager æ•°æ®å·²åŠ è½½');
                    }

                    // ã€ä¿®å¤ã€‘åˆ·æ–°é¡µé¢æ—¶ä¸æ¢å¤çŠ¶æ€ï¼Œå§‹ç»ˆä»åˆå§‹åŒ–çŠ¶æ€å¼€å§‹
                    console.log('ğŸ”„ é¡µé¢å·²é‡æ–°åŠ è½½ï¼Œä»åˆå§‹åŒ–çŠ¶æ€å¼€å§‹ï¼ˆä¸æ¢å¤æ—§çŠ¶æ€ï¼‰');

                } catch (error) {
                    if (dbLoading) dbLoading.classList.add('hidden');
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);

                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    const errorAlert = document.getElementById('dbErrorAlert');
                    const errorMsg = document.getElementById('dbErrorMsg');
                    if (errorAlert && errorMsg) {
                        errorMsg.textContent = 'æ•°æ®åŠ è½½å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯');
                        errorAlert.classList.remove('hidden');
                    }

                    // åŒæ—¶æ˜¾ç¤ºæ— æ•°æ®æç¤ºï¼Œç»™ç”¨æˆ·æä¾›è¿”å›é¦–é¡µçš„é€‰é¡¹
                    const noDataAlert = document.getElementById('noDataAlert');
                    if (noDataAlert) {
                        noDataAlert.classList.remove('hidden');
                    }
                }
            }

            extractFilterValues() {
                Object.keys(this.filterValues).forEach(key => this.filterValues[key] = []);

                if (!this.data || !this.data.length) return;

                this.data.forEach(item => {
                    Object.keys(this.filterValues).forEach(systemField => {
                        const value = getFieldValue(item, systemField).toString().trim();
                        if (value && !this.filterValues[systemField].includes(value)) {
                            this.filterValues[systemField].push(value);
                        }
                    });
                });

                Object.keys(this.filterValues).forEach(key => {
                    this.filterValues[key].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                });
            }

            initializeFilters() {
                // ã€çº§è”ä¼˜åŒ–ã€‘åªåˆå§‹åŒ–é¡¶çº§ç­›é€‰å™¨ï¼ˆæµ‹ç«™ï¼‰ï¼Œå…¶ä»–ç­›é€‰å™¨é€šè¿‡çº§è”æ›´æ–°æ–¹æ³•è®¾ç½®
                const stationOptions = this.filterValues['æµ‹ç«™åç§°'].map(station => ({ value: station, label: station }));
                this.stationSelect.setOptions(stationOptions);
                this.stationChartSelect.setOptions(stationOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘é€šè¿‡è°ƒç”¨çº§è”æ›´æ–°æ–¹æ³•æ¥åˆå§‹åŒ–å…¶ä»–ç­›é€‰å™¨çš„é€‰é¡¹
                // è¿™æ ·å¯ä»¥ç¡®ä¿ä»ä¸€å¼€å§‹å°±æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨é€‰é¡¹ï¼ˆå› ä¸ºæ²¡æœ‰é€‰æ‹©æµ‹ç«™ï¼‰
                this.updateCustomerOptions();
                this.updateSatelliteOptions();
                this.updateTypeOptions();
                this.updateStatusOptions();

                // ã€çº§è”ä¼˜åŒ–ã€‘åº•éƒ¨å›¾è¡¨ç­›é€‰å™¨ä¹Ÿé€šè¿‡çº§è”æ–¹æ³•åˆå§‹åŒ–
                this.updateCustomerChartOptions();
                this.updateSatelliteChartOptions();
                this.updateTypeChartOptions();
                this.updateStatusChartOptions();

                // åˆå§‹åŒ–å›¾è¡¨é€‰é¡¹
                this.initializeAllChartOptions();

                if (this.filterValues['å®¢æˆ·åç§°'].length === 0 && this.data.some(item => getFieldValue(item, 'å®¢æˆ·åç§°'))) {
                    document.getElementById('dataStructureAlert').classList.remove('hidden');
                    document.getElementById('structureMsg').textContent =
                        `å·²è‡ªåŠ¨æ˜ å°„å­—æ®µ: "${FIELD_MAPPING['å®¢æˆ·åç§°']}" â†’ "å®¢æˆ·åç§°"`;
                }
            }

            // å®¢æˆ·é€‰é¡¹æ›´æ–° - å—æµ‹ç«™å½±å“
            updateCustomerOptions() {
                if (!this.data || !this.data.length) return;

                const stationValues = this.stationSelect.getSelectedValues();

                console.log(`ğŸ”„ [é¡¶éƒ¨çº§è”] æ›´æ–°å®¢æˆ·é€‰é¡¹ - å½“å‰é€‰æ‹©çš„æµ‹ç«™: [${stationValues.join(', ')}]`);
                console.log(`ğŸ“Š [é¡¶éƒ¨çº§è”] æ€»æ•°æ®æ¡æ•°: ${this.data.length}`);

                // å…è®¸ç‹¬ç«‹é€‰æ‹©ï¼šå¦‚æœæ²¡æœ‰é€‰æ‹©æµ‹ç«™ï¼Œæ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·
                const filteredData = this.data.filter(item => {
                    if (stationValues.length === 0) return true; // æ— ä¸Šçº§é€‰æ‹©æ—¶æ˜¾ç¤ºæ‰€æœ‰
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();
                    return stationValues.includes(itemStation);
                });

                console.log(`ğŸ“Š [é¡¶éƒ¨çº§è”] è¿‡æ»¤åæ•°æ®æ¡æ•°: ${filteredData.length}`);

                // è·å–å”¯ä¸€çš„å®¢æˆ·åç§°
                const customerMap = new Map();
                filteredData.forEach(item => {
                    const customer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();
                    if (customer) {
                        if (!customerMap.has(customer)) {
                            customerMap.set(customer, 0);
                        }
                        customerMap.set(customer, customerMap.get(customer) + 1);
                    }
                });

                const filteredCustomers = Array.from(customerMap.keys()).sort();

                console.log(`âœ… [é¡¶éƒ¨çº§è”] å®¢æˆ·é€‰é¡¹å·²æ›´æ–°: ${filteredCustomers.length} ä¸ªå¯é€‰é¡¹`);
                customerMap.forEach((count, customer) => {
                    console.log(`   - ${customer}: ${count} æ¡è®°å½•`);
                });

                const customerOptions = filteredCustomers.map(customer => ({ value: customer, label: customer }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.customerSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => filteredCustomers.includes(value));

                this.customerSelect.setOptions(customerOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤ä¸åœ¨æµ‹ç«™å†…çš„å®¢æˆ·ï¼‰
                this.customerSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [é¡¶éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„å®¢æˆ·é€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [é¡¶éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªä¸åœ¨å½“å‰æµ‹ç«™çš„å®¢æˆ·é€‰æ‹©`);
                }
            }

            // å«æ˜Ÿé€‰é¡¹æ›´æ–° - å—æµ‹ç«™å’Œå®¢æˆ·å½±å“
            updateSatelliteOptions() {
                if (!this.data || !this.data.length) return;

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();

                // å…è®¸ç‹¬ç«‹é€‰æ‹©ï¼šå¦‚æœæ²¡æœ‰é€‰æ‹©æµ‹ç«™æˆ–å®¢æˆ·ï¼Œæ˜¾ç¤ºæ‰€æœ‰å«æ˜Ÿ
                const filteredSatellites = [...new Set(
                    this.data
                        .filter(item => {
                            // æ— ä¸Šçº§é€‰æ‹©æ—¶æ˜¾ç¤ºæ‰€æœ‰
                            if (stationValues.length === 0 && customerValues.length === 0) return true;

                            const matchesStation = stationValues.length === 0 ||
                                                  stationValues.includes((getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim());
                            const matchesCustomer = customerValues.length === 0 ||
                                                  customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim());
                            return matchesStation && matchesCustomer;
                        })
                        .map(item => (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim())
                        .filter(Boolean)
                )].sort();

                const satelliteOptions = filteredSatellites.map(satellite => ({ value: satellite, label: satellite }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.satelliteSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => filteredSatellites.includes(value));

                this.satelliteSelect.setOptions(satelliteOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤ä¸åœ¨æµ‹ç«™/å®¢æˆ·å†…çš„å«æ˜Ÿï¼‰
                this.satelliteSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [é¡¶éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„å«æ˜Ÿé€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [é¡¶éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªæ— æ•ˆçš„å«æ˜Ÿé€‰æ‹©`);
                }
            }

            // ã€çº§è”ä¼˜åŒ–ã€‘ä»»åŠ¡ç±»å‹é€‰é¡¹æ›´æ–° - å—æµ‹ç«™ã€å®¢æˆ·ã€å«æ˜Ÿå½±å“
            updateTypeOptions() {
                if (!this.data || !this.data.length) return;

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();

                // å…è®¸ç‹¬ç«‹é€‰æ‹©ï¼šå¦‚æœæ²¡æœ‰é€‰æ‹©ä¸Šçº§ç­›é€‰ï¼Œæ˜¾ç¤ºæ‰€æœ‰ç±»å‹
                const filteredTypes = [...new Set(
                    this.data
                        .filter(item => {
                            // æ— ä¸Šçº§é€‰æ‹©æ—¶æ˜¾ç¤ºæ‰€æœ‰
                            if (stationValues.length === 0 && customerValues.length === 0 && satelliteValues.length === 0) {
                                return true;
                            }

                            const matchesStation = stationValues.length === 0 ||
                                                  stationValues.includes((getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim());
                            const matchesCustomer = customerValues.length === 0 ||
                                                   customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim());
                            const matchesSatellite = satelliteValues.length === 0 ||
                                                    satelliteValues.includes((getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim());
                            return matchesStation && matchesCustomer && matchesSatellite;
                        })
                        .map(item => (getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim())
                        .filter(Boolean)
                )].sort();

                const typeOptions = filteredTypes.map(type => ({ value: type, label: type }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.typeSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => filteredTypes.includes(value));

                this.typeSelect.setOptions(typeOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤æ— æ•ˆçš„ä»»åŠ¡ç±»å‹ï¼‰
                this.typeSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [é¡¶éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„ä»»åŠ¡ç±»å‹é€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [é¡¶éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªæ— æ•ˆçš„ä»»åŠ¡ç±»å‹é€‰æ‹©`);
                }
            }

            // ã€çº§è”ä¼˜åŒ–ã€‘çŠ¶æ€é€‰é¡¹æ›´æ–° - å—æµ‹ç«™ã€å®¢æˆ·ã€å«æ˜Ÿã€ä»»åŠ¡ç±»å‹å½±å“ï¼ˆçº§è”æœ«ç«¯ï¼‰
            updateStatusOptions() {
                if (!this.data || !this.data.length) return;

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();
                const typeValues = this.typeSelect.getSelectedValues();

                // å…è®¸ç‹¬ç«‹é€‰æ‹©ï¼šå¦‚æœæ²¡æœ‰é€‰æ‹©ä¸Šçº§ç­›é€‰ï¼Œæ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€
                const filteredStatuses = [...new Set(
                    this.data
                        .filter(item => {
                            // æ— ä¸Šçº§é€‰æ‹©æ—¶æ˜¾ç¤ºæ‰€æœ‰
                            if (stationValues.length === 0 && customerValues.length === 0 &&
                                satelliteValues.length === 0 && typeValues.length === 0) {
                                return true;
                            }

                            const matchesStation = stationValues.length === 0 ||
                                                  stationValues.includes((getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim());
                            const matchesCustomer = customerValues.length === 0 ||
                                                   customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim());
                            const matchesSatellite = satelliteValues.length === 0 ||
                                                    satelliteValues.includes((getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim());
                            const matchesType = typeValues.length === 0 ||
                                               typeValues.includes((getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim());
                            return matchesStation && matchesCustomer && matchesSatellite && matchesType;
                        })
                        .map(item => (getFieldValue(item, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim())
                        .filter(Boolean)
                )].sort();

                const statusOptions = filteredStatuses.map(status => ({ value: status, label: status }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.statusSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => filteredStatuses.includes(value));

                this.statusSelect.setOptions(statusOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤æ— æ•ˆçš„çŠ¶æ€ï¼‰
                this.statusSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [é¡¶éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„çŠ¶æ€é€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [é¡¶éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªæ— æ•ˆçš„çŠ¶æ€é€‰æ‹©`);
                }
            }

            // ã€çº§è”ä¼˜åŒ–ã€‘é‡ç½®åç»­ç­›é€‰å™¨ - çº§è”é¡ºåºï¼šæµ‹ç«™ â†’ å®¢æˆ· â†’ å«æ˜Ÿ â†’ ç±»å‹ â†’ çŠ¶æ€
            resetSubsequentFilters(after = '') {
                const filterOrder = ['station', 'customer', 'satellite', 'type', 'status'];
                const startIndex = after ? filterOrder.indexOf(after) + 1 : 1;

                for (let i = startIndex; i < filterOrder.length; i++) {
                    const filterType = filterOrder[i];
                    const select = this[`${filterType}Select`];
                    if (select) select.clearSelection();
                }
            }

            // ã€åŒå‘åŒæ­¥ã€‘é¡¶éƒ¨ç­›é€‰å™¨åŒæ­¥åˆ°åº•éƒ¨ç­›é€‰å™¨
            syncTopToBottom(filterType, values) {
                if (this.isSyncingFilters) return; // é˜²æ­¢å¾ªç¯è§¦å‘

                this.isSyncingFilters = true;
                try {
                    const chartSelect = this[`${filterType}ChartSelect`];
                    if (chartSelect) {
                        // ç›´æ¥è®¾ç½®é€‰ä¸­çš„å€¼ï¼Œä¸è§¦å‘å›è°ƒ
                        chartSelect.setSelectedValues(values);
                        console.log(`ğŸ”„ é¡¶éƒ¨â†’åº•éƒ¨åŒæ­¥: ${filterType} = [${values.join(', ')}]`);
                    }
                } finally {
                    this.isSyncingFilters = false;
                }
            }

            // ã€åŒå‘åŒæ­¥ã€‘åº•éƒ¨ç­›é€‰å™¨åŒæ­¥åˆ°é¡¶éƒ¨ç­›é€‰å™¨
            syncBottomToTop(filterType, values) {
                if (this.isSyncingFilters) return; // é˜²æ­¢å¾ªç¯è§¦å‘

                this.isSyncingFilters = true;
                try {
                    const topSelect = this[`${filterType}Select`];
                    if (topSelect) {
                        // ç›´æ¥è®¾ç½®é€‰ä¸­çš„å€¼ï¼Œä¸è§¦å‘å›è°ƒ
                        topSelect.setSelectedValues(values);
                        console.log(`ğŸ”„ åº•éƒ¨â†’é¡¶éƒ¨åŒæ­¥: ${filterType} = [${values.join(', ')}]`);
                    }
                } finally {
                    this.isSyncingFilters = false;
                }
            }

            // Helper: å°†å„ç§æ—¶é—´å€¼æŒ‰"æ–‡ä»¶æ—¶é—´"(æœ¬åœ°è¯­ä¹‰)è§£æä¸º Date å¯¹è±¡
            parseToLocalDate(value) {
                if (!value && value !== 0) return null;
                if (value instanceof Date) return new Date(
                    value.getFullYear(), value.getMonth(), value.getDate(),
                    value.getHours(), value.getMinutes(), value.getSeconds(), value.getMilliseconds()
                );

                // å¤„ç† Excel æ•°å­—åºåˆ—ï¼ˆå¦‚æœæœ‰ï¼‰
                if (typeof value === 'number') {
                    // Excelåºåˆ—å· -> JS æ—¶é—´ï¼ˆä¸åšæ—¶åŒºåç§»ï¼‰
                    try {
                        return new Date((value - 25569) * 86400000);
                    } catch (e) {
                        return new Date(value);
                    }
                }

                if (typeof value === 'string') {
                    const s = value.trim();
                    // YYYY-MM-DD æˆ– YYYY-MM-DD HH:MM:SS
                    const dateTimeMatch = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2}):(\d{2}))?$/);
                    if (dateTimeMatch) {
                        const y = parseInt(dateTimeMatch[1], 10);
                        const m = parseInt(dateTimeMatch[2], 10) - 1;
                        const d = parseInt(dateTimeMatch[3], 10);
                        const hh = parseInt(dateTimeMatch[4] || '0', 10);
                        const mm = parseInt(dateTimeMatch[5] || '0', 10);
                        const ss = parseInt(dateTimeMatch[6] || '0', 10);
                        return new Date(y, m, d, hh, mm, ss, 0);
                    }

                    // å…¶ä»–æ ¼å¼ï¼Œfallback åˆ° Date æ„é€ ï¼ˆæœ‰å¯èƒ½èµ°åˆ° UTCï¼Œå°½é‡é¿å…ï¼‰
                    const fallback = new Date(s);
                    if (!isNaN(fallback.getTime())) return fallback;

                    return null;
                }

                // fallback
                const fallback = new Date(value);
                return isNaN(fallback.getTime()) ? null : fallback;
            }

            // å°† start/end çš„ YYYY-MM-DD è¾“å…¥æ˜ å°„åˆ°å®Œæ•´å‘¨æœŸè¾¹ç•Œï¼ˆç¡®ä¿åŒ…å«å®Œæ•´çš„Xæ—¥YY:YYè‡³X+1æ—¥YY:YYå‘¨æœŸï¼‰
            // è§£ææ—¥æœŸè¾“å…¥ä¸ºæœ¬åœ°æ—¶é—´
            parseDateInputToLocal(dateStr, hour = 0, minute = 0, second = 0, ms = 0) {
                if (!dateStr) return null;
                const parts = dateStr.split('-').map(Number);
                const year = parts[0], month = parts[1] - 1, day = parts[2];
                return new Date(year, month, day, hour, minute, second, ms);
            }

            computeDateRangeForGroup(groupType, startDateStr, endDateStr) {
                let startBound = null;
                let endBound = null;

                // Helper: ä½¿ç”¨é½¿è½®é…ç½®æ—¶é—´æ¥ç¡®ä¿æ­£ç¡®è½åœ¨å‘¨æœŸåˆ†ç»„å†…
                const makeMidday = (dateStr) => {
                    if (!dateStr) return null;
                    const parts = dateStr.split('-').map(Number);

                    // è·å–é½¿è½®é…ç½®çš„æ—¶é—´
                    const config = this.cycleEngine.config;
                    let configTime = config.day.start;

                    // è§£æé½¿è½®æ—¶é—´ HH:mm
                    const [hours = 0, minutes = 0] = configTime.split(':').map(num => parseInt(num, 10));

                    // ä½¿ç”¨é½¿è½®é…ç½®çš„å…·ä½“æ—¶é—´è€Œä¸æ˜¯12:00
                    return new Date(parts[0], parts[1] - 1, parts[2], hours, minutes, 0, 0);
                };

                try {
                    if (startDateStr) {
                        const midStart = makeMidday(startDateStr);
                        const gStart = this.cycleEngine.getGroup(midStart, groupType);

                        // ç¡®ä¿startBoundä¸æ—©äºç”¨æˆ·è®¾ç½®çš„å¼€å§‹æ—¥æœŸ
                        const userStartDate = this.parseDateInputToLocal(startDateStr, 0, 0, 0, 0);
                        startBound = gStart.rangeStart < userStartDate ? userStartDate : gStart.rangeStart;
                    }

                    if (endDateStr) {
                        const midEnd = makeMidday(endDateStr);
                        const gEnd = this.cycleEngine.getGroup(midEnd, groupType);

                        // ç¡®ä¿åŒ…å«ç»“æŸæ—¥æœŸçš„å®Œæ•´å‘¨æœŸï¼Œå»¶é•¿åˆ°ä¸‹ä¸€å¤©çš„é½¿è½®æ—¶é—´
                        const nextDayStart = new Date(midEnd);
                        nextDayStart.setDate(nextDayStart.getDate() + 1);
                        const gNext = this.cycleEngine.getGroup(nextDayStart, groupType);
                        endBound = gNext.rangeStart;
                    }
                } catch (err) {
                    console.warn('è®¡ç®—æ—¥æœŸèŒƒå›´å¤±è´¥ï¼Œå›é€€åˆ°åŸºäºæœ¬åœ°æ—¥å†çš„é»˜è®¤è§£æ', err);
                    // é€€å›ï¼šæŒ‰æœ¬åœ°åˆå¤œ/23:59:59.999è§£æ
                    if (startDateStr) startBound = this.parseDateInputToLocal(startDateStr, 0, 0, 0, 0);
                    if (endDateStr) endBound = this.parseDateInputToLocal(endDateStr, 23, 59, 59, 999);
                }

                return { startDate: startBound, endDate: endBound };
            }

            // åº”ç”¨ç­›é€‰ï¼ˆä¿®å¤æ—¶é—´è½´èŒƒå›´é—®é¢˜ï¼‰
            // ã€æ–°å¢ã€‘è‡ªåŠ¨åº”ç”¨ç­›é€‰ï¼ˆé˜²æŠ–ï¼Œé¿å…é¢‘ç¹è§¦å‘ï¼‰
            autoApplyFilters() {
                if (!this.data || !this.data.length) {
                    console.warn('âš ï¸ æ•°æ®æœªåŠ è½½ï¼Œæ— æ³•è‡ªåŠ¨åº”ç”¨ç­›é€‰');
                    return;
                }

                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (this.autoApplyTimer) {
                    clearTimeout(this.autoApplyTimer);
                }

                // 300ms é˜²æŠ–
                this.autoApplyTimer = setTimeout(() => {
                    console.log('ğŸ”„ è‡ªåŠ¨åº”ç”¨ç­›é€‰å¹¶ç”Ÿæˆå›¾è¡¨');
                    this.applyFilters();
                }, 300);
            }

            // ã€ä¿®å¤æ—¶é—´è½´è·³è·ƒã€‘ç”Ÿæˆå®Œæ•´çš„æ—¶é—´åºåˆ—ï¼ˆå¡«å……0å€¼ï¼‰
            generateCompleteTimeline(startBound, endBound, groupBy) {
                if (!startBound || !endBound) {
                    console.warn('âš ï¸ æ—¶é—´èŒƒå›´æœªè®¾ç½®ï¼Œæ— æ³•ç”Ÿæˆå®Œæ•´æ—¶é—´è½´');
                    return [];
                }

                const timeline = [];
                const timelineKeys = new Set();
                let currentDate = new Date(startBound);
                const endDate = new Date(endBound);

                // ä½¿ç”¨ä¸€ä¸ªè¶³å¤Ÿå¤§çš„è¿­ä»£é™åˆ¶ï¼Œé˜²æ­¢æ— é™å¾ªç¯
                const maxIterations = 10000;
                let iterations = 0;

                while (currentDate < endDate && iterations < maxIterations) {
                    iterations++;

                    try {
                        const group = this.cycleEngine.getGroup(currentDate, groupBy);

                        // é¿å…é‡å¤æ·»åŠ åŒä¸€ä¸ªå‘¨æœŸ
                        if (!timelineKeys.has(group.key)) {
                            timelineKeys.add(group.key);
                            timeline.push(group);
                        }

                        // æ ¹æ®åˆ†ç»„ç±»å‹ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹
                        switch (groupBy) {
                            case 'day':
                                currentDate.setDate(currentDate.getDate() + 1);
                                break;
                            case 'week':
                                currentDate.setDate(currentDate.getDate() + 7);
                                break;
                            case 'month':
                                currentDate.setMonth(currentDate.getMonth() + 1);
                                break;
                            case 'quarter':
                                currentDate.setMonth(currentDate.getMonth() + 3);
                                break;
                            default:
                                currentDate.setDate(currentDate.getDate() + 1);
                        }
                    } catch (error) {
                        console.error('ç”Ÿæˆæ—¶é—´è½´å¤±è´¥:', error);
                        break;
                    }
                }

                if (iterations >= maxIterations) {
                    console.warn('âš ï¸ æ—¶é—´è½´ç”Ÿæˆè¾¾åˆ°è¿­ä»£é™åˆ¶ï¼Œå¯èƒ½æ—¶é—´èŒƒå›´è¿‡å¤§');
                }

                // æŒ‰ rangeStart æ’åº
                timeline.sort((a, b) => a.rangeStart - b.rangeStart);

                console.log(`ğŸ“… ç”Ÿæˆå®Œæ•´æ—¶é—´è½´: ${timeline.length} ä¸ªæ—¶é—´ç‚¹ (${groupBy})`);
                return timeline;
            }

            // ã€æ–°å¢ã€‘æ—¶é—´æ”¹å˜æ—¶æ›´æ–°å›¾è¡¨ï¼ˆä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼‰
            updateChartsOnTimeChange() {
                if (!this.data) return;

                console.log('ğŸ“… æ—¶é—´èŒƒå›´æ”¹å˜ï¼Œä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼Œæ›´æ–°å›¾è¡¨');

                // å¦‚æœè¿˜æ²¡æœ‰ç­›é€‰è¿‡æ•°æ®ï¼Œç›´æ¥åº”ç”¨ç­›é€‰
                if (!this.filteredData) {
                    console.log('âš ï¸ é¦–æ¬¡è®¾ç½®æ—¶é—´ï¼Œåº”ç”¨ç­›é€‰å¹¶ç”Ÿæˆå›¾è¡¨');
                    this.applyFilters();
                    return;
                }

                // æ¸…é™¤å®šæ—¶å™¨
                if (this.timeChangeTimer) {
                    clearTimeout(this.timeChangeTimer);
                }

                // 300ms é˜²æŠ–
                this.timeChangeTimer = setTimeout(() => {
                    const groupBy = document.getElementById('groupBy')?.value || 'day';

                    // é‡æ–°åº”ç”¨é¡¶éƒ¨ç­›é€‰ï¼ˆä¼šæ›´æ–° filteredDataï¼‰
                    const stationValues = this.stationSelect.getSelectedValues();
                    const customerValues = this.customerSelect.getSelectedValues();
                    const satelliteValues = this.satelliteSelect.getSelectedValues();
                    const statusValues = this.statusSelect.getSelectedValues();
                    const typeValues = this.typeSelect.getSelectedValues();

                    const startInput = document.getElementById('startDate').value;
                    const endInput = document.getElementById('endDate').value;
                    const range = this.computeDateRangeForGroup(groupBy, startInput, endInput);
                    const startBound = range.startDate;
                    const endBound = range.endDate;

                    // ã€ä¿®å¤æ—¶é—´è½´è·³è·ƒã€‘ä¿å­˜æ—¶é—´èŒƒå›´
                    this.currentTimeRange = {
                        startBound: startBound,
                        endBound: endBound,
                        groupBy: groupBy
                    };

                    const normalizedField = FIELD_MAPPING['å¼€å§‹æ—¶é—´'];
                    const dataForFiltering = this.data.map(item => {
                        const newItem = Object.assign({}, item);
                        newItem[normalizedField] = this.parseToLocalDate(item[normalizedField]);
                        return newItem;
                    });

                    this.filteredData = dataForFiltering.filter(item => {
                        const itemDate = item[normalizedField];
                        if (!itemDate) return false;

                        if (startBound && itemDate < startBound) return false;
                        if (endBound && itemDate > endBound) return false;

                        if (stationValues.length && !stationValues.includes((getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim())) {
                            return false;
                        }
                        if (customerValues.length && !customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim())) {
                            return false;
                        }
                        if (satelliteValues.length && !satelliteValues.includes((getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim())) {
                            return false;
                        }
                        if (statusValues.length && !statusValues.includes((getFieldValue(item, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim())) {
                            return false;
                        }
                        if (typeValues.length && !typeValues.includes((getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim())) {
                            return false;
                        }

                        return true;
                    });

                    // ã€å…³é”®ã€‘ä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼Œåªæ›´æ–°ç›¸å…³å›¾è¡¨
                    this.generateStationChartWithFilter();
                    this.generateCustomerChartWithFilter();
                    this.generateSatelliteChartWithFilter();
                    this.generateStatusChartWithFilter();
                    this.generateTypeChartWithFilter();

                    console.log('âœ… å›¾è¡¨å·²æ›´æ–°ï¼ˆåº•éƒ¨ç­›é€‰æ¡ä»¶å·²ä¿ç•™ï¼‰');
                }, 300);
            }

            // ã€æ–°å¢ã€‘åˆ†ç»„æ–¹å¼æ”¹å˜æ—¶æ›´æ–°å›¾è¡¨ï¼ˆä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼‰
            updateChartsOnGroupByChange() {
                if (!this.data) return;

                console.log('ğŸ“Š åˆ†ç»„æ–¹å¼æ”¹å˜ï¼Œä¿ç•™åº•éƒ¨ç­›é€‰æ¡ä»¶ï¼Œé‡æ–°ç”Ÿæˆå›¾è¡¨');

                // å¦‚æœè¿˜æ²¡æœ‰ç­›é€‰è¿‡æ•°æ®ï¼Œç›´æ¥åº”ç”¨ç­›é€‰
                if (!this.filteredData) {
                    console.log('âš ï¸ é¦–æ¬¡è®¾ç½®åˆ†ç»„ï¼Œåº”ç”¨ç­›é€‰å¹¶ç”Ÿæˆå›¾è¡¨');
                    this.applyFilters();
                    return;
                }

                // æ¸…é™¤å®šæ—¶å™¨
                if (this.groupByChangeTimer) {
                    clearTimeout(this.groupByChangeTimer);
                }

                // 300ms é˜²æŠ–
                this.groupByChangeTimer = setTimeout(() => {
                    // ç›´æ¥é‡æ–°ç”Ÿæˆå›¾è¡¨ï¼Œä¸æ”¹å˜ filteredData
                    this.generateStationChartWithFilter();
                    this.generateCustomerChartWithFilter();
                    this.generateSatelliteChartWithFilter();
                    this.generateStatusChartWithFilter();
                    this.generateTypeChartWithFilter();

                    console.log('âœ… å›¾è¡¨å·²é‡æ–°ç”Ÿæˆï¼ˆåº•éƒ¨ç­›é€‰æ¡ä»¶å·²ä¿ç•™ï¼‰');
                }, 300);
            }

            applyFilters() {
                if (!this.data) return;

                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();
                const statusValues = this.statusSelect.getSelectedValues();
                const typeValues = this.typeSelect.getSelectedValues();

                // å…ˆè®¡ç®—å‘¨æœŸæ€§èŒƒå›´è¾¹ç•Œï¼ˆå°† YYYY-MM-DD æ˜ å°„åˆ°å¯¹åº”å‘¨æœŸçš„ rangeStart/rangeEndï¼‰
                const groupBy = document.getElementById('groupBy').value;
                const startInput = document.getElementById('startDate').value;
                const endInput = document.getElementById('endDate').value;
                const range = this.computeDateRangeForGroup(groupBy, startInput, endInput);
                const startBound = range.startDate; // may be null
                const endBound = range.endDate; // may be null (inclusive)

                // ã€ä¿®å¤æ—¶é—´è½´è·³è·ƒã€‘ä¿å­˜æ—¶é—´èŒƒå›´ï¼Œç”¨äºç”Ÿæˆå®Œæ•´æ—¶é—´è½´
                this.currentTimeRange = {
                    startBound: startBound,
                    endBound: endBound,
                    groupBy: groupBy
                };

                // ä¸ºäº†é¿å…æµè§ˆå™¨å°† YYYY-MM-DD å½“æˆ UTC å¯¼è‡´åç§»ï¼Œæˆ‘ä»¬å…ˆæŠŠæ•°æ®å‰¯æœ¬ä¸­çš„å¼€å§‹æ—¶é—´è§£æä¸ºæœ¬åœ° Date
                const normalizedField = FIELD_MAPPING['å¼€å§‹æ—¶é—´'];
                const dataForFiltering = this.data.map(item => {
                    const newItem = Object.assign({}, item);
                    newItem[normalizedField] = this.parseToLocalDate(item[normalizedField]);
                    return newItem;
                });

                // è¿‡æ»¤ï¼ˆæ‰€æœ‰æ¡ä»¶ä¸º "ä¸”"ï¼‰
                this.filteredData = dataForFiltering.filter(item => {
                    const itemDate = item[normalizedField];
                    if (!itemDate) return false;

                    // æ—¶é—´èŒƒå›´æ¯”è¾ƒï¼ˆä½¿ç”¨æ–‡ä»¶æ—¶é—´è¯­ä¹‰ï¼‰
                    if (startBound && itemDate < startBound) return false;
                    if (endBound && itemDate > endBound) return false;

                    // æµ‹ç«™
                    if (stationValues.length && !stationValues.includes((getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim())) {
                        return false;
                    }

                    // å®¢æˆ·
                    if (customerValues.length && !customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim())) {
                        return false;
                    }

                    // å«æ˜Ÿ
                    if (satelliteValues.length && !satelliteValues.includes((getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim())) {
                        return false;
                    }

                    // çŠ¶æ€
                    if (statusValues.length && !statusValues.includes((getFieldValue(item, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim())) {
                        return false;
                    }

                    // ç±»å‹
                    if (typeValues.length && !typeValues.includes((getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim())) {
                        return false;
                    }

                    return true;
                });

                // ç”Ÿæˆå›¾è¡¨
                this.generateAllCharts(groupBy);
            }

            generateAllCharts(groupBy) {
                if (!this.filteredData || !this.filteredData.length) {
                    this.clearAllCharts();
                    return;
                }

                // ã€æ–°å¢ã€‘æ”¶é›†æ‰€æœ‰å›¾è¡¨æ•°æ®ï¼Œç”¨äºä¿å­˜åˆ° sessionStorage
                const chartDataMap = {};

                const chartsConfig = [
                    { chartId: 'stationChart', title: 'æµ‹ç«™åç§°è¶‹åŠ¿åˆ†æ', categoryField: 'æµ‹ç«™åç§°' },
                    { chartId: 'customerChart', title: 'å®¢æˆ·åç§°è¶‹åŠ¿åˆ†æ', categoryField: 'å®¢æˆ·åç§°' },
                    { chartId: 'satelliteChart', title: 'å«æ˜Ÿåç§°è¶‹åŠ¿åˆ†æ', categoryField: 'å«æ˜Ÿåç§°' },
                    { chartId: 'statusChart', title: 'ä»»åŠ¡ç»“æœçŠ¶æ€è¶‹åŠ¿åˆ†æ', categoryField: 'ä»»åŠ¡ç»“æœçŠ¶æ€' },
                    { chartId: 'typeChart', title: 'ä»»åŠ¡ç±»å‹è¶‹åŠ¿åˆ†æ', categoryField: 'ä»»åŠ¡ç±»å‹' }
                ];

                chartsConfig.forEach(({ chartId, title, categoryField }) => {
                    const chartData = this.generateCategoryChart(chartId, title, categoryField, groupBy);
                    if (chartData) {
                        chartDataMap[chartId] = chartData;
                    }
                });

                // ã€æ–°å¢ã€‘ä¿å­˜æ‰€æœ‰å›¾è¡¨æ•°æ®åˆ° sessionStorage
                this.saveTrendChartsResult(chartDataMap, groupBy);
            }

            generateCategoryChart(chartId, title, categoryField, groupBy, additionalFilter = null) {
                let dataToUse = this.filteredData;

                // åº”ç”¨å›¾è¡¨ä¸“ç”¨ç­›é€‰
                if (additionalFilter) {
                    dataToUse = dataToUse.filter(additionalFilter);
                }

                // ä½¿ç”¨å·²ç»æ ‡å‡†åŒ–ï¼ˆæœ¬åœ° Dateï¼‰çš„å­—æ®µè¿›è¡Œåˆ†ç»„ï¼šgroupByStartTime ä¼šç”¨ item[FIELD_MAPPING['å¼€å§‹æ—¶é—´']] çš„å€¼ï¼ˆç°åœ¨ä¸º Dateï¼‰
                const groupedResult = this.cycleEngine.groupByStartTime(
                    dataToUse,
                    groupBy,
                    'è®¡åˆ’ID',
                    FIELD_MAPPING['å¼€å§‹æ—¶é—´']
                );

                // ã€ä¿®å¤æ—¶é—´è½´è·³è·ƒã€‘ç”Ÿæˆå®Œæ•´çš„æ—¶é—´åºåˆ—ï¼ˆåŒ…æ‹¬0å€¼æ—¶é—´ç‚¹ï¼‰
                let completeTimeline;
                if (this.currentTimeRange && this.currentTimeRange.startBound && this.currentTimeRange.endBound) {
                    completeTimeline = this.generateCompleteTimeline(
                        this.currentTimeRange.startBound,
                        this.currentTimeRange.endBound,
                        groupBy
                    );
                } else {
                    // å¦‚æœæ²¡æœ‰è®¾ç½®æ—¶é—´èŒƒå›´ï¼Œå›é€€åˆ°åŸæœ‰é€»è¾‘ï¼ˆåªæ˜¾ç¤ºæœ‰æ•°æ®çš„æ—¶é—´ç‚¹ï¼‰
                    console.warn('âš ï¸ æ—¶é—´èŒƒå›´æœªè®¾ç½®ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘ï¼ˆå¯èƒ½å‡ºç°æ—¶é—´è½´è·³è·ƒï¼‰');
                    completeTimeline = groupedResult.sortedKeys.map(key => groupedResult.groupMetadata[key]);
                }

                if (!completeTimeline || completeTimeline.length === 0) {
                    const emptyEl = document.getElementById(`${chartId}Empty`);
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    this.chartGenerator.destroyChart(chartId);
                    return null;
                }

                const categories = [...new Set(
                    dataToUse.map(item => getFieldValue(item, categoryField).toString().trim()).filter(Boolean)
                )];

                // ä½¿ç”¨å®Œæ•´æ—¶é—´è½´ç”ŸæˆXè½´æ ‡ç­¾
                const xLabels = completeTimeline.map(group => group.label);

                // ã€ä¿®å¤æ—¶é—´è½´è·³è·ƒã€‘ä¸ºæ¯ä¸ªç±»åˆ«ç”Ÿæˆæ•°æ®é›†ï¼ˆå¡«å……0å€¼ï¼‰
                const datasets = categories.map(category => ({
                    label: category,
                    data: completeTimeline.map(group => {
                        // å¦‚æœè¯¥æ—¶é—´ç‚¹æœ‰æ•°æ®ï¼Œè¿”å›æ•°æ®é‡ï¼›å¦åˆ™è¿”å›0
                        if (groupedResult.groups[group.key]) {
                            return groupedResult.groups[group.key].filter(item =>
                                getFieldValue(item, categoryField).toString().trim() === category
                            ).length;
                        } else {
                            return 0; // å¡«å……0å€¼ï¼Œä¿æŒæ—¶é—´è½´è¿ç»­
                        }
                    })
                }));

                // ç”Ÿæˆå›¾è¡¨
                this.chartGenerator.generateTrendChart(chartId, title, xLabels, datasets);

                // ã€æ–°å¢ã€‘è¿”å›å›¾è¡¨æ•°æ®ï¼Œç”¨äºä¿å­˜åˆ° sessionStorage
                return {
                    chartId: chartId,
                    title: title,
                    xLabels: xLabels,
                    datasets: datasets
                };
            }

            // å›¾è¡¨ä¸“ç”¨ç­›é€‰å’Œç”Ÿæˆæ–¹æ³• - ä½¿ç”¨é¡¶éƒ¨å®Œæ•´ç­›é€‰æ¡ä»¶
            generateStationChartWithFilter() {
                if (!this.data || !this.data.length) return;
                
                // è·å–é¡¶éƒ¨ç­›é€‰çš„æ‰€æœ‰æ¡ä»¶
                const startInput = document.getElementById('startDate').value;
                const endInput = document.getElementById('endDate').value;
                const groupBy = document.getElementById('groupBy').value;
                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();
                const statusValues = this.statusSelect.getSelectedValues();
                const typeValues = this.typeSelect.getSelectedValues();
                
                // è·å–å›¾è¡¨ä¸“ç”¨çš„æµ‹ç«™ç­›é€‰
                const selectedStations = this.stationChartSelect.getSelectedValues();
                
                // åº”ç”¨å®Œæ•´çš„ç­›é€‰é€»è¾‘ï¼Œä½†å¦‚æœå›¾è¡¨ä¸“ç”¨ç­›é€‰æœ‰å€¼ï¼Œåˆ™è¦†ç›–é¡¶éƒ¨æµ‹ç«™ç­›é€‰
                const filteredData = this.applyFiltersToData(this.data, {
                    startDate: startInput,
                    endDate: endInput,
                    stations: selectedStations.length > 0 ? selectedStations : stationValues,
                    customers: customerValues,
                    satellites: satelliteValues,
                    statuses: statusValues,
                    types: typeValues
                });
                
                this.generateCategoryChartFromData('stationChart', 'æµ‹ç«™åç§°è¶‹åŠ¿åˆ†æ', 'æµ‹ç«™åç§°', groupBy, filteredData);
            }

            generateCustomerChartWithFilter() {
                if (!this.data || !this.data.length) return;
                
                // è·å–é¡¶éƒ¨ç­›é€‰çš„æ‰€æœ‰æ¡ä»¶
                const startInput = document.getElementById('startDate').value;
                const endInput = document.getElementById('endDate').value;
                const groupBy = document.getElementById('groupBy').value;
                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();
                const statusValues = this.statusSelect.getSelectedValues();
                const typeValues = this.typeSelect.getSelectedValues();
                
                // è·å–å›¾è¡¨ä¸“ç”¨çš„å®¢æˆ·ç­›é€‰
                const selectedCustomers = this.customerChartSelect.getSelectedValues();
                
                // åº”ç”¨å®Œæ•´çš„ç­›é€‰é€»è¾‘ï¼Œä½†å¦‚æœå›¾è¡¨ä¸“ç”¨ç­›é€‰æœ‰å€¼ï¼Œåˆ™è¦†ç›–é¡¶éƒ¨å®¢æˆ·ç­›é€‰
                const filteredData = this.applyFiltersToData(this.data, {
                    startDate: startInput,
                    endDate: endInput,
                    stations: stationValues,
                    customers: selectedCustomers.length > 0 ? selectedCustomers : customerValues,
                    satellites: satelliteValues,
                    statuses: statusValues,
                    types: typeValues
                });
                
                this.generateCategoryChartFromData('customerChart', 'å®¢æˆ·åç§°è¶‹åŠ¿åˆ†æ', 'å®¢æˆ·åç§°', groupBy, filteredData);
            }

            generateSatelliteChartWithFilter() {
                if (!this.data || !this.data.length) return;
                
                // è·å–æ—¶é—´å’Œåˆ†ç»„æ¡ä»¶
                const startInput = document.getElementById('startDate').value;
                const endInput = document.getElementById('endDate').value;
                const groupBy = document.getElementById('groupBy').value;
                
                // è·å–é¡¶éƒ¨ç­›é€‰æ¡ä»¶
                const topStationValues = this.stationSelect.getSelectedValues();
                const topCustomerValues = this.customerSelect.getSelectedValues();
                const topSatelliteValues = this.satelliteSelect.getSelectedValues();
                const topStatusValues = this.statusSelect.getSelectedValues();
                const topTypeValues = this.typeSelect.getSelectedValues();
                
                // è·å–æ¨¡å—é—´çº§è”ç­›é€‰æ¡ä»¶
                const customerChartValues = this.customerChartSelect.getSelectedValues();
                const selectedSatellites = this.satelliteChartSelect.getSelectedValues();
                
                // çº§è”ç­›é€‰é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨æ¨¡å—é—´çº§è”ç­›é€‰ï¼Œå¦åˆ™ä½¿ç”¨é¡¶éƒ¨ç­›é€‰
                const finalCustomerValues = customerChartValues.length > 0 ? customerChartValues : topCustomerValues;
                const finalSatelliteValues = selectedSatellites.length > 0 ? selectedSatellites : topSatelliteValues;
                
                // åº”ç”¨ç­›é€‰é€»è¾‘
                const filteredData = this.applyFiltersToData(this.data, {
                    startDate: startInput,
                    endDate: endInput,
                    stations: topStationValues,
                    customers: finalCustomerValues,
                    satellites: finalSatelliteValues,
                    statuses: topStatusValues,
                    types: topTypeValues
                });
                
                this.generateCategoryChartFromData('satelliteChart', 'å«æ˜Ÿåç§°è¶‹åŠ¿åˆ†æ', 'å«æ˜Ÿåç§°', groupBy, filteredData);
            }

            generateStatusChartWithFilter() {
                if (!this.data || !this.data.length) return;
                
                // è·å–æ—¶é—´å’Œåˆ†ç»„æ¡ä»¶
                const startInput = document.getElementById('startDate').value;
                const endInput = document.getElementById('endDate').value;
                const groupBy = document.getElementById('groupBy').value;
                
                // è·å–é¡¶éƒ¨ç­›é€‰æ¡ä»¶
                const topStationValues = this.stationSelect.getSelectedValues();
                const topCustomerValues = this.customerSelect.getSelectedValues();
                const topSatelliteValues = this.satelliteSelect.getSelectedValues();
                const topStatusValues = this.statusSelect.getSelectedValues();
                const topTypeValues = this.typeSelect.getSelectedValues();
                
                // è·å–æ¨¡å—é—´çº§è”ç­›é€‰æ¡ä»¶
                const customerChartValues = this.customerChartSelect.getSelectedValues();
                const satelliteChartValues = this.satelliteChartSelect.getSelectedValues();
                const selectedStatuses = this.statusChartSelect.getSelectedValues();
                
                // çº§è”ç­›é€‰é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨æ¨¡å—é—´çº§è”ç­›é€‰ï¼Œå¦åˆ™ä½¿ç”¨é¡¶éƒ¨ç­›é€‰
                const finalCustomerValues = customerChartValues.length > 0 ? customerChartValues : topCustomerValues;
                const finalSatelliteValues = satelliteChartValues.length > 0 ? satelliteChartValues : topSatelliteValues;
                const finalStatusValues = selectedStatuses.length > 0 ? selectedStatuses : topStatusValues;
                
                // åº”ç”¨ç­›é€‰é€»è¾‘
                const filteredData = this.applyFiltersToData(this.data, {
                    startDate: startInput,
                    endDate: endInput,
                    stations: topStationValues,
                    customers: finalCustomerValues,
                    satellites: finalSatelliteValues,
                    statuses: finalStatusValues,
                    types: topTypeValues
                });
                
                this.generateCategoryChartFromData('statusChart', 'ä»»åŠ¡ç»“æœçŠ¶æ€è¶‹åŠ¿åˆ†æ', 'ä»»åŠ¡ç»“æœçŠ¶æ€', groupBy, filteredData);
            }

            generateTypeChartWithFilter() {
                if (!this.data || !this.data.length) return;
                
                // è·å–æ—¶é—´å’Œåˆ†ç»„æ¡ä»¶
                const startInput = document.getElementById('startDate').value;
                const endInput = document.getElementById('endDate').value;
                const groupBy = document.getElementById('groupBy').value;
                
                // è·å–é¡¶éƒ¨ç­›é€‰æ¡ä»¶
                const topStationValues = this.stationSelect.getSelectedValues();
                const topCustomerValues = this.customerSelect.getSelectedValues();
                const topSatelliteValues = this.satelliteSelect.getSelectedValues();
                const topStatusValues = this.statusSelect.getSelectedValues();
                const topTypeValues = this.typeSelect.getSelectedValues();
                
                // è·å–æ¨¡å—é—´çº§è”ç­›é€‰æ¡ä»¶
                const customerChartValues = this.customerChartSelect.getSelectedValues();
                const satelliteChartValues = this.satelliteChartSelect.getSelectedValues();
                const selectedTypes = this.typeChartSelect.getSelectedValues();
                
                // çº§è”ç­›é€‰é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨æ¨¡å—é—´çº§è”ç­›é€‰ï¼Œå¦åˆ™ä½¿ç”¨é¡¶éƒ¨ç­›é€‰
                const finalCustomerValues = customerChartValues.length > 0 ? customerChartValues : topCustomerValues;
                const finalSatelliteValues = satelliteChartValues.length > 0 ? satelliteChartValues : topSatelliteValues;
                const finalTypeValues = selectedTypes.length > 0 ? selectedTypes : topTypeValues;
                
                // åº”ç”¨ç­›é€‰é€»è¾‘
                const filteredData = this.applyFiltersToData(this.data, {
                    startDate: startInput,
                    endDate: endInput,
                    stations: topStationValues,
                    customers: finalCustomerValues,
                    satellites: finalSatelliteValues,
                    statuses: topStatusValues,
                    types: finalTypeValues
                });
                
                this.generateCategoryChartFromData('typeChart', 'ä»»åŠ¡ç±»å‹è¶‹åŠ¿åˆ†æ', 'ä»»åŠ¡ç±»å‹', groupBy, filteredData);
            }

            // ã€çº§è”ä¼˜åŒ–ã€‘æ›´æ–°å›¾è¡¨ä¸“ç”¨ç­›é€‰é€‰é¡¹ - çº§è”é¡ºåºï¼šæµ‹ç«™ â†’ å®¢æˆ· â†’ å«æ˜Ÿ â†’ ç±»å‹ â†’ çŠ¶æ€
            updateChartFilterOptions() {
                if (!this.data || !this.data.length) return;

                console.log(`ğŸ”„ [updateChartFilterOptions] å¼€å§‹æ›´æ–°åº•éƒ¨ç­›é€‰å™¨é€‰é¡¹`);

                // è·å–é¡¶éƒ¨å½“å‰çš„ç­›é€‰æ¡ä»¶
                const stationValues = this.stationSelect.getSelectedValues();
                const customerValues = this.customerSelect.getSelectedValues();
                const satelliteValues = this.satelliteSelect.getSelectedValues();
                const typeValues = this.typeSelect.getSelectedValues();
                const statusValues = this.statusSelect.getSelectedValues();

                // ã€ä¿®å¤ã€‘æ›´æ–°å®¢æˆ·å›¾è¡¨çš„ç­›é€‰é€‰é¡¹ï¼ˆåŸºäºå·²é€‰æ‹©çš„æµ‹ç«™ï¼‰
                this.updateCustomerChartOptions();

                // æ›´æ–°å«æ˜Ÿå›¾è¡¨çš„ç­›é€‰é€‰é¡¹ï¼ˆåŸºäºå·²é€‰æ‹©çš„æµ‹ç«™å’Œå®¢æˆ·ï¼‰
                const filteredForSatellite = this.data.filter(item => {
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();
                    const itemCustomer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();

                    if (stationValues.length && !stationValues.includes(itemStation)) return false;
                    if (customerValues.length && !customerValues.includes(itemCustomer)) return false;

                    return true;
                });

                const availableSatellites = [...new Set(
                    filteredForSatellite.map(item => (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));

                const satelliteOptions = availableSatellites.map(satellite => ({ value: satellite, label: satellite }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©
                const currentSatelliteSelection = this.satelliteChartSelect.getSelectedValues();
                const validSatelliteSelection = currentSatelliteSelection.filter(value => availableSatellites.includes(value));

                this.satelliteChartSelect.setOptions(satelliteOptions);

                if (validSatelliteSelection.length > 0) {
                    this.satelliteChartSelect.setSelectedValues(validSatelliteSelection);
                }

                // ã€çº§è”ä¼˜åŒ–ã€‘æ›´æ–°ç±»å‹å›¾è¡¨çš„ç­›é€‰é€‰é¡¹ï¼ˆåŸºäºæµ‹ç«™ã€å®¢æˆ·ã€å«æ˜Ÿï¼‰
                const filteredForType = this.data.filter(item => {
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();
                    const itemCustomer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();
                    const itemSatellite = (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim();

                    if (stationValues.length && !stationValues.includes(itemStation)) return false;
                    if (customerValues.length && !customerValues.includes(itemCustomer)) return false;
                    if (satelliteValues.length && !satelliteValues.includes(itemSatellite)) return false;

                    return true;
                });

                const availableTypes = [...new Set(
                    filteredForType.map(item => (getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));

                const typeOptions = availableTypes.map(type => ({ value: type, label: type }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©
                const currentTypeSelection = this.typeChartSelect.getSelectedValues();
                const validTypeSelection = currentTypeSelection.filter(value => availableTypes.includes(value));

                this.typeChartSelect.setOptions(typeOptions);

                if (validTypeSelection.length > 0) {
                    this.typeChartSelect.setSelectedValues(validTypeSelection);
                }

                // ã€çº§è”ä¼˜åŒ–ã€‘æ›´æ–°çŠ¶æ€å›¾è¡¨çš„ç­›é€‰é€‰é¡¹ï¼ˆåŸºäºæµ‹ç«™ã€å®¢æˆ·ã€å«æ˜Ÿã€ç±»å‹ - çº§è”æœ«ç«¯ï¼‰
                const filteredForStatus = this.data.filter(item => {
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();
                    const itemCustomer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();
                    const itemSatellite = (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim();
                    const itemType = (getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim();

                    if (stationValues.length && !stationValues.includes(itemStation)) return false;
                    if (customerValues.length && !customerValues.includes(itemCustomer)) return false;
                    if (satelliteValues.length && !satelliteValues.includes(itemSatellite)) return false;
                    if (typeValues.length && !typeValues.includes(itemType)) return false;

                    return true;
                });

                const availableStatuses = [...new Set(
                    filteredForStatus.map(item => (getFieldValue(item, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));

                const statusOptions = availableStatuses.map(status => ({ value: status, label: status }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©
                const currentStatusSelection = this.statusChartSelect.getSelectedValues();
                const validStatusSelection = currentStatusSelection.filter(value => availableStatuses.includes(value));

                this.statusChartSelect.setOptions(statusOptions);

                if (validStatusSelection.length > 0) {
                    this.statusChartSelect.setSelectedValues(validStatusSelection);
                }
            }

            // ========ã€çº§è”ç­›é€‰ã€‘åº•éƒ¨å›¾è¡¨ç­›é€‰çš„é“¾å¼çº§è”æ›´æ–°æ–¹æ³• ========

            // ã€çº§è”ä¼˜åŒ–ã€‘1. æµ‹ç«™æ”¹å˜ â†’ æ›´æ–°å®¢æˆ·é€‰é¡¹ï¼ˆæ¸…é™¤å®¢æˆ·åŠå…¶ä¹‹åçš„é€‰æ‹©ï¼‰
            updateCustomerChartOptions() {
                if (!this.data || !this.data.length) return;

                const chartStationValues = this.stationChartSelect.getSelectedValues();
                const topStationValues = this.stationSelect.getSelectedValues();

                console.log(`ğŸ”„ [åº•éƒ¨çº§è”] æ›´æ–°å®¢æˆ·é€‰é¡¹ - åº•éƒ¨æµ‹ç«™: [${chartStationValues.join(', ')}], é¡¶éƒ¨æµ‹ç«™: [${topStationValues.join(', ')}]`);
                console.log(`ğŸ“Š [åº•éƒ¨çº§è”] æ€»æ•°æ®æ¡æ•°: ${this.data.length}`);

                // è¿‡æ»¤æ•°æ®ï¼šæ ¹æ®åº•éƒ¨æµ‹ç«™ç­›é€‰ï¼ˆæˆ–é¡¶éƒ¨æµ‹ç«™ï¼‰
                const filteredForCustomer = this.data.filter(item => {
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();

                    // å¦‚æœåº•éƒ¨æµ‹ç«™æœ‰é€‰æ‹©ï¼Œä½¿ç”¨åº•éƒ¨æµ‹ç«™ç­›é€‰ï¼›å¦åˆ™ä½¿ç”¨é¡¶éƒ¨æµ‹ç«™ç­›é€‰
                    if (chartStationValues.length > 0) {
                        return chartStationValues.includes(itemStation);
                    } else if (topStationValues.length > 0) {
                        return topStationValues.includes(itemStation);
                    }

                    // å¦‚æœéƒ½æ²¡é€‰æ‹©ï¼Œæ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·é€‰é¡¹
                    return true;
                });

                console.log(`ğŸ“Š [åº•éƒ¨çº§è”] è¿‡æ»¤åæ•°æ®æ¡æ•°: ${filteredForCustomer.length}`);

                // è·å–å”¯ä¸€çš„å®¢æˆ·åç§°å¹¶ç»Ÿè®¡
                const customerMap = new Map();
                filteredForCustomer.forEach(item => {
                    const customer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();
                    if (customer) {
                        if (!customerMap.has(customer)) {
                            customerMap.set(customer, 0);
                        }
                        customerMap.set(customer, customerMap.get(customer) + 1);
                    }
                });

                const availableCustomers = Array.from(customerMap.keys()).sort((a, b) => a.localeCompare(b, 'zh-CN'));

                console.log(`âœ… [åº•éƒ¨çº§è”] å®¢æˆ·é€‰é¡¹å·²æ›´æ–°: ${availableCustomers.length} ä¸ªå¯é€‰é¡¹`);
                customerMap.forEach((count, customer) => {
                    console.log(`   - ${customer}: ${count} æ¡è®°å½•`);
                });

                const customerOptions = availableCustomers.map(customer => ({ value: customer, label: customer }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.customerChartSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => availableCustomers.includes(value));

                this.customerChartSelect.setOptions(customerOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤ä¸åœ¨æµ‹ç«™å†…çš„å®¢æˆ·ï¼‰
                this.customerChartSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [åº•éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„å®¢æˆ·é€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [åº•éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªä¸åœ¨å½“å‰æµ‹ç«™çš„å®¢æˆ·é€‰æ‹©`);
                }
            }

            // ã€çº§è”ä¼˜åŒ–ã€‘2. å®¢æˆ·æ”¹å˜ â†’ æ›´æ–°å«æ˜Ÿé€‰é¡¹ï¼ˆæ¸…é™¤å«æ˜ŸåŠå…¶ä¹‹åçš„é€‰æ‹©ï¼‰
            updateSatelliteChartOptions() {
                if (!this.data || !this.data.length) return;

                const chartStationValues = this.stationChartSelect.getSelectedValues();
                const chartCustomerValues = this.customerChartSelect.getSelectedValues();
                const topStationValues = this.stationSelect.getSelectedValues();
                const topCustomerValues = this.customerSelect.getSelectedValues();

                // è¿‡æ»¤æ•°æ®ï¼šæ ¹æ®åº•éƒ¨æµ‹ç«™+å®¢æˆ·ç­›é€‰ï¼ˆæˆ–é¡¶éƒ¨ç­›é€‰ï¼‰
                const filteredForSatellite = this.data.filter(item => {
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();
                    const itemCustomer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();

                    // å¦‚æœåº•éƒ¨æµ‹ç«™æœ‰é€‰æ‹©ï¼Œä½¿ç”¨åº•éƒ¨æµ‹ç«™ç­›é€‰
                    if (chartStationValues.length > 0 && !chartStationValues.includes(itemStation)) {
                        return false;
                    } else if (chartStationValues.length === 0 && topStationValues.length > 0 && !topStationValues.includes(itemStation)) {
                        // åº•éƒ¨æ²¡é€‰ï¼Œä½¿ç”¨é¡¶éƒ¨æµ‹ç«™ç­›é€‰
                        return false;
                    }

                    // å¦‚æœåº•éƒ¨å®¢æˆ·æœ‰é€‰æ‹©ï¼Œä½¿ç”¨åº•éƒ¨å®¢æˆ·ç­›é€‰
                    if (chartCustomerValues.length > 0 && !chartCustomerValues.includes(itemCustomer)) {
                        return false;
                    } else if (chartCustomerValues.length === 0 && topCustomerValues.length > 0 && !topCustomerValues.includes(itemCustomer)) {
                        // åº•éƒ¨æ²¡é€‰ï¼Œä½¿ç”¨é¡¶éƒ¨å®¢æˆ·ç­›é€‰
                        return false;
                    }

                    return true;
                });

                const availableSatellites = [...new Set(
                    filteredForSatellite.map(item => (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));

                const satelliteOptions = availableSatellites.map(satellite => ({ value: satellite, label: satellite }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.satelliteChartSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => availableSatellites.includes(value));

                this.satelliteChartSelect.setOptions(satelliteOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤æ— æ•ˆçš„å«æ˜Ÿï¼‰
                this.satelliteChartSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [åº•éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„å«æ˜Ÿé€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [åº•éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªæ— æ•ˆçš„å«æ˜Ÿé€‰æ‹©`);
                }

                console.log(`âœ… å«æ˜Ÿé€‰é¡¹å·²æ›´æ–°: ${availableSatellites.length} ä¸ªå¯é€‰é¡¹`);
            }

            // ã€çº§è”ä¼˜åŒ–ã€‘3. å«æ˜Ÿæ”¹å˜ â†’ æ›´æ–°ç±»å‹é€‰é¡¹ï¼ˆæ¸…é™¤ç±»å‹åŠå…¶ä¹‹åçš„é€‰æ‹©ï¼‰
            updateTypeChartOptions() {
                if (!this.data || !this.data.length) return;

                const chartStationValues = this.stationChartSelect.getSelectedValues();
                const chartCustomerValues = this.customerChartSelect.getSelectedValues();
                const chartSatelliteValues = this.satelliteChartSelect.getSelectedValues();
                const topStationValues = this.stationSelect.getSelectedValues();
                const topCustomerValues = this.customerSelect.getSelectedValues();
                const topSatelliteValues = this.satelliteSelect.getSelectedValues();

                // è¿‡æ»¤æ•°æ®ï¼šæ ¹æ®åº•éƒ¨æµ‹ç«™+å®¢æˆ·+å«æ˜Ÿç­›é€‰ï¼ˆæˆ–é¡¶éƒ¨ç­›é€‰ï¼‰
                const filteredForType = this.data.filter(item => {
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();
                    const itemCustomer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();
                    const itemSatellite = (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim();

                    // æµ‹ç«™ç­›é€‰
                    if (chartStationValues.length > 0 && !chartStationValues.includes(itemStation)) {
                        return false;
                    } else if (chartStationValues.length === 0 && topStationValues.length > 0 && !topStationValues.includes(itemStation)) {
                        return false;
                    }

                    // å®¢æˆ·ç­›é€‰
                    if (chartCustomerValues.length > 0 && !chartCustomerValues.includes(itemCustomer)) {
                        return false;
                    } else if (chartCustomerValues.length === 0 && topCustomerValues.length > 0 && !topCustomerValues.includes(itemCustomer)) {
                        return false;
                    }

                    // å«æ˜Ÿç­›é€‰
                    if (chartSatelliteValues.length > 0 && !chartSatelliteValues.includes(itemSatellite)) {
                        return false;
                    } else if (chartSatelliteValues.length === 0 && topSatelliteValues.length > 0 && !topSatelliteValues.includes(itemSatellite)) {
                        return false;
                    }

                    return true;
                });

                const availableTypes = [...new Set(
                    filteredForType.map(item => (getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));

                const typeOptions = availableTypes.map(type => ({ value: type, label: type }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.typeChartSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => availableTypes.includes(value));

                this.typeChartSelect.setOptions(typeOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤æ— æ•ˆçš„ä»»åŠ¡ç±»å‹ï¼‰
                this.typeChartSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [åº•éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„ç±»å‹é€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [åº•éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªæ— æ•ˆçš„ç±»å‹é€‰æ‹©`);
                }

                console.log(`âœ… ç±»å‹é€‰é¡¹å·²æ›´æ–°: ${availableTypes.length} ä¸ªå¯é€‰é¡¹`);
            }

            // ã€çº§è”ä¼˜åŒ–ã€‘4. ç±»å‹æ”¹å˜ â†’ æ›´æ–°çŠ¶æ€é€‰é¡¹ï¼ˆæ¸…é™¤çŠ¶æ€çš„é€‰æ‹© - çº§è”æœ«ç«¯ï¼‰
            updateStatusChartOptions() {
                if (!this.data || !this.data.length) return;

                const chartStationValues = this.stationChartSelect.getSelectedValues();
                const chartCustomerValues = this.customerChartSelect.getSelectedValues();
                const chartSatelliteValues = this.satelliteChartSelect.getSelectedValues();
                const chartTypeValues = this.typeChartSelect.getSelectedValues();
                const topStationValues = this.stationSelect.getSelectedValues();
                const topCustomerValues = this.customerSelect.getSelectedValues();
                const topSatelliteValues = this.satelliteSelect.getSelectedValues();
                const topTypeValues = this.typeSelect.getSelectedValues();

                // è¿‡æ»¤æ•°æ®ï¼šæ ¹æ®åº•éƒ¨æµ‹ç«™+å®¢æˆ·+å«æ˜Ÿ+ç±»å‹ç­›é€‰ï¼ˆæˆ–é¡¶éƒ¨ç­›é€‰ï¼‰
                const filteredForStatus = this.data.filter(item => {
                    const itemStation = (getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim();
                    const itemCustomer = (getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim();
                    const itemSatellite = (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim();
                    const itemType = (getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim();

                    // æµ‹ç«™ç­›é€‰
                    if (chartStationValues.length > 0 && !chartStationValues.includes(itemStation)) {
                        return false;
                    } else if (chartStationValues.length === 0 && topStationValues.length > 0 && !topStationValues.includes(itemStation)) {
                        return false;
                    }

                    // å®¢æˆ·ç­›é€‰
                    if (chartCustomerValues.length > 0 && !chartCustomerValues.includes(itemCustomer)) {
                        return false;
                    } else if (chartCustomerValues.length === 0 && topCustomerValues.length > 0 && !topCustomerValues.includes(itemCustomer)) {
                        return false;
                    }

                    // å«æ˜Ÿç­›é€‰
                    if (chartSatelliteValues.length > 0 && !chartSatelliteValues.includes(itemSatellite)) {
                        return false;
                    } else if (chartSatelliteValues.length === 0 && topSatelliteValues.length > 0 && !topSatelliteValues.includes(itemSatellite)) {
                        return false;
                    }

                    // ã€çº§è”ä¼˜åŒ–ã€‘ç±»å‹ç­›é€‰
                    if (chartTypeValues.length > 0 && !chartTypeValues.includes(itemType)) {
                        return false;
                    } else if (chartTypeValues.length === 0 && topTypeValues.length > 0 && !topTypeValues.includes(itemType)) {
                        return false;
                    }

                    return true;
                });

                const availableStatuses = [...new Set(
                    filteredForStatus.map(item => (getFieldValue(item, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));

                const statusOptions = availableStatuses.map(status => ({ value: status, label: status }));

                // ã€çº§è”ä¼˜åŒ–ã€‘ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é€‰æ‹©ï¼Œç§»é™¤æ— æ•ˆçš„é€‰æ‹©
                const currentSelection = this.statusChartSelect.getSelectedValues();
                const validSelection = currentSelection.filter(value => availableStatuses.includes(value));

                this.statusChartSelect.setOptions(statusOptions);

                // ã€çº§è”ä¼˜åŒ–ã€‘å§‹ç»ˆè®¾ç½®æœ‰æ•ˆé€‰æ‹©ï¼ˆæ¸…é™¤æ— æ•ˆçš„çŠ¶æ€ï¼‰
                this.statusChartSelect.setSelectedValues(validSelection);
                if (validSelection.length > 0) {
                    console.log(`âœ… [åº•éƒ¨çº§è”] ä¿ç•™äº† ${validSelection.length} ä¸ªæœ‰æ•ˆçš„çŠ¶æ€é€‰æ‹©`);
                } else if (currentSelection.length > 0) {
                    console.log(`ğŸ—‘ï¸ [åº•éƒ¨çº§è”] æ¸…é™¤äº† ${currentSelection.length} ä¸ªæ— æ•ˆçš„çŠ¶æ€é€‰æ‹©`);
                }

                console.log(`âœ… çŠ¶æ€é€‰é¡¹å·²æ›´æ–°: ${availableStatuses.length} ä¸ªå¯é€‰é¡¹`);
            }

            // ======== æ¨¡å—é—´çº§è”ç­›é€‰æ–¹æ³• ========
            initializeAllChartOptions() {
                if (!this.data || !this.data.length) return;
                
                // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨çš„ç­›é€‰é€‰é¡¹ä¸ºå…¨éƒ¨å¯é€‰é¡¹
                const satelliteOptions = this.filterValues['å«æ˜Ÿåç§°'].map(satellite => ({ value: satellite, label: satellite }));
                const statusOptions = this.filterValues['ä»»åŠ¡ç»“æœçŠ¶æ€'].map(status => ({ value: status, label: status }));
                const typeOptions = this.filterValues['ä»»åŠ¡ç±»å‹'].map(type => ({ value: type, label: type }));
                
                this.satelliteChartSelect.setOptions(satelliteOptions);
                this.statusChartSelect.setOptions(statusOptions);
                this.typeChartSelect.setOptions(typeOptions);
            }

            updateInterModuleCascading(sourceModule) {
                if (!this.data || !this.data.length) return;
                
                let filteredData = this.data;
                
                if (sourceModule === 'customer') {
                    // å®¢æˆ·å›¾è¡¨é€‰æ‹©åï¼Œå½±å“å«æ˜Ÿã€çŠ¶æ€ã€ç±»å‹å›¾è¡¨
                    const customerValues = this.customerChartSelect.getSelectedValues();
                    
                    if (customerValues.length > 0) {
                        filteredData = filteredData.filter(item => 
                            customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim())
                        );
                        
                        // æ›´æ–°å«æ˜Ÿé€‰é¡¹
                        const availableSatellites = [...new Set(
                            filteredData.map(item => (getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim()).filter(Boolean)
                        )].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                        
                        const satelliteOptions = availableSatellites.map(satellite => ({ value: satellite, label: satellite }));
                        this.satelliteChartSelect.setOptions(satelliteOptions);
                        
                        // æ¸…ç©ºå«æ˜Ÿçš„å½“å‰é€‰æ‹©ï¼Œå› ä¸ºé€‰é¡¹å·²æ”¹å˜
                        this.satelliteChartSelect.clearSelection();
                        
                        // è‡ªåŠ¨é‡æ–°ç”Ÿæˆå«æ˜Ÿå›¾è¡¨ä»¥åæ˜ å®¢æˆ·ç­›é€‰çš„å½±å“
                        this.generateSatelliteChartWithFilter();
                    } else {
                        // æ¢å¤æ‰€æœ‰å«æ˜Ÿé€‰é¡¹
                        const satelliteOptions = this.filterValues['å«æ˜Ÿåç§°'].map(satellite => ({ value: satellite, label: satellite }));
                        this.satelliteChartSelect.setOptions(satelliteOptions);
                        
                        // é‡æ–°ç”Ÿæˆå«æ˜Ÿå›¾è¡¨æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                        this.generateSatelliteChartWithFilter();
                    }
                    
                    // æ›´æ–°çŠ¶æ€å’Œç±»å‹é€‰é¡¹
                    this.updateStatusAndTypeOptions(filteredData);
                    
                } else if (sourceModule === 'satellite') {
                    // å«æ˜Ÿå›¾è¡¨é€‰æ‹©åï¼Œå½±å“çŠ¶æ€ã€ç±»å‹å›¾è¡¨
                    const satelliteValues = this.satelliteChartSelect.getSelectedValues();
                    
                    if (satelliteValues.length > 0) {
                        filteredData = filteredData.filter(item => 
                            satelliteValues.includes((getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim())
                        );
                        
                        // å¦‚æœå®¢æˆ·å›¾è¡¨ä¹Ÿæœ‰é€‰æ‹©ï¼Œéœ€è¦åŒæ—¶è€ƒè™‘
                        const customerValues = this.customerChartSelect.getSelectedValues();
                        if (customerValues.length > 0) {
                            filteredData = filteredData.filter(item => 
                                customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim())
                            );
                        }
                    } else {
                        // å¦‚æœå«æ˜Ÿæ²¡æœ‰é€‰æ‹©ï¼Œä½†å®¢æˆ·æœ‰é€‰æ‹©ï¼Œä»ç„¶è¦è€ƒè™‘å®¢æˆ·çš„è¿‡æ»¤
                        const customerValues = this.customerChartSelect.getSelectedValues();
                        if (customerValues.length > 0) {
                            filteredData = filteredData.filter(item => 
                                customerValues.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim())
                            );
                        }
                    }
                    
                    // æ›´æ–°çŠ¶æ€å’Œç±»å‹é€‰é¡¹
                    this.updateStatusAndTypeOptions(filteredData);
                }
            }

            updateStatusAndTypeOptions(filteredData) {
                // æ›´æ–°çŠ¶æ€é€‰é¡¹
                const availableStatuses = [...new Set(
                    filteredData.map(item => (getFieldValue(item, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                
                const statusOptions = availableStatuses.map(status => ({ value: status, label: status }));
                this.statusChartSelect.setOptions(statusOptions);
                
                // æ›´æ–°ç±»å‹é€‰é¡¹
                const availableTypes = [...new Set(
                    filteredData.map(item => (getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim()).filter(Boolean)
                )].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                
                const typeOptions = availableTypes.map(type => ({ value: type, label: type }));
                this.typeChartSelect.setOptions(typeOptions);
                
                // æ¸…ç©ºçŠ¶æ€å’Œç±»å‹çš„å½“å‰é€‰æ‹©ï¼Œå› ä¸ºé€‰é¡¹å·²æ”¹å˜
                this.statusChartSelect.clearSelection();
                this.typeChartSelect.clearSelection();
                
                // é‡æ–°ç”Ÿæˆå›¾è¡¨
                this.generateStatusChartWithFilter();
                this.generateTypeChartWithFilter();
            }

            resetChartSubsequentFilters(after = '') {
                const filterOrder = ['station', 'customer', 'satellite', 'status', 'type'];
                const startIndex = after ? filterOrder.indexOf(after) + 1 : 1;

                for (let i = startIndex; i < filterOrder.length; i++) {
                    const filterType = filterOrder[i];
                    const select = this[`${filterType}ChartSelect`];
                    if (select) {
                        select.clearSelection();
                    }
                }
            }

            // æå–çš„é€šç”¨ç­›é€‰é€»è¾‘
            applyFiltersToData(originalData, filters) {
                const { startDate, endDate, stations, customers, satellites, statuses, types } = filters;
                
                // è®¡ç®—æ—¶é—´èŒƒå›´è¾¹ç•Œ
                const groupBy = document.getElementById('groupBy').value;
                const range = this.computeDateRangeForGroup(groupBy, startDate, endDate);
                const startBound = range.startDate;
                const endBound = range.endDate;
                
                // æ ‡å‡†åŒ–æ•°æ®ä¸­çš„æ—¶é—´å­—æ®µ
                const normalizedField = FIELD_MAPPING['å¼€å§‹æ—¶é—´'];
                const dataForFiltering = originalData.map(item => {
                    const newItem = Object.assign({}, item);
                    newItem[normalizedField] = this.parseToLocalDate(item[normalizedField]);
                    return newItem;
                });
                
                // åº”ç”¨ç­›é€‰æ¡ä»¶
                return dataForFiltering.filter(item => {
                    const itemDate = item[normalizedField];
                    if (!itemDate) return false;

                    // æ—¶é—´èŒƒå›´æ¯”è¾ƒ
                    if (startBound && itemDate < startBound) return false;
                    if (endBound && itemDate > endBound) return false;

                    // æµ‹ç«™ç­›é€‰
                    if (stations.length && !stations.includes((getFieldValue(item, 'æµ‹ç«™åç§°') || '').toString().trim())) {
                        return false;
                    }

                    // å®¢æˆ·ç­›é€‰
                    if (customers.length && !customers.includes((getFieldValue(item, 'å®¢æˆ·åç§°') || '').toString().trim())) {
                        return false;
                    }

                    // å«æ˜Ÿç­›é€‰
                    if (satellites.length && !satellites.includes((getFieldValue(item, 'å«æ˜Ÿåç§°') || '').toString().trim())) {
                        return false;
                    }

                    // çŠ¶æ€ç­›é€‰
                    if (statuses.length && !statuses.includes((getFieldValue(item, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim())) {
                        return false;
                    }

                    // ç±»å‹ç­›é€‰
                    if (types.length && !types.includes((getFieldValue(item, 'ä»»åŠ¡ç±»å‹') || '').toString().trim())) {
                        return false;
                    }

                    return true;
                });
            }

            // ä»æŒ‡å®šæ•°æ®ç”Ÿæˆåˆ†ç±»å›¾è¡¨ï¼ˆä¿®å¤æ—¶é—´è½´è·³è·ƒï¼šå¡«å……0å€¼ï¼‰
            generateCategoryChartFromData(chartId, title, categoryField, groupBy, dataToUse) {
                if (!dataToUse || !dataToUse.length) {
                    const emptyEl = document.getElementById(`${chartId}Empty`);
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    this.chartGenerator.destroyChart(chartId);
                    return null;
                }

                // 1. å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„
                const groupedResult = this.cycleEngine.groupByStartTime(
                    dataToUse,
                    groupBy,
                    'è®¡åˆ’ID',
                    FIELD_MAPPING['å¼€å§‹æ—¶é—´']
                );

                // 2. ã€ä¿®å¤æ—¶é—´è½´è·³è·ƒã€‘ç”Ÿæˆå®Œæ•´çš„æ—¶é—´åºåˆ—ï¼ˆåŒ…æ‹¬0å€¼æ—¶é—´ç‚¹ï¼‰
                let completeTimeline;
                if (this.currentTimeRange && this.currentTimeRange.startBound && this.currentTimeRange.endBound) {
                    completeTimeline = this.generateCompleteTimeline(
                        this.currentTimeRange.startBound,
                        this.currentTimeRange.endBound,
                        groupBy
                    );
                } else {
                    // å¦‚æœæ²¡æœ‰è®¾ç½®æ—¶é—´èŒƒå›´ï¼Œå›é€€åˆ°åŸæœ‰é€»è¾‘ï¼ˆåªæ˜¾ç¤ºæœ‰æ•°æ®çš„æ—¶é—´ç‚¹ï¼‰
                    console.warn('âš ï¸ æ—¶é—´èŒƒå›´æœªè®¾ç½®ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘ï¼ˆå¯èƒ½å‡ºç°æ—¶é—´è½´è·³è·ƒï¼‰');
                    completeTimeline = groupedResult.sortedKeys.map(key => groupedResult.groupMetadata[key]);
                }

                if (!completeTimeline || completeTimeline.length === 0) {
                    const emptyEl = document.getElementById(`${chartId}Empty`);
                    if (emptyEl) emptyEl.classList.remove('hidden');
                    this.chartGenerator.destroyChart(chartId);
                    return null;
                }

                // 3. è·å–æ‰€æœ‰ç±»åˆ«
                const categories = [...new Set(
                    dataToUse.map(item => getFieldValue(item, categoryField).toString().trim()).filter(Boolean)
                )];

                // 4. ç”ŸæˆXè½´æ ‡ç­¾ï¼ˆä½¿ç”¨å®Œæ•´æ—¶é—´è½´ï¼‰
                const xLabels = completeTimeline.map(group => group.label);

                // 5. ã€ä¿®å¤æ—¶é—´è½´è·³è·ƒã€‘ä¸ºæ¯ä¸ªç±»åˆ«ç”Ÿæˆæ•°æ®é›†ï¼ˆå¡«å……0å€¼ï¼‰
                const datasets = categories.map(category => ({
                    label: category,
                    data: completeTimeline.map(group => {
                        // å¦‚æœè¯¥æ—¶é—´ç‚¹æœ‰æ•°æ®ï¼Œè¿”å›æ•°æ®é‡ï¼›å¦åˆ™è¿”å›0
                        if (groupedResult.groups[group.key]) {
                            return groupedResult.groups[group.key].filter(item =>
                                getFieldValue(item, categoryField).toString().trim() === category
                            ).length;
                        } else {
                            return 0; // å¡«å……0å€¼ï¼Œä¿æŒæ—¶é—´è½´è¿ç»­
                        }
                    })
                }));

                // ç”Ÿæˆå›¾è¡¨
                this.chartGenerator.generateTrendChart(chartId, title, xLabels, datasets);

                // ã€æ–°å¢ã€‘è¿”å›å›¾è¡¨æ•°æ®ï¼Œç”¨äºä¿å­˜åˆ° sessionStorage
                return {
                    chartId: chartId,
                    title: title,
                    xLabels: xLabels,
                    datasets: datasets
                };
            }

            resetFilters() {
                this.stationSelect.clearSelection();
                this.customerSelect.clearSelection();
                this.satelliteSelect.clearSelection();
                this.statusSelect.clearSelection();
                this.typeSelect.clearSelection();

                // é‡ç½®å›¾è¡¨ä¸“ç”¨ç­›é€‰
                if (this.stationChartSelect) this.stationChartSelect.clearSelection();
                if (this.customerChartSelect) this.customerChartSelect.clearSelection();
                if (this.satelliteChartSelect) this.satelliteChartSelect.clearSelection();
                if (this.statusChartSelect) this.statusChartSelect.clearSelection();
                if (this.typeChartSelect) this.typeChartSelect.clearSelection();

                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';

                this.clearAllCharts();
            }

            // ==================== å¢é‡æ›´æ–°æ–¹æ³•ï¼ˆå®æ—¶åŒæ­¥ï¼‰====================

            // ã€æ–°å¢ã€‘æ™ºèƒ½æ›´æ–°å›¾è¡¨ï¼ˆåªæ›´æ–°å—å½±å“çš„å›¾è¡¨ï¼Œä¸é‡å»ºï¼‰
            smartUpdateCharts(record, operation) {
                // å¦‚æœæ²¡æœ‰å›¾è¡¨æˆ–æ²¡æœ‰ filteredDataï¼Œè·³è¿‡
                if (!this.filteredData || this.filteredData.length === 0) {
                    console.log('â­ï¸ å›¾è¡¨æœªåˆå§‹åŒ–æˆ–æ— ç­›é€‰æ•°æ®ï¼Œè·³è¿‡æ™ºèƒ½æ›´æ–°');
                    return false;
                }

                try {
                    // ç®€å•ç­–ç•¥ï¼šå¦‚æœè®°å½•åœ¨å½“å‰ filteredData ä¸­ï¼Œæ ‡è®°éœ€è¦é‡å»º
                    // æ›´å¤æ‚çš„ç­–ç•¥å¯ä»¥åªæ›´æ–°å—å½±å“çš„å›¾è¡¨ï¼Œä½†ä¼šå¢åŠ å¤æ‚åº¦
                    // è¿™é‡Œä½¿ç”¨"é™çº§åˆ°é‡å»º"ç­–ç•¥ï¼Œä½†é€šè¿‡é˜²æŠ–åˆå¹¶å¤šæ¬¡æ›´æ–°
                    console.log('ğŸ“Š è®°å½•å¯èƒ½å½±å“å›¾è¡¨ï¼Œé™çº§åˆ°é˜²æŠ–é‡å»º');
                    return false;
                } catch (error) {
                    console.error('âŒ æ™ºèƒ½æ›´æ–°å¤±è´¥:', error);
                    return false;
                }
            }

            // ã€æ–°å¢ã€‘é˜²æŠ–é‡å»ºå›¾è¡¨ï¼ˆ200msï¼Œåˆå¹¶å¤šä¸ªæ›´æ–°ï¼‰
            scheduleChartRebuild() {
                // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
                if (this.chartRebuildTimer) {
                    clearTimeout(this.chartRebuildTimer);
                }

                // è®¾ç½®æ–°çš„é˜²æŠ–è®¡æ—¶å™¨ï¼ˆ200ms å»¶è¿Ÿï¼‰
                this.chartRebuildTimer = setTimeout(() => {
                    // å¦‚æœå·²ç»åœ¨é‡å»ºï¼Œè·³è¿‡
                    if (this.isChartRebuilding) {
                        console.log('â­ï¸ å›¾è¡¨æ­£åœ¨é‡å»ºä¸­ï¼Œè·³è¿‡æ­¤æ¬¡è¯·æ±‚');
                        return;
                    }

                    console.log('ğŸ”¨ å¼€å§‹æ‰¹é‡é‡å»ºå›¾è¡¨...');
                    this.isChartRebuilding = true;
                    this.pendingChartRebuild = false;

                    try {
                        // é‡æ–°æå–ç­›é€‰å€¼
                        this.extractFilterValues();
                        // é‡æ–°åº”ç”¨ç­›é€‰å¹¶ç”Ÿæˆå›¾è¡¨
                        this.applyFilters();
                        console.log('âœ… å›¾è¡¨é‡å»ºå®Œæˆ');
                    } catch (error) {
                        console.error('âŒ å›¾è¡¨é‡å»ºå¤±è´¥:', error);
                    } finally {
                        this.isChartRebuilding = false;
                    }
                }, 200); // 200ms é˜²æŠ–ï¼šå¤šæ¬¡æ›´æ–°åªè§¦å‘ä¸€æ¬¡é‡å»º
            }

            // ã€æ–°å¢ã€‘ä»å•æ¡è®°å½•ä¸­æå–ç­›é€‰å€¼ï¼ˆç”¨äºæ¸è¿›å¼åŠ è½½ï¼‰
            extractSingleRecordFilterValues(record) {
                if (!record) return;

                const addUniqueValue = (field, value) => {
                    if (value && !this.filterValues[field].includes(value)) {
                        this.filterValues[field].push(value);
                        this.filterValues[field].sort((a, b) => a.localeCompare(b, 'zh-CN'));
                    }
                };

                addUniqueValue('æµ‹ç«™åç§°', (getFieldValue(record, 'æµ‹ç«™åç§°') || '').toString().trim());
                addUniqueValue('å®¢æˆ·åç§°', (getFieldValue(record, 'å®¢æˆ·åç§°') || '').toString().trim());
                addUniqueValue('å«æ˜Ÿåç§°', (getFieldValue(record, 'å«æ˜Ÿåç§°') || '').toString().trim());
                addUniqueValue('ä»»åŠ¡ç»“æœçŠ¶æ€', (getFieldValue(record, 'ä»»åŠ¡ç»“æœçŠ¶æ€') || '').toString().trim());
                addUniqueValue('ä»»åŠ¡ç±»å‹', (getFieldValue(record, 'ä»»åŠ¡ç±»å‹') || '').toString().trim());
            }

            // å¢é‡æ›´æ–°ï¼šæ’å…¥æˆ–æ›´æ–°å•æ¡è®°å½•åˆ°å†…å­˜
            incrementalUpdateRecord(record) {
                if (!this.data) {
                    console.warn('âš ï¸ å†…å­˜æ•°æ®æœªåˆå§‹åŒ–ï¼Œè·³è¿‡å¢é‡æ›´æ–°');
                    return false;
                }

                const recordId = record.id || record.plan_id;
                if (!recordId) {
                    console.warn('âš ï¸ è®°å½•ç¼ºå°‘IDï¼Œè·³è¿‡å¢é‡æ›´æ–°');
                    return false;
                }

                // åœ¨ this.data ä¸­æŸ¥æ‰¾å¹¶æ›´æ–°
                const index = this.data.findIndex(item => {
                    const itemId = item.id || item.plan_id;
                    return itemId === recordId;
                });

                if (index !== -1) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    this.data[index] = { ...this.data[index], ...record };
                    console.log(`âœ… å¢é‡æ›´æ–°ï¼šID=${recordId}`);
                } else {
                    // æ’å…¥æ–°è®°å½•
                    this.data.push(record);
                    console.log(`âœ… å¢é‡æ’å…¥ï¼šID=${recordId}`);
                }

                return true;
            }

            // å¢é‡åˆ é™¤ï¼šä»å†…å­˜ä¸­åˆ é™¤å•æ¡è®°å½•
            incrementalDeleteRecord(recordId) {
                if (!this.data) {
                    console.warn('âš ï¸ å†…å­˜æ•°æ®æœªåˆå§‹åŒ–ï¼Œè·³è¿‡å¢é‡åˆ é™¤');
                    return false;
                }

                const index = this.data.findIndex(item => {
                    const itemId = item.id || item.plan_id;
                    return itemId === recordId;
                });

                if (index !== -1) {
                    this.data.splice(index, 1);
                    console.log(`âœ… å¢é‡åˆ é™¤ï¼šID=${recordId}`);
                    return true;
                } else {
                    console.warn(`âš ï¸ å¢é‡åˆ é™¤ï¼šæœªæ‰¾åˆ°è®°å½• ID=${recordId}`);
                    return false;
                }
            }

            // ã€å·²åºŸå¼ƒã€‘é‡æ–°åº”ç”¨ç­›é€‰å¹¶åˆ·æ–°å›¾è¡¨ï¼ˆè¢«æ™ºèƒ½æ›´æ–°æ›¿ä»£ï¼‰
            // ä¿ç•™æ­¤æ–¹æ³•ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨
            refreshChartsAfterUpdate() {
                console.log('âš ï¸ refreshChartsAfterUpdate å·²è¢«æ™ºèƒ½æ›´æ–°æ›¿ä»£ï¼Œä½¿ç”¨é˜²æŠ–é‡å»º');
                // ä½¿ç”¨é˜²æŠ–é‡å»ºä»£æ›¿
                this.pendingChartRebuild = true;
                this.scheduleChartRebuild();
            }

            // ==================== å›¾è¡¨ç®¡ç† ====================

            clearAllCharts() {
                ['stationChart', 'customerChart', 'satelliteChart', 'statusChart', 'typeChart'].forEach(id => {
                    this.chartGenerator.destroyChart(id);
                    const emptyEl = document.getElementById(`${id}Empty`);
                    if (emptyEl) emptyEl.classList.remove('hidden');
                });
            }

            updateDebugInfo() {
                const debugContent = document.getElementById('debugContent');
                let info = "å­—æ®µæ˜ å°„é…ç½®:\n";
                Object.entries(FIELD_MAPPING).forEach(([sys, data]) => {
                    info += `  ç³»ç»Ÿå­—æ®µ"${sys}" â†’ æ•°æ®å­—æ®µ"${data}"\n`;
                });

                info += "\nç­›é€‰å­—æ®µæ•°æ®:\n";
                Object.entries(this.filterValues).forEach(([field, values]) => {
                    info += `  ${field}: ${values.length} é¡¹\n`;
                });

                debugContent.textContent = info;
            }

            addDebugButtons() {
                const debugInfo = document.getElementById('debugInfo');
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'absolute top-4 right-4 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded';
                toggleBtn.textContent = 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
                toggleBtn.addEventListener('click', () => {
                    debugInfo.classList.toggle('hidden');
                    toggleBtn.textContent = debugInfo.classList.contains('hidden') ? 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯' : 'éšè—è°ƒè¯•ä¿¡æ¯';
                });

                document.querySelector('main').style.position = 'relative';
                document.querySelector('main').appendChild(toggleBtn);
            }

            bindDownloadButtons() {
                document.addEventListener('click', (e) => {
                    const btn = e.target.closest && e.target.closest('.chart-download-btn');
                    if (!btn) return;

                    const chartId = btn.getAttribute('data-chart');
                    const type = btn.getAttribute('data-type');

                    const chart = this.chartGenerator.charts[chartId];
                    if (!chart) {
                        alert('å½“å‰å›¾è¡¨æ— æ•°æ®æˆ–å°šæœªç”Ÿæˆï¼Œè¯·å…ˆåº”ç”¨ç­›é€‰ç”Ÿæˆå›¾è¡¨åå†ä¸‹è½½ã€‚');
                        return;
                    }

                    if (type === 'image') {
                        try {
                            const imgUrl = chart.toBase64Image();
                            const a = document.createElement('a');
                            a.href = imgUrl;
                            const now = new Date();
                            const ts = now.toISOString().replace(/[:.]/g, '-');
                            a.download = `${chartId}-${ts}.png`;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => document.body.removeChild(a), 300);
                        } catch (err) {
                            console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥', err);
                            alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ”¯æŒæˆ–æ•°æ®é‡æ˜¯å¦è¿‡å¤§ã€‚');
                        }
                    } else if (type === 'csv') {
                        try {
                            const csv = chartToCSV(chart);
                            const now = new Date();
                            const ts = now.toISOString().replace(/[:.]/g, '-');
                            downloadFile(`${chartId}-${ts}.csv`, csv, 'text/csv;charset=utf-8;');
                        } catch (err) {
                            console.error('å¯¼å‡º CSV å¤±è´¥', err);
                            alert('å¯¼å‡º CSV å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚');
                        }
                    }
                });
            }

            // å¯åŠ¨ç¼“å­˜ç›‘å¬
            startCacheMonitoring() {
                console.log('ğŸ” å¯åŠ¨IndexedDBç¼“å­˜ç›‘å¬...');
                
                // è·å–åˆå§‹ç¼“å­˜çŠ¶æ€
                this.getCacheLastUpdated().then(time => {
                    this.lastCacheCheckTime = time;
                    console.log('ğŸ“‹ åˆå§‹ç¼“å­˜æ—¶é—´:', time ? new Date(time).toLocaleString() : 'æœªçŸ¥');
                });

                // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ç¼“å­˜æ˜¯å¦æœ‰æ›´æ–°
                this.cacheCheckInterval = setInterval(() => {
                    this.checkForCacheUpdates();
                }, 3000);
            }

            // åœæ­¢ç¼“å­˜ç›‘å¬
            stopCacheMonitoring() {
                if (this.cacheCheckInterval) {
                    clearInterval(this.cacheCheckInterval);
                    this.cacheCheckInterval = null;
                }
            }

            // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ›´æ–°
            async checkForCacheUpdates() {
                try {
                    const currentTime = await this.getCacheLastUpdated();
                    
                    if (currentTime && this.lastCacheCheckTime && currentTime > this.lastCacheCheckTime) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°ç¼“å­˜æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°æ•°æ®...');
                        console.log('ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´:', new Date(this.lastCacheCheckTime).toLocaleString());
                        console.log('å½“å‰ç¼“å­˜æ—¶é—´:', new Date(currentTime).toLocaleString());
                        
                        this.lastCacheCheckTime = currentTime;
                        await this.reloadData();
                    }
                } catch (error) {
                    console.warn('âš ï¸ æ£€æŸ¥ç¼“å­˜æ›´æ–°å¤±è´¥:', error);
                }
            }

            // è·å–ç¼“å­˜æœ€åæ›´æ–°æ—¶é—´
            async getCacheLastUpdated() {
                try {
                    await this.db.ensureInitialized();
                    const transaction = this.db.db.transaction(['metaData'], 'readonly');
                    const store = transaction.objectStore('metaData');
                    
                    return new Promise((resolve) => {
                        const request = store.get('allDataMeta');
                        request.onsuccess = () => {
                            const meta = request.result;
                            resolve(meta ? meta.lastUpdated : null);
                        };
                        request.onerror = () => resolve(null);
                    });
                } catch (error) {
                    console.warn('è·å–ç¼“å­˜æ—¶é—´å¤±è´¥:', error);
                    return null;
                }
            }

            // é‡æ–°åŠ è½½æ•°æ®
            async reloadData() {
                console.log('ğŸ”„ é‡æ–°åŠ è½½æ•°æ®ä¸­...');

                // ã€æ–°å¢ã€‘æ¸…ç©ºæ—§çš„å›¾è¡¨ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                this.clearTrendChartsResult();

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingEl = document.getElementById('dbLoading');
                if (loadingEl) loadingEl.classList.remove('hidden');

                try {
                    await this.loadData();
                    console.log('âœ… æ•°æ®é‡è½½å®Œæˆ');
                    
                    // æ˜¾ç¤ºæ›´æ–°æç¤º
                    this.showUpdateNotification();
                    
                } catch (error) {
                    console.error('âŒ æ•°æ®é‡è½½å¤±è´¥:', error);
                }
            }

            // æ‰‹åŠ¨åˆ·æ–°æ•°æ®
            async refreshData() {
                const btn = document.getElementById('refreshDataBtn');
                if (!btn) return;
                
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>æ£€æŸ¥æ›´æ–°...';
                
                try {
                    // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
                    if (await this.db.hasData()) {
                        // æ£€æŸ¥ç¼“å­˜æ›´æ–°
                        await this.checkForCacheUpdates();
                        
                        if (!this.data || this.data.length === 0) {
                            await this.reloadData();
                        } else {
                            // æ•°æ®ä¸ºæœ€æ–°çŠ¶æ€
                            this.showStatusMessage('âœ… æ•°æ®ä¸ºæœ€æ–°çŠ¶æ€', 'success');
                        }
                    } else {
                        this.showStatusMessage('âŒ æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåœ¨é¦–é¡µå¯¼å…¥æ•°æ®', 'warning');
                    }
                } catch (error) {
                    console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                    this.showStatusMessage('âŒ åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
            showUpdateNotification() {
                // åˆ›å»ºä¸´æ—¶é€šçŸ¥å…ƒç´ 
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 z-50 bg-success text-white px-4 py-2 rounded-lg shadow-lg';
                notification.innerHTML = '<i class="fa fa-check-circle mr-2"></i>æ•°æ®å·²è‡ªåŠ¨æ›´æ–°';
                document.body.appendChild(notification);
                
                // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            showStatusMessage(message, type = 'info') {
                const colors = {
                    success: 'bg-success text-white',
                    warning: 'bg-warning text-white', 
                    error: 'bg-danger text-white',
                    info: 'bg-primary text-white'
                };
                
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg ${colors[type] || colors.info}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // è¾…åŠ©å‡½æ•°ï¼šå°†æ—¶é—´å­—ç¬¦ä¸²å‡å»æŒ‡å®šå°æ—¶æ•°
            subtractHoursFromTime(timeStr, hours) {
                const [h, m] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(h, m, 0, 0);
                date.setHours(date.getHours() - hours);
                
                const newHours = date.getHours();
                const newMinutes = date.getMinutes();
                
                return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
            }

            // è¾…åŠ©å‡½æ•°ï¼šå°†æ—¶é—´å­—ç¬¦ä¸²åŠ ä¸ŠæŒ‡å®šå°æ—¶æ•°
            addHoursToTime(timeStr, hours) {
                const [h, m] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(h, m, 0, 0);
                date.setHours(date.getHours() + hours);
                
                const newHours = date.getHours();
                const newMinutes = date.getMinutes();
                
                return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
            }

            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateTimeDisplays() {
                const dayStartEl = document.getElementById('dayStart');
                if (dayStartEl && dayStartEl.value) {
                    // ç›´æ¥æ˜¾ç¤ºinputä¸­çš„å€¼ï¼Œæ— è½¬æ¢
                    const displayTime = dayStartEl.value;
                    document.getElementById('dayStartDisplay').textContent = displayTime;
                    document.getElementById('dayEndDisplay').textContent = displayTime;
                } else {
                    // ä»é…ç½®ä¸­è·å–æ—¶é—´å¹¶ç›´æ¥æ˜¾ç¤º
                    const timeValue = this.cycleEngine.config.day.start;
                    if (dayStartEl) dayStartEl.value = timeValue;
                    document.getElementById('dayStartDisplay').textContent = timeValue;
                    document.getElementById('dayEndDisplay').textContent = timeValue;
                }
            }

            // ä¿å­˜é¡µé¢çŠ¶æ€åˆ°sessionStorage
            savePageState() {
                try {
                    const startDateEl = document.getElementById('startDate');
                    const endDateEl = document.getElementById('endDate');
                    const groupByEl = document.getElementById('groupBy');

                    const pageState = {
                        startDate: startDateEl?.value || '',
                        endDate: endDateEl?.value || '',
                        groupBy: groupByEl?.value || 'day',
                        timestamp: Date.now()
                    };

                    sessionStorage.setItem('trendAnalysisPageState', JSON.stringify(pageState));
                    console.log('ğŸ’¾ é¡µé¢çŠ¶æ€å·²ä¿å­˜:', pageState);
                } catch (error) {
                    console.warn('ä¿å­˜é¡µé¢çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // æ¢å¤é¡µé¢çŠ¶æ€ä»sessionStorage
            restorePageState() {
                try {
                    const savedState = sessionStorage.getItem('trendAnalysisPageState');
                    if (!savedState) {
                        console.log('ğŸ“‹ æ— ä¿å­˜çš„é¡µé¢çŠ¶æ€');
                        return false;
                    }

                    const pageState = JSON.parse(savedState);
                    console.log('ğŸ”„ æ¢å¤é¡µé¢çŠ¶æ€:', pageState);

                    const startDateEl = document.getElementById('startDate');
                    const endDateEl = document.getElementById('endDate');
                    const groupByEl = document.getElementById('groupBy');

                    // æ¢å¤æ—¥æœŸèŒƒå›´
                    if (pageState.startDate && startDateEl) {
                        startDateEl.value = pageState.startDate;
                    }
                    if (pageState.endDate && endDateEl) {
                        endDateEl.value = pageState.endDate;
                    }

                    // æ¢å¤åˆ†ç»„æ–¹å¼
                    if (pageState.groupBy && groupByEl) {
                        groupByEl.value = pageState.groupBy;
                    }

                    console.log('âœ… é¡µé¢çŠ¶æ€æ¢å¤å®Œæˆ');
                    return true;
                } catch (error) {
                    console.warn('æ¢å¤é¡µé¢çŠ¶æ€å¤±è´¥:', error);
                    return false;
                }
            }

            // ä¿å­˜ç­›é€‰å™¨çŠ¶æ€åˆ°sessionStorage
            saveFilters() {
                try {
                    const filterState = {
                        stations: this.stationSelect?.getSelectedValues() || [],
                        customers: this.customerSelect?.getSelectedValues() || [],
                        satellites: this.satelliteSelect?.getSelectedValues() || [],
                        statuses: this.statusSelect?.getSelectedValues() || [],
                        types: this.typeSelect?.getSelectedValues() || [],
                        timestamp: Date.now()
                    };

                    sessionStorage.setItem('trendAnalysisFilters', JSON.stringify(filterState));
                    console.log('ğŸ’¾ ç­›é€‰å™¨çŠ¶æ€å·²ä¿å­˜:', filterState);
                } catch (error) {
                    console.warn('ä¿å­˜ç­›é€‰å™¨çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // æ¢å¤ç­›é€‰å™¨çŠ¶æ€ä»sessionStorage
            restoreFilters() {
                try {
                    const savedFilters = sessionStorage.getItem('trendAnalysisFilters');
                    if (!savedFilters) {
                        console.log('ğŸ“‹ æ— ä¿å­˜çš„ç­›é€‰å™¨çŠ¶æ€');
                        return false;
                    }

                    const filterState = JSON.parse(savedFilters);
                    console.log('ğŸ”„ æ¢å¤ç­›é€‰å™¨çŠ¶æ€:', filterState);

                    // æ¢å¤ç­›é€‰å™¨é€‰æ‹©ï¼ˆè¿™é‡Œä¸å®é™…åº”ç”¨ï¼Œåªæ˜¯æ¢å¤UIçŠ¶æ€ï¼‰
                    // å®é™…åº”ç”¨éœ€è¦ç”¨æˆ·ç‚¹å‡»"åº”ç”¨"æŒ‰é’®

                    console.log('âœ… ç­›é€‰å™¨çŠ¶æ€æ¢å¤å®Œæˆ');
                    return true;
                } catch (error) {
                    console.warn('æ¢å¤ç­›é€‰å™¨çŠ¶æ€å¤±è´¥:', error);
                    return false;
                }
            }

            // ä¿å­˜è¶‹åŠ¿å›¾è¡¨ç»“æœåˆ° sessionStorage
            saveTrendChartsResult(chartDataMap, groupBy) {
                try {
                    if (!chartDataMap || Object.keys(chartDataMap).length === 0) {
                        console.log('ğŸ“Š å›¾è¡¨ç»“æœä¸ºç©ºï¼Œä¸ä¿å­˜');
                        return;
                    }

                    const trendChartsData = {
                        chartDataMap: chartDataMap,
                        groupBy: groupBy,
                        generatedAt: Date.now()
                    };

                    sessionStorage.setItem('trendAnalysisCharts', JSON.stringify(trendChartsData));
                    console.log('ğŸ’¾ è¶‹åŠ¿å›¾è¡¨ç»“æœå·²ä¿å­˜:', {
                        chartsCount: Object.keys(chartDataMap).length,
                        groupBy: groupBy,
                        generatedAt: new Date(trendChartsData.generatedAt).toLocaleString()
                    });
                } catch (error) {
                    console.warn('ä¿å­˜è¶‹åŠ¿å›¾è¡¨ç»“æœå¤±è´¥:', error);
                }
            }

            // æ¢å¤è¶‹åŠ¿å›¾è¡¨ç»“æœå¹¶é‡æ–°æ¸²æŸ“
            restoreTrendChartsResult() {
                try {
                    const savedCharts = sessionStorage.getItem('trendAnalysisCharts');
                    if (!savedCharts) {
                        console.log('ğŸ“Š æ— ä¿å­˜çš„è¶‹åŠ¿å›¾è¡¨ç»“æœ');
                        return false;
                    }

                    const trendChartsData = JSON.parse(savedCharts);
                    console.log('ğŸ”„ æ¢å¤è¶‹åŠ¿å›¾è¡¨ç»“æœ:', {
                        chartsCount: Object.keys(trendChartsData.chartDataMap).length,
                        groupBy: trendChartsData.groupBy,
                        generatedAt: new Date(trendChartsData.generatedAt).toLocaleString()
                    });

                    // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ¸²æŸ“æ—¶æœº
                    requestAnimationFrame(() => {
                        // éå†æ‰€æœ‰ä¿å­˜çš„å›¾è¡¨æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“æ¯ä¸ªå›¾è¡¨
                        Object.keys(trendChartsData.chartDataMap).forEach(chartId => {
                            const chartData = trendChartsData.chartDataMap[chartId];

                            // éšè—ç©ºçŠ¶æ€æç¤º
                            const emptyState = document.getElementById(`${chartId}Empty`);
                            if (emptyState) {
                                emptyState.classList.add('hidden');
                            }

                            // é‡æ–°ç”Ÿæˆå›¾è¡¨
                            this.chartGenerator.generateTrendChart(
                                chartId,
                                chartData.title,
                                chartData.xLabels,
                                chartData.datasets
                            );
                        });

                        console.log('âœ… è¶‹åŠ¿å›¾è¡¨ç»“æœæ¢å¤å®Œæˆ');
                    });

                    return true;
                } catch (error) {
                    console.warn('æ¢å¤è¶‹åŠ¿å›¾è¡¨ç»“æœå¤±è´¥:', error);
                    return false;
                }
            }

            // æ¸…ç©ºè¶‹åŠ¿å›¾è¡¨ç»“æœ
            clearTrendChartsResult() {
                try {
                    sessionStorage.removeItem('trendAnalysisCharts');
                    console.log('ğŸ—‘ï¸ è¶‹åŠ¿å›¾è¡¨ç»“æœå·²æ¸…ç©º');
                } catch (error) {
                    console.warn('æ¸…ç©ºè¶‹åŠ¿å›¾è¡¨ç»“æœå¤±è´¥:', error);
                }
            }

            // æ¸…ç©ºé¡µé¢çŠ¶æ€
            clearPageState() {
                try {
                    sessionStorage.removeItem('trendAnalysisPageState');
                    sessionStorage.removeItem('trendAnalysisFilters');
                    sessionStorage.removeItem('trendAnalysisCharts');
                    console.log('ğŸ—‘ï¸ é¡µé¢çŠ¶æ€å·²æ¸…ç©º');
                } catch (error) {
                    console.warn('æ¸…ç©ºé¡µé¢çŠ¶æ€å¤±è´¥:', error);
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨ï¼ˆç¡®ä¿ Chart.js å·²åŠ è½½ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥ Chart.js æ˜¯å¦å·²åŠ è½½
            if (typeof Chart === 'undefined') {
                console.warn('âš ï¸ Chart.js æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ...');

                // è½®è¯¢æ£€æŸ¥ Chart.js æ˜¯å¦åŠ è½½å®Œæˆ
                const checkChartJs = setInterval(() => {
                    if (typeof Chart !== 'undefined') {
                        clearInterval(checkChartJs);
                        console.log('âœ… Chart.js åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åº”ç”¨');
                        window.trendApp = new TrendAnalysisApp();
                    }
                }, 100);

                // 10ç§’åè¶…æ—¶
                setTimeout(() => {
                    if (typeof Chart === 'undefined') {
                        clearInterval(checkChartJs);
                        console.error('âŒ Chart.js åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢');
                        alert('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                }, 10000);
            } else {
                console.log('âœ… Chart.js å·²å°±ç»ªï¼Œåˆå§‹åŒ–åº”ç”¨');
                window.trendApp = new TrendAnalysisApp();
            }
        });
    </script>
</body>
</html>
